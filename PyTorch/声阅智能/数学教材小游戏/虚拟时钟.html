<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟时钟·认识时间</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #e0e7ff;
            --success: #22c55e;
            --error: #ef4444;
            --background: #f3f4f6;
            --text: #22223b;
            --text-light: #6b7280;
            --white: #fff;
            --gray: #e5e7eb;
            --shadow: 0 6px 24px rgba(37, 99, 235, 0.08), 0 1.5px 4px rgba(0,0,0,0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 8px 32px 8px;
        }

        .container {
            max-width: 980px;
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            justify-content: flex-start;
            padding: 0 0 0 0;
            min-height: 100vh;
        }

        .main-layout {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            margin-left: -80px;
        }

        .sidebar {
            min-width: 220px;
            max-width: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: unset;
            background: var(--white);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 32px 24px;
            position: relative;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 10;
            margin-left: 8px;
        }
        .sidebar-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            min-height: 0;
        }
        .main-content.quiz1-layout,
        .main-content.quiz2-layout {
            justify-content: flex-start;
            gap: 24px;
            min-height: 100vh;
        }
        .quiz1-layout .clock-container {
            margin-bottom: 6px;
            width: 270px;
            height: 270px;
        }
        .quiz1-layout .input-group {
            margin-top: 12px;
            gap: 10px;
        }
        .quiz1-layout .num-pad {
            gap: 6px;
            margin-bottom: 2px;
        }
        .quiz1-layout .quiz1-btn-row {
            gap: 6px;
            margin: 4px 0 0 0;
        }
        .quiz1-layout #feedback-message {
            min-height: 22px;
            font-size: 16px;
            margin-top: 8px;
        }
        @media (max-width: 800px) {
            .quiz1-layout .clock-container {
                width: 140px;
                height: 140px;
            }
            .main-content.quiz1-layout {
                gap: 14px;
                padding-top: 12px;
                padding-bottom: 12px;
            }
            .quiz1-layout .input-group {
                gap: 10px;
            }
            .quiz1-layout .num-pad {
                gap: 4px;
                margin-bottom: 6px;
            }
            .quiz1-layout .quiz1-btn-row {
                gap: 8px;
                margin: 6px 0 0 0;
            }
        }

        .score-top {
            margin-bottom: 24px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .score-display {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 60%, #22c55e 100%);
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(37,99,235,0.10);
            padding: 10px 36px;
            letter-spacing: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mode-bar {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 28px;
            width: 100%;
        }

        .mode-btn {
            width: 100%;
            padding: 14px 0;
            font-size: 17px;
            border-radius: 10px;
            border: none;
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.06);
        }
        .mode-btn.active {
            background: linear-gradient(90deg, var(--primary) 70%, #60a5fa 100%);
            color: var(--white);
            box-shadow: 0 2px 8px rgba(37,99,235,0.13);
        }
        .mode-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .mode-instruction {
            background: #f8fafc;
            border-radius: 12px;
            padding: 18px 18px 12px 18px;
            font-size: 15px;
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(37,99,235,0.06);
            width: 100%;
        }
        .mode-instruction h3 {
            font-size: 17px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .mode-instruction ul {
            padding-left: 20px;
            margin: 0;
        }
        .mode-instruction li {
            margin-bottom: 7px;
            line-height: 1.7;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 8px;
            text-align: center;
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 1.5px;
        }
        .description {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 16px;
            max-width: 650px;
            font-size: 1.08rem;
        }

        .clock-container {
            margin: 0 auto 12px auto;
            position: relative;
            width: 320px;
            height: 320px;
            background: var(--white);
            border-radius: 50%;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #clock-canvas {
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: 50%;
            border: 10px solid var(--white);
            box-shadow: none;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 340px;
        }

        .time-label {
            font-size: 25px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .target-time {
            font-size: 30px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 18px;
            min-height: 40px;
            text-align: center;
            letter-spacing: 2px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 14px;
            margin-top: 10px;
        }
        .time-input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .time-input-wrapper input {
            width: 56px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 2px;
            border: 2px solid var(--gray);
            border-radius: 10px;
            padding: 12px 8px;
            margin: 0 4px;
            background: #f9fafb;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .time-input-wrapper input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px #2563eb33;
        }
        .time-input-wrapper input.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px #2563eb33;
        }
        .time-input-wrapper input::placeholder {
            color: #bbb;
            opacity: 1;
            text-align: center;
        }
        .colon-separator {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-left: 2px;
            margin-right: 2px;
        }

        .num-pad {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .num-btn, .del-btn {
            width: 44px;
            height: 44px;
            font-size: 22px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: linear-gradient(145deg, #f3f4f6 0%, #e0e7ff 100%);
            color: #2563eb;
            box-shadow: 0 4px 12px rgba(37,99,235,0.10), 0 1.5px 4px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, color 0.18s, transform 0.1s;
            outline: none;
            border-bottom: 3px solid #c7d2fe;
        }
        .num-btn:active, .del-btn:active {
            background: linear-gradient(145deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #1d4ed8;
            transform: scale(0.96);
            box-shadow: 0 2px 6px rgba(37,99,235,0.08);
        }
        .num-btn:hover, .del-btn:hover {
            background: linear-gradient(145deg, #dbeafe 0%, #93c5fd 100%);
            color: #1d4ed8;
            box-shadow: 0 6px 18px rgba(37,99,235,0.13);
        }

        .custom-time-container {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
            padding: 22px 20px 20px 20px;
            border-radius: 18px;
            box-shadow: 0 4px 18px rgba(37,99,235,0.10), 0 1.5px 4px rgba(0,0,0,0.04);
            width: 100%;
            margin-bottom: 18px;
            border: 1.5px solid #e0e7ff;
        }
        .custom-time-title {
            font-size: 17px;
            color: var(--text-light);
            margin-bottom: 14px;
            text-align: center;
            font-weight: 600;
        }
        .custom-time-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
        }
        .custom-time-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 7px;
        }
        .custom-time-input label {
            font-size: 15px;
            color: var(--text-light);
        }
        .custom-time-input input {
            width: 64px;
            padding: 12px;
            border: 2px solid var(--gray);
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #f4f6fb;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.04);
        }
        .custom-time-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px #2563eb33;
        }
        #set-custom-time {
            padding: 12px 0;
            background: linear-gradient(90deg, var(--primary) 70%, #60a5fa 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
            width: 100%;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.08);
        }
        #set-custom-time:hover {
            background: var(--primary-dark);
        }
        #submit-btn {
            padding: 14px 0;
            background: linear-gradient(90deg, var(--primary) 70%, #60a5fa 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.08);
        }
        #submit-btn:hover {
            background: var(--primary-dark);
        }
        #feedback-message {
            min-height: 26px;
            font-weight: 700;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
        }
        .success {
            color: var(--success);
        }
        .error {
            color: var(--error);
        }
        .hand-hint {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 6px 18px;
            border-radius: 24px;
            font-size: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.10);
            z-index: 2;
        }
        .quiz2-submit-btn {
            margin: 14px auto 0 auto;
            display: block;
            padding: 14px 0;
            background: linear-gradient(90deg, var(--primary) 70%, #60a5fa 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 19px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 120px;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 1.5px 4px rgba(37,99,235,0.08);
        }
        .quiz2-submit-btn:hover {
            background: var(--primary-dark);
        }
        .quiz1-btn-row, .quiz2-btn-row {
            display: flex !important;
            gap: 18px;
            justify-content: center;
            width: 100%;
            margin: 10px 0;
            flex-wrap: nowrap;
        }
        @media (max-width: 1100px) {
            .sidebar {
                min-width: 140px;
                max-width: 180px;
                padding: 18px 4px;
                border-radius: 14px;
                margin-left: 8px;
            }
            .main-layout {
                margin-left: 0;
                gap: 18px;
            }
        }
        @media (max-width: 800px) {
            .sidebar {
                position: static;
                min-width: 100vw;
                max-width: 100vw;
                width: 100vw;
                border-radius: 0;
                box-shadow: none;
                min-height: auto;
                height: auto;
                padding: 10px 0;
                margin-left: 0;
            }
            .main-layout {
                margin-left: 0;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            .container {
                flex-direction: column;
                align-items: center;
                padding: 0 2px;
            }
            .clock-container {
                width: 180px;
                height: 180px;
            }
            .mode-btn {
                padding: 8px 8px;
                font-size: 14px;
            }
            .time-label, .target-time {
                font-size: 18px;
            }
            .custom-time-input input, .time-input-wrapper input {
                width: 38px;
                font-size: 16px;
                padding: 8px 2px;
            }
            .quiz2-submit-btn {
                font-size: 15px;
                padding: 10px 0;
            }
            .quiz1-btn-row, .quiz2-btn-row {
                gap: 8px;
            }
        }
        #hour-input, #minute-input {
            width: 44px;
            font-size: 22px;
            text-align: center;
            letter-spacing: 2px;
            border: 2px solid var(--gray);
            border-radius: 10px;
            padding: 10px 4px;
            margin: 0 2px;
            background: #f9fafb;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #hour-input:focus, #minute-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px #2563eb33;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-layout">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="score-top">
                        <div class="score-display">得分: <span id="score">0</span></div>
                    </div>
                    <div class="mode-bar">
                        <button class="mode-btn active" data-mode="display">展示模式</button>
                        <button class="mode-btn" data-mode="quiz1">数一数</button>
                        <button class="mode-btn" data-mode="quiz2">拨一拨</button>
                    </div>
                    <div class="mode-instruction">
                        <h3>操作说明</h3>
                        <ul>
                            <li><b>展示模式：</b>自定义时间，观察时钟指针。</li>
                            <li><b>数一数：</b>根据时钟输入对应时间，答题有3次机会。</li>
                            <li><b>拨一拨：</b>拖动指针拨到目标时间，答题有3次机会。</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="main-content">
                <h1>虚拟时钟·认识时间</h1>
                <p class="description">通过互动游戏学习认识时钟和时间，拖动指针或输入时间来完成练习。</p>
                <div class="clock-container">
                    <canvas id="clock-canvas" width="300" height="300"></canvas>
                    <canvas id="quiz1-clock-canvas" width="270" height="270" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);"></canvas>
                    <div class="hand-hint" id="hand-hint"></div>
                </div>
                <div class="control-panel">
                    <!-- 展示模式下的自定义时间控件 -->
                    <div class="custom-time-container" id="custom-time-controls">
                        <div class="custom-time-title">自定义时间</div>
                        <div class="custom-time-inputs">
                            <div class="custom-time-input">
                                <label for="custom-hour">小时</label>
                                <input type="number" id="custom-hour" min="0" max="23" placeholder="时" value="12">
                            </div>
                            <div style="font-size: 24px; margin-top: 18px;">:</div>
                            <div class="custom-time-input">
                                <label for="custom-minute">分钟</label>
                                <input type="number" id="custom-minute" min="0" max="59" placeholder="分" value="0">
                            </div>
                        </div>
                        <button id="set-custom-time">确认时间</button>
                    </div>
                    <!-- 数一数模式下的输入控件 -->
                    <div class="input-group" id="quiz1-controls">
                        <div class="time-input-wrapper">
                            <input type="text" id="hour-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" readonly>
                            <div class="colon-separator">:</div>
                            <input type="text" id="minute-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" readonly>
                        </div>
                        <div class="num-pad" id="num-pad">
                            <button class="num-btn">1</button>
                            <button class="num-btn">2</button>
                            <button class="num-btn">3</button>
                            <button class="num-btn">4</button>
                            <button class="num-btn">5</button>
                            <button class="num-btn">6</button>
                            <button class="num-btn">7</button>
                            <button class="num-btn">8</button>
                            <button class="num-btn">9</button>
                            <button class="num-btn">0</button>
                            <button class="del-btn">删除</button>
                        </div>
                        <div class="quiz1-btn-col">
                            <div class="quiz1-btn-row">
                                <button id="submit-btn" class="quiz2-submit-btn">提交答案</button>
                                <button id="quiz1-next-btn" class="quiz2-submit-btn" style="display:none;">下一题</button>
                                <button id="quiz1-reset-btn" class="quiz2-submit-btn">重置</button>
                            </div>
                        </div>
                    </div>
                    <!-- 拨一拨模式下的目标时间显示 -->
                    <div class="target-time" id="target-time"></div>
                    <div class="quiz2-btn-col">
                        <div class="quiz2-btn-row">
                            <button id="quiz2-submit-btn" class="quiz2-submit-btn">提交答案</button>
                            <button id="quiz2-next-btn" class="quiz2-submit-btn">下一题</button>
                        </div>
                    </div>
                    <div id="feedback-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM元素
        const canvas = document.getElementById('clock-canvas');
        const ctx = canvas.getContext('2d');
        const quiz1Canvas = document.getElementById('quiz1-clock-canvas');
        const quiz1Ctx = quiz1Canvas.getContext('2d');
        const timeLabel = document.getElementById('time-label');
        const targetTimeDisplay = document.getElementById('target-time');
        const hourInput = document.getElementById('hour-input');
        const minuteInput = document.getElementById('minute-input');
        const submitBtn = document.getElementById('submit-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const scoreDisplay = document.getElementById('score');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const customTimeControls = document.getElementById('custom-time-controls');
        const customHourInput = document.getElementById('custom-hour');
        const customMinuteInput = document.getElementById('custom-minute');
        const setCustomTimeBtn = document.getElementById('set-custom-time');
        const handHint = document.getElementById('hand-hint');
        const quiz2SubmitBtn = document.getElementById('quiz2-submit-btn');
        const numPad = document.getElementById('num-pad');
        let activeInput = hourInput;

        // 时钟参数
        let radius = canvas.width / 2;
        let centerX = canvas.width / 2;
        let centerY = canvas.height / 2;
        let isDragging = false;
        let draggedHand = null; // 'hour' 或 'minute'
        let currentMode = 'display';
        let hintTimeout = null;

        // 游戏状态
        let score = 0;
        let targetTime = '';
        let targetHours = 0;
        let targetMinutes = 0;
        let displayHours = 12;
        let displayMinutes = 0;
        let quiz2Tries = 0;
        let quiz2ShowAnswerBtn = null;
        let nextQuizBtn = null;
        let quiz1Tries = 0;
        let quiz1ShowAnswerBtn = null;

        // 新增 quiz1 时钟参数
        let quiz1Radius = quiz1Canvas.width / 2;
        let quiz1CenterX = quiz1Canvas.width / 2;
        let quiz1CenterY = quiz1Canvas.height / 2;

        // 初始化时钟
        function initClock() {
            // 设置主canvas实际尺寸
            const dpr = window.devicePixelRatio || 1;
            canvas.style.width = canvas.width + 'px';
            canvas.style.height = canvas.height + 'px';
            canvas.width = canvas.width * dpr;
            canvas.height = canvas.height * dpr;
            ctx.setTransform(1,0,0,1,0,0);
            ctx.scale(dpr, dpr);
            radius = canvas.width / (2 * dpr);
            centerX = canvas.width / (2 * dpr);
            centerY = canvas.height / (2 * dpr);
            // 设置quiz1 canvas实际尺寸
            quiz1Canvas.style.width = quiz1Canvas.width + 'px';
            quiz1Canvas.style.height = quiz1Canvas.height + 'px';
            quiz1Canvas.width = quiz1Canvas.width * dpr;
            quiz1Canvas.height = quiz1Canvas.height * dpr;
            quiz1Ctx.setTransform(1,0,0,1,0,0);
            quiz1Ctx.scale(dpr, dpr);
            quiz1Radius = quiz1Canvas.width / (2 * dpr);
            quiz1CenterX = quiz1Canvas.width / (2 * dpr);
            quiz1CenterY = quiz1Canvas.height / (2 * dpr);

            // 设置事件监听
            canvas.addEventListener('mousedown', handleDragStart);
            canvas.addEventListener('mousemove', handleDragging);
            canvas.addEventListener('mouseup', handleDragEnd);
            canvas.addEventListener('touchstart', handleDragStart);
            canvas.addEventListener('touchmove', handleDragging);
            canvas.addEventListener('touchend', handleDragEnd);

            submitBtn.addEventListener('click', handleSubmit);
            setCustomTimeBtn.addEventListener('click', setCustomTime);

            // 模式切换
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentMode = button.dataset.mode;
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    // 切换main-content的布局类
                    const mainContent = document.querySelector('.main-content');
                    if (currentMode === 'quiz1') {
                        mainContent.classList.add('quiz1-layout');
                        canvas.style.display = 'none';
                        quiz1Canvas.style.display = 'block';
                    } else {
                        mainContent.classList.remove('quiz1-layout');
                        canvas.style.display = 'block';
                        quiz1Canvas.style.display = 'none';
                    }
                    resetQuiz();
                });
            });

            // 页面初始显示
            if(currentMode === 'quiz1'){
                canvas.style.display = 'none';
                quiz1Canvas.style.display = 'block';
            }else{
                canvas.style.display = 'block';
                quiz1Canvas.style.display = 'none';
            }

            // 开始时钟动画
            updateClock();
        }

        // 绘制时钟
        function drawClock(hours, minutes) {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制表盘
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.9, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#4a90e2';
            ctx.stroke();

            // 绘制刻度
            ctx.lineWidth = 2;
            for (let i = 0; i < 60; i++) {
                const angle = (i * 6) * Math.PI / 180;
                const startX = centerX + Math.sin(angle) * (radius * 0.8);
                const startY = centerY - Math.cos(angle) * (radius * 0.8);
                let endX, endY;

                if (i % 5 === 0) {
                    // 小时刻度
                    endX = centerX + Math.sin(angle) * (radius * 0.7);
                    endY = centerY - Math.cos(angle) * (radius * 0.7);
                    ctx.lineWidth = 4;

                    // 绘制小时数字
                    const hourNum = i / 5 || 12;
                    const textX = centerX + Math.sin(angle) * (radius * 0.6) - 5;
                    const textY = centerY - Math.cos(angle) * (radius * 0.6) + 5;
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#333';
                    ctx.fillText(hourNum, textX, textY);
                } else {
                    // 分钟刻度
                    endX = centerX + Math.sin(angle) * (radius * 0.75);
                    endY = centerY - Math.cos(angle) * (radius * 0.75);
                    ctx.lineWidth = 2;
                }

                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }

            // 计算指针角度
            const hourAngle = (hours % 12) * 30 + minutes * 0.5;
            const minuteAngle = minutes * 6;

            // 绘制时针（如果正在拖动则高亮显示）
            drawHand(hourAngle, radius * 0.5, 6, draggedHand === 'hour' ? '#FF6B6B' : '#333');

            // 绘制分针（如果正在拖动则高亮显示）
            drawHand(minuteAngle, radius * 0.7, 4, draggedHand === 'minute' ? '#FF6B6B' : '#333');

            // 绘制中心点
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#4a90e2';
            ctx.fill();
        }

        // 绘制指针
        function drawHand(angle, length, width, color) {
            const radian = (angle - 90) * Math.PI / 180;
            const endX = centerX + Math.cos(radian) * length;
            const endY = centerY + Math.sin(radian) * length;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(endX, endY);
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.strokeStyle = color;
            ctx.stroke();
        }

        // 新增 quiz1 绘制函数
        function drawQuiz1Clock(hours, minutes) {
            quiz1Ctx.clearRect(0, 0, quiz1Canvas.width, quiz1Canvas.height);
            // 复用主时钟绘制逻辑，但用 quiz1 的 ctx 和参数
            // 绘制表盘
            quiz1Ctx.beginPath();
            quiz1Ctx.arc(quiz1CenterX, quiz1CenterY, quiz1Radius * 0.9, 0, 2 * Math.PI);
            quiz1Ctx.fillStyle = 'white';
            quiz1Ctx.fill();
            quiz1Ctx.lineWidth = 4;
            quiz1Ctx.strokeStyle = '#4a90e2';
            quiz1Ctx.stroke();
            // 绘制刻度
            quiz1Ctx.lineWidth = 2;
            for (let i = 0; i < 60; i++) {
                const angle = (i * 6) * Math.PI / 180;
                const startX = quiz1CenterX + Math.sin(angle) * (quiz1Radius * 0.8);
                const startY = quiz1CenterY - Math.cos(angle) * (quiz1Radius * 0.8);
                let endX, endY;
                if (i % 5 === 0) {
                    endX = quiz1CenterX + Math.sin(angle) * (quiz1Radius * 0.7);
                    endY = quiz1CenterY - Math.cos(angle) * (quiz1Radius * 0.7);
                    quiz1Ctx.lineWidth = 4;
                    const hourNum = i / 5 || 12;
                    const textX = quiz1CenterX + Math.sin(angle) * (quiz1Radius * 0.6) - 5;
                    const textY = quiz1CenterY - Math.cos(angle) * (quiz1Radius * 0.6) + 5;
                    quiz1Ctx.font = '16px Arial';
                    quiz1Ctx.fillStyle = '#333';
                    quiz1Ctx.fillText(hourNum, textX, textY);
                } else {
                    endX = quiz1CenterX + Math.sin(angle) * (quiz1Radius * 0.75);
                    endY = quiz1CenterY - Math.cos(angle) * (quiz1Radius * 0.75);
                    quiz1Ctx.lineWidth = 2;
                }
                quiz1Ctx.beginPath();
                quiz1Ctx.moveTo(startX, startY);
                quiz1Ctx.lineTo(endX, endY);
                quiz1Ctx.stroke();
            }
            // 指针
            const hourAngle = (hours % 12) * 30 + minutes * 0.5;
            const minuteAngle = minutes * 6;
            drawQuiz1Hand(hourAngle, quiz1Radius * 0.5, 6, '#333');
            drawQuiz1Hand(minuteAngle, quiz1Radius * 0.7, 4, '#333');
            // 中心点
            quiz1Ctx.beginPath();
            quiz1Ctx.arc(quiz1CenterX, quiz1CenterY, 5, 0, 2 * Math.PI);
            quiz1Ctx.fillStyle = '#4a90e2';
            quiz1Ctx.fill();
        }
        function drawQuiz1Hand(angle, length, width, color) {
            const radian = (angle - 90) * Math.PI / 180;
            const endX = quiz1CenterX + Math.cos(radian) * length;
            const endY = quiz1CenterY + Math.sin(radian) * length;
            quiz1Ctx.beginPath();
            quiz1Ctx.moveTo(quiz1CenterX, quiz1CenterY);
            quiz1Ctx.lineTo(endX, endY);
            quiz1Ctx.lineWidth = width;
            quiz1Ctx.lineCap = 'round';
            quiz1Ctx.strokeStyle = color;
            quiz1Ctx.stroke();
        }

        // 修改updateClock，支持quiz1独立canvas
        function updateClock() {
            let hours, minutes;
            if (currentMode === 'display') {
                hours = displayHours;
                minutes = displayMinutes;
                drawClock(hours, minutes);
            } else if (currentMode === 'quiz1') {
                hours = targetHours;
                minutes = targetMinutes;
                drawQuiz1Clock(hours, minutes);
            } else if (currentMode === 'quiz2') {
                hours = targetHours;
                minutes = targetMinutes;
                drawClock(hours, minutes);
            }
            requestAnimationFrame(updateClock);
        }

        // 格式化时间显示
        function formatTime(hours, minutes) {
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // 开始拖拽
        function handleDragStart(e) {
            if (currentMode !== 'quiz2') return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;

            // 计算当前时针和分针端点
            let hours, minutes;
            if (currentMode === 'display') {
                hours = displayHours;
                minutes = displayMinutes;
            } else {
                hours = targetHours;
                minutes = targetMinutes;
            }
            const hourAngle = ((hours % 12) * 30 + minutes * 0.5) * Math.PI / 180;
            const minuteAngle = (minutes * 6) * Math.PI / 180;
            const hourLen = radius * 0.5;
            const minLen = radius * 0.7;
            const hourEnd = {
                x: centerX + Math.cos(hourAngle - Math.PI / 2) * hourLen,
                y: centerY + Math.sin(hourAngle - Math.PI / 2) * hourLen
            };
            const minEnd = {
                x: centerX + Math.cos(minuteAngle - Math.PI / 2) * minLen,
                y: centerY + Math.sin(minuteAngle - Math.PI / 2) * minLen
            };

            // 计算到两根指针的"垂直距离"
            function pointToLine(px, py, x1, y1, x2, y2) {
                // 点到线段的最短距离
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                const dot = A * C + B * D;
                const len_sq = C * C + D * D;
                let param = -1;
                if (len_sq !== 0) param = dot / len_sq;
                let xx, yy;
                if (param < 0) {
                    xx = x1; yy = y1;
                } else if (param > 1) {
                    xx = x2; yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy);
            }
            const hourDist = pointToLine(x, y, centerX, centerY, hourEnd.x, hourEnd.y);
            const minDist = pointToLine(x, y, centerX, centerY, minEnd.x, minEnd.y);

            // 优先判定分针（分针更长更容易点到）
            if (minDist < 18) {
                isDragging = true;
                draggedHand = 'minute';
                showHandHint('正在调整分针');
            } else if (hourDist < 18) {
                isDragging = true;
                draggedHand = 'hour';
                showHandHint('正在调整时针');
            }

            // 立即更新一次位置
            handleDragging(e);
        }

        // 显示指针提示
        function showHandHint(text) {
            handHint.textContent = text;
            handHint.style.opacity = 1;

            if (hintTimeout) clearTimeout(hintTimeout);
            hintTimeout = setTimeout(() => {
                handHint.style.opacity = 0;
            }, 1000);
        }

        // 拖拽中
        function handleDragging(e) {
            if (!isDragging) return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;

            // 计算角度
            let angle = Math.atan2(y - centerY, x - centerX) * 180 / Math.PI;
            angle = (angle + 90 + 360) % 360; // 调整为0°在顶部

            if (currentMode === 'display') {
                if (draggedHand === 'hour') {
                    // 计算小时和分钟，联动分针
                    const hour = angle / 30;
                    displayHours = Math.floor(hour) % 12;
                    displayMinutes = Math.round((hour - Math.floor(hour)) * 60);
                } else if (draggedHand === 'minute') {
                    // 计算分钟，联动时针
                    const min = angle / 6;
                    let prevMin = displayMinutes;
                    let prevHour = displayHours;
                    let newMin = Math.round(min) % 60;
                    // 判断是否跨越0点
                    let hourDelta = 0;
                    if (prevMin === 59 && newMin === 0) {
                        hourDelta = 1;
                    } else if (prevMin === 0 && newMin === 59) {
                        hourDelta = -1;
                    }
                    displayMinutes = newMin;
                    displayHours = (displayHours + hourDelta + 12) % 12;
                }
            } else if (currentMode === 'quiz2') {
                if (draggedHand === 'hour') {
                    // 计算小时和分钟，联动分针
                    const hour = angle / 30;
                    targetHours = Math.floor(hour) % 12;
                    targetMinutes = Math.round((hour - Math.floor(hour)) * 60);
                } else if (draggedHand === 'minute') {
                    // 计算分钟，联动时针
                    const min = angle / 6;
                    let prevMin = targetMinutes;
                    let prevHour = targetHours;
                    let newMin = Math.round(min) % 60;
                    // 判断是否跨越0点
                    let hourDelta = 0;
                    if (prevMin === 59 && newMin === 0) {
                        hourDelta = 1;
                    } else if (prevMin === 0 && newMin === 59) {
                        hourDelta = -1;
                    }
                    targetMinutes = newMin;
                    targetHours = (targetHours + hourDelta + 12) % 12;
                }
            }
        }

        // 结束拖拽
        function handleDragEnd() {
            isDragging = false;
            draggedHand = null;
        }

        // 设置自定义时间
        function setCustomTime() {
            let hours = parseInt(customHourInput.value) || 0;
            let minutes = parseInt(customMinuteInput.value) || 0;

            // 验证输入范围
            hours = Math.max(0, Math.min(23, hours));
            minutes = Math.max(0, Math.min(59, minutes));

            displayHours = hours;
            displayMinutes = minutes;

            customHourInput.value = hours;
            customMinuteInput.value = minutes.toString().padStart(2, '0');
        }

        // 分钟输入框输入时自动补0，且只允许两位数字
        function padMinuteInput() {
            let v = customMinuteInput.value.replace(/\D/g, '');
            if (v.length === 1) v = '0' + v;
            if (v.length > 2) v = v.slice(-2);
            customMinuteInput.value = v;
        }
        customMinuteInput.addEventListener('input', padMinuteInput);
        // 初始化时也补0
        window.addEventListener('DOMContentLoaded', function() {
            padMinuteInput();
        });

        // 生成随机时间
        function generateRandomTime() {
            let hours, minutes;
            if (currentMode === 'quiz2') {
                hours = Math.floor(Math.random() * 24);
            } else {
                hours = Math.floor(Math.random() * 12);
            }
            minutes = Math.floor(Math.random() * 12) * 5; // 以5分钟为间隔
            return { hours, minutes, formatted: formatTime(hours, minutes) };
        }

        // 生成不同于目标时间的初始时间
        function generateDifferentTime(targetHours, targetMinutes) {
            let hours, minutes;
            do {
                const randomTime = generateRandomTime();
                hours = randomTime.hours;
                minutes = randomTime.minutes;
            } while (hours === targetHours && minutes === targetMinutes);

            return { hours, minutes };
        }

        // 重置测验
        function resetQuiz() {
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
            quiz2Tries = 0;
            quiz1Tries = 0;
            if (quiz2ShowAnswerBtn) quiz2ShowAnswerBtn.style.display = 'none';
            if (quiz1ShowAnswerBtn) quiz1ShowAnswerBtn.style.display = 'none';
            if (nextQuizBtn) nextQuizBtn.style.display = 'none';
            if (hourInput) hourInput.value = '';
            if (minuteInput) minuteInput.value = '';

            // 显示/隐藏相关控件
            customTimeControls.style.display = currentMode === 'display' ? 'block' : 'none';
            document.getElementById('quiz1-controls').style.display = currentMode === 'quiz1' ? 'flex' : 'none';
            targetTimeDisplay.style.display = currentMode === 'quiz2' ? 'block' : 'none';
            // quiz1按钮竖直列
            document.querySelector('.quiz1-btn-col').style.display = currentMode === 'quiz1' ? 'flex' : 'none';
            // quiz2按钮竖直列
            document.querySelector('.quiz2-btn-col').style.display = currentMode === 'quiz2' ? 'flex' : 'none';
            submitBtn.style.display = currentMode === 'quiz1' ? 'block' : 'none';
            quiz2SubmitBtn.style.display = currentMode === 'quiz2' ? 'block' : 'none';
            hourInput.style.display = currentMode === 'quiz1' ? 'block' : 'none';
            minuteInput.style.display = currentMode === 'quiz1' ? 'block' : 'none';
            quiz1NextBtn.style.display = 'none';

            if (currentMode === 'quiz1') {
                // 数一数模式：生成随机时钟
                const randomTime = generateRandomTime();
                targetHours = randomTime.hours;
                targetMinutes = randomTime.minutes;
                targetTime = randomTime.formatted;
                hourInput.value = '';
                minuteInput.value = '';
                hourInput.focus();
                quiz2SubmitBtn.style.display = 'none';
                hourInput.style.display = 'block';
                minuteInput.style.display = 'block';
                quiz1NextBtn.style.display = 'inline-block';
                if (quiz1ShowAnswerBtn) quiz1ShowAnswerBtn.style.display = 'none';
            } else if (currentMode === 'quiz2') {
                // 拨一拨模式：生成随机目标时间，初始化时钟不匹配
                const randomTarget = generateRandomTime();
                targetTime = randomTarget.formatted;
                targetTimeDisplay.textContent = `目标时间: ${targetTime}`;
                // 生成不同于目标时间的初始时间
                const initialTime = generateDifferentTime(randomTarget.hours, randomTarget.minutes);
                targetHours = initialTime.hours;
                targetMinutes = initialTime.minutes;
                // 拨一拨模式下输入框隐藏
                hourInput.style.display = 'none';
                minuteInput.style.display = 'none';
                quiz2SubmitBtn.style.display = 'block';
            } else {
                // 展示模式下输入框和提交按钮隐藏
                hourInput.style.display = 'none';
                minuteInput.style.display = 'none';
                submitBtn.style.display = 'none';
                quiz2SubmitBtn.style.display = 'none';
            }
        }

        // 处理提交答案
        function handleSubmit() {
            if (currentMode === 'quiz1') {
                // 数一数模式：验证输入的时间
                let h = parseInt(hourInput.value, 10);
                let m = parseInt(minuteInput.value, 10);
                if (isNaN(h) || isNaN(m) || h > 23 || m > 59) {
                    showFeedback('请输入有效的时间', false);
                    return;
                }
                const userTime = formatTime(h, m);
                // 允许12小时制和24小时制互认
                const [targetH, targetM] = targetTime.split(':').map(Number);
                let altH = (targetH + 12) % 24;
                let altTargetTime = formatTime(altH, targetM);
                if (userTime === targetTime || userTime === altTargetTime) {
                    score += 10;
                    showFeedback('✅ 回答正确！', true);
                    scoreDisplay.textContent = score;
                    quiz1NextBtn.style.display = 'inline-block';
                    quiz1Tries = 0;
                } else {
                    quiz1Tries++;
                    score = Math.max(0, score - 5);
                    if (quiz1Tries < 3) {
                        showFeedback(`❌ 答案错误，还有${3-quiz1Tries}次机会可以查看答案`, false);
                    } else {
                        showFeedback('❌ 答案错误，现在可以查看正确答案了', false);
                        createQuiz1ShowAnswerBtn(targetH, targetM);
                    }
                    scoreDisplay.textContent = score;
                    quiz1NextBtn.style.display = 'inline-block';
                }
            } else if (currentMode === 'quiz2') {
                // 拨一拨模式：验证指针位置
                const [targetH, targetM] = targetTime.split(':').map(Number);
                const targetHourAngle = (targetH % 12) * 30 + targetM * 0.5;
                const targetMinuteAngle = targetM * 6;
                const currentHourAngle = (targetHours % 12) * 30 + targetMinutes * 0.5;
                const currentMinuteAngle = targetMinutes * 6;
                const hourDiff = Math.abs(targetHourAngle - currentHourAngle);
                const minuteDiff = Math.abs(targetMinuteAngle - currentMinuteAngle);
                // 允许2度的误差
                if (hourDiff <= 2 && minuteDiff <= 2) {
                    score += 10;
                    showFeedback('✅ 时间正确！', true);
                    scoreDisplay.textContent = score;
                    quiz2NextBtn.style.display = 'inline-block';
                } else {
                    quiz2Tries++;
                    score = Math.max(0, score - 5);
                    if (quiz2Tries < 3) {
                        showFeedback(`❌ 请再调整指针位置（剩余${3-quiz2Tries}次机会）`, false);
                    } else {
                        showFeedback('❌ 答案错误，现在可以查看正确答案了', false);
                    }
                    scoreDisplay.textContent = score;
                    if (quiz2Tries >= 3) {
                        createShowAnswerBtn();
                    }
                }
            }
        }

        // 显示反馈信息
        function showFeedback(message, isSuccess) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = isSuccess ? 'success' : 'error';
        }

        // 拨一拨模式提交按钮事件
        quiz2SubmitBtn.addEventListener('click', function() {
            if (currentMode === 'quiz2') {
                handleSubmit();
            }
        });

        // 数一数模式下展示正确答案按钮
        function createQuiz1ShowAnswerBtn(targetH, targetM) {
            if (!quiz1ShowAnswerBtn) {
                quiz1ShowAnswerBtn = document.createElement('button');
                quiz1ShowAnswerBtn.textContent = '查看正确答案';
                quiz1ShowAnswerBtn.className = 'quiz2-submit-btn';
                quiz1ShowAnswerBtn.style.background = '#77DD77';
                quiz1ShowAnswerBtn.style.color = '#fff';
                quiz1ShowAnswerBtn.onclick = function() {
                    hourInput.value = targetH.toString().padStart(2, '0');
                    minuteInput.value = targetM.toString().padStart(2, '0');
                    showFeedback('已自动填入正确答案', true);
                };
                document.querySelector('.quiz1-btn-row').appendChild(quiz1ShowAnswerBtn);
            }
            quiz1ShowAnswerBtn.style.display = 'inline-block';
        }

        // 拨一拨模式下展示正确答案按钮（不覆盖下一题）
        function createShowAnswerBtn() {
            if (!quiz2ShowAnswerBtn) {
                quiz2ShowAnswerBtn = document.createElement('button');
                quiz2ShowAnswerBtn.textContent = '查看答案';
                quiz2ShowAnswerBtn.className = 'quiz2-submit-btn';
                quiz2ShowAnswerBtn.style.background = '#77DD77';
                quiz2ShowAnswerBtn.style.color = '#fff';
                quiz2ShowAnswerBtn.onclick = function() {
                    showCorrectClock();
                    this.style.display = 'inline-block';
                };
                document.querySelector('.quiz2-btn-row').appendChild(quiz2ShowAnswerBtn);
            }
            quiz2ShowAnswerBtn.style.display = 'inline-block';
        }

        function showCorrectClock() {
            // 将当前拨一拨的指针设置为目标时间
            const [targetH, targetM] = targetTime.split(':').map(Number);
            targetHours = targetH;
            targetMinutes = targetM;
            showFeedback('请观察正确答案的时钟', true);
        }

        // 输入框聚焦切换
        hourInput.addEventListener('click', function() { activeInput = hourInput; hourInput.classList.add('active'); minuteInput.classList.remove('active'); });
        minuteInput.addEventListener('click', function() { activeInput = minuteInput; minuteInput.classList.add('active'); hourInput.classList.remove('active'); });
        // 默认高亮小时
        hourInput.classList.add('active');

        // 数字键盘输入逻辑
        if (numPad) {
            numPad.addEventListener('click', function(e) {
                if (e.target.classList.contains('num-btn')) {
                    if (activeInput.value.length < 2) {
                        activeInput.value += e.target.textContent;
                    }
                } else if (e.target.classList.contains('del-btn')) {
                    activeInput.value = activeInput.value.slice(0, -1);
                }
            });
        }
        hourInput.addEventListener('keydown', function(e) { e.preventDefault(); });
        minuteInput.addEventListener('keydown', function(e) { e.preventDefault(); });

        // 初始化应用
        window.onload = function() {
            initClock();
            // 页面初始时根据模式设置布局
            const mainContent = document.querySelector('.main-content');
            if (currentMode === 'quiz1') {
                mainContent.classList.add('quiz1-layout');
            } else {
                mainContent.classList.remove('quiz1-layout');
            }
            resetQuiz();
        };

        const quiz1NextBtn = document.getElementById('quiz1-next-btn');
        const quiz1ResetBtn = document.getElementById('quiz1-reset-btn');
        const quiz2BtnRow = document.querySelector('.quiz2-btn-row');
        const quiz2NextBtn = document.getElementById('quiz2-next-btn');

        // quiz1按钮事件
        quiz1NextBtn.addEventListener('click', resetQuiz);
        quiz1ResetBtn.addEventListener('click', function() {
            hourInput.value = '';
            minuteInput.value = '';
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
            hourInput.focus();
        });
        // quiz2按钮事件
        quiz2NextBtn.addEventListener('click', resetQuiz);

        // 去除数一数输入框里的placeholder
        hourInput.placeholder = '';
        minuteInput.placeholder = '';
    </script>
</body>
</html>