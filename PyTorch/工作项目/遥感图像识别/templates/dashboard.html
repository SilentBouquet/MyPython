<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>功能主页 - 遥感图像识别系统</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">
  <style>
    :root {
      /* 颜色变量 */
      --color-primary: #2A5CAA;
      --color-primary-light: rgba(42, 92, 170, 0.1);
      --color-primary-dark: #1a4785;
      --color-secondary: #FF6B35;
      --color-success: #00C49A;
      --color-warning: #FFD166;
      --color-danger: #F25F5C;
      --color-dark: #1A1A1A;
      --color-gray-dark: #343a40;
      --color-gray: #6c757d;
      --color-gray-light: #ced4da;
      --color-white: #fff;
      --color-bg: #f8f9fa;
      --color-bg-dark: #f1f3f5;
      --color-border: #dee2e6;

      /* 尺寸变量 */
      --border-radius: 6px;
      --sidebar-width: 240px;
      --header-height: 60px;
      --font-size-base: 14px;
      --font-size-sm: 12px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-xxl: 24px;

      /* 阴影变量 */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);

      /* 过渡变量 */
      --transition-base: all 0.3s ease;
    }

    /* 新增：批量上传样式 */
    .upload-mode-switch {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-switch {
      background-color: var(--color-bg-dark);
      color: var(--color-gray-dark);
      border: none;
      padding: 5px 15px;
      border-radius: var(--border-radius);
      transition: var(--transition-base);
    }

    .btn-switch.active {
      background-color: var(--color-primary);
      color: var(--color-white);
    }

    .batch-images-grid, .batch-videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .batch-item, .batch-image-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      height: 150px;
    }

    .batch-item img, .batch-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-item .delete-batch-item {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }

    .batch-item .item-overlay, .batch-image-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .batch-process-status {
      margin: 20px 0;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 15px;
    }

    .batch-progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .batch-progress-item:last-child {
      border-bottom: none;
    }

    .batch-progress-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 10px;
    }

    .batch-progress-status {
      width: 100px;
      text-align: center;
    }

    .status-waiting {
      color: var(--color-gray);
    }

    .status-processing {
      color: var(--color-primary);
    }

    .status-completed {
      color: var(--color-success);
    }

    .status-failed {
      color: var(--color-danger);
    }

    /* 批量结果样式 */
    .batch-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 10px;
    }

    .batch-result-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
      height: 220px;
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .batch-result-image {
      height: 140px;
      overflow: hidden;
    }

    .batch-result-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-result-info {
      padding: 10px;
      background-color: var(--color-white);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .batch-result-filename {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 5px;
    }

    .batch-result-stats {
      display: flex;
      flex-direction: column;
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .batch-result-actions {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
      padding-top: 5px;
    }

    /* 批量视频结果样式 */
    .batch-video-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 10px;
    }

    .batch-video-result-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
      height: 240px;
    }

    .batch-video-result-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .batch-result-card {
      padding: 15px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .batch-result-card.error {
      background-color: rgba(255, 0, 0, 0.05);
    }

    .batch-result-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }

    .batch-result-status i {
      font-size: 24px;
      color: var(--color-danger);
      margin-bottom: 5px;
    }

    .batch-result-message {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-top: 10px;
    }

    /* 基础重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      font-size: var(--font-size-base);
      color: var(--color-dark);
      background-color: var(--color-bg);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    ul {
      list-style: none;
    }

    /* 布局组件 */
    .dashboard {
      display: flex;
      width: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--color-white);
      border-right: 1px solid var(--color-border);
      position: fixed;
      height: 100vh;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
      transition: var(--transition-base);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--color-border);
    }

    .logo {
      font-size: var(--font-size-xl);
      font-weight: bold;
      color: var(--color-primary);
      display: flex;
      align-items: center;
    }

    .logo i {
      margin-right: 10px;
      font-size: 24px;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-title {
      font-size: var(--font-size-sm);
      font-weight: bold;
      color: var(--color-gray);
      padding: 10px 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--color-gray-dark);
      transition: var(--transition-base);
      cursor: pointer;
    }

    .menu-item i {
      margin-right: 10px;
      font-size: 18px;
    }

    .menu-item.active {
      color: var(--color-primary);
      background-color: var(--color-primary-light);
      border-left: 3px solid var(--color-primary);
    }

    .menu-item:hover:not(.active) {
      background-color: var(--color-bg);
    }

    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      width: calc(100% - var(--sidebar-width));
      min-height: 100vh;
      transition: var(--transition-base);
    }

    .header {
      height: var(--header-height);
      background-color: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      position: sticky;
      top: 0;
      z-index: 99;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background-color: var(--color-bg);
      border-radius: var(--border-radius);
      padding: 8px 15px;
      width: 300px;
    }

    .search-bar input {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      margin-left: 10px;
      font-size: var(--font-size-base);
      color: var(--color-dark);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .header-icon {
      font-size: 20px;
      color: var(--color-gray-dark);
      position: relative;
      margin-left: 20px;
      cursor: pointer;
    }

    .header-icon .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--color-danger);
      color: var(--color-white);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-dropdown {
      margin-left: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--color-primary-light);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
    }

    .dropdown-toggle i {
      margin-left: 5px;
      font-size: var(--font-size-base);
      color: var(--color-gray);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      width: 180px;
      z-index: 100;
      overflow: hidden;
      display: none;
    }

    .dropdown-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      transition: var(--transition-base);
    }

    .dropdown-item i {
      margin-right: 10px;
      font-size: 16px;
    }

    .dropdown-item:hover {
      background-color: var(--color-bg);
    }

    .dropdown-divider {
      height: 1px;
      background-color: var(--color-border);
      margin: 5px 0;
    }

    .page-content {
      padding: 30px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: var(--font-size-xl);
      font-weight: bold;
      color: var(--color-dark);
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: var(--transition-base);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-header {
      padding: 15px;
      border-bottom: 1px solid var(--color-border);
      font-weight: bold;
      color: var(--color-gray-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header i {
      color: var(--color-gray);
      font-size: 18px;
    }

    .card-body {
      padding: 15px;
    }

    .statistic {
      text-align: center;
    }

    .statistic h2 {
      font-size: var(--font-size-xxl);
      color: var(--color-primary);
      margin-bottom: 10px;
    }

    .progress {
      height: 6px;
      background-color: var(--color-bg-dark);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--color-primary);
    }

    .statistic span {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .percentage {
      color: var(--color-success);
      font-size: var(--font-size-sm);
      display: flex;
      align-items: center;
    }

    .percentage i {
      font-size: 16px;
      margin-right: 2px;
    }

    .table-container {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .table th {
      background-color: var(--color-bg);
      color: var(--color-gray-dark);
      font-weight: bold;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .table tr:hover td {
      background-color: var(--color-bg);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      margin-right: 5px;
    }

    .tag-success {
      background-color: rgba(0, 196, 154, 0.1);
      color: var(--color-success);
    }

    .tag-warning {
      background-color: rgba(255, 209, 102, 0.1);
      color: var(--color-warning);
    }

    .tag-danger {
      background-color: rgba(242, 95, 92, 0.1);
      color: var(--color-danger);
    }

    .tag-info {
      background-color: rgba(42, 92, 170, 0.1);
      color: var(--color-primary);
    }

    .action-btn {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
      font-size: 16px;
      margin-left: 8px;
    }

    .action-btn:hover {
      color: var(--color-primary);
    }

    .models-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 30px;
      min-height: 400px;
    }

    .model-card {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
      width: 100%;
      height: 300px;
    }

    .model-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .model-image {
      height: 160px;
      background-color: var(--color-bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .model-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .model-content {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .model-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: var(--font-size-lg);
    }

    .model-description {
      color: var(--color-gray);
      font-size: var(--font-size-sm);
      margin-bottom: 10px;
      flex: 1;
    }

    .model-metadata {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-bottom: 10px;
    }

    .model-actions {
      display: flex;
      flex-direction: row;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
    }

    .model-actions .btn,
    .model-actions .action-btn {
      white-space: nowrap;
      flex: 0 0 auto;
      min-width: 0;
      margin: 0;
    }

    .model-actions .action-btn.favorite {
      flex: 0 0 36px;
      padding: 0 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      transition: var(--transition-base);
      cursor: pointer;
      border: none;
      outline: none;
      font-size: var(--font-size-base);
    }

    .btn i {
      margin-right: 5px;
      font-size: 18px;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-white);
    }

    .btn-primary:hover {
      background-color: var(--color-primary-dark);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--color-border);
    }

    .btn-outline:hover {
      background-color: var(--color-bg);
    }

    .btn-success {
      background-color: var(--color-success);
      color: var(--color-white);
    }

    .btn-success:hover {
      background-color: #00b38b;
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: var(--color-white);
    }

    .btn-danger:hover {
      background-color: #e3574f;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: var(--font-size-sm);
    }

    .tab-container {
      margin-bottom: 30px;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .tab-link {
      padding: 10px 20px;
      margin-right: 10px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-base);
      white-space: nowrap;
    }

    .tab-link.active {
      color: var(--color-primary);
      border-color: var(--color-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .upload-container {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 30px;
      margin-bottom: 30px;
    }

    .upload-dropzone {
      border: 2px dashed var(--color-border);
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      transition: var(--transition-base);
    }

    .upload-icon {
      font-size: 48px;
      color: var(--color-gray);
      margin-bottom: 20px;
    }

    .upload-text h3 {
      font-size: var(--font-size-lg);
      margin-bottom: 10px;
    }

    .upload-text p {
      color: var(--color-gray);
      margin-bottom: 20px;
    }

    .file-input {
      position: absolute;
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      z-index: -1;
    }

    .upload-preview {
      margin-top: 20px;
    }

    .upload-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--border-radius);
      display: block;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--color-gray-dark);
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      transition: var(--transition-base);
      outline: none;
    }

    .form-control:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    .select-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
    }

    .form-text {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-top: 5px;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .modal {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: var(--font-size-lg);
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
    }

    .close-modal:hover {
      color: var(--color-danger);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 15px;
      border-bottom: 1px solid var(--color-border);
      transition: var(--transition-base);
      display: flex;
      align-items: flex-start;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background-color: var(--color-bg);
    }

    .notification-icon {
      margin-right: 15px;
      font-size: 20px;
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0; /* 确保内容可以正确换行 */
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .notification-title {
      font-weight: 500;
    }

    .notification-time {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-left: 10px;
    }

    .notification-text {
      color: var(--color-gray);
      margin-top: 5px;
    }

    .notification-actions {
      display: flex;
      margin-left: 15px;
      flex-shrink: 0;
      align-self: center;
    }

    .action-btn {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
      font-size: 16px;
      padding: 5px;
      margin-left: 5px;
    }

    .action-btn:hover {
      color: var(--color-primary);
    }

    .action-btn.delete-notification-btn:hover {
      color: var(--color-danger);
    }

    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--color-primary-light);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spinner 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--color-gray);
    }
    .empty-state.model-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      grid-column: 1/-1;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .empty-state h3 {
      font-size: var(--font-size-lg);
      margin-bottom: 10px;
      color: var(--color-gray-dark);
    }

    .steps-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: var(--color-border);
      z-index: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--color-white);
      border: 2px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      position: relative;
      z-index: 2;
    }

    .step.active .step-icon {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .step.completed .step-icon {
      background-color: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-white);
    }

    .step-label {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .step.active .step-label {
      color: var(--color-primary);
      font-weight: 500;
    }

    .step.completed .step-label {
      color: var(--color-success);
    }

    /* 响应式设计 */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
        padding: 20px 0;
      }

      .logo span, .menu-item span, .menu-title {
        display: none;
      }

      .menu-item {
        justify-content: center;
        padding: 15px 0;
      }

      .menu-item i {
        margin-right: 0;
        font-size: 20px;
      }

      .main-content {
        margin-left: 70px;
        width: calc(100% - 70px);
      }

      .cards-container, .models-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .cards-container, .models-grid {
        grid-template-columns: 1fr;
      }

      .search-bar {
        width: 200px;
      }

      .header {
        padding: 0 15px;
      }

      .page-content {
        padding: 20px 15px;
      }

      .upload-dropzone {
        padding: 20px;
      }
    }

    @media (max-width: 576px) {
      .sidebar {
        position: fixed;
        left: -70px;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }

      .search-bar {
        display: none;
      }

      .user-dropdown .username {
        display: none;
      }
    }

    /* 工具类 */
    .mb-0 { margin-bottom: 0 !important; }
    .mb-10 { margin-bottom: 10px !important; }
    .mb-20 { margin-bottom: 20px !important; }
    .mt-0 { margin-top: 0 !important; }
    .mt-10 { margin-top: 10px !important; }
    .mt-20 { margin-top: 20px !important; }
    .ml-auto { margin-left: auto !important; }
    .mr-auto { margin-right: auto !important; }
    .text-primary { color: var(--color-primary) !important; }
    .text-success { color: var(--color-success) !important; }
    .text-warning { color: var(--color-warning) !important; }
    .text-danger { color: var(--color-danger) !important; }
    .text-center { text-align: center !important; }
    .text-right { text-align: right !important; }
    .fw-bold { font-weight: bold !important; }
    .d-flex { display: flex !important; }
    .d-none { display: none !important; }
    .justify-between { justify-content: space-between !important; }
    .align-center { align-items: center !important; }
    .w-100 { width: 100% !important; }

    /* Toast 提示样式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      background-color: var(--color-gray-dark);
      color: var(--color-white);
      box-shadow: var(--shadow-md);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-info {
      background-color: var(--color-primary);
    }

    .toast-success {
      background-color: var(--color-success);
    }

    .toast-warning {
      background-color: var(--color-warning);
      color: var(--color-dark);
    }

    .toast-error {
      background-color: var(--color-danger);
    }

    /* 添加收藏按钮的加载状态样式 */
    .action-btn.loading {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }

    .action-btn.loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      margin: -6px 0 0 -6px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .model-container.active {
      display: grid;
    }

    /* 视频信息样式 */
    .video-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .video-info-item {
      display: flex;
      align-items: center;
    }

    .info-label {
      font-weight: 600;
      margin-right: 8px;
      color: #666;
      min-width: 70px;
    }

    .info-value {
      color: #333;
    }

    .video-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }

    .notification-text {
      color: var(--color-gray);
      margin-top: 5px;
    }

    .notification-item.unread {
      background-color: rgba(42, 92, 170, 0.05);
    }

    .notification-item.unread .notification-title {
      font-weight: bold;
    }

    .notification-actions {
      display: flex;
      margin-left: 15px;
      flex-shrink: 0;
      align-self: center;
    }

    :root {
      /* 颜色变量 */
      --color-primary: #2A5CAA;
      --color-primary-light: rgba(42, 92, 170, 0.1);
      --color-primary-dark: #1a4785;
      --color-secondary: #FF6B35;
      --color-success: #00C49A;
      --color-warning: #FFD166;
      --color-danger: #F25F5C;
      --color-dark: #1A1A1A;
      --color-gray-dark: #343a40;
      --color-gray: #6c757d;
      --color-gray-light: #ced4da;
      --color-white: #fff;
      --color-bg: #f8f9fa;
      --color-bg-dark: #f1f3f5;
      --color-border: #dee2e6;

      /* 尺寸变量 */
      --border-radius: 6px;
      --sidebar-width: 240px;
      --header-height: 60px;
      --font-size-base: 14px;
      --font-size-sm: 12px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-xxl: 24px;

      /* 阴影变量 */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);

      /* 过渡变量 */
      --transition-base: all 0.3s ease;
    }

    /* 新增：批量上传样式 */
    .upload-mode-switch {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-switch {
      background-color: var(--color-bg-dark);
      color: var(--color-gray-dark);
      border: none;
      padding: 5px 15px;
      border-radius: var(--border-radius);
      transition: var(--transition-base);
    }

    .btn-switch.active {
      background-color: var(--color-primary);
      color: var(--color-white);
    }

    .batch-images-grid, .batch-videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .batch-item, .batch-image-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      height: 150px;
    }

    .batch-item img, .batch-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-item .delete-batch-item {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }

    .batch-item .item-overlay, .batch-image-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .batch-process-status {
      margin: 20px 0;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 15px;
    }

    .batch-progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .batch-progress-item:last-child {
      border-bottom: none;
    }

    .batch-progress-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 10px;
    }

    .batch-progress-status {
      width: 100px;
      text-align: center;
    }

    .status-waiting {
      color: var(--color-gray);
    }

    .status-processing {
      color: var(--color-primary);
    }

    .status-completed {
      color: var(--color-success);
    }

    .status-failed {
      color: var(--color-danger);
    }

    /* 批量结果样式 */
    .batch-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 10px;
    }

    .batch-result-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
      height: 220px;
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .batch-result-image {
      height: 140px;
      overflow: hidden;
    }

    .batch-result-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-result-info {
      padding: 10px;
      background-color: var(--color-white);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .batch-result-filename {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 5px;
    }

    .batch-result-stats {
      display: flex;
      flex-direction: column;
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .batch-result-actions {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
      padding-top: 5px;
    }

    /* 批量视频结果样式 */
    .batch-video-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 10px;
    }

    .batch-video-result-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
      height: 240px;
    }

    .batch-video-result-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .batch-result-card {
      padding: 15px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .batch-result-card.error {
      background-color: rgba(255, 0, 0, 0.05);
    }

    .batch-result-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }

    .batch-result-status i {
      font-size: 24px;
      color: var(--color-danger);
      margin-bottom: 5px;
    }

    .batch-result-message {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-top: 10px;
    }

    /* 基础重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      font-size: var(--font-size-base);
      color: var(--color-dark);
      background-color: var(--color-bg);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    ul {
      list-style: none;
    }

    /* 布局组件 */
    .dashboard {
      display: flex;
      width: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--color-white);
      border-right: 1px solid var(--color-border);
      position: fixed;
      height: 100vh;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
      transition: var(--transition-base);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--color-border);
    }

    .logo {
      font-size: var(--font-size-xl);
      font-weight: bold;
      color: var(--color-primary);
      display: flex;
      align-items: center;
    }

    .logo i {
      margin-right: 10px;
      font-size: 24px;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-title {
      font-size: var(--font-size-sm);
      font-weight: bold;
      color: var(--color-gray);
      padding: 10px 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--color-gray-dark);
      transition: var(--transition-base);
      cursor: pointer;
    }

    .menu-item i {
      margin-right: 10px;
      font-size: 18px;
    }

    .menu-item.active {
      color: var(--color-primary);
      background-color: var(--color-primary-light);
      border-left: 3px solid var(--color-primary);
    }

    .menu-item:hover:not(.active) {
      background-color: var(--color-bg);
    }

    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      width: calc(100% - var(--sidebar-width));
      min-height: 100vh;
      transition: var(--transition-base);
    }

    .header {
      height: var(--header-height);
      background-color: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      position: sticky;
      top: 0;
      z-index: 99;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background-color: var(--color-bg);
      border-radius: var(--border-radius);
      padding: 8px 15px;
      width: 300px;
    }

    .search-bar input {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      margin-left: 10px;
      font-size: var(--font-size-base);
      color: var(--color-dark);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .header-icon {
      font-size: 20px;
      color: var(--color-gray-dark);
      position: relative;
      margin-left: 20px;
      cursor: pointer;
    }

    .header-icon .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--color-danger);
      color: var(--color-white);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-dropdown {
      margin-left: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--color-primary-light);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
    }

    .dropdown-toggle i {
      margin-left: 5px;
      font-size: var(--font-size-base);
      color: var(--color-gray);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      width: 180px;
      z-index: 100;
      overflow: hidden;
      display: none;
    }

    .dropdown-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      transition: var(--transition-base);
    }

    .dropdown-item i {
      margin-right: 10px;
      font-size: 16px;
    }

    .dropdown-item:hover {
      background-color: var(--color-bg);
    }

    .dropdown-divider {
      height: 1px;
      background-color: var(--color-border);
      margin: 5px 0;
    }

    .page-content {
      padding: 30px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: var(--font-size-xl);
      font-weight: bold;
      color: var(--color-dark);
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: var(--transition-base);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-header {
      padding: 15px;
      border-bottom: 1px solid var(--color-border);
      font-weight: bold;
      color: var(--color-gray-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header i {
      color: var(--color-gray);
      font-size: 18px;
    }

    .card-body {
      padding: 15px;
    }

    .statistic {
      text-align: center;
    }

    .statistic h2 {
      font-size: var(--font-size-xxl);
      color: var(--color-primary);
      margin-bottom: 10px;
    }

    .progress {
      height: 6px;
      background-color: var(--color-bg-dark);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--color-primary);
    }

    .statistic span {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .percentage {
      color: var(--color-success);
      font-size: var(--font-size-sm);
      display: flex;
      align-items: center;
    }

    .percentage i {
      font-size: 16px;
      margin-right: 2px;
    }

    .table-container {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .table th {
      background-color: var(--color-bg);
      color: var(--color-gray-dark);
      font-weight: bold;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .table tr:hover td {
      background-color: var(--color-bg);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      margin-right: 5px;
    }

    .tag-success {
      background-color: rgba(0, 196, 154, 0.1);
      color: var(--color-success);
    }

    .tag-warning {
      background-color: rgba(255, 209, 102, 0.1);
      color: var(--color-warning);
    }

    .tag-danger {
      background-color: rgba(242, 95, 92, 0.1);
      color: var(--color-danger);
    }

    .tag-info {
      background-color: rgba(42, 92, 170, 0.1);
      color: var(--color-primary);
    }

    .action-btn {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
      font-size: 16px;
      margin-left: 8px;
    }

    .action-btn:hover {
      color: var(--color-primary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      transition: var(--transition-base);
      cursor: pointer;
      border: none;
      outline: none;
      font-size: var(--font-size-base);
    }

    .btn i {
      margin-right: 5px;
      font-size: 18px;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-white);
    }

    .btn-primary:hover {
      background-color: var(--color-primary-dark);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--color-border);
    }

    .btn-outline:hover {
      background-color: var(--color-bg);
    }

    .btn-success {
      background-color: var(--color-success);
      color: var(--color-white);
    }

    .btn-success:hover {
      background-color: #00b38b;
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: var(--color-white);
    }

    .btn-danger:hover {
      background-color: #e3574f;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: var(--font-size-sm);
    }

    .tab-container {
      margin-bottom: 30px;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .tab-link {
      padding: 10px 20px;
      margin-right: 10px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-base);
      white-space: nowrap;
    }

    .tab-link.active {
      color: var(--color-primary);
      border-color: var(--color-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .upload-container {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 30px;
      margin-bottom: 30px;
    }

    .upload-dropzone {
      border: 2px dashed var(--color-border);
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      transition: var(--transition-base);
    }

    .upload-icon {
      font-size: 48px;
      color: var(--color-gray);
      margin-bottom: 20px;
    }

    .upload-text h3 {
      font-size: var(--font-size-lg);
      margin-bottom: 10px;
    }

    .upload-text p {
      color: var(--color-gray);
      margin-bottom: 20px;
    }

    .file-input {
      position: absolute;
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      z-index: -1;
    }

    .upload-preview {
      margin-top: 20px;
    }

    .upload-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--border-radius);
      display: block;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--color-gray-dark);
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      transition: var(--transition-base);
      outline: none;
    }

    .form-control:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    .select-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
    }

    .form-text {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-top: 5px;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .modal {
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: var(--font-size-lg);
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
    }

    .close-modal:hover {
      color: var(--color-danger);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 15px;
      border-bottom: 1px solid var(--color-border);
      transition: var(--transition-base);
      display: flex;
      align-items: flex-start;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background-color: var(--color-bg);
    }

    .notification-icon {
      margin-right: 15px;
      font-size: 20px;
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0; /* 确保内容可以正确换行 */
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .notification-title {
      font-weight: 500;
    }

    .notification-time {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
      margin-left: 10px;
    }

    .notification-text {
      color: var(--color-gray);
      margin-top: 5px;
    }

    .notification-actions {
      display: flex;
      margin-left: 15px;
      flex-shrink: 0;
      align-self: center;
    }

    .action-btn {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      color: var(--color-gray);
      transition: var(--transition-base);
      font-size: 16px;
      padding: 5px;
      margin-left: 5px;
    }

    .action-btn:hover {
      color: var(--color-primary);
    }

    .action-btn.delete-notification-btn:hover {
      color: var(--color-danger);
    }

    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--color-primary-light);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spinner 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--color-gray);
    }

    .empty-state.model-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      grid-column: 1/-1;
    }

    .models-grid > .empty-state.model-center {
      justify-self: center !important;
      align-self: center !important;
      width: 100%;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .empty-state h3 {
      font-size: var(--font-size-lg);
      margin-bottom: 10px;
      color: var(--color-gray-dark);
    }

    .steps-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: var(--color-border);
      z-index: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--color-white);
      border: 2px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      position: relative;
      z-index: 2;
    }

    .step.active .step-icon {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .step.completed .step-icon {
      background-color: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-white);
    }

    .step-label {
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .step.active .step-label {
      color: var(--color-primary);
      font-weight: 500;
    }

    .step.completed .step-label {
      color: var(--color-success);
    }

    /* 响应式设计 */
    @media (max-width: 992px) {
      .sidebar {
        width: 70px;
        padding: 20px 0;
      }

      .logo span, .menu-item span, .menu-title {
        display: none;
      }

      .menu-item {
        justify-content: center;
        padding: 15px 0;
      }

      .menu-item i {
        margin-right: 0;
        font-size: 20px;
      }

      .main-content {
        margin-left: 70px;
        width: calc(100% - 70px);
      }

      .cards-container, .models-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .cards-container, .models-grid {
        grid-template-columns: 1fr;
      }

      .search-bar {
        width: 200px;
      }

      .header {
        padding: 0 15px;
      }

      .page-content {
        padding: 20px 15px;
      }

      .upload-dropzone {
        padding: 20px;
      }
    }

    @media (max-width: 576px) {
      .sidebar {
        position: fixed;
        left: -70px;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }

      .search-bar {
        display: none;
      }

      .user-dropdown .username {
        display: none;
      }
    }

    /* 工具类 */
    .mb-0 { margin-bottom: 0 !important; }
    .mb-10 { margin-bottom: 10px !important; }
    .mb-20 { margin-bottom: 20px !important; }
    .mt-0 { margin-top: 0 !important; }
    .mt-10 { margin-top: 10px !important; }
    .mt-20 { margin-top: 20px !important; }
    .ml-auto { margin-left: auto !important; }
    .mr-auto { margin-right: auto !important; }
    .text-primary { color: var(--color-primary) !important; }
    .text-success { color: var(--color-success) !important; }
    .text-warning { color: var(--color-warning) !important; }
    .text-danger { color: var(--color-danger) !important; }
    .text-center { text-align: center !important; }
    .text-right { text-align: right !important; }
    .fw-bold { font-weight: bold !important; }
    .d-flex { display: flex !important; }
    .d-none { display: none !important; }
    .justify-between { justify-content: space-between !important; }
    .align-center { align-items: center !important; }
    .w-100 { width: 100% !important; }

    /* Toast 提示样式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      background-color: var(--color-gray-dark);
      color: var(--color-white);
      box-shadow: var(--shadow-md);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-info {
      background-color: var(--color-primary);
    }

    .toast-success {
      background-color: var(--color-success);
    }

    .toast-warning {
      background-color: var(--color-warning);
      color: var(--color-dark);
    }

    .toast-error {
      background-color: var(--color-danger);
    }

    /* 添加收藏按钮的加载状态样式 */
    .action-btn.loading {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }

    .action-btn.loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      margin: -6px 0 0 -6px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .model-container.active {
      display: grid;
    }

    /* 视频信息样式 */
    .video-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .video-info-item {
      display: flex;
      align-items: center;
    }

    .info-label {
      font-weight: 600;
      margin-right: 8px;
      color: #666;
      min-width: 70px;
    }

    .info-value {
      color: #333;
    }

    .video-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
    }

    .notification-text {
      color: var(--color-gray);
      margin-top: 5px;
    }

    .notification-item.unread {
      background-color: rgba(42, 92, 170, 0.05);
    }

    .notification-item.unread .notification-title {
      font-weight: bold;
    }

    .notification-actions {
      display: flex;
      margin-left: 15px;
      flex-shrink: 0;
      align-self: center;
    }

    /* 确保权限状态样式定义明确 */
    .menu-item .badge {
      position: relative;
      background-color: var(--color-danger);
      color: var(--color-white);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
    }

    /* Alert提示框样式 */
    .alert {
      padding: 12px 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert i {
      font-size: 18px;
      flex-shrink: 0;
    }

    .alert-warning {
      background-color: rgba(255, 209, 102, 0.1);
      color: var(--color-warning);
      border: 1px solid rgba(255, 209, 102, 0.3);
    }

    .alert-warning i,
    .alert-warning span {
      color: #664d03;
    }

    .alert-warning i {
      color: #664d03;
    }

    .alert-info {
      background-color: rgba(42, 92, 170, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(42, 92, 170, 0.3);
    }

    .alert-danger {
      background-color: rgba(242, 95, 92, 0.1);
      color: var(--color-danger);
      border: 1px solid rgba(242, 95, 92, 0.3);
    }

    .alert-success {
      background-color: rgba(0, 196, 154, 0.1);
      color: var(--color-success);
      border: 1px solid rgba(0, 196, 154, 0.3);
    }

    /* 错误消息样式 */
    .error-message {
      color: var(--color-danger);
      font-size: 0.85rem;
      margin-top: 5px;
      min-height: 1.2em;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="ri-earth-line"></i>
          <span>遥感图像目标检测系统</span>
        </div>
      </div>

      <div class="sidebar-menu">
        <div class="menu-title">主要功能</div>
        <div class="menu-item active" data-tab="dashboard">
          <i class="ri-dashboard-line"></i>
          <span>控制面板</span>
        </div>
        <div class="menu-item" data-tab="upload">
          <i class="ri-upload-cloud-line"></i>
          <span>目标检测</span>
        </div>
        <div class="menu-item" data-tab="history">
          <i class="ri-history-line"></i>
          <span>识别记录</span>
        </div>
        <div class="menu-item" data-tab="models">
          <i class="ri-database-2-line"></i>
          <span>模型管理</span>
        </div>

        <div class="menu-title">系统</div>
        <div class="menu-item" data-tab="permissions">
          <i class="ri-shield-check-line"></i>
          <span id="permissions-menu-text">权限申请</span>
          <span class="badge" id="permission-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item" data-tab="model-publish">
          <i class="ri-share-line"></i>
          <span id="model-publish-menu-text">模型公开</span>
          <span class="badge" id="model-publish-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item" data-tab="notifications">
          <i class="ri-notification-3-line"></i>
          <span>消息通知</span>
        </div>
        <div class="menu-item" data-tab="profile">
          <i class="ri-user-settings-line"></i>
          <span>个人中心</span>
        </div>
        <div class="menu-item" id="logout-btn">
          <i class="ri-logout-box-line"></i>
          <span>退出登录</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="header">
        <div class="header-actions">
          <!-- 权限审批图标，仅管理员可见 -->
          <div class="header-icon notification-icon" id="permission-toggle" style="display:none;">
            <i class="ri-shield-check-line"></i>
            <span class="badge" id="header-permission-badge">0</span>
          </div>

          <div class="header-icon notification-icon" id="notification-toggle">
            <i class="ri-notification-3-line"></i>
            <span class="badge" id="notification-badge">0</span>
          </div>

          <div class="user-dropdown" id="user-dropdown-toggle">
            <div class="avatar" id="user-avatar">U</div>
            <div class="dropdown-toggle">
              <span class="username" id="username">用户</span>
              <i class="ri-arrow-down-s-line"></i>
            </div>
            <div class="dropdown-menu" id="user-dropdown-menu">
              <div class="dropdown-item" id="profile-link">
                <i class="ri-user-line"></i>
                <span>个人资料</span>
              </div>
              <div class="dropdown-item" id="settings-link">
                <i class="ri-settings-3-line"></i>
                <span>设置</span>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" id="logout-link">
                <i class="ri-logout-box-line"></i>
                <span>退出登录</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <!-- 控制面板 -->
        <div class="tab-content active" id="dashboard-tab">
          <div class="section-header">
            <h2 class="section-title">控制面板</h2>
            <button class="btn btn-outline btn-sm" id="refresh-dashboard">
              <i class="ri-refresh-line"></i> 刷新数据
            </button>
          </div>

          <!-- 数据统计卡片 -->
          <div class="cards-container">
            <div class="card">
              <div class="card-header">
                <span>模型使用</span>
                <i class="ri-line-chart-line"></i>
              </div>
              <div class="card-body">
                <div class="statistic" id="model-usage-stats">
                  <div class="loading-spinner"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span>平均准确度</span>
                <i class="ri-pie-chart-line"></i>
              </div>
              <div class="card-body">
                <div class="statistic" id="accuracy-stats">
                  <div class="loading-spinner"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span>处理时间</span>
                <i class="ri-time-line"></i>
              </div>
              <div class="card-body">
                <div class="statistic" id="processing-time-stats">
                  <div class="loading-spinner"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span>数据量</span>
                <i class="ri-bar-chart-box-line"></i>
              </div>
              <div class="card-body">
                <div class="statistic" id="data-volume-stats">
                    <div class="loading-spinner"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- 最近处理 -->
          <div class="section-header">
            <h3 class="section-title">最近处理</h3>
            <a href="#" class="btn btn-outline btn-sm" id="view-all-history">
              查看全部 <i class="ri-arrow-right-line"></i>
            </a>
          </div>

          <div class="table-container">
            <table class="table" id="recent-processing-table">
              <thead>
                <tr>
                  <th>图像</th>
                  <th>类型</th>
                  <th>识别模型</th>
                  <th>处理时间</th>
                  <th>准确度</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="recent-history-body">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="loading-spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 常用模型 -->
          <div class="section-header">
            <h3 class="section-title">常用模型</h3>
            <a href="#" class="btn btn-outline btn-sm" id="view-all-models">
              查看全部 <i class="ri-arrow-right-line"></i>
            </a>
          </div>

          <div class="models-grid" id="popular-models-container">
            <div class="text-center" style="grid-column: 1/-1;">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <!-- 上传识别 -->
        <div class="tab-content" id="upload-tab">
          <div class="section-header">
            <h2 class="section-title">目标检测</h2>
          </div>

          <div class="tab-container">
            <div class="tab-nav">
              <div class="tab-link active" data-tab="upload-image">图像识别</div>
              <div class="tab-link" data-tab="upload-video">视频识别</div>
              <div class="tab-link" data-tab="upload-realtime">实时识别</div>
            </div>

            <div class="tab-content active" id="upload-image-content">
              <!-- 将单张/批量处理按钮移到上方 -->
              <div class="upload-mode-switch mb-20">
                <button class="btn btn-sm btn-switch active" id="single-upload-mode">单张处理</button>
                <button class="btn btn-sm btn-switch" id="batch-upload-mode">批量处理</button>
              </div>
              <div class="upload-container">
                <div class="upload-dropzone" id="image-dropzone">
                  <div class="upload-icon">
                    <i class="ri-image-add-line"></i>
                  </div>
                  <div class="upload-text">
                    <h3>拖放图像或点击上传</h3>
                    <p>支持PNG、JPG、TIFF格式，最大文件大小20MB</p>
                    <button class="btn btn-primary" id="select-image-btn">
                      <i class="ri-upload-2-line"></i> <span id="select-image-btn-text">选择图像</span>
                    </button>
                  </div>
                  <input type="file" class="file-input" id="image-input" accept=".png,.jpg,.jpeg,.tif,.tiff">
                  <input type="file" class="file-input" id="batch-image-input" accept=".png,.jpg,.jpeg,.tif,.tiff" multiple style="display: none;">
                </div>

                <div class="upload-preview" id="image-preview" style="display: none;">
                  <div class="mb-20">
                    <div class="d-flex justify-between align-center mb-10">
                      <h3>预览图像</h3>
                      <button class="btn btn-outline btn-sm" id="remove-image">
                        <i class="ri-delete-bin-line"></i> 移除
                      </button>
                    </div>
                    <img id="preview-img" src="" alt="预览">
                  </div>

                  <form id="image-process-form">
                    <div class="form-group">
                      <label class="form-label">选择识别模型</label>
                      <select class="form-control select-control" id="model-select">
                        <option value="">--请选择模型--</option>
                      </select>
                    </div>

                    <div class="text-right">
                      <button type="submit" class="btn btn-primary" id="process-image-btn">
                        <i class="ri-play-circle-line"></i> 开始处理
                      </button>
                    </div>
                  </form>
                </div>

                <!-- 批量上传预览区域 -->
                <div class="upload-preview" id="batch-image-preview" style="display: none;">
                  <div class="mb-20">
                    <div class="d-flex justify-between align-center mb-10">
                      <h3>批量处理 (<span id="batch-image-count">0</span> 张图像)</h3>
                      <button class="btn btn-outline btn-sm" id="remove-batch-images">
                        <i class="ri-delete-bin-line"></i> 移除所有
                      </button>
                    </div>

                    <div class="batch-images-grid" id="batch-images-container">
                      <!-- 批量图片预览将在这里动态生成 -->
                    </div>
                  </div>

                  <form id="batch-image-process-form">
                    <div class="form-group">
                      <label class="form-label">选择识别模型</label>
                      <select class="form-control select-control" id="batch-model-select">
                        <option value="">--请选择模型--</option>
                      </select>
                    </div>

                    <div class="text-right">
                      <button type="submit" class="btn btn-primary" id="process-batch-btn">
                        <i class="ri-play-circle-line"></i> 开始批量处理
                      </button>
                    </div>
                  </form>
                </div>

                <div id="processing-progress" style="display: none;">
                  <h3 class="mb-20">图像处理中...</h3>

                  <div class="steps-container">
                    <div class="step active" id="step-upload">
                      <div class="step-icon"><i class="ri-upload-2-line"></i></div>
                      <div class="step-label">上传完成</div>
                    </div>
                    <div class="step" id="step-processing">
                      <div class="step-icon"><i class="ri-loader-4-line"></i></div>
                      <div class="step-label">处理中</div>
                    </div>
                    <div class="step" id="step-complete">
                      <div class="step-icon"><i class="ri-check-line"></i></div>
                      <div class="step-label">完成</div>
                    </div>
                  </div>

                  <div class="progress mb-10">
                    <div class="progress-bar" id="process-progress-bar" style="width: 33%"></div>
                  </div>

                  <p class="text-center" id="process-status-text">正在处理图像数据...</p>

                  <!-- 修改process-result部分，增加批量结果展示 -->
                  <div id="process-result" style="display: none;">
                    <div class="d-flex justify-between align-center mb-20">
                      <h3>处理结果</h3>
                      <div>
                        <button class="btn btn-outline btn-sm" id="download-result">
                          <i class="ri-download-line"></i> 下载
                        </button>
                        <button class="btn btn-primary btn-sm" id="view-details">
                          <i class="ri-eye-line"></i> 查看详情
                        </button>
                      </div>
                    </div>

                    <!-- 单张结果显示 -->
                    <div id="single-result-display" style="display: none;">
                      <div class="card mb-20">
                        <div class="card-body">
                          <div class="text-center mb-20">
                            <img id="result-image" src="" alt="处理结果" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; display: block;">
                          </div>
                          <div style="text-align: center; margin: 0 auto; width: 100%; font-size: 17px;">
                            <table style="margin: 0 auto; width: auto; border-collapse: separate; border-spacing: 30px 10px;">
                              <tr>
                                <td style="padding: 5px 15px; text-align: left;"><strong>精确度:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="result-accuracy">-</span></td>
                                <td style="padding: 5px 15px; text-align: left;"><strong>识别分类:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="result-categories">-</span></td>
                              </tr>
                              <tr>
                                <td style="padding: 5px 15px; text-align: left;"><strong>处理时间:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="result-time">-</span></td>
                                <td style="padding: 5px 15px; text-align: left;"><strong>识别目标数:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="result-objects">-</span></td>
                              </tr>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 批量结果显示 -->
                    <div id="batch-results-display" style="display: none;">
                      <div class="card mb-10">
                        <div class="card-header">
                          批量处理结果
                        </div>
                        <div class="card-body">
                          <div class="batch-results-grid" id="batch-results-container">
                            <!-- 批量结果将在这里动态生成 -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="text-center">
                      <button class="btn btn-success" id="process-new-image">
                        <i class="ri-add-circle-line"></i> 处理新图像
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-content" id="upload-video-content">
              <!-- 将单张/批量处理按钮移到上方 -->
              <div class="upload-mode-switch mb-20">
                <button class="btn btn-sm btn-switch active" id="single-video-mode">单个处理</button>
                <button class="btn btn-sm btn-switch" id="batch-video-mode">批量处理</button>
              </div>
              <div class="upload-container">
                <div class="upload-dropzone" id="video-dropzone">
                  <div class="upload-icon">
                    <i class="ri-film-line"></i>
                  </div>
                  <div class="upload-text">
                    <h3>拖放视频或点击上传</h3>
                    <p>支持MP4、AVI、MOV、WMV、FLV、MKV格式，最大文件大小100MB</p>
                    <button type="button" class="btn btn-primary" id="select-video-btn">
                      <i class="ri-upload-2-line"></i> <span id="select-video-btn-text">选择视频</span>
                    </button>
                  </div>
                  <input type="file" class="file-input" id="video-input" accept=".mp4,.avi,.mov,.wmv,.flv,.mkv">
                  <input type="file" class="file-input" id="batch-video-input" accept=".mp4,.avi,.mov,.wmv,.flv,.mkv" multiple style="display: none;">
                </div>

                <div class="upload-preview" id="video-preview" style="display: none;">
                  <div class="mb-20">
                    <div class="d-flex justify-between align-center mb-10">
                      <h3>预览视频</h3>
                      <button class="btn btn-outline btn-sm" id="remove-video">
                        <i class="ri-delete-bin-line"></i> 移除
                      </button>
                    </div>
                    <div class="text-center mb-20">
                      <video id="preview-video" src="" controls style="max-width: 100%; max-height: 300px; margin: 0 auto; display: block;"></video>
                    </div>
                  </div>

                  <form id="video-process-form">
                    <div class="form-group">
                      <label class="form-label">选择识别模型</label>
                      <select class="form-control select-control" id="video-model-select">
                        <option value="">加载中...</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">处理选项</label>
                      <div class="d-flex mb-10">
                        <div style="flex: 1; margin-right: 10px;">
                          <label class="form-label">开始时间 (秒)</label>
                          <input type="number" class="form-control" id="video-start-time" min="0" value="0">
                        </div>
                        <div style="flex: 1;">
                          <label class="form-label">结束时间 (秒)</label>
                          <input type="number" class="form-control" id="video-end-time" min="0">
                        </div>
                      </div>
                      <div class="form-text">留空结束时间将处理至视频结尾</div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">备注（可选）</label>
                      <input type="text" class="form-control" id="video-remark" placeholder="添加备注信息">
                    </div>

                    <div class="text-right">
                      <button type="submit" class="btn btn-primary" id="process-video-btn">
                        <i class="ri-play-circle-line"></i> 开始处理
                      </button>
                    </div>
                  </form>
                </div>

                <!-- 批量视频上传预览区域 -->
                <div class="upload-preview" id="batch-video-preview" style="display: none;">
                  <div class="mb-20">
                    <div class="d-flex justify-between align-center mb-10">
                      <h3>批量处理 (<span id="batch-video-count">0</span> 个视频)</h3>
                      <button class="btn btn-outline btn-sm" id="remove-batch-videos">
                        <i class="ri-delete-bin-line"></i> 移除所有
                      </button>
                    </div>

                    <div class="batch-videos-grid" id="batch-videos-container">
                      <!-- 批量视频预览将在这里动态生成 -->
                    </div>
                  </div>

                  <form id="batch-video-process-form">
                    <div class="form-group">
                      <label class="form-label">选择识别模型</label>
                      <select class="form-control select-control" id="batch-video-model-select">
                        <option value="">--请选择模型--</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">处理选项</label>
                      <div class="d-flex mb-10">
                        <div style="flex: 1; margin-right: 10px;">
                          <label class="form-label">开始时间 (秒)</label>
                          <input type="number" class="form-control" id="batch-video-start-time" min="0" value="0">
                        </div>
                        <div style="flex: 1;">
                          <label class="form-label">结束时间 (秒)</label>
                          <input type="number" class="form-control" id="batch-video-end-time" min="0">
                        </div>
                      </div>
                      <div class="form-text">留空结束时间将处理至视频结尾，应用于所有视频</div>
                    </div>

                    <div class="text-right">
                      <button type="submit" class="btn btn-primary" id="process-batch-video-btn">
                        <i class="ri-play-circle-line"></i> 开始批量处理
                      </button>
                    </div>
                  </form>
                </div>

                <div id="video-processing-progress" style="display: none;">
                  <h3 class="mb-20">视频处理中...</h3>

                  <div class="steps-container">
                    <div class="step active" id="video-step-upload">
                      <div class="step-icon"><i class="ri-upload-2-line"></i></div>
                      <div class="step-label">上传完成</div>
                    </div>
                    <div class="step" id="video-step-processing">
                      <div class="step-icon"><i class="ri-loader-4-line"></i></div>
                      <div class="step-label">处理中</div>
                    </div>
                    <div class="step" id="video-step-complete">
                      <div class="step-icon"><i class="ri-check-line"></i></div>
                      <div class="step-label">完成</div>
                    </div>
                  </div>

                  <div class="progress mb-10">
                    <div class="progress-bar" id="video-progress-bar" style="width: 33%"></div>
                  </div>

                  <p class="text-center" id="video-status-text">正在准备视频数据...</p>

                  <!-- 视频结果显示 -->
                  <div id="video-result" style="display: none;">
                    <div class="d-flex justify-between align-center mb-20" id="video-result-main-buttons">
                      <h3>处理结果</h3>
                      <div>
                        <button class="btn btn-outline btn-sm" id="download-video-result">
                          <i class="ri-download-line"></i> 下载
                        </button>
                        <button class="btn btn-primary btn-sm" id="view-video-details">
                          <i class="ri-eye-line"></i> 查看详情
                        </button>
                      </div>
                    </div>

                    <!-- 单个视频结果显示 -->
                    <div id="single-video-result-display" style="display: none;">
                      <div class="card mb-20">
                        <div class="card-body">
                          <div class="text-center mb-20">
                            <video id="result-video" src="" controls style="max-width: 100%; max-height: 300px; margin: 0 auto; display: block;" type="video/mp4"></video>
                          </div>
                          <div style="text-align: center; margin: 0 auto; width: 100%; font-size: 17px;">
                            <table style="margin: 0 auto; width: auto; border-collapse: separate; border-spacing: 30px 10px;">
                              <tr>
                                <td style="padding: 5px 15px; text-align: left;"><strong>精确度:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="video-result-accuracy">-</span></td>
                                <td style="padding: 5px 15px; text-align: left;"><strong>识别分类:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="video-result-categories">-</span></td>
                              </tr>
                              <tr>
                                <td style="padding: 5px 15px; text-align: left;"><strong>处理时间:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="video-result-time">-</span></td>
                                <td style="padding: 5px 15px; text-align: left;"><strong>识别目标数:</strong></td>
                                <td style="padding: 5px 15px; text-align: left;"><span id="video-result-objects">-</span></td>
                              </tr>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 批量视频结果显示 -->
                    <div id="batch-video-results-display" style="display: none;">
                      <div class="card mb-10">
                        <div class="card-header">
                          批量处理结果
                        </div>
                        <div class="card-body">
                          <div class="batch-video-results-grid" id="batch-video-results-container">
                            <!-- 批量结果将在这里动态生成 -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="text-center">
                      <button class="btn btn-success" id="process-new-video">
                        <i class="ri-add-circle-line"></i> 处理新视频
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 新增：实时监测内容区域 -->
            <div class="tab-content" id="upload-realtime-content">
              <div class="upload-container">
                <div class="card mb-20">
                  <div class="card-header">
                    <span>实时监测配置</span>
                  </div>
                  <div class="card-body">
                    <form id="realtime-config-form">
                      <div class="form-group">
                        <label class="form-label">视频来源</label>
                        <select class="form-control select-control" id="realtime-source-select">
                          <option value="camera">摄像头</option>
                        </select>
                      </div>

                      <div class="form-group" id="camera-source-group">
                        <label class="form-label">选择摄像头</label>
                        <select class="form-control select-control" id="camera-select">
                          <option value="0">默认摄像头</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label class="form-label">选择识别模型</label>
                        <select class="form-control select-control" id="realtime-model-select">
                          <option value="">正在加载模型...</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label class="form-label">检测参数</label>
                        <div class="d-flex" style="gap: 10px; flex-wrap: wrap;">
                          <div style="flex: 1; min-width: 100px;">
                            <label class="form-label">检测阈值</label>
                            <input type="number" class="form-control" id="detection-threshold" min="0.1" max="1.0" step="0.05" value="0.5">
                          </div>
                          <div style="flex: 1; min-width: 100px;">
                            <label class="form-label">检测频率 (帧)</label>
                            <input type="number" class="form-control" id="detection-frequency" min="1" max="30" value="5">
                          </div>
                          <div style="flex: 1; min-width: 100px;">
                            <label class="form-label">保存频率 (秒)</label>
                            <input type="number" class="form-control" id="save-frequency" min="1" max="60" value="10">
                          </div>
                        </div>
                      </div>

                      <div class="text-right">
                        <button type="submit" class="btn btn-primary" id="start-monitoring-btn">
                          <i class="ri-play-circle-line"></i> 开始监测
                        </button>
                      </div>
                    </form>
                  </div>
                </div>

                <div id="realtime-monitoring-area" style="display: none;">
                  <div class="d-flex justify-between align-center mb-20">
                    <h3>实时监测</h3>
                    <button class="btn btn-danger" id="stop-monitoring-btn">
                      <i class="ri-stop-circle-line"></i> 停止监测
                    </button>
                  </div>

                  <div class="card mb-20">
                    <div class="card-body">
                      <div class="d-flex" style="flex-wrap: wrap; gap: 20px;">
                        <div style="flex: 2; min-width: 400px;">
                          <div class="text-center mb-10">
                            <div id="realtime-stream-container" style="position: relative; background: #000; min-height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden;">
                              <img id="realtime-frame" src="" alt="实时监测画面" style="max-width: 100%; max-height: 100%; display: none;">
                              <div id="loading-stream" style="color: white;">准备连接视频流...</div>
                            </div>
                          </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                          <div class="card" style="height: 100%;">
                            <div class="card-header">
                              监测数据
                            </div>
                            <div class="card-body">
                              <div id="realtime-stats">
                                <div class="d-flex justify-between mb-10">
                                  <span>监测时长:</span>
                                  <span id="monitoring-duration">00:00:00</span>
                                </div>
                                <div class="d-flex justify-between mb-10">
                                  <span>检测目标:</span>
                                  <span id="detected-objects-count">0</span>
                                </div>
                                <div class="d-flex justify-between mb-10">
                                  <span>当前帧速率:</span>
                                  <span id="current-fps">0 FPS</span>
                                </div>
                                <div class="d-flex justify-between mb-10">
                                  <span>平均精确度:</span>
                                  <span id="avg-accuracy">0%</span>
                                </div>
                                <div class="d-flex justify-between mb-10">
                                  <span>保存的帧数:</span>
                                  <span id="saved-frames">0</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card mb-20">
                    <div class="card-header">
                      <span>检测记录</span>
                      <button class="btn btn-outline btn-sm" id="clear-detection-log">
                        <i class="ri-delete-bin-line"></i> 清空日志
                      </button>
                    </div>
                    <div class="card-body">
                      <div id="detection-log" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-gray">监测开始后将显示检测日志</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 历史记录 -->
        <div class="tab-content" id="history-tab">
          <div class="section-header">
            <h2 class="section-title">处理历史</h2>
            <button class="btn btn-outline btn-sm" id="refresh-history">
              <i class="ri-refresh-line"></i> 刷新
            </button>
          </div>

          <div class="card mb-20">
            <div class="card-body">
              <div class="d-flex" style="flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1; min-width: 200px;">
                  <label class="form-label">时间范围</label>
                  <select class="form-control select-control" id="history-time-filter">
                    <option value="all">全部时间</option>
                    <option value="today">今天</option>
                    <option value="week" selected>最近7天</option>
                    <option value="month">最近30天</option>
                    <option value="custom">自定义范围</option>
                  </select>
                </div>

                <div style="flex: 1; min-width: 200px;">
                  <label class="form-label">模型类型</label>
                  <select class="form-control select-control" id="history-model-filter">
                    <option value="all">全部模型</option>
                    <!-- 动态加载模型选项 -->
                  </select>
                </div>

                <div style="flex: 1; min-width: 200px;">
                  <label class="form-label">搜索</label>
                  <div class="d-flex">
                    <input type="text" class="form-control" id="history-search" placeholder="搜索图像名称...">
                    <button class="btn btn-primary" style="margin-left: 10px;" id="history-search-btn">
                      <i class="ri-search-line"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div id="custom-date-range" style="display: none; margin-top: 10px;">
                <div class="d-flex" style="gap: 10px;">
                  <div style="flex: 1;">
                    <label class="form-label">开始日期</label>
                    <input type="date" class="form-control" id="history-start-date">
                  </div>
                  <div style="flex: 1;">
                    <label class="form-label">结束日期</label>
                    <input type="date" class="form-control" id="history-end-date">
                  </div>
                  <div style="align-self: end;">
                    <button class="btn btn-primary" id="apply-date-filter">应用</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <table class="table" id="history-table">
              <thead>
                <tr>
                  <th width="30">
                    <input type="checkbox" id="select-all-history">
                  </th>
                  <th>图像</th>
                  <th>类型</th>
                  <th>识别模型</th>
                  <th>处理时间</th>
                  <th>准确度</th>
                  <th>处理日期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <tr>
                  <td colspan="8" class="text-center">
                    <div class="loading-spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-between align-center mt-20">
            <div>
              <button class="btn btn-outline btn-sm" id="batch-download" disabled>
                <i class="ri-download-line"></i> 批量下载
              </button>
              <button class="btn btn-danger btn-sm" id="batch-delete" disabled>
                <i class="ri-delete-bin-line"></i> 批量删除
              </button>
            </div>

            <div class="pagination" id="history-pagination">
              <!-- 分页控件将由JS动态生成 -->
            </div>
          </div>
        </div>

        <!-- 模型管理 -->
        <div class="tab-content" id="models-tab">
          <div class="section-header">
            <h2 class="section-title">模型管理</h2>
            <button class="btn btn-primary btn-sm" id="add-model-btn">
              <i class="ri-add-line"></i> 上传新模型
            </button>
          </div>

          <div class="tab-container">
            <div class="tab-nav">
              <div class="tab-link active" data-tab="all-models">所有模型</div>
              <div class="tab-link" data-tab="system-models">系统模型</div>
              <div class="tab-link" data-tab="custom-models">自定义模型</div>
              <div class="tab-link" data-tab="favorite-models">收藏模型</div>
            </div>

            <div class="card mb-20">
              <div class="card-body">
                <div class="d-flex" style="flex-wrap: wrap; gap: 10px;">
                  <div style="flex: 1; min-width: 200px;">
                    <label class="form-label">模型类型</label>
                    <select class="form-control select-control" id="model-type-filter">
                      <option value="all">全部类型</option>
                      <option value="landcover">土地覆盖</option>
                      <option value="building">建筑物提取</option>
                      <option value="water">水体监测</option>
                      <option value="vegetation">植被分析</option>
                      <option value="urban">城市分析</option>
                      <option value="other">其他</option>
                    </select>
                  </div>

                  <div style="flex: 1; min-width: 200px;">
                    <label class="form-label">排序方式</label>
                    <select class="form-control select-control" id="model-sort">
                      <option value="newest">最新上传</option>
                      <option value="popular">使用次数</option>
                      <option value="accuracy">准确度</option>
                    </select>
                  </div>

                  <div style="flex: 1; min-width: 200px;">
                    <label class="form-label">搜索</label>
                    <div class="d-flex">
                      <input type="text" class="form-control" id="model-search" placeholder="搜索模型名称...">
                      <button class="btn btn-primary" style="margin-left: 10px;" id="model-search-btn">
                        <i class="ri-search-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-content active" id="all-models-content">
              <div class="models-grid" id="all-models-grid">
                <div class="text-center" style="grid-column: 1/-1;">
                  <div class="loading-spinner"></div>
                </div>
              </div>

              <div class="text-center mt-20" id="load-more-models-container" style="display: none;">
                <button class="btn btn-outline" id="load-more-models">
                  加载更多 <i class="ri-arrow-down-line"></i>
                </button>
              </div>
            </div>

            <div class="tab-content" id="system-models-content">
              <div class="models-grid" id="system-models-grid">
                <!-- 系统模型由JS动态加载 -->
              </div>
            </div>

            <div class="tab-content" id="custom-models-content">
              <div class="models-grid" id="custom-models-grid">
                <!-- 自定义模型由JS动态加载 -->
              </div>
            </div>

            <div class="tab-content" id="favorite-models-content">
              <div class="models-grid" id="favorite-models-grid">
                <!-- 收藏模型由JS动态加载 -->
              </div>
            </div>
          </div>
        </div>

        <!-- 权限申请/审批部分 -->
        <div class="tab-content" id="permissions-tab">
          <div class="section-header" id="permissions-header">
            <!-- 标题和按钮由JS根据用户角色动态添加 -->
          </div>

          <!-- 普通用户权限申请部分 -->
          <div id="user-permissions-content">
            <div class="card mb-20">
              <div class="card-header">申请记录</div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table" id="permissions-table">
                    <thead>
                      <tr>
                        <th>申请内容</th>
                        <th>申请日期</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="permissions-table-body">
                      <tr>
                        <td colspan="4" class="text-center">
                          <div class="loading-spinner"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 管理员权限审批部分 -->
          <div id="admin-permissions-content" style="display: none;">
            <div class="card mb-20">
              <div class="card-header">待审批申请</div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table" id="admin-permissions-table">
                    <thead>
                      <tr>
                        <th>申请用户</th>
                        <th>申请内容</th>
                        <th>申请日期</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admin-permissions-table-body">
                      <tr>
                        <td colspan="5" class="text-center">
                          <div class="loading-spinner"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 模型公开申请/审批部分 -->
        <div class="tab-content" id="model-publish-tab">
          <div class="section-header" id="model-publish-header">
            <!-- 标题和按钮由JS根据用户角色动态添加 -->
          </div>

          <!-- 普通用户模型公开申请列表 -->
          <div id="user-model-publish-content">
            <div class="card mb-20">
              <div class="card-header">模型公开申请记录</div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table" id="model-publish-table">
                    <thead>
                      <tr>
                        <th>模型名称</th>
                        <th>模型类型</th>
                        <th>申请日期</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="model-publish-table-body">
                      <tr>
                        <td colspan="5" class="text-center">
                          <div class="loading-spinner"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 管理员模型公开审批部分 -->
          <div id="admin-model-publish-content" style="display: none;">
            <div class="card mb-20">
              <div class="card-header">待审批模型</div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table" id="admin-model-publish-table">
                    <thead>
                      <tr>
                        <th>申请用户</th>
                        <th>模型名称</th>
                        <th>模型类型</th>
                        <th>申请日期</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admin-model-publish-table-body">
                      <tr>
                        <td colspan="6" class="text-center">
                          <div class="loading-spinner"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 通知消息 -->
        <div class="tab-content" id="notifications-tab">
          <div class="section-header">
            <h2 class="section-title">消息通知</h2>
            <div>
              <button class="btn btn-outline btn-sm" id="mark-all-read">
                <i class="ri-check-double-line"></i> 全部已读
              </button>
              <button class="btn btn-outline btn-sm" id="clear-read">
                <i class="ri-delete-bin-line"></i> 清除已读
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="tab-nav" style="border: none; margin: 0;">
                <div class="tab-link active" data-tab="all-notifications">全部</div>
                <div class="tab-link" data-tab="unread-notifications">未读</div>
                <div class="tab-link" data-tab="read-notifications">已读</div>
              </div>
            </div>
            <div class="card-body">
              <div class="tab-content active" id="all-notifications-content">
                <div class="notification-list" id="all-notifications-list">
                  <div class="text-center">
                    <div class="loading-spinner"></div>
                  </div>
                </div>
              </div>

              <div class="tab-content" id="unread-notifications-content">
                <div class="notification-list" id="unread-notifications-list">
                  <!-- 未读通知由JS动态加载 -->
                </div>
              </div>

              <div class="tab-content" id="read-notifications-content">
                <div class="notification-list" id="read-notifications-list">
                  <!-- 已读通知由JS动态加载 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 个人中心 -->
        <div class="tab-content" id="profile-tab">
          <div class="section-header">
            <h2 class="section-title">个人中心</h2>
          </div>

          <div class="card mb-20">
            <div class="card-header">个人资料</div>
            <div class="card-body">
              <form id="profile-form">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-control" id="profile-username" disabled>
                  </div>

                  <div class="form-group">
                    <label class="form-label">邮箱</label>
                    <input type="email" class="form-control" id="profile-email">
                  </div>

                  <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" id="profile-name">
                  </div>

                  <div class="form-group">
                    <label class="form-label">电话</label>
                    <input type="tel" class="form-control" id="profile-phone">
                  </div>

                  <div class="form-group">
                    <label class="form-label">单位</label>
                    <input type="text" class="form-control" id="profile-organization">
                  </div>

                  <div class="form-group">
                    <label class="form-label">部门</label>
                    <input type="text" class="form-control" id="profile-department">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">个人简介</label>
                  <textarea class="form-control" id="profile-bio" rows="3"></textarea>
                </div>

                <div class="text-right">
                  <button type="submit" class="btn btn-primary" id="save-profile">
                    <i class="ri-save-line"></i> 保存资料
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">修改密码</div>
            <div class="card-body">
              <form id="password-form">
                <div class="form-group">
                  <label class="form-label">当前密码</label>
                  <label for="current-password"></label><input type="password" class="form-control" id="current-password" required>
                  <div class="error-message" id="current-password-error"></div>
                </div>

                <div class="form-group">
                  <label class="form-label">新密码</label>
                  <label for="new-password"></label><input type="password" class="form-control" id="new-password" required>
                  <div class="error-message" id="new-password-error"></div>
                </div>

                <div class="form-group">
                  <label class="form-label">确认新密码</label>
                  <label for="confirm-password"></label><input type="password" class="form-control" id="confirm-password" required>
                  <div class="error-message" id="confirm-password-error"></div>
                </div>

                <div class="text-right">
                  <button type="submit" class="btn btn-primary" id="change-password">
                    <i class="ri-lock-line"></i> 修改密码
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 上传模型模态框 -->
  <div class="modal-backdrop" id="add-model-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">上传新模型</h3>
        <button class="close-modal" id="close-model-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="model-upload-form">
          <div class="form-group">
            <label class="form-label">模型名称</label>
            <input type="text" class="form-control" id="model-name" required>
          </div>

          <div class="form-group">
            <label class="form-label">模型分类</label>
            <select class="form-control select-control" id="model-category" required>
              <option value="landcover">土地覆盖</option>
              <option value="building">建筑物提取</option>
              <option value="water">水体监测</option>
              <option value="vegetation">植被分析</option>
              <option value="urban">城市分析</option>
              <option value="other">其他</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">模型描述</label>
            <textarea class="form-control" id="model-description" rows="3" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">上传模型文件</label>
            <div class="upload-dropzone" id="model-file-dropzone">
              <div class="upload-text">
                <p>拖放模型文件或点击上传</p>
                <p>支持.pt、.h5、.pth格式，最大2GB</p>
                <button type="button" class="btn btn-outline" id="select-model-file-btn">
                  <i class="ri-upload-2-line"></i> 选择文件
                </button>
              </div>
              <input type="file" class="file-input" id="model-file-input" accept=".pt,.h5,.pth">
            </div>
            <div id="model-file-info" style="display: none;" class="mt-10">
              <div class="d-flex align-center">
                <i class="ri-file-zip-line" style="font-size: 24px; margin-right: 10px;"></i>
                <div>
                  <div id="model-file-name">model.pt</div>
                  <div id="model-file-size" class="text-gray">2.5MB</div>
                </div>
                <button type="button" class="btn btn-outline btn-sm ml-auto" id="remove-model-file">
                  <i class="ri-close-line"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">初始示例图片 <span style="color:red">*</span></label>
            <div class="upload-dropzone" id="model-image-dropzone">
              <div class="upload-text">
                <p>上传模型输入的示例图片</p>
                <p>建议JPG、PNG格式，800x600分辨率</p>
                <button type="button" class="btn btn-outline" id="select-model-image-btn">
                  <i class="ri-image-add-line"></i> 选择图片
                </button>
              </div>
              <input type="file" class="file-input" id="model-image-input" accept="image/*" required>
            </div>
            <div id="model-image-preview" style="display: none;" class="mt-10">
              <img id="model-image-preview-img" src="" alt="初始示例图片预览" style="max-width: 100%; max-height: 200px;">
              <button type="button" class="btn btn-outline btn-sm" id="remove-model-image">
                <i class="ri-close-line"></i> 移除图片
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">结果示例图片 <span style="color:red">*</span></label>
            <div class="upload-dropzone" id="model-result-image-dropzone">
              <div class="upload-text">
                <p>上传模型输出的结果示例图片</p>
                <p>建议JPG、PNG格式，800x600分辨率</p>
                <button type="button" class="btn btn-outline" id="select-model-result-image-btn">
                  <i class="ri-image-add-line"></i> 选择图片
                </button>
              </div>
              <input type="file" class="file-input" id="model-result-image-input" accept="image/*" required>
            </div>
            <div id="model-result-image-preview" style="display: none;" class="mt-10">
              <img id="model-result-image-preview-img" src="" alt="结果示例图片预览" style="max-width: 100%; max-height: 200px;">
              <button type="button" class="btn btn-outline btn-sm" id="remove-model-result-image">
                <i class="ri-close-line"></i> 移除图片
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">技术参数（可选）</label>
            <textarea class="form-control" id="model-parameters" rows="2" placeholder="模型架构、训练参数等技术信息"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">使用说明（可选）</label>
            <textarea class="form-control" id="model-instructions" rows="2" placeholder="模型适用场景和使用提示"></textarea>
          </div>

          <div class="form-group">
            <div class="d-flex align-center">
              <input type="checkbox" id="model-shared">
              <label for="model-shared" style="margin-left: 10px;">申请公开模型</label>
            </div>
            <div class="form-text">申请后，管理员审批通过的模型将对其他用户开放使用</div>
          </div>

          <div class="form-group" id="publish-reason-group" style="display: none;">
            <label class="form-label">申请理由</label>
            <textarea class="form-control" id="model-publish-reason" rows="3" placeholder="请详细说明公开该模型的原因，例如：模型的优势、适用场景等"></textarea>
            <div class="form-text">详细的申请理由有助于管理员更快审批</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-model-upload">取消</button>
        <button class="btn btn-primary" id="submit-model-upload" type="submit">保存模型</button>
      </div>
    </div>
  </div>

  <!-- 新建权限申请模态框 -->
  <div class="modal-backdrop" id="new-permission-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">新建权限申请</h3>
        <button class="close-modal" id="close-permission-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="permission-form">
          <div class="form-group">
            <label class="form-label">申请类型</label>
            <select class="form-control select-control" id="permission-type" required>
              <option value="">请选择申请类型</option>
              <option value="model">高级模型使用权限</option>
              <option value="storage">增加存储空间</option>
              <option value="api">API接口调用权限</option>
              <option value="other">其他权限</option>
            </select>
          </div>

          <div class="form-group" id="storage-size-group" style="display: none;">
            <label class="form-label">申请存储空间大小 (GB)</label>
            <input type="number" class="form-control" id="storage-size" min="10" value="20">
            <div class="form-text">最小申请10GB</div>
          </div>

          <div class="form-group">
            <label class="form-label">申请原因</label>
            <textarea class="form-control" id="permission-reason" rows="4" required></textarea>
            <div class="form-text">请详细说明申请用途，以便管理员审核</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-permission">取消</button>
        <button class="btn btn-primary" id="submit-permission">提交申请</button>
      </div>
    </div>
  </div>

  <!-- 权限申请审批模态框 -->
  <div class="modal-backdrop" id="permission-approval-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">权限申请详情</h3>
        <button class="close-modal" id="close-approval-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="permission-detail-content">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="reject-permission-btn">拒绝</button>
        <button class="btn btn-primary" id="approve-permission-btn">批准</button>
      </div>
    </div>
  </div>

  <!-- 批准权限申请意见模态框 -->
  <div class="modal-backdrop" id="approve-comment-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">批准权限申请</h3>
        <button class="close-modal" id="close-approve-comment-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">批准意见（可选）</label>
          <textarea class="form-control" id="approve-comment-textarea" rows="4" placeholder="请输入批准意见，可以为空"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-approve-btn">取消</button>
        <button class="btn btn-primary" id="submit-approve-btn">确认批准</button>
      </div>
    </div>
  </div>

  <!-- 拒绝权限申请意见模态框 -->
  <div class="modal-backdrop" id="reject-comment-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">拒绝权限申请</h3>
        <button class="close-modal" id="close-reject-comment-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-20">
          <i class="ri-information-line"></i>
          <span>拒绝申请需要提供明确的理由，帮助用户了解被拒绝的原因</span>
        </div>
        <div class="form-group">
          <label class="form-label">拒绝原因（必填）</label>
          <textarea class="form-control" id="reject-comment-textarea" rows="5" placeholder="请详细说明拒绝原因，例如：申请不符合系统规定、申请理由不充分等"></textarea>
          <div class="form-text" id="reject-validation-message">请填写详细的拒绝理由，至少10个字符</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-reject-btn">取消</button>
        <button class="btn btn-danger" id="submit-reject-btn">确认拒绝</button>
      </div>
    </div>
  </div>

  <!-- 用户权限申请详情模态框 -->
  <div class="modal-backdrop" id="user-permission-detail-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">权限申请详情</h3>
        <button class="close-modal" id="close-user-permission-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="user-permission-detail-content">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="save-permission-btn" style="display: none;">保存修改</button>
        <button class="btn btn-outline" id="close-user-permission-btn">关闭</button>
      </div>
    </div>
  </div>

  <!-- 查看模型公开申请详情模态框（用户） -->
  <div class="modal-backdrop" id="user-model-publish-detail-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">模型公开申请详情</h3>
        <button class="close-modal" id="close-user-model-publish-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="user-model-publish-detail-content">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="close-user-model-publish-btn">关闭</button>
        <div id="model-publish-pending-actions" style="display: none;">
          <button class="btn btn-outline" id="edit-model-publish-btn">
            <i class="ri-edit-line"></i> 修改申请
          </button>
          <button class="btn btn-danger" id="cancel-model-publish-btn">
            <i class="ri-close-circle-line"></i> 撤销申请
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 模型公开申请审批模态框（管理员） -->
  <div class="modal-backdrop" id="model-publish-approval-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">模型公开申请审批</h3>
        <button class="close-modal" id="close-model-publish-approval-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="model-publish-detail-content">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="close-approval-btn">关闭</button>
        <button class="btn btn-outline" id="reject-model-publish-btn">拒绝</button>
        <button class="btn btn-primary" id="approve-model-publish-btn">批准</button>
      </div>
    </div>
  </div>

  <!-- 添加模型详情模态框 -->
  <div class="modal-backdrop" id="model-detail-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">模型详情</h3>
        <button class="close-modal" id="close-model-detail-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="model-detail-content">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="close-detail-btn">关闭</button>
        <!-- 删除固定的使用此模型按钮，改为动态生成 -->
      </div>
    </div>
  </div>

  <!-- 添加历史记录详情弹窗 -->
  <div class="modal-backdrop" id="history-detail-modal" style="display: none;">
    <div class="modal" style="width: 80%; max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">处理详情</h3>
        <button class="close-modal" id="close-history-detail-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="history-detail-content" style="text-align: center;">
          <div class="loading-spinner"></div>
        </div>
        <div id="history-detail-image-container" class="text-center mb-20">
          <!-- 图像或视频将在这里显示 -->
        </div>
        <div id="history-detail-info" style="text-align: center; margin: 0 auto; width: 100%; font-size: 17px;">
          <table style="margin: 0 auto; width: 100%; border-collapse: separate; border-spacing: 30px 10px;">
            <tr>
              <td style="padding: 5px 15px; text-align: left;"><strong>精确度:</strong></td>
              <td style="padding: 5px 15px; text-align: left;"><span id="detail-accuracy">-</span></td>
              <td style="padding: 5px 15px; text-align: left;"><strong>识别分类:</strong></td>
              <td style="padding: 5px 15px; text-align: left;"><span id="detail-categories">-</span></td>
            </tr>
            <tr>
              <td style="padding: 5px 15px; text-align: left;"><strong>处理时间:</strong></td>
              <td style="padding: 5px 15px; text-align: left;"><span id="detail-time">-</span></td>
              <td style="padding: 5px 15px; text-align: left;"><strong>识别目标数:</strong></td>
              <td style="padding: 5px 15px; text-align: left;"><span id="detail-objects">-</span></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="download-detail-btn">
          <i class="ri-download-line"></i> 下载结果
        </button>
        <button class="btn btn-primary" id="close-history-detail-btn">关闭</button>
      </div>
    </div>
  </div>

  <!-- 添加批量结果项的CSS样式 -->
  <style>
    .batch-result-item {
      position: relative;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition-base);
    }

    .batch-result-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .batch-result-image {
      height: 150px;
      overflow: hidden;
    }

    .batch-result-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-result-info {
      padding: 10px;
      background-color: var(--color-white);
    }

    .batch-result-filename {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 5px;
    }

    .batch-result-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      font-size: var(--font-size-sm);
      color: var(--color-gray);
    }

    .batch-result-stat {
      display: flex;
      align-items: center;
    }

    .batch-result-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      gap: 5px;
    }
  </style>

  <script>
    // 工具函数
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      try {
        // 处理非数字输入
        if (typeof bytes !== 'number') {
          bytes = parseInt(bytes, 10);
          if (isNaN(bytes)) return '未知大小';
        }

        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      } catch (error) {
        console.error("文件大小格式化错误:", error);
        return '未知大小';
      }
    }

    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.innerHTML = '<div class="loading-spinner"></div>';
    }

    function showEmptyState(elementId, message, icon = 'ri-inbox-line') {
      const element = document.getElementById(elementId);
      if (!element) {
        console.error(`找不到ID为${elementId}的元素`);
        return;
      }

      element.innerHTML = `
        <tr>
          <td colspan="7" class="text-center">
            <div class="empty-state">
              <i class="${icon}"></i>
              <h3>暂无数据</h3>
              <p>${message}</p>
            </div>
          </td>
        </tr>
      `;
    }

    // HTML转义函数，防止XSS攻击
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // 格式化日期函数
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // DOM 加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 检查登录状态并初始化应用
      checkLoginStatus();
      // 初始化应用
      initApp();

      // 延迟检查用户角色并更新权限界面
      setTimeout(function() {
        // 获取用户信息，检查是否为管理员
        const userInfoStr = localStorage.getItem('user_info');
        let isAdmin = false;

        if (userInfoStr) {
          try {
            const userInfo = JSON.parse(userInfoStr);
            isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

            // 强制检查是否为admin用户名
            const username = document.getElementById('username').textContent;
            if (username === 'admin') {
              isAdmin = true;
            }

            if (isAdmin) {
              // 如果是管理员，确保显示权限审批界面
              const titleElement = document.querySelector('#permissions-header .section-title');
              if (titleElement) {
                titleElement.textContent = '权限审批';
              }
              document.getElementById('admin-permissions-content').style.display = 'block';
              document.getElementById('user-permissions-content').style.display = 'none';
              fetchAdminPermissions();
            }
          } catch (e) {
            console.error("【延迟检查】解析用户信息失败:", e);
          }
        }
      }, 1000); // 延迟1秒检查
    });

    // 检查登录状态并初始化页面
    function checkLoginStatus() {
      // 获取Token - 注意login.html中存储的是auth_token而不是token
      const token = localStorage.getItem('auth_token');
      if (!token) {
        // 未登录，跳转到登录页
        window.location.href = '/login.html';
        return;
      }

      // 验证token有效性
      fetch('/api/user/info', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            // token无效或过期，清除并跳转到登录页
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取用户信息失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已经处理了跳转

        if (data.success) {
        } else {
          console.error('获取用户信息失败:', data.message);
          showToast('获取用户信息失败', 'error');
        }
      })
      .catch(error => {
        console.error('获取用户信息出错:', error);
        showToast('网络错误，请重试', 'error');
      });
    }

    // 获取用户信息
    function fetchUserInfo() {
      // 由于我们已经在checkLoginStatus中获取了用户信息，这个函数现在可以删除
      // 或者改为刷新用户信息的功能
      const token = localStorage.getItem('auth_token');
      if (!token) {
        // 如果正在实时监测，就不要重定向
        if (isRealtimeMonitoring) {
          console.warn('检测到未登录状态，但由于正在进行实时监测，暂不跳转');
          return;
        }
        window.location.href = '/login.html';
        return;
      }

      fetch('/api/user/info', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            // 如果正在实时监测，就不要重定向
            if (isRealtimeMonitoring) {
              console.warn('检测到授权失效，但由于正在进行实时监测，暂不跳转');
              return null;
            }
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取用户信息失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已经处理了跳转

        if (data.success) {
          // 更新用户信息显示
          const user = data.user;
          document.getElementById('username').textContent = user.username;
          document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase();

          // 初始化用户角色变量
          window.userRole = user.is_admin === true || user.is_admin === 1 || user.username === 'admin' ? 'admin' : 'user';

          console.log("用户角色初始化:", window.userRole);

          // 更新个人资料表单
          document.getElementById('profile-username').value = user.username;
          document.getElementById('profile-email').value = user.email || '';
          document.getElementById('profile-name').value = user.name || '';
          document.getElementById('profile-phone').value = user.phone || '';
          document.getElementById('profile-organization').value = user.organization || '';
          document.getElementById('profile-department').value = user.department || '';
          document.getElementById('profile-bio').value = user.bio || '';

          // 检查通知数量并立即更新通知徽章
          if (user.unreadNotifications > 0) {
            document.getElementById('notification-badge').textContent = user.unreadNotifications;
            document.getElementById('notification-badge').style.display = 'flex';
          } else {
            document.getElementById('notification-badge').style.display = 'none';
          }

          // 强制刷新通知徽章，确保显示最新状态
          updateNotificationBadge();
        } else {
          console.error('获取用户信息失败:', data.message);
          showToast('获取用户信息失败', 'error');
        }
      })
      .catch(error => {
        console.error('获取用户信息出错:', error);
        showToast('网络错误，请重试', 'error');
      });
    }

    // 初始化侧边栏菜单
    function initSidebarMenu() {
      const menuItems = document.querySelectorAll('.menu-item');
      const tabContents = document.querySelectorAll('.tab-content');

      menuItems.forEach(item => {
        if (item.id === 'logout-btn') {
          item.addEventListener('click', function() {
            // 清除本地存储的token
            localStorage.removeItem('auth_token');
            // 跳转到登录页
            window.location.href = '/login.html';
          });
          return;
        }

        item.addEventListener('click', function() {
          // 移除所有菜单项的激活状态
          menuItems.forEach(mi => mi.classList.remove('active'));
          // 添加当前菜单项的激活状态
          this.classList.add('active');

          // 隐藏所有内容区域
          tabContents.forEach(tc => tc.classList.remove('active'));

          // 显示对应的内容区域
          const tabId = this.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');

          // 根据不同标签加载相应的数据
          if (tabId === 'upload') {
            // 加载模型列表
            loadModelList();

            // 强制清除所有标签激活状态，避免多条激活线问题
            console.log("侧边栏菜单切换：强制清除所有目标检测子标签状态");
            const allUploadTabs = document.querySelectorAll('.tab-link[data-tab^="upload-"]');
            allUploadTabs.forEach(t => t.classList.remove('active'));

            // 初始化默认选中遥感图像上传选项卡
            const defaultUploadTab = document.querySelector('.tab-link[data-tab="upload-image"]');
            if (defaultUploadTab) {
              defaultUploadTab.classList.add('active');
              const defaultContent = document.getElementById('upload-image-content');
              if (defaultContent) {
                defaultContent.classList.add('active');
              }
            }
          } else if (tabId === 'history') {
            // 加载历史记录，默认第一页
            fetchHistoryRecords(1);
          } else if (tabId === 'models') {
            // 强制清除所有标签激活状态，避免多条激活线问题
            console.log("切换到模型管理标签：强制清除所有模型子标签状态");
            document.querySelectorAll('.tab-link[data-tab^="all-models"], .tab-link[data-tab^="system-models"], .tab-link[data-tab^="custom-models"], .tab-link[data-tab^="favorite-models"]').forEach(t => t.classList.remove('active'));

            // 默认选中"所有模型"标签
            const defaultModelTab = document.querySelector('.tab-link[data-tab="all-models"]');
            if (defaultModelTab) {
              defaultModelTab.classList.add('active');

              // 显示对应内容
              document.querySelectorAll('#models-tab .tab-content').forEach(c => c.classList.remove('active'));
              const defaultContent = document.getElementById('all-models-content');
              if (defaultContent) {
                defaultContent.classList.add('active');
              }
            }
            // 直接调用加载函数，确保数据显示
            fetchAllModels('all');
            // 确保加载所有类别的模型数据
            fetchAllModels('system');
            fetchAllModels('custom');
            fetchAllModels('favorite');
          } else if (tabId === 'notifications') {
            // 强制清除所有标签激活状态，避免多条激活线问题
            console.log("切换到通知标签：强制清除所有通知子标签状态");
            document.querySelectorAll('.tab-link[data-tab^="all-notifications"], .tab-link[data-tab^="unread-notifications"], .tab-link[data-tab^="read-notifications"]').forEach(t => t.classList.remove('active'));

            // 默认选中"全部通知"标签
            const defaultNotificationsTab = document.querySelector('.tab-link[data-tab="all-notifications"]');
            if (defaultNotificationsTab) {
              defaultNotificationsTab.classList.add('active');

              // 显示对应内容
              document.querySelectorAll('.card-body .tab-content').forEach(c => c.classList.remove('active'));
              const defaultContent = document.getElementById('all-notifications-content');
              if (defaultContent) {
                defaultContent.classList.add('active');
              }
            }

            // 加载通知数据
            fetchNotifications();
          } else if (tabId === 'dashboard') {
            // 加载控制面板数据
            fetchDashboardStats();
            fetchRecentHistory();
            fetchPopularModels();
          } else if (tabId === 'permissions') {
            // 检查用户角色并根据角色加载相应数据
            const userInfoStr = localStorage.getItem('user_info');
            let isAdmin = false;

            if (userInfoStr) {
              try {
                const userInfo = JSON.parse(userInfoStr);
                isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

                // 强制检查是否为admin用户名(额外检查以确保管理员功能正常显示)
                const username = document.getElementById('username').textContent;
                if (username === 'admin') {
                  isAdmin = true;
                }

                if (isAdmin) {
                  // 管理员 - 加载待审批权限列表
                  fetchAdminPermissions();
                  // 显示管理员内容，隐藏用户内容
                  document.getElementById('admin-permissions-content').style.display = 'block';
                  document.getElementById('user-permissions-content').style.display = 'none';
                } else {
                  // 普通用户 - 加载权限申请列表
                  fetchPermissions();
                  // 显示用户内容，隐藏管理员内容
                  document.getElementById('admin-permissions-content').style.display = 'none';
                  document.getElementById('user-permissions-content').style.display = 'block';
                }
              } catch (e) {
                console.error("解析用户信息失败:", e);
              }
            }
          } else if (tabId === 'model-publish') {
            // 模型公开申请选项卡被选中时，检查用户角色并更新界面
            const userInfoStr = localStorage.getItem('user_info');
            let isAdmin = false;

            if (userInfoStr) {
              try {
                const userInfo = JSON.parse(userInfoStr);
                isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

                // 更新权限界面
                if (isAdmin) {
                  // 加载管理员待审批列表
                  fetchAdminModelPublishRequests();
                  document.getElementById('admin-model-publish-content').style.display = 'block';
                  document.getElementById('user-model-publish-content').style.display = 'none';
                } else {
                  // 加载用户申请列表
                  fetchUserModelPublishRequests();
                  document.getElementById('admin-model-publish-content').style.display = 'none';
                  document.getElementById('user-model-publish-content').style.display = 'block';
                }
              } catch (e) {
                console.error("【Tab切换】解析用户信息失败:", e);
              }
            }
          } else if (tabId === 'profile') {
            // 加载用户资料信息
            loadUserProfile();
          }
        });
      });
    }

    // 初始化用户下拉菜单
    function initUserDropdown() {
      const dropdownToggle = document.getElementById('user-dropdown-toggle');
      const dropdownMenu = document.getElementById('user-dropdown-menu');

      dropdownToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', function() {
        dropdownMenu.style.display = 'none';
      });

      // 下拉菜单项点击事件
      document.getElementById('profile-link').addEventListener('click', function() {
        // 显示个人中心选项卡
        showTab('profile');
      });

      document.getElementById('settings-link').addEventListener('click', function() {
        // 显示个人中心选项卡
        showTab('profile');
      });

      document.getElementById('logout-link').addEventListener('click', function() {
        // 清除本地存储的token
        localStorage.removeItem('auth_token');
        // 跳转到登录页
        window.location.href = '/login.html';
      });
    }

    // 显示特定选项卡
    function showTab(tabId) {
      console.log(`显示标签: ${tabId}`);

      // 检查当前激活的标签，如果从上传标签切换到其他标签，则重置上传表单
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab && activeTab.id === 'upload-tab' && tabId !== 'upload') {
        console.log('从上传标签切换到其他标签，重置所有上传表单');
        resetUploadForms();
      }

      // 更新侧边栏菜单激活状态
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(mi => mi.classList.remove('active'));
      const targetMenuItem = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
      if (targetMenuItem) {
        targetMenuItem.classList.add('active');
      }

      // 更新内容区域显示
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tc => tc.classList.remove('active'));
      const tabContent = document.getElementById(`${tabId}-tab`);
      if (tabContent) {
        tabContent.classList.add('active');
        console.log(`激活tab内容: ${tabId}-tab`);
      } else {
        console.error(`找不到内容区域: ${tabId}-tab`);
      }

      // 根据不同选项卡自动加载相应数据
      if (tabId === 'upload') {
        console.log("进入上传标签，初始化上传功能");
        // 自动加载模型列表
        loadModelList();

        // 强制清除所有标签激活状态，避免多条激活线问题
        console.log("强制清除所有目标检测子标签状态");
        const allUploadTabs = document.querySelectorAll('.tab-link[data-tab^="upload-"]');
        allUploadTabs.forEach(t => t.classList.remove('active'));

        // 添加激活状态到图像识别标签
        const defaultUploadTab = document.querySelector('.tab-link[data-tab="upload-image"]');
        if (defaultUploadTab) {
          defaultUploadTab.classList.add('active');

          // 显示对应内容
          const allUploadContents = document.querySelectorAll('#upload-tab .tab-content');
          allUploadContents.forEach(c => c.classList.remove('active'));

          const defaultContent = document.getElementById('upload-image-content');
          if (defaultContent) {
            defaultContent.classList.add('active');
            console.log("激活上传图像内容区域");
          } else {
            console.error("找不到上传图像内容区域");
          }
        } else {
          console.error("找不到图像识别标签");
        }
      } else if (tabId === 'history') {
        // 自动加载历史记录，默认第一页
        fetchHistoryRecords(1);
      } else if (tabId === 'models') {
        // 强制清除所有标签激活状态，避免多条激活线问题
        console.log("切换到模型管理标签：强制清除所有模型子标签状态");
        document.querySelectorAll('.tab-link[data-tab^="all-models"], .tab-link[data-tab^="system-models"], .tab-link[data-tab^="custom-models"], .tab-link[data-tab^="favorite-models"]').forEach(t => t.classList.remove('active'));

        // 默认选中"所有模型"标签
        const defaultModelTab = document.querySelector('.tab-link[data-tab="all-models"]');
        if (defaultModelTab) {
          defaultModelTab.classList.add('active');

          // 显示对应内容
          document.querySelectorAll('#models-tab .tab-content').forEach(c => c.classList.remove('active'));
          const defaultContent = document.getElementById('all-models-content');
          if (defaultContent) {
            defaultContent.classList.add('active');
          }
        }

        // 直接调用加载函数，确保数据显示
        fetchAllModels('all');
        // 确保加载所有类别的模型数据
        fetchAllModels('system');
        fetchAllModels('custom');
        fetchAllModels('favorite');
      } else if (tabId === 'notifications') {
        // 强制清除所有标签激活状态，避免多条激活线问题
        console.log("切换到通知标签：强制清除所有通知子标签状态");
        document.querySelectorAll('.tab-link[data-tab^="all-notifications"], .tab-link[data-tab^="unread-notifications"], .tab-link[data-tab^="read-notifications"]').forEach(t => t.classList.remove('active'));

        // 默认选中"全部通知"标签
        const defaultNotificationsTab = document.querySelector('.tab-link[data-tab="all-notifications"]');
        if (defaultNotificationsTab) {
          defaultNotificationsTab.classList.add('active');

          // 显示对应内容
          document.querySelectorAll('.card-body .tab-content').forEach(c => c.classList.remove('active'));
          const defaultContent = document.getElementById('all-notifications-content');
          if (defaultContent) {
            defaultContent.classList.add('active');
          }
        }

        // 加载通知数据
        fetchNotifications();
      } else if (tabId === 'dashboard') {
        // 加载控制面板数据
        fetchDashboardStats();
        fetchRecentHistory();
        fetchPopularModels();
      } else if (tabId === 'permissions') {
        // 权限选项卡被选中时，检查用户角色并更新界面
        const userInfoStr = localStorage.getItem('user_info');
        let isAdmin = false;

        if (userInfoStr) {
          try {
            const userInfo = JSON.parse(userInfoStr);
            isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

            // 强制检查是否为admin用户名(额外检查以确保管理员功能正常显示)
            const username = document.getElementById('username').textContent;
            if (username === 'admin') {
              isAdmin = true;
            }

            // 更新权限界面
            const permissionsHeader = document.getElementById('permissions-header');
            if (isAdmin) {
              // 确保菜单文本更新为"权限审批"
              const permissionMenuText = document.getElementById('permissions-menu-text');
              if (permissionMenuText) {
                permissionMenuText.textContent = '权限审批';
              }

              permissionsHeader.innerHTML = `
                <h2 class="section-title">权限审批</h2>
                <div>
                  <button class="btn btn-outline btn-sm" id="refresh-permissions-btn">
                    <i class="ri-refresh-line"></i> 刷新列表
                  </button>
                </div>
              `;

              // 显示管理员内容，隐藏用户内容
              document.getElementById('admin-permissions-content').style.display = 'block';
              document.getElementById('user-permissions-content').style.display = 'none';

              // 获取待审批权限列表
              fetchAdminPermissions();

              // 绑定刷新按钮事件
              const refreshBtn = document.getElementById('refresh-permissions-btn');
              if (refreshBtn) {
                refreshBtn.addEventListener('click', fetchAdminPermissions);
              }
            } else {
              // 确保菜单文本更新为"权限申请"
              const permissionMenuText = document.getElementById('permissions-menu-text');
              if (permissionMenuText) {
                permissionMenuText.textContent = '权限申请';
              }

              permissionsHeader.innerHTML = `
                <h2 class="section-title">权限申请</h2>
                <button class="btn btn-primary btn-sm" id="new-permission-btn">
                  <i class="ri-add-line"></i> 新建申请
                </button>
              `;

              // 显示用户内容，隐藏管理员内容
              document.getElementById('admin-permissions-content').style.display = 'none';
              document.getElementById('user-permissions-content').style.display = 'block';

              // 获取权限申请列表
              fetchPermissions();

              // 新建权限申请按钮
              const newPermissionBtn = document.getElementById('new-permission-btn');
              const newPermissionModal = document.getElementById('new-permission-modal');

              if (newPermissionBtn && newPermissionModal) {
                newPermissionBtn.addEventListener('click', function() {
                  newPermissionModal.style.display = 'flex';
                });
              }
            }
          } catch (e) {
            console.error("【Tab切换】解析用户信息失败:", e);
          }
        }
      } else if (tabId === 'model-publish') {
        // 模型公开申请选项卡被选中时，检查用户角色并更新界面
        const userInfoStr = localStorage.getItem('user_info');
        let isAdmin = false;

        if (userInfoStr) {
          try {
            const userInfo = JSON.parse(userInfoStr);
            isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

            // 更新权限界面
            if (isAdmin) {
              // 加载管理员待审批列表
              fetchAdminModelPublishRequests();
              document.getElementById('admin-model-publish-content').style.display = 'block';
              document.getElementById('user-model-publish-content').style.display = 'none';
            } else {
              // 加载用户申请列表
              fetchUserModelPublishRequests();
              document.getElementById('admin-model-publish-content').style.display = 'none';
              document.getElementById('user-model-publish-content').style.display = 'block';
            }
          } catch (e) {
            console.error("【Tab切换】解析用户信息失败:", e);
          }
        }
      } else if (tabId === 'profile') {
        // 加载用户资料
        loadUserProfile();
      }
    }

    // 获取控制面板统计数据
    function fetchDashboardStats() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      fetch('/api/statistics/overview', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            // token无效或过期，清除并跳转到登录页
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取统计数据失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success && data.overview) {
          const overview = data.overview;

          // 更新模型使用统计
          const modelUsage = document.getElementById('model-usage-stats');
          if (overview.totalProcessed !== undefined) {
            // 计算百分比和趋势（假设这些数据没有直接从API提供）
            const percentage = Math.min(overview.totalProcessed, 100); // 简单展示，实际应根据需求调整
            const trend = 0; // 如果API不提供趋势数据，可以省略或显示为0

            modelUsage.innerHTML = `
              <h2>${overview.totalProcessed}</h2>
              <div class="progress">
                <div class="progress-bar" style="width: ${percentage}%"></div>
              </div>
              <div class="d-flex justify-between">
                <span>模型使用次数</span>
                ${trend !== undefined ? `
                <span class="percentage ${trend < 0 ? 'negative' : ''}">
                  <i class="ri-${trend < 0 ? 'arrow-down' : 'arrow-up'}-line"></i>
                  ${Math.abs(trend)}%
                </span>
                ` : ''}
              </div>
            `;
          } else {
            modelUsage.innerHTML = '<p class="text-center">暂无数据</p>';
          }

          // 更新准确度统计
          const accuracy = document.getElementById('accuracy-stats');
          if (overview.avgAccuracy !== undefined) {
            const percentage = Math.min(overview.avgAccuracy, 100);
            const trend = 0; // 同上

            accuracy.innerHTML = `
              <h2>${overview.avgAccuracy}%</h2>
              <div class="progress">
                <div class="progress-bar" style="width: ${percentage}%"></div>
              </div>
              <div class="d-flex justify-between">
                <span>平均识别准确度</span>
                ${trend !== undefined ? `
                <span class="percentage ${trend < 0 ? 'negative' : ''}">
                  <i class="ri-${trend < 0 ? 'arrow-down' : 'arrow-up'}-line"></i>
                  ${Math.abs(trend)}%
                </span>
                ` : ''}
              </div>
            `;
          } else {
            accuracy.innerHTML = '<p class="text-center">暂无数据</p>';
          }

          // 更新处理时间统计
          const processingTime = document.getElementById('processing-time-stats');
          if (overview.avgTime !== undefined) {
            const percentage = Math.min(overview.avgTime * 10, 100); // 假设处理时间在0-10秒之间为合理范围
            const trend = 0; // 同上

            processingTime.innerHTML = `
              <h2>${overview.avgTime}s</h2>
              <div class="progress">
                <div class="progress-bar" style="width: ${percentage}%"></div>
              </div>
              <div class="d-flex justify-between">
                <span>平均处理时间</span>
                ${trend !== undefined ? `
                <span class="percentage ${trend > 0 ? 'negative' : ''}">
                  <i class="ri-${trend > 0 ? 'arrow-up' : 'arrow-down'}-line"></i>
                  ${Math.abs(trend)}%
                </span>
                ` : ''}
              </div>
            `;
          } else {
            processingTime.innerHTML = '<p class="text-center">暂无数据</p>';
          }

          // 更新数据量统计
          const dataVolume = document.getElementById('data-volume-stats');
          if (overview.totalSize !== undefined) {
            const percentage = Math.min(overview.totalSize, 100); // 根据实际情况调整
            const trend = 0; // 同上

            dataVolume.innerHTML = `
              <h2>${overview.totalSize}MB</h2>
              <div class="progress">
                <div class="progress-bar" style="width: ${percentage}%"></div>
              </div>
              <div class="d-flex justify-between">
                <span>已处理数据量</span>
                ${trend !== undefined ? `
                <span class="percentage">
                  <i class="ri-arrow-up-line"></i>
                  ${trend}%
                </span>
                ` : ''}
              </div>
            `;
          } else {
            dataVolume.innerHTML = '<p class="text-center">暂无数据</p>';
          }
        } else {
          // 显示所有统计无数据状态
          document.getElementById('model-usage-stats').innerHTML = '<p class="text-center">暂无数据</p>';
          document.getElementById('accuracy-stats').innerHTML = '<p class="text-center">暂无数据</p>';
          document.getElementById('processing-time-stats').innerHTML = '<p class="text-center">暂无数据</p>';
          document.getElementById('data-volume-stats').innerHTML = '<p class="text-center">暂无数据</p>';
        }
      })
      .catch(error => {
        console.error('获取统计数据出错:', error);
        // 显示错误状态
        document.getElementById('model-usage-stats').innerHTML = '<p class="text-danger">加载失败</p>';
        document.getElementById('accuracy-stats').innerHTML = '<p class="text-danger">加载失败</p>';
        document.getElementById('processing-time-stats').innerHTML = '<p class="text-danger">加载失败</p>';
        document.getElementById('data-volume-stats').innerHTML = '<p class="text-danger">加载失败</p>';
      });
    }

    function initUploadFeatures() {
      console.log("初始化上传功能...");

      // 上传功能标签切换
      const uploadTabLinks = document.querySelectorAll('.tab-link[data-tab^="upload-"]');
      const uploadTabContents = document.querySelectorAll('#upload-tab .tab-content');

      console.log("上传标签数:", uploadTabLinks.length);
      console.log("上传内容区域数:", uploadTabContents.length);

      // 强制清除所有标签激活状态，避免多条激活线问题
      console.log("初始化时清除所有目标检测子标签状态");
      uploadTabLinks.forEach(tab => tab.classList.remove('active'));

      // 添加激活状态到图像识别标签
      const defaultUploadTab = document.querySelector('.tab-link[data-tab="upload-image"]');
      if (defaultUploadTab) {
        defaultUploadTab.classList.add('active');

        // 显示对应内容
        uploadTabContents.forEach(content => content.classList.remove('active'));

        const defaultContent = document.getElementById('upload-image-content');
        if (defaultContent) {
          defaultContent.classList.add('active');
          loadModelList();
          console.log("初始化时激活默认上传图像内容区域");
        } else {
          console.error("找不到上传图像内容区域");
        }
      } else {
        console.error("找不到图像识别标签");
      }

      // 添加标签切换事件
      uploadTabLinks.forEach(link => {
        link.addEventListener('click', function() {
          // 记录切换前的标签
          const currentActiveTab = document.querySelector('.tab-link[data-tab^="upload-"].active');
          const prevTabId = currentActiveTab ? currentActiveTab.getAttribute('data-tab') : null;

          // 移除所有标签页的激活状态
          uploadTabLinks.forEach(tab => tab.classList.remove('active'));
          // 添加当前标签页的激活状态
          this.classList.add('active');

          // 获取要显示的内容ID
          const tabId = this.getAttribute('data-tab');
          const contentId = `${tabId}-content`;

          // 如果是切换到不同的上传类型标签，重置表单
          if (prevTabId && prevTabId !== tabId) {
            console.log(`从${prevTabId}切换到${tabId}，重置表单`);
            resetUploadForms();
          }

          // 隐藏所有内容
          uploadTabContents.forEach(content => content.classList.remove('active'));

          // 显示当前内容
          const currentContent = document.getElementById(contentId);
          if (currentContent) {
            currentContent.classList.add('active');

            // 根据不同标签加载不同内容
            if (tabId === 'upload-image') {
              // 图像处理标签
              loadModelList();
            } else if (tabId === 'upload-video') {
              // 视频处理标签
              loadVideoModelList();
            } else if (tabId === 'upload-realtime') {
              // 实时监测标签 - 加载实时监测相关内容
              loadRealtimeModelList();
              console.log("切换到实时监测标签");
            }
          }
        });
      });

      // 添加单张/批量处理按钮事件监听
      // 图像处理模式切换
      const singleUploadModeBtn = document.getElementById('single-upload-mode');
      const batchUploadModeBtn = document.getElementById('batch-upload-mode');
      const selectImageBtnText = document.getElementById('select-image-btn-text');
      const imagePreview = document.getElementById('image-preview');
      const batchImagePreview = document.getElementById('batch-image-preview');

      if (singleUploadModeBtn && batchUploadModeBtn) {
        // 单张处理按钮点击事件
        singleUploadModeBtn.addEventListener('click', function() {
          console.log("切换到单张图像处理模式");
          singleUploadModeBtn.classList.add('active');
          batchUploadModeBtn.classList.remove('active');

          // 切换输入元素
          imageInput.style.display = '';
          batchImageInput.style.display = 'none';

          // 更新按钮文本
          if (selectImageBtnText) {
            selectImageBtnText.textContent = '选择图像';
          }

          // 如果已上传图片，显示单张预览
          if (imageInput.files && imageInput.files.length > 0) {
            imagePreview.style.display = 'block';
            batchImagePreview.style.display = 'none';
          } else {
            // 如果未上传，隐藏所有预览
            imagePreview.style.display = 'none';
            batchImagePreview.style.display = 'none';
          }

          // 重置处理结果区域
          document.getElementById('processing-progress').style.display = 'none';
          document.getElementById('process-result').style.display = 'none';

          // 重置处理进度状态
          document.getElementById('step-processing').classList.remove('active', 'completed');
          document.getElementById('step-complete').classList.remove('active', 'completed');
          document.getElementById('process-progress-bar').style.width = '33%';
          document.getElementById('process-status-text').textContent = '正在处理图像数据...';

          // 隐藏所有结果显示区域
          document.getElementById('single-result-display').style.display = 'none';
          document.getElementById('batch-results-display').style.display = 'none';

          // 清空结果容器
          const batchResultsContainer = document.getElementById('batch-results-container');
          if (batchResultsContainer) {
            batchResultsContainer.innerHTML = '';
          }
        });

        // 批量处理按钮点击事件
        batchUploadModeBtn.addEventListener('click', function() {
          console.log("切换到批量图像处理模式");
          batchUploadModeBtn.classList.add('active');
          singleUploadModeBtn.classList.remove('active');

          // 切换输入元素
          imageInput.style.display = 'none';
          batchImageInput.style.display = '';

          // 更新按钮文本
          if (selectImageBtnText) {
            selectImageBtnText.textContent = '选择多张图像';
          }

          // 如果已上传图片，显示批量预览
          if (batchImageInput.files && batchImageInput.files.length > 0) {
            imagePreview.style.display = 'none';
            batchImagePreview.style.display = 'block';
          } else {
            // 如果未上传，隐藏所有预览
            imagePreview.style.display = 'none';
            batchImagePreview.style.display = 'none';
          }

          // 重置处理结果区域
          document.getElementById('processing-progress').style.display = 'none';
          document.getElementById('process-result').style.display = 'none';

          // 重置处理进度状态
          document.getElementById('step-processing').classList.remove('active', 'completed');
          document.getElementById('step-complete').classList.remove('active', 'completed');
          document.getElementById('process-progress-bar').style.width = '33%';
          document.getElementById('process-status-text').textContent = '正在处理图像数据...';

          // 隐藏所有结果显示区域
          document.getElementById('single-result-display').style.display = 'none';
          document.getElementById('batch-results-display').style.display = 'none';

          // 清空结果容器
          const batchResultsContainer = document.getElementById('batch-results-container');
          if (batchResultsContainer) {
            batchResultsContainer.innerHTML = '';
          }

          // 确保批量处理模式下也加载模型列表
          loadModelList();
        });
      }

      // 视频处理模式切换
      const singleVideoModeBtn = document.getElementById('single-video-mode');
      const batchVideoModeBtn = document.getElementById('batch-video-mode');
      const videoInput = document.getElementById('video-input');
      const batchVideoInput = document.getElementById('batch-video-input');
      const selectVideoBtnText = document.getElementById('select-video-btn-text');
      const videoPreview = document.getElementById('video-preview');
      const batchVideoPreview = document.getElementById('batch-video-preview');

      if (singleVideoModeBtn && batchVideoModeBtn) {
        // 单个处理按钮点击事件
        singleVideoModeBtn.addEventListener('click', function() {
          console.log("切换到单个视频处理模式");
          singleVideoModeBtn.classList.add('active');
          batchVideoModeBtn.classList.remove('active');

          // 切换输入元素
          videoInput.style.display = '';
          batchVideoInput.style.display = 'none';

          // 更新按钮文本
          if (selectVideoBtnText) {
            selectVideoBtnText.textContent = '选择视频';
          }

          // 如果已上传视频，显示单个预览
          if (videoInput.files && videoInput.files.length > 0) {
            videoPreview.style.display = 'block';
            batchVideoPreview.style.display = 'none';
          } else {
            // 如果未上传，隐藏所有预览
            videoPreview.style.display = 'none';
            batchVideoPreview.style.display = 'none';
          }

          // 重置视频处理结果区域
          document.getElementById('video-processing-progress').style.display = 'none';
          document.getElementById('video-process-result').style.display = 'none';

          // 重置视频处理进度状态
          document.getElementById('video-step-processing').classList.remove('active', 'completed');
          document.getElementById('video-step-complete').classList.remove('active', 'completed');
          document.getElementById('video-process-progress-bar').style.width = '33%';
          document.getElementById('video-process-status-text').textContent = '正在处理视频数据...';

          // 隐藏所有视频结果显示区域
          document.getElementById('single-video-result-display').style.display = 'none';
          document.getElementById('batch-video-results-display').style.display = 'none';

          // 清空视频结果容器
          const batchVideoResultsContainer = document.getElementById('batch-video-results-container');
          if (batchVideoResultsContainer) {
            batchVideoResultsContainer.innerHTML = '';
          }
        });

        // 批量处理按钮点击事件
        batchVideoModeBtn.addEventListener('click', function() {
          console.log("切换到批量视频处理模式");
          batchVideoModeBtn.classList.add('active');
          singleVideoModeBtn.classList.remove('active');

          // 切换输入元素
          videoInput.style.display = 'none';
          batchVideoInput.style.display = '';

          // 更新按钮文本
          if (selectVideoBtnText) {
            selectVideoBtnText.textContent = '选择多个视频';
          }

          // 如果已上传视频，显示批量预览
          if (batchVideoInput.files && batchVideoInput.files.length > 0) {
            videoPreview.style.display = 'none';
            batchVideoPreview.style.display = 'block';
          } else {
            // 如果未上传，隐藏所有预览
            videoPreview.style.display = 'none';
            batchVideoPreview.style.display = 'none';
          }

          // 重置视频处理结果区域
          document.getElementById('video-processing-progress').style.display = 'none';
          document.getElementById('video-process-result').style.display = 'none';

          // 重置视频处理进度状态
          document.getElementById('video-step-processing').classList.remove('active', 'completed');
          document.getElementById('video-step-complete').classList.remove('active', 'completed');
          document.getElementById('video-process-progress-bar').style.width = '33%';
          document.getElementById('video-process-status-text').textContent = '正在处理视频数据...';

          // 隐藏所有视频结果显示区域
          document.getElementById('single-video-result-display').style.display = 'none';
          document.getElementById('batch-video-results-display').style.display = 'none';

          // 清空视频结果容器
          const batchVideoResultsContainer = document.getElementById('batch-video-results-container');
          if (batchVideoResultsContainer) {
            batchVideoResultsContainer.innerHTML = '';
          }

          // 确保批量处理模式下也加载视频模型列表
          loadVideoModelList();
        });
      }

      function selectImageBtnClickHandler(e) {
        e.stopPropagation();
        console.log('点击选择图像按钮');
        if (batchUploadModeBtn.classList.contains('active')) {
          batchImageInput.value = '';
          batchImageInput.click();
        } else {
          imageInput.value = '';
          imageInput.click();
        }
      }
      if (selectImageBtn) {
        selectImageBtn.removeEventListener('click', selectImageBtnClickHandler);
        selectImageBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          imageInput.value = '';
          selectImageBtnClickHandler(e);
        });
      }

      // 修改选择视频按钮点击逻辑，根据当前模式点击对应的输入
      const selectVideoBtn = document.getElementById('select-video-btn');
      if (selectVideoBtn) {
        selectVideoBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          // 判断当前模式
          if (batchVideoModeBtn.classList.contains('active')) {
            // 批量模式
            batchVideoInput.click();
          } else {
            // 单个模式
            videoInput.click();
          }
        });
      }

      // 立即加载图像模型列表，确保下拉菜单中有数据
      loadModelList();
    }

    // 图像上传功能实现
    const imageDropzone = document.getElementById('image-dropzone');
    const imageInput = document.getElementById('image-input');
    const selectImageBtn = document.getElementById('select-image-btn');
    const batchImageInput = document.getElementById('batch-image-input');

    // 修改批量图片处理逻辑
    if (batchImageInput) {
      batchImageInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
          handleBatchImages(this.files);
        }
      });
    }

    // 添加处理批量图片的函数
    function handleBatchImages(files) {
      console.log(`处理${files.length}张批量图片`);
      const batchPreview = document.getElementById('batch-image-preview');
      const batchContainer = document.getElementById('batch-images-container');
      const batchCount = document.getElementById('batch-image-count');

      if (batchPreview && batchContainer && batchCount) {
        // 更新计数
        batchCount.textContent = files.length;

        // 清空现有预览
        batchContainer.innerHTML = '';

        // 创建一个FileList的数组副本，因为原始FileList对象不可修改
        const fileArray = Array.from(files);

        // 为每个文件创建预览
        for (let i = 0; i < fileArray.length; i++) {
          const file = fileArray[i];

          // 创建预览元素
          const previewItem = document.createElement('div');
          previewItem.className = 'batch-image-item';
          previewItem.setAttribute('data-index', i);

          // 读取文件并显示预览
          const reader = new FileReader();
          reader.onload = function(e) {
            previewItem.innerHTML = `
              <img src="${e.target.result}" alt="预览图 ${i+1}">
              <div class="batch-image-name">${file.name}</div>
              <button type="button" class="delete-batch-item" data-index="${i}">
                <i class="ri-close-line"></i>
              </button>
            `;

            // 添加删除按钮的点击事件
            const deleteBtn = previewItem.querySelector('.delete-batch-item');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.getAttribute('data-index'));

                // 从数组中移除文件
                fileArray.splice(index, 1);

                // 重新处理所有文件，更新预览
                handleBatchImagesArray(fileArray);

                // 如果没有文件了，隐藏预览区域
                if (fileArray.length === 0) {
                  batchPreview.style.display = 'none';
                }
              });
            }
          };
          reader.readAsDataURL(file);

          // 添加到容器
          batchContainer.appendChild(previewItem);
        }

        // 更新批量图片输入的文件
        updateBatchImageInput(fileArray);

        // 显示批量预览区域
        batchPreview.style.display = 'block';

        // 加载模型列表
        loadModelList();
      }
    }

    // 处理文件数组的辅助函数
    function handleBatchImagesArray(fileArray) {
      const batchPreview = document.getElementById('batch-image-preview');
      const batchContainer = document.getElementById('batch-images-container');
      const batchCount = document.getElementById('batch-image-count');

      if (!fileArray || fileArray.length === 0) {
        if (batchPreview) batchPreview.style.display = 'none';
        if (batchCount) batchCount.textContent = '0';
        if (batchContainer) batchContainer.innerHTML = '';
        return;
      }

      if (batchPreview && batchContainer && batchCount) {
        // 更新计数
        batchCount.textContent = fileArray.length;

        // 清空现有预览
        batchContainer.innerHTML = '';

        // 为每个文件创建预览
        for (let i = 0; i < fileArray.length; i++) {
          const file = fileArray[i];

          // 创建预览元素
          const previewItem = document.createElement('div');
          previewItem.className = 'batch-image-item';
          previewItem.setAttribute('data-index', i);

          // 读取文件并显示预览
          const reader = new FileReader();
          reader.onload = function(e) {
            previewItem.innerHTML = `
              <img src="${e.target.result}" alt="预览图 ${i+1}">
              <div class="batch-image-name">${file.name}</div>
              <button type="button" class="delete-batch-item" data-index="${i}">
                <i class="ri-close-line"></i>
              </button>
            `;

            // 添加删除按钮的点击事件
            const deleteBtn = previewItem.querySelector('.delete-batch-item');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(this.getAttribute('data-index'));

                // 从数组中移除文件
                fileArray.splice(index, 1);

                // 重新处理所有文件，更新预览
                handleBatchImagesArray(fileArray);

                // 如果没有文件了，隐藏预览区域
                if (fileArray.length === 0) {
                  batchPreview.style.display = 'none';
                }
              });
            }
          };
          reader.readAsDataURL(file);

          // 添加到容器
          batchContainer.appendChild(previewItem);
        }

        // 更新批量图片输入的文件
        updateBatchImageInput(fileArray);

        // 显示批量预览区域
        batchPreview.style.display = 'block';
      }
    }

    // 更新批量图片输入的文件
    function updateBatchImageInput(fileArray) {
      if (!batchImageInput) return;

      // 创建一个新的DataTransfer对象（HTML5 API）
      const dataTransfer = new DataTransfer();

      // 将文件添加到DataTransfer对象
      fileArray.forEach(file => {
        dataTransfer.items.add(file);
      });

      // 设置input的文件为DataTransfer的文件列表
      batchImageInput.files = dataTransfer.files;
    }

    // 添加移除批量图片的功能
    const removeBatchImagesBtn = document.getElementById('remove-batch-images');
    if (removeBatchImagesBtn) {
      removeBatchImagesBtn.addEventListener('click', function() {
        const batchPreview = document.getElementById('batch-image-preview');
        const batchContainer = document.getElementById('batch-images-container');
        const batchCount = document.getElementById('batch-image-count');

        // 清空文件选择
        if (batchImageInput) batchImageInput.value = '';

        // 清空预览容器
        if (batchContainer) batchContainer.innerHTML = '';

        // 重置计数
        if (batchCount) batchCount.textContent = '0';

        // 隐藏预览区域
        if (batchPreview) batchPreview.style.display = 'none';
      });
    }

    // 加载图像模型列表
    function loadModelList() {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modelSelect = document.getElementById('model-select');
      const batchModelSelect = document.getElementById('batch-model-select'); // 添加批量处理的模型选择器

      fetch('/api/models', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('获取模型列表失败');
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.models && data.models.length > 0) {
          // 更新单张处理的模型选择下拉菜单
          if (modelSelect) {
            // 清空现有选项，保留第一个默认选项
            while (modelSelect.options.length > 1) {
              modelSelect.remove(1);
            }

            // 添加新选项
            data.models.forEach(model => {
              const option = document.createElement('option');
              option.value = model.id;
              option.textContent = model.name;
              modelSelect.appendChild(option);
            });
          }

          // 更新批量处理的模型选择下拉菜单
          if (batchModelSelect) {
            // 清空现有选项，保留第一个默认选项
            while (batchModelSelect.options.length > 1) {
              batchModelSelect.remove(1);
            }

            // 如果没有默认选项，则添加一个
            if (batchModelSelect.options.length === 0) {
              const defaultOption = document.createElement('option');
              defaultOption.value = "";
              defaultOption.textContent = "--请选择模型--";
              batchModelSelect.appendChild(defaultOption);
            }

            // 添加新选项
            data.models.forEach(model => {
              const option = document.createElement('option');
              option.value = model.id;
              option.textContent = model.name;
              batchModelSelect.appendChild(option);
            });
          }
        } else {
          console.warn('未获取到任何模型');

          if (modelSelect) {
            modelSelect.innerHTML = '<option value="">--没有可用模型--</option>';
          }

          if (batchModelSelect) {
            batchModelSelect.innerHTML = '<option value="">--没有可用模型--</option>';
          }
        }
      })
      .catch(error => {
        console.error('加载模型列表出错:', error);

        if (modelSelect) {
          modelSelect.innerHTML = '<option value="">加载失败，请重试</option>';
        }

        if (batchModelSelect) {
          batchModelSelect.innerHTML = '<option value="">加载失败，请重试</option>';
        }
      });
    }

    // 加载视频模型列表
    function loadVideoModelList() {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const videoModelSelect = document.getElementById('video-model-select');
      const batchVideoModelSelect = document.getElementById('batch-video-model-select'); // 添加批量处理模型选择

      if (!videoModelSelect && !batchVideoModelSelect) return;

      // 显示加载中
      if (videoModelSelect) videoModelSelect.innerHTML = '<option value="">加载中...</option>';
      if (batchVideoModelSelect) batchVideoModelSelect.innerHTML = '<option value="">加载中...</option>';

      fetch('/api/models?supports_video=true', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('获取模型列表失败');
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.models && data.models.length > 0) {
          // 过滤支持视频的模型
          const videoModels = data.models.filter(model => model.supports_video);

          // 更新单个视频处理的模型选择
          if (videoModelSelect) {
            // 清空现有选项
            videoModelSelect.innerHTML = '';

            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '--请选择模型--';
            videoModelSelect.appendChild(defaultOption);

            // 添加模型选项
            if (videoModels.length > 0) {
              videoModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                videoModelSelect.appendChild(option);
              });
            } else {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = '暂无支持视频的模型';
              videoModelSelect.appendChild(option);
            }
          }

          // 更新批量视频处理的模型选择
          if (batchVideoModelSelect) {
            // 清空现有选项
            batchVideoModelSelect.innerHTML = '';

            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '--请选择模型--';
            batchVideoModelSelect.appendChild(defaultOption);

            // 添加模型选项
            if (videoModels.length > 0) {
              videoModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                batchVideoModelSelect.appendChild(option);
              });
            } else {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = '暂无支持视频的模型';
              batchVideoModelSelect.appendChild(option);
            }
          }
        } else {
          if (videoModelSelect) videoModelSelect.innerHTML = '<option value="">暂无可用模型</option>';
          if (batchVideoModelSelect) batchVideoModelSelect.innerHTML = '<option value="">暂无可用模型</option>';
        }
      })
      .catch(error => {
        console.error('加载视频模型列表出错:', error);
        if (videoModelSelect) videoModelSelect.innerHTML = '<option value="">加载失败，请重试</option>';
        if (batchVideoModelSelect) batchVideoModelSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      });
    }

    // 初始加载模型列表
    loadModelList();
    // 初始加载视频模型列表
    loadVideoModelList();

    // 添加文件拖放功能
    if (imageDropzone && imageInput) {
      // 阻止拖放默认行为
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageDropzone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // 添加高亮效果
      ['dragenter', 'dragover'].forEach(eventName => {
        imageDropzone.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        imageDropzone.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        imageDropzone.classList.add('dragover');
      }

      function unhighlight() {
        imageDropzone.classList.remove('dragover');
      }

      // 处理文件放置
      imageDropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const files = e.dataTransfer.files;
        if (files.length) {
          imageInput.files = files; // 只在这里赋值
          handleFiles(files);
        }
      }, false);

      // 处理文件选择变更
      imageInput.addEventListener('change', function() {
        if (this.files.length) {
          handleFiles(this.files);
        }
      });

      function handleFiles(files) {
        const file = files[0];
        const preview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');

        // 显示预览
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;

          // 确保图像加载完成，防止处理中断
          previewImg.onload = function() {
            console.log("图像预览已完全加载");
          };
        };
        reader.readAsDataURL(file);

        // 显示预览区域，隐藏上传区域
        preview.style.display = 'block';
        //imageDropzone.style.display = 'none';

        // 重新加载模型列表，确保模型选择下拉菜单有数据
        loadModelList();
      }

      // 移除图像按钮
      const removeImageBtn = document.getElementById('remove-image');
      if (removeImageBtn) {
        removeImageBtn.addEventListener('click', function() {
          const preview = document.getElementById('image-preview');

          // 清除文件选择
          imageInput.value = '';

          // 隐藏预览，显示上传区域
          preview.style.display = 'none';
          //imageDropzone.style.display = 'block';
        });
      }
    }

    // 视频上传功能实现
    const videoDropzone = document.getElementById('video-dropzone');
    const videoInput = document.getElementById('video-input');
    const selectVideoBtn = document.getElementById('select-video-btn');
    const batchVideoInput = document.getElementById('batch-video-input');

    // 修改批量视频处理逻辑
    if (batchVideoInput) {
      batchVideoInput.addEventListener('change', function() {
        if (this.files && this.files.length > 0) {
          handleBatchVideos(this.files);
        }
      });
    }

    // 添加处理批量视频的函数
    function handleBatchVideos(files) {
      console.log(`处理${files.length}个批量视频`);
      const batchPreview = document.getElementById('batch-video-preview');
      const batchContainer = document.getElementById('batch-videos-container');
      const batchCount = document.getElementById('batch-video-count');

      if (batchPreview && batchContainer && batchCount) {
        // 更新计数
        batchCount.textContent = files.length;

        // 清空现有预览
        batchContainer.innerHTML = '';

        // 为每个文件创建预览
        for (let i = 0; i < files.length; i++) {
          const file = files[i];

          // 创建预览元素
          const previewItem = document.createElement('div');
          previewItem.className = 'batch-video-item';

          // 创建视频预览（使用文件URL）
          const videoURL = URL.createObjectURL(file);
          let ext = videoURL.split('.').pop().toLowerCase();
          let type = 'video/mp4';
          if (ext === 'avi') type = 'video/avi';
          else if (ext === 'mov') type = 'video/quicktime';
          previewItem.innerHTML = `
            <div class="batch-video-preview">
              <video src="${videoURL}" controls muted style="width: 100%; height: 120px;" type="${type}"></video>
              <div class="batch-video-name">${file.name}</div>
            </div>
          `;

          // 添加到容器
          batchContainer.appendChild(previewItem);
        }

        // 确保文件被正确赋值给input元素
        // 这是修复需要上传两次的关键
        try {
          console.log("确保批量视频文件被正确赋值给input元素");
          const batchVideoInput = document.getElementById('batch-video-input');
          if (batchVideoInput && window.DataTransfer) {
            // 创建一个新的DataTransfer对象
            const dataTransfer = new DataTransfer();

            // 添加所有文件
            for (let i = 0; i < files.length; i++) {
              dataTransfer.items.add(files[i]);
            }

            // 将文件列表赋值给input元素
            batchVideoInput.files = dataTransfer.files;
          } else {
            // 对于不支持DataTransfer的浏览器，保留原始files
            console.log("使用原始files引用");
          }
        } catch(e) {
          console.error("批量视频文件处理错误:", e);
        }

        // 显示批量预览区域
        batchPreview.style.display = 'block';

        // 加载模型列表
        loadVideoModelList();
      }
    }

    // 添加移除批量视频的功能
    const removeBatchVideosBtn = document.getElementById('remove-batch-videos');
    if (removeBatchVideosBtn) {
      removeBatchVideosBtn.addEventListener('click', function() {
        const batchPreview = document.getElementById('batch-video-preview');
        const batchContainer = document.getElementById('batch-videos-container');
        const batchCount = document.getElementById('batch-video-count');

        // 清空文件选择
        if (batchVideoInput) batchVideoInput.value = '';

        // 从DOM中移除所有视频元素前，清除URL对象
        if (batchContainer) {
          const videos = batchContainer.querySelectorAll('video');
          videos.forEach(video => {
            if (video.src) {
              URL.revokeObjectURL(video.src);
            }
          });

          // 清空预览容器
          batchContainer.innerHTML = '';
        }

        // 重置计数
        if (batchCount) batchCount.textContent = '0';

        // 隐藏预览区域
        if (batchPreview) batchPreview.style.display = 'none';
      });
    }

    // 视频拖放功能
    if (videoDropzone && videoInput) {
      // 阻止拖放默认行为
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        videoDropzone.addEventListener(eventName, preventVideoDrop, false);
      });

      function preventVideoDrop(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // 添加高亮效果
      ['dragenter', 'dragover'].forEach(eventName => {
        videoDropzone.addEventListener(eventName, highlightVideo, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        videoDropzone.addEventListener(eventName, unhighlightVideo, false);
      });

      function highlightVideo() {
        videoDropzone.classList.add('dragover');
      }

      function unhighlightVideo() {
        videoDropzone.classList.remove('dragover');
      }

      // 处理文件放置
      videoDropzone.addEventListener('drop', handleVideoDrop, false);

      function handleVideoDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length) {
          videoInput.files = files;
          handleVideoFiles(files);
        }
      }

      // 处理文件选择变更
      videoInput.addEventListener('change', function() {
        if (this.files.length) {
          handleVideoFiles(this.files);
        }
      });

      function handleVideoFiles(files) {
        const file = files[0];
        const preview = document.getElementById('video-preview');
        const previewVideo = document.getElementById('preview-video');

        // 检查文件类型是否为视频
        const fileType = file.type.split('/')[0];
        if (fileType !== 'video') {
          showToast('请选择视频文件', 'warning');
          videoInput.value = '';
          return;
        }

        // 检查文件大小是否超过限制 (100MB)
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
          showToast('视频文件大小不能超过100MB', 'warning');
          videoInput.value = '';
          return;
        }

        // 显示预览
        const videoURL = URL.createObjectURL(file);
        previewVideo.src = videoURL;

        // 添加加载事件，确保视频元数据正确加载
        previewVideo.onloadedmetadata = function() {
          console.log("视频元数据已加载");

          // 设置视频结束时间输入框的默认值为视频持续时间
          const videoEndTimeInput = document.getElementById('video-end-time');
          if (videoEndTimeInput && previewVideo.duration) {
            videoEndTimeInput.value = Math.floor(previewVideo.duration);
          }

          // 显示预览区域
          preview.style.display = 'block';

          // 加载视频模型列表
          loadVideoModelList();
        };

        // 添加错误处理
        previewVideo.onerror = function(e) {
          console.error("视频加载错误:", e);
          showToast('视频加载失败，请选择其他格式', 'error');
          videoInput.value = '';
        };

        // 确保文件被正确赋值给input元素
        try {
          console.log("确保视频文件被正确赋值给input元素");
          const videoInput = document.getElementById('video-input');
          if (videoInput && window.DataTransfer) {
            // 创建一个新的DataTransfer对象
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            // 将文件列表赋值给input元素
            videoInput.files = dataTransfer.files;
          } else {
            // 对于不支持DataTransfer的浏览器，保留原始files
            console.log("使用原始files引用");
          }
        } catch(e) {
          console.error("视频文件处理错误:", e);
        }
      }

      // 移除视频按钮
      const removeVideoBtn = document.getElementById('remove-video');
      if (removeVideoBtn) {
        removeVideoBtn.addEventListener('click', function() {
          const preview = document.getElementById('video-preview');
          const previewVideo = document.getElementById('preview-video');

          // 清除视频URL对象
          if (previewVideo.src) {
            URL.revokeObjectURL(previewVideo.src);
            previewVideo.src = '';
          }

          // 清除文件选择
          videoInput.value = '';

          // 隐藏预览
          preview.style.display = 'none';
        });
      }
    }

    // 处理视频表单提交
    const videoProcessForm = document.getElementById('video-process-form');
    if (videoProcessForm) {
      videoProcessForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const videoModelSelect = document.getElementById('video-model-select');
        const videoInput = document.getElementById('video-input');

        if (!videoModelSelect.value) {
          showToast('请选择识别模型', 'warning');
          return;
        }

        if (!videoInput.files || videoInput.files.length === 0) {
          showToast('请先上传视频', 'warning');
          return;
        }

        // 显示处理进度
        document.getElementById('video-processing-progress').style.display = 'block';
        document.getElementById('video-step-processing').classList.add('active');
        document.getElementById('video-progress-bar').style.width = '33%';
        document.getElementById('video-status-text').textContent = '正在上传视频...';

        // 禁用提交按钮防止重复提交
        document.getElementById('process-video-btn').disabled = true;

        // 首先上传视频
        const formData = new FormData();
        const videoFile = videoInput.files[0];
        formData.append('file', videoFile);

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 第一步：上传视频
        fetch('/api/videos/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('视频上传失败: ' + response.statusText);
          }
          return response.json();
        })
        .then(uploadData => {
          if (uploadData.success) {
            document.getElementById('video-progress-bar').style.width = '50%';
            document.getElementById('video-status-text').textContent = '正在处理视频...';

            // 获取开始和结束时间
            const startTime = parseFloat(document.getElementById('video-start-time').value || 0);
            const endTime = parseFloat(document.getElementById('video-end-time').value || 0);

            // 准备处理请求数据
            const processData = {
              videoId: uploadData.video.id,
              modelId: videoModelSelect.value,
              startTime: startTime,
              endTime: endTime > startTime ? endTime : null,
              remark: document.getElementById('video-remark').value || ''
            };

            // 第二步：处理视频
            return fetch('/api/videos/process', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(processData)
            });
          } else {
            throw new Error(uploadData.message || '视频上传失败');
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('视频处理请求失败: ' + response.statusText);
          }
          return response.json();
        })
        .then(processData => {
          if (processData.success) {
            // 不再需要轮询处理状态，改为直接显示结果
            const result = processData.result;

            // 更新UI状态
            document.getElementById('video-step-processing').classList.add('completed');
            document.getElementById('video-step-complete').classList.add('active');
            document.getElementById('video-step-complete').classList.add('completed');
            document.getElementById('video-progress-bar').style.width = '100%';
            document.getElementById('video-status-text').textContent = '处理完成';

            // 显示结果区域
            document.getElementById('video-result').style.display = 'block';

            // 单视频结果显示
            document.getElementById('single-video-result-display').style.display = 'block';
            document.getElementById('batch-video-results-display').style.display = 'none';

            // 显示主按钮
            const mainButtonsElement = document.getElementById('video-result-main-buttons');
            if (mainButtonsElement) {
              mainButtonsElement.style.display = 'flex';
            }

            // 设置结果视频
            if (result.staticUrl) {
              const resultVideo = document.getElementById('result-video');

              // 处理视频URL
              let videoUrl = result.staticUrl;

              // 如果URL是以/static开头，需要加上基础URL
              if (videoUrl.startsWith('/static/')) {
                // 添加当前域名作为基础URL
                const baseUrl = window.location.origin;
                videoUrl = baseUrl + videoUrl;
                console.log('转换后的视频URL:', videoUrl);
              }

              resultVideo.src = videoUrl;
              resultVideo.style.display = 'block';

              // 加载视频
              resultVideo.load();

              // 添加加载和错误事件处理
              resultVideo.addEventListener('loadeddata', function() {
                console.log('结果视频加载成功');
              });

              resultVideo.addEventListener('error', function(e) {
                console.error('视频加载失败:', e);
                console.error('失败的视频URL:', videoUrl);
                console.error('原始staticUrl:', result.staticUrl);
                showToast('视频加载失败，请刷新页面重试', 'error');
              });

              // 展示处理结果信息
              document.getElementById('video-result-accuracy').textContent =
                result.accuracy ? `${result.accuracy.toFixed(2)}%` : 'N/A';

              document.getElementById('video-result-time').textContent =
                result.processingTime ? `${result.processingTime.toFixed(2)}秒` : 'N/A';

              document.getElementById('video-result-categories').textContent =
                (result.categories && result.categories.length > 0) ?
                result.categories.join(', ') : '未检测到分类';

              document.getElementById('video-result-objects').textContent =
                result.objectCount !== undefined ? result.objectCount : '0';

              // 保存结果ID用于下载
              document.getElementById('download-video-result').setAttribute('data-id', result.id);
              // 保存结果ID用于查看详情
              document.getElementById('view-video-details').setAttribute('data-id', result.id);

              console.log(`设置视频ID: ${result.id} 用于下载和查看`);

              showToast('视频处理成功', 'success');

              // 刷新相关数据
              fetchRecentHistory();
              fetchDashboardStats();
            } else {
              console.error('没有可用的结果视频URL');
              showToast('视频处理完成，但未能获取结果URL', 'warning');
            }
          } else {
            throw new Error(processData.message || '视频处理失败');
          }
        })
        .catch(error => {
          console.error('处理视频出错:', error);
          document.getElementById('video-status-text').textContent = '处理失败: ' + error.message;
          document.getElementById('video-progress-bar').style.width = '33%';
          document.getElementById('video-step-processing').classList.remove('active', 'completed');
          document.getElementById('video-step-complete').classList.remove('active', 'completed');
          showToast('处理失败: ' + error.message, 'error');
        });
      });
    }

    // 处理批量视频表单提交
    const batchVideoProcessForm = document.getElementById('batch-video-process-form');
    if (batchVideoProcessForm) {
      batchVideoProcessForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // 强制隐藏主按钮区域
        const mainButtonsElement = document.getElementById('video-result-main-buttons');
        if (mainButtonsElement) {
          mainButtonsElement.style.display = 'none';
        }

        const batchVideoModelSelect = document.getElementById('batch-video-model-select');
        const batchVideoInput = document.getElementById('batch-video-input');
        const batchVideoStartTime = document.getElementById('batch-video-start-time');
        const batchVideoEndTime = document.getElementById('batch-video-end-time');

        // 验证选择了模型
        if (!batchVideoModelSelect.value) {
          showToast('请选择识别模型', 'warning');
          return;
        }

        // 验证选择了视频文件
        if (!batchVideoInput.files || batchVideoInput.files.length === 0) {
          showToast('请先上传视频', 'warning');
          return;
        }

        // 验证时间范围
        const startTime = parseFloat(batchVideoStartTime.value) || 0;
        let endTime = null;
        if (batchVideoEndTime.value) {
          endTime = parseFloat(batchVideoEndTime.value);
          if (endTime <= startTime) {
            showToast('结束时间必须大于开始时间', 'warning');
            return;
          }
        }

        // 显示处理进度
        document.getElementById('video-processing-progress').style.display = 'block';
        document.getElementById('video-step-processing').classList.add('active');
        document.getElementById('video-progress-bar').style.width = '33%';
        document.getElementById('video-status-text').textContent = '正在上传视频...';

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 保存原始视频名映射
        const originalVideoNames = {};
        Array.from(batchVideoInput.files).forEach((file, index) => {
          originalVideoNames[index] = file.name;
        });
        window.batchOriginalVideoNames = originalVideoNames;

        // 首先上传所有视频
        const uploadPromises = [];
        const videoIds = [];
        const files = Array.from(batchVideoInput.files);
        const totalFiles = files.length;
        let completedUploads = 0;

        // 遍历所有选择的文件，逐个上传
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileFormData = new FormData();
          fileFormData.append('file', file);

          const uploadPromise = fetch('/api/videos/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: fileFormData
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`上传视频 ${file.name} 失败: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            completedUploads++;
            // 更新上传进度
            const progress = Math.floor((completedUploads / totalFiles) * 100 * 0.5);
            document.getElementById('video-status-text').textContent =
              `正在上传视频 (${completedUploads}/${totalFiles})`;
            document.getElementById('video-progress-bar').style.width = `${50 + progress/2}%`;

            if (data.success && data.video && data.video.id) {
              // 收集成功上传的视频ID
              videoIds.push(data.video.id);
              return data.video;
            } else {
              throw new Error(data.message || `上传视频 ${file.name} 失败`);
            }
          });

          uploadPromises.push(uploadPromise);
        }

        // 处理所有上传完成后的操作
        Promise.all(uploadPromises)
          .then(uploadedVideos => {
            // 更新状态
            document.getElementById('video-status-text').textContent =
              `已上传 ${videoIds.length} 个视频，正在批量处理...`;
            document.getElementById('video-progress-bar').style.width = '75%';

            // 如果没有成功上传的视频，则停止处理
            if (videoIds.length === 0) {
              throw new Error('没有成功上传的视频');
            }

            // 发送批量处理请求，使用/api/videos/batch-process接口
            return fetch('/api/videos/batch-process', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                videoIds: videoIds,
                modelId: batchVideoModelSelect.value,
                startTime: startTime,
                endTime: endTime
              })
            });
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('批量视频处理请求失败');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // 处理成功，更新UI
              document.getElementById('video-step-processing').classList.add('completed');
              document.getElementById('video-step-complete').classList.add('active');
              document.getElementById('video-step-complete').classList.add('completed');
              document.getElementById('video-progress-bar').style.width = '100%';
              document.getElementById('video-status-text').textContent = '批量处理已启动';

              // 过滤出成功处理的结果
              const successResults = data.results ? data.results.filter(r => r.success) : [];

              // 显示结果
              document.getElementById('video-result').style.display = 'block';

              if (successResults.length > 0) {
                // 显示批量结果
                document.getElementById('single-video-result-display').style.display = 'none';
                document.getElementById('batch-video-results-display').style.display = 'block';

                // 显示主按钮区域，并设置主按钮关联到第一个视频结果
                const mainButtonsElement = document.getElementById('video-result-main-buttons');
                if (mainButtonsElement) {
                  mainButtonsElement.style.display = 'flex';
                  const firstResult = successResults[0].result;
                  if (firstResult) {
                    document.getElementById('download-video-result').setAttribute('data-id', firstResult.id);
                    document.getElementById('view-video-details').setAttribute('data-id', firstResult.id);
                  }
                }

                // 清空批量视频结果容器
                const batchVideoResultsContainer = document.getElementById('batch-video-results-container');
                batchVideoResultsContainer.innerHTML = '';

                // 为每个视频创建处理结果卡片
                successResults.forEach((resultItem, index) => {
                  const result = resultItem.result;

                  // 获取正确的文件名
                  let filename = '';
                  if (resultItem.original_filename) {
                    filename = resultItem.original_filename;
                  } else if (window.batchOriginalVideoNames && window.batchOriginalVideoNames[index]) {
                    filename = window.batchOriginalVideoNames[index];
                  } else {
                    filename = `视频${index + 1}`;
                  }

                  // 创建结果卡片元素
                  const videoResultElement = document.createElement('div');
                  videoResultElement.className = 'batch-video-result-item';
                  videoResultElement.setAttribute('data-id', result.id);

                  // 处理视频URL
                  let videoUrl = result.staticUrl;

                  // 如果URL是以/static开头，需要加上基础URL
                  if (videoUrl.startsWith('/static/')) {
                    // 添加当前域名作为基础URL
                    const baseUrl = window.location.origin;
                    videoUrl = baseUrl + videoUrl;
                    console.log('转换后的视频URL:', videoUrl);
                  }

                  // 设置卡片内容
                  let ext2 = videoUrl.split('.').pop().toLowerCase();
                  let type2 = 'video/mp4';
                  if (ext2 === 'avi') type2 = 'video/avi';
                  else if (ext2 === 'mov') type2 = 'video/quicktime';
                  videoResultElement.innerHTML = `
                    <div class="batch-result-image">
                      <video src="${videoUrl}" controls loading="lazy" style="width: 100%; height: 140px; object-fit: contain;" type="${type2}"></video>
                    </div>
                    <div class="batch-result-info">
                      <div class="batch-result-filename" title="${filename}">${filename}</div>
                      <div class="batch-result-stats">
                        <span>精度: ${result.accuracy ? result.accuracy.toFixed(2) + '%' : 'N/A'}</span>
                        <span>目标: ${result.objectCount !== undefined ? result.objectCount : '0'}</span>
                      </div>
                      <div class="batch-result-actions" style="display: flex; justify-content: flex-end; gap: 5px;">
                        <button class="btn btn-outline btn-sm download-batch-video-result" data-id="${result.id}">
                          <i class="ri-download-line"></i> 下载
                        </button>
                        <button class="btn btn-primary btn-sm view-batch-video-result" data-id="${result.id}">
                          <i class="ri-eye-line"></i> 查看
                        </button>
                      </div>
                    </div>`;

                  // 添加到结果容器
                  batchVideoResultsContainer.appendChild(videoResultElement);

                  // 为视频元素添加点击事件，点击查看大图
                  const videoElement = videoResultElement.querySelector('video');
                  if (videoElement) {
                    videoElement.addEventListener('dblclick', function(e) {
                      e.preventDefault();
                      // 使用与查看按钮相同的逻辑打开视频
                      const historyId = videoResultElement.getAttribute('data-id');
                      if (historyId) {
                        const token = localStorage.getItem('auth_token');
                        if (token) {
                          window.open(`/api/videos/preview/${historyId}?token=${token}`, '_blank');
                        }
                      }
                    });
                  }
                });

                // 绑定批量视频下载和查看事件
                attachBatchVideoResultEvents();

                showToast(`成功提交处理${successResults.length}个视频`, 'success');
              } else {
                // 没有成功处理的结果
                document.getElementById('video-result').style.display = 'none';
                showToast('没有视频处理成功', 'warning');
              }

              // 自动刷新相关数据
              fetchRecentHistory();
              fetchDashboardStats();
            } else {
              throw new Error(data.message || '批量处理失败');
            }
          })
          .catch(error => {
            console.error('批量处理视频出错:', error);
            document.getElementById('video-status-text').textContent = '处理失败: ' + error.message;
            document.getElementById('video-progress-bar').style.width = '33%';
            document.getElementById('video-step-processing').classList.remove('active', 'completed');
            document.getElementById('video-step-complete').classList.remove('active', 'completed');
            showToast('批量处理失败: ' + error.message, 'error');
          });
      });
    }

    // 处理新视频按钮
    const processNewVideoBtn = document.getElementById('process-new-video');
    if (processNewVideoBtn) {
      processNewVideoBtn.addEventListener('click', function() {
        // 重置处理UI
        document.getElementById('video-processing-progress').style.display = 'none';
        document.getElementById('video-result').style.display = 'none';
        document.getElementById('video-preview').style.display = 'none';
        document.getElementById('batch-video-preview').style.display = 'none';
        document.getElementById('video-dropzone').style.display = 'block';

        // 清空视频预览
        const previewVideo = document.getElementById('preview-video');
        if (previewVideo && previewVideo.src) {
          URL.revokeObjectURL(previewVideo.src);
          previewVideo.src = '';
          previewVideo.load(); // 强制重新加载
        }

        // 重置处理进度状态
        const videoStepProcessing = document.getElementById('video-step-processing');
        const videoStepComplete = document.getElementById('video-step-complete');
        const videoProgressBar = document.getElementById('video-progress-bar');
        const videoStatusText = document.getElementById('video-status-text');

        if (videoStepProcessing) videoStepProcessing.classList.remove('active', 'completed');
        if (videoStepComplete) videoStepComplete.classList.remove('active', 'completed');
        if (videoProgressBar) videoProgressBar.style.width = '33%';
        if (videoStatusText) videoStatusText.textContent = '正在处理视频数据...';

        // 隐藏所有视频结果显示区域
        const singleVideoResultDisplay = document.getElementById('single-video-result-display');
        const batchVideoResultsDisplay = document.getElementById('batch-video-results-display');

        if (singleVideoResultDisplay) singleVideoResultDisplay.style.display = 'none';
        if (batchVideoResultsDisplay) batchVideoResultsDisplay.style.display = 'none';

        // 清空批量视频结果容器
        const batchVideoResultsContainer = document.getElementById('batch-video-results-container');
        if (batchVideoResultsContainer) {
          const videos = batchVideoResultsContainer.querySelectorAll('video');
          videos.forEach(video => {
            if (video && video.src) {
              URL.revokeObjectURL(video.src);
            }
          });
          batchVideoResultsContainer.innerHTML = '';
        }

        // 清除视频结果
        const resultVideo = document.getElementById('result-video');
        if (resultVideo && resultVideo.src) {
          URL.revokeObjectURL(resultVideo.src);
          resultVideo.src = '';
          resultVideo.load(); // 强制重新加载
        }

        // 清除文件选择
        const videoInput = document.getElementById('video-input');
        const batchVideoInput = document.getElementById('batch-video-input');
        if (videoInput) videoInput.value = '';
        if (batchVideoInput) batchVideoInput.value = '';

        // 重置表单
        const videoProcessForm = document.getElementById('video-process-form');
        const batchVideoProcessForm = document.getElementById('batch-video-process-form');
        if (videoProcessForm) videoProcessForm.reset();
        if (batchVideoProcessForm) batchVideoProcessForm.reset();

        // 默认设置开始时间为0
        const videoStartTime = document.getElementById('video-start-time');
        if (videoStartTime) videoStartTime.value = '0';

        // 重新启用处理按钮
        const processVideoBtn = document.getElementById('process-video-btn');
        const processBatchVideoBtn = document.getElementById('process-batch-video-btn');
        if (processVideoBtn) processVideoBtn.disabled = false;
        if (processBatchVideoBtn) processBatchVideoBtn.disabled = false;

        console.log("视频处理状态已完全重置");
      });
    }

    // 添加批量视频结果事件处理函数
    function attachBatchVideoResultEvents() {
      // 为批量视频结果中的下载按钮添加事件
      document.querySelectorAll('.download-batch-video-result').forEach(btn => {
        btn.addEventListener('click', function() {
          const historyId = this.getAttribute('data-id');
          if (!historyId) {
            showToast('无法下载，结果ID无效', 'error');
            return;
          }

          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 创建一个临时的隐藏a标签来处理下载
          const downloadLink = document.createElement('a');
          downloadLink.href = `/api/videos/download/${historyId}?token=${token}`;
          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });

      // 为批量视频结果中的查看按钮添加事件
      document.querySelectorAll('.view-batch-video-result').forEach(btn => {
        btn.addEventListener('click', function() {
          const historyId = this.getAttribute('data-id');
          if (!historyId) {
            showToast('无法查看，结果ID无效', 'error');
            return;
          }

          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 在新窗口打开查看结果视频
          window.open(`/api/videos/preview/${historyId}?token=${token}`, '_blank');
        });
      });
    }

    // 处理下载视频结果按钮
    const downloadVideoResultBtn = document.getElementById('download-video-result');
    if (downloadVideoResultBtn) {
      downloadVideoResultBtn.addEventListener('click', function() {
        // 处理批量结果的情况
        if (document.getElementById('batch-video-results-display').style.display === 'block') {
          // 如果是批量结果，询问用户是否要下载全部
          if (confirm('是否下载所有成功处理的视频？选择"确定"下载全部，选择"取消"则仅下载第一个。')) {
            // 找到所有成功处理的结果按钮并模拟点击
            const downloadBtns = document.querySelectorAll('.download-batch-video-result');
            if (downloadBtns.length > 0) {
              downloadBtns.forEach(btn => {
                setTimeout(() => {
                  btn.click();
                }, 100); // 稍微延迟避免浏览器阻止多个下载
              });
              return;
            }
          }
          // 如果用户取消或者没有找到下载按钮，就下载第一个结果
        }

        // 下载单个结果（默认行为）
        const historyId = this.getAttribute('data-id');
        if (!historyId) {
          showToast('无法下载，结果ID无效', 'error');
          return;
        }

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 创建一个临时的隐藏a标签来处理下载
        const downloadLink = document.createElement('a');
        downloadLink.href = `/api/videos/download/${historyId}?token=${token}`;
        downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });
    }

    // 处理查看视频详情按钮
    const viewVideoDetailsBtn = document.getElementById('view-video-details');
    if (viewVideoDetailsBtn) {
      viewVideoDetailsBtn.addEventListener('click', function() {
        // 处理批量结果的情况
        if (document.getElementById('batch-video-results-display').style.display === 'block') {
          // 如果是批量结果，打开第一个结果的详情
          const viewBtns = document.querySelectorAll('.view-batch-video-result');
          if (viewBtns.length > 0) {
            viewBtns[0].click();
            return;
          }
        }

        // 查看单个结果（默认行为）
        const historyId = this.getAttribute('data-id');
        if (!historyId) {
          showToast('无法查看，结果ID无效', 'error');
          console.error('查看视频详情失败：ID无效', this);
          return;
        }

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        console.log(`打开视频详情，ID: ${historyId}`);
        // 在新窗口打开查看结果视频
        window.open(`/api/videos/preview/${historyId}?token=${token}`, '_blank');
      });
    }

    // 处理表单提交
    const imageProcessForm = document.getElementById('image-process-form');
    if (imageProcessForm) {
      imageProcessForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const modelSelect = document.getElementById('model-select');
        console.log('[图片提交] 当前 imageInput.files:', imageInput.files);
        if (!modelSelect.value) {
          showToast('请选择识别模型', 'warning');
          return;
        }

        if (!imageInput.files || imageInput.files.length === 0) {
          console.warn('[图片提交] imageInput.files 为空，无法提交');
          showToast('请先上传图像', 'warning');
          return;
        }
        console.log('[图片提交] imageInput.files[0]:', imageInput.files[0]);
        // 显示处理进度
        document.getElementById('processing-progress').style.display = 'block';
        document.getElementById('step-processing').classList.add('active');
        document.getElementById('process-progress-bar').style.width = '66%';
        document.getElementById('process-status-text').textContent = '正在上传图像...';

        // 禁用提交按钮防止重复提交
        document.getElementById('process-image-btn').disabled = true;

        // 首先上传图像
        const formData = new FormData();
        formData.append('file', imageInput.files[0]);
        console.log('[图片提交] FormData已添加文件:', imageInput.files[0]);

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 第一步：上传图像
        fetch('/api/images/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('图像上传失败');
          }
          return response.json();
        })
        .then(uploadData => {
          if (uploadData.success) {
            document.getElementById('process-status-text').textContent = '正在分析图像特征...';
            // 第二步：处理图像
            return fetch('/api/images/process', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                imageId: uploadData.image.id,
                modelId: modelSelect.value
              })
            });
          } else {
            throw new Error(uploadData.message || '图像上传失败');
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('图像处理失败');
          }
          return response.json();
        })
        .then(processData => {
          if (processData.success) {
            // 处理成功，更新UI
            document.getElementById('step-processing').classList.add('completed');
            document.getElementById('step-complete').classList.add('active');
            document.getElementById('step-complete').classList.add('completed');
            document.getElementById('process-progress-bar').style.width = '100%';
            document.getElementById('process-status-text').textContent = '处理完成';

            // 显示结果
            document.getElementById('process-result').style.display = 'block';

            // 单张图像处理结果显示
            document.getElementById('single-result-display').style.display = 'block';
            document.getElementById('batch-results-display').style.display = 'none';

            // 展示结果信息
            document.getElementById('result-accuracy').textContent =
              processData.result.accuracy ? `${processData.result.accuracy.toFixed(2)}%` : 'N/A';
            document.getElementById('result-time').textContent =
              processData.result.processingTime ? `${processData.result.processingTime.toFixed(2)}秒` : 'N/A';
            document.getElementById('result-categories').textContent =
              (processData.result.categories && processData.result.categories.length > 0) ?
              processData.result.categories.join(', ') : '未检测到分类';
            document.getElementById('result-objects').textContent =
              processData.result.objectCount !== undefined ? processData.result.objectCount : '0';

            // 保存结果ID用于下载
            document.getElementById('download-result').setAttribute('data-id', processData.result.id);

            // 显示结果图片
            if (processData.result.resultUrl) {
              const resultImg = document.getElementById('result-image');
              resultImg.src = processData.result.resultUrl;
              resultImg.style.display = 'block';
            } else {
              document.getElementById('result-image').style.display = 'none';
            }

            showToast('图像处理成功', 'success');

            // 自动刷新相关数据
            fetchRecentHistory(); // 刷新仪表盘的最近历史记录
            fetchDashboardStats(); // 刷新仪表盘的统计数据

            // 如果用户在历史记录页面，也刷新该页面的数据
            if (document.getElementById('history-tab').classList.contains('active')) {
              fetchHistoryRecords(1); // 刷新到第一页，显示最新记录
            }
          } else {
            throw new Error(processData.message || '图像处理失败');
          }
        })
        .catch(error => {
          console.error('处理图像出错:', error);
          document.getElementById('process-status-text').textContent = '处理失败: ' + error.message;
          document.getElementById('process-progress-bar').style.width = '33%';
          document.getElementById('step-processing').classList.remove('active', 'completed');
          document.getElementById('step-complete').classList.remove('active', 'completed');
          showToast('处理失败: ' + error.message, 'error');
        });
      });
    }

    // 添加批量图像处理的表单提交事件
    const batchImageProcessForm = document.getElementById('batch-image-process-form');
    if (batchImageProcessForm) {
      batchImageProcessForm.addEventListener('submit', function(e) {
        e.preventDefault(); // 阻止表单默认提交行为

        const batchModelSelect = document.getElementById('batch-model-select');

        if (!batchModelSelect.value) {
          showToast('请选择识别模型', 'warning');
          return;
        }

        if (!batchImageInput.files || batchImageInput.files.length === 0) {
          showToast('请先上传图像', 'warning');
          return;
        }

        // 显示处理进度
        document.getElementById('processing-progress').style.display = 'block';
        document.getElementById('step-processing').classList.add('active');
        document.getElementById('process-progress-bar').style.width = '66%';
        document.getElementById('process-status-text').textContent = '正在上传图像...';

        // 禁用提交按钮防止重复提交
        document.getElementById('process-batch-btn').disabled = true;

        // 获取token
        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 首先上传所有图片
        const uploadPromises = [];
        const imageIds = [];
        const files = Array.from(batchImageInput.files);
        const totalFiles = files.length;
        let completedUploads = 0;

        // 遍历所有选择的文件，逐个上传
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileFormData = new FormData();
          fileFormData.append('file', file);

          const uploadPromise = fetch('/api/images/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: fileFormData
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`上传图像 ${file.name} 失败`);
            }
            return response.json();
          })
          .then(data => {
            completedUploads++;
            // 更新上传进度
            const progress = Math.floor((completedUploads / totalFiles) * 100 * 0.5);
            document.getElementById('process-status-text').textContent =
              `正在上传图像 (${completedUploads}/${totalFiles})`;
            document.getElementById('process-progress-bar').style.width = `${50 + progress/2}%`;

            if (data.success && data.image && data.image.id) {
              // 收集成功上传的图像ID
              imageIds.push(data.image.id);
              return data.image;
            } else {
              throw new Error(data.message || `上传图像 ${file.name} 失败`);
            }
          });

          uploadPromises.push(uploadPromise);
        }

        // 处理所有上传完成后的操作
        Promise.all(uploadPromises)
          .then(uploadedImages => {
            // 更新状态
            document.getElementById('process-status-text').textContent =
              `已上传 ${imageIds.length} 张图像，正在批量处理...`;
            document.getElementById('process-progress-bar').style.width = '75%';

            // 如果没有成功上传的图像，则停止处理
            if (imageIds.length === 0) {
              throw new Error('没有成功上传的图像');
            }

            // 发送批量处理请求，使用JSON格式传递imageIds和modelId，与后端API期望的格式匹配
            return fetch('/api/images/batch-process', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                imageIds: imageIds,
                modelId: batchModelSelect.value
              })
            });
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('批量处理请求失败');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // 处理成功，更新UI
              document.getElementById('step-processing').classList.add('completed');
              document.getElementById('step-complete').classList.add('active');
              document.getElementById('step-complete').classList.add('completed');
              document.getElementById('process-progress-bar').style.width = '100%';
              document.getElementById('process-status-text').textContent = '批量处理完成';

              // 显示结果
              document.getElementById('process-result').style.display = 'block';

              // 过滤出成功处理的结果
              const successResults = data.results ? data.results.filter(r => r.success) : [];

              if (successResults.length > 0) {
                // 显示批量结果
                document.getElementById('single-result-display').style.display = 'none';
                document.getElementById('batch-results-display').style.display = 'block';

                // 显示主按钮区域用于批量操作，并且主下载和查看按钮跟随第一个结果
                const firstResult = successResults[0].result;
                if (firstResult) {
                  document.getElementById('download-result').setAttribute('data-id', firstResult.id);
                  document.getElementById('view-details').setAttribute('data-id', firstResult.id);
                }

                // 清空批量结果容器
                const batchResultsContainer = document.getElementById('batch-results-container');
                batchResultsContainer.innerHTML = '';

                // 为每个图像创建处理结果卡片
                successResults.forEach((resultItem, index) => {
                  const result = resultItem.result;

                  // 获取正确的文件名
                  let filename = '';
                  if (resultItem.original_filename) {
                    filename = resultItem.original_filename;
                  } else if (window.batchOriginalImageNames && window.batchOriginalImageNames[index]) {
                    filename = window.batchOriginalImageNames[index];
                  } else {
                    filename = `图像${index + 1}`;
                  }

                  // 创建结果卡片元素
                  const imageResultElement = document.createElement('div');
                  imageResultElement.className = 'batch-result-item';
                  imageResultElement.setAttribute('data-id', result.id);

                  // 设置卡片内容
                  imageResultElement.innerHTML = `
                    <div class="batch-result-image">
                      <img src="${result.resultUrl}" alt="${filename}" loading="lazy">
                    </div>
                    <div class="batch-result-info">
                      <div class="batch-result-filename" title="${filename}">${filename}</div>
                      <div class="batch-result-stats">
                        <span>精度: ${result.accuracy ? result.accuracy.toFixed(2) + '%' : 'N/A'}</span>
                        <span>目标: ${result.objectCount !== undefined ? result.objectCount : '0'}</span>
                      </div>
                      <div class="batch-result-actions">
                        <button class="btn btn-outline btn-sm download-batch-result" data-id="${result.id}">
                          <i class="ri-download-line"></i> 下载
                        </button>
                        <button class="btn btn-primary btn-sm view-batch-result" data-id="${result.id}">
                          <i class="ri-eye-line"></i> 查看
                        </button>
                      </div>
                    </div>`;

                  // 添加到批量结果容器
                  batchResultsContainer.appendChild(imageResultElement);
                });

                // 绑定批量结果的下载按钮事件
                attachBatchResultEvents();

                showToast(`成功处理了${successResults.length}张图像`, 'success');
              } else {
                // 没有成功处理的结果
                document.getElementById('batch-results-display').style.display = 'none';
                document.getElementById('single-result-display').style.display = 'none';
                showToast('没有图像处理成功', 'warning');
              }

              // 自动刷新相关数据
              fetchRecentHistory(); // 刷新仪表盘的最近历史记录
              fetchDashboardStats(); // 刷新仪表盘的统计数据

              // 如果用户在历史记录页面，也刷新该页面的数据
              if (document.getElementById('history-tab').classList.contains('active')) {
                fetchHistoryRecords(1); // 刷新到第一页，显示最新记录
              }
            } else {
              throw new Error(data.message || '批量处理失败');
            }
          })
          .catch(error => {
            console.error('批量处理图像出错:', error);
            document.getElementById('process-status-text').textContent = '处理失败: ' + error.message;
            document.getElementById('process-progress-bar').style.width = '33%';
            document.getElementById('step-processing').classList.remove('active', 'completed');
            document.getElementById('step-complete').classList.remove('active', 'completed');
            showToast('批量处理失败: ' + error.message, 'error');
          });
      });
    }

    // 处理下载结果按钮
    const downloadResultBtn = document.getElementById('download-result');
    if (downloadResultBtn) {
      downloadResultBtn.addEventListener('click', function() {
        // 处理批量结果的情况
        if (document.getElementById('batch-results-display').style.display === 'block') {
          // 如果是批量结果，询问用户是否要下载全部
          if (confirm('是否下载所有成功处理的图像？选择"确定"下载全部，选择"取消"则仅下载第一张。')) {
            // 找到所有成功处理的结果按钮并模拟点击
            const downloadBtns = document.querySelectorAll('.download-batch-result');
            if (downloadBtns.length > 0) {
              downloadBtns.forEach(btn => {
                setTimeout(() => {
                  btn.click();
                }, 100); // 稍微延迟避免浏览器阻止多个下载
              });
              return;
            }
          }
          // 如果用户取消或者没有找到下载按钮，就下载第一个结果
        }

        // 下载单个结果（默认行为）
        const historyId = this.getAttribute('data-id');
        if (!historyId) {
          showToast('无法下载，结果ID无效', 'error');
          return;
        }

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 创建一个临时的隐藏a标签来处理下载
        const downloadLink = document.createElement('a');
        downloadLink.href = `/api/images/download/${historyId}?token=${token}`;
        downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });
    }

    // 处理查看详情按钮
    const viewDetailsBtn = document.getElementById('view-details');
    if (viewDetailsBtn) {
      viewDetailsBtn.addEventListener('click', function() {
        // 处理批量结果的情况
        if (document.getElementById('batch-results-display').style.display === 'block') {
          // 如果是批量结果，打开第一个结果的详情
          const viewBtns = document.querySelectorAll('.view-batch-result');
          if (viewBtns.length > 0) {
            viewBtns[0].click();
            return;
          }
        }

        // 查看单个结果（默认行为）
        const historyId = document.getElementById('download-result').getAttribute('data-id');
        if (!historyId) {
          showToast('无法查看，结果ID无效', 'error');
          return;
        }

        const token = localStorage.getItem('auth_token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // 在新窗口打开查看结果图片
        window.open(`/api/images/view/${historyId}?token=${token}`, '_blank');
      });
    }

    // 处理新图像按钮
    const processNewImageBtn = document.getElementById('process-new-image');
    if (processNewImageBtn) {
      processNewImageBtn.addEventListener('click', function() {
        // 重置界面状态
        document.getElementById('processing-progress').style.display = 'none';
        document.getElementById('process-result').style.display = 'none';
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('batch-image-preview').style.display = 'none';
        document.getElementById('image-dropzone').style.display = 'block';

        // 清空文件选择
        const imageInput = document.getElementById('image-input');
        const batchImageInput = document.getElementById('batch-image-input');
        if (imageInput) {
          imageInput.value = '';
        }
        if (batchImageInput) {
          batchImageInput.value = '';
        }

        // 重置处理进度状态
        const stepProcessing = document.getElementById('step-processing');
        const stepComplete = document.getElementById('step-complete');
        const processProgressBar = document.getElementById('process-progress-bar');
        const processStatusText = document.getElementById('process-status-text');

        if (stepProcessing) stepProcessing.classList.remove('active', 'completed');
        if (stepComplete) stepComplete.classList.remove('active', 'completed');
        if (processProgressBar) processProgressBar.style.width = '33%';
        if (processStatusText) processStatusText.textContent = '正在处理图像数据...';

        // 隐藏所有结果显示区域
        const singleResultDisplay = document.getElementById('single-result-display');
        const batchResultsDisplay = document.getElementById('batch-results-display');

        if (singleResultDisplay) singleResultDisplay.style.display = 'none';
        if (batchResultsDisplay) batchResultsDisplay.style.display = 'none';

        // 清空结果容器
        const batchResultsContainer = document.getElementById('batch-results-container');
        if (batchResultsContainer) {
          batchResultsContainer.innerHTML = '';
        }

        // 重置预览图
        const previewImg = document.getElementById('preview-img');
        if (previewImg) {
          previewImg.src = '';
        }

        // 重置表单
        const imageProcessForm = document.getElementById('image-process-form');
        const batchImageProcessForm = document.getElementById('batch-image-process-form');
        if (imageProcessForm) imageProcessForm.reset();
        if (batchImageProcessForm) batchImageProcessForm.reset();

        // 重新启用处理按钮
        const processImageBtn = document.getElementById('process-image-btn');
        const processBatchBtn = document.getElementById('process-batch-btn');
        if (processImageBtn) processImageBtn.disabled = false;
        if (processBatchBtn) processBatchBtn.disabled = false;

        console.log("图像处理状态已完全重置");
      });
    }

    // 添加批量结果事件处理函数
    function attachBatchResultEvents() {
      // 为批量结果中的下载按钮添加事件
      document.querySelectorAll('.download-batch-result').forEach(btn => {
        btn.addEventListener('click', function() {
          const historyId = this.getAttribute('data-id');
          if (!historyId) {
            showToast('无法下载，结果ID无效', 'error');
            return;
          }

          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 创建一个临时的隐藏a标签来处理下载
          const downloadLink = document.createElement('a');
          downloadLink.href = `/api/images/download/${historyId}?token=${token}`;
          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });

      // 为批量结果中的查看按钮添加事件
      document.querySelectorAll('.view-batch-result').forEach(btn => {
        btn.addEventListener('click', function() {
          const historyId = this.getAttribute('data-id');
          if (!historyId) {
            showToast('无法查看，结果ID无效', 'error');
            return;
          }

          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 在新窗口打开查看结果图片
          window.open(`/api/images/view/${historyId}?token=${token}`, '_blank');
        });
      });
    }

    function initHistoryFeatures() {
      // 历史记录标签切换和筛选功能
      const historyTimeFilter = document.getElementById('history-time-filter');
      const customDateRange = document.getElementById('custom-date-range');

      if (historyTimeFilter) {
        historyTimeFilter.addEventListener('change', function() {
          if (this.value === 'custom') {
            customDateRange.style.display = 'block';
          } else {
            customDateRange.style.display = 'none';
            fetchHistoryRecords(); // 当筛选条件改变时刷新历史记录
          }
        });
      }

      // 加载模型选项
    loadModelOptions();

      // 刷新历史记录按钮
      const refreshHistoryBtn = document.getElementById('refresh-history');
      if (refreshHistoryBtn) {
        refreshHistoryBtn.addEventListener('click', function() {
          // 实现刷新历史记录的逻辑
          fetchHistoryRecords();
        });
      }

      // 搜索按钮
      const historySearchBtn = document.getElementById('history-search-btn');
      if (historySearchBtn) {
        historySearchBtn.addEventListener('click', function() {
          fetchHistoryRecords();
        });
      }

      // 应用日期过滤按钮
      const applyDateFilterBtn = document.getElementById('apply-date-filter');
      if (applyDateFilterBtn) {
        applyDateFilterBtn.addEventListener('click', function() {
          fetchHistoryRecords();
        });
      }

      // 初始加载历史记录
      fetchHistoryRecords();

      // 模型过滤器变更事件
      const historyModelFilter = document.getElementById('history-model-filter');
      if (historyModelFilter) {
        historyModelFilter.addEventListener('change', function() {
    fetchHistoryRecords();
        });
      }

      // 选择所有复选框
      const selectAllHistory = document.getElementById('select-all-history');
      if (selectAllHistory) {
        selectAllHistory.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('#history-table-body input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
          updateBatchButtonsState();
        });
      }

      // 批量下载按钮
      const batchDownloadBtn = document.getElementById('batch-download');
      if (batchDownloadBtn) {
        batchDownloadBtn.addEventListener('click', function() {
          if (this.disabled) return;

          const selectedIds = getSelectedHistoryIds();
          if (selectedIds.length === 0) return;

          // 获取当前的token
          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 确认是否批量下载
          if (confirm(`确定要下载所选的${selectedIds.length}条记录吗？`)) {
            // 查找所有选中的记录并确定它们的类型
            const selectedCheckboxes = document.querySelectorAll('#history-table-body .history-checkbox:checked');
            selectedCheckboxes.forEach((checkbox, index) => {
              const recordId = checkbox.getAttribute('data-id');
              // 找到对应行来确定记录类型
              const row = checkbox.closest('tr');
              const typeCell = row.querySelector('td:nth-child(3)');
              const typeText = typeCell.textContent.trim();

              // 根据记录类型选择下载路径
              let downloadUrl = '';
              if (typeText.includes('视频')) {
                downloadUrl = `/api/videos/download/${recordId}?token=${token}`;
              } else if (typeText.includes('实时监测')) {
                downloadUrl = `/api/realtime/download/${recordId}?token=${token}`;
              } else {
                // 默认为图像
                downloadUrl = `/api/images/download/${recordId}?token=${token}`;
              }

              // 创建延迟执行下载，避免浏览器阻止多个下载
              setTimeout(() => {
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
              }, index * 300); // 每个下载之间间隔300毫秒
            });

            showToast(`已开始下载${selectedIds.length}个文件`, 'success');
          }
        });
      }

      // 批量删除按钮
      const batchDeleteBtn = document.getElementById('batch-delete');
      if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
          if (this.disabled) return;

          const selectedIds = getSelectedHistoryIds();
          if (selectedIds.length === 0) return;

          if (confirm(`确定要删除所选的${selectedIds.length}条记录吗？`)) {
            deleteHistoryRecords(selectedIds);
          }
        });
      }
    }

    // 加载模型选项
    function loadModelOptions() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      fetch('/api/models', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取模型数据失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        const modelFilter = document.getElementById('history-model-filter');

        if (data.success && data.models && data.models.length > 0) {
          // 获取现有的模型类型
          const modelTypes = [...new Set(data.models.map(model => model.type))];

          // 添加类型选项
          let typeOptionsHtml = '<option value="all">全部类型</option>';
          modelTypes.forEach(type => {
            typeOptionsHtml += `<option value="${type}">${getModelTypeName(type)}</option>`;
          });

          // 添加具体模型选项
          let modelOptionsHtml = '';
          data.models.forEach(model => {
            modelOptionsHtml += `<option value="${model.id}">${model.name}</option>`;
          });

          // 更新下拉框
          modelFilter.innerHTML = typeOptionsHtml + modelOptionsHtml;
        }
      })
      .catch(error => {
        console.error('加载模型选项出错:', error);
      });
    }

    // 获取模型类型名称
    function getModelTypeName(type) {
      const typeNames = {
        'landcover': '土地覆盖',
        'building': '建筑物提取',
        'water': '水体监测',
        'vegetation': '植被分析',
        'urban': '城市分析',
        'other': '其他'
      };
      return typeNames[type] || type;
    }

    // 重置所有上传表单和预览区域
    function resetUploadForms() {
      console.log("重置所有上传表单和预览区域");

      // 获取所有表单元素
      const imageInput = document.getElementById('image-input');
      const batchImageInput = document.getElementById('batch-image-input');
      const videoInput = document.getElementById('video-input');
      const batchVideoInput = document.getElementById('batch-video-input');
      const imageProcessForm = document.getElementById('image-process-form');
      const batchImageProcessForm = document.getElementById('batch-image-process-form');
      const videoProcessForm = document.getElementById('video-process-form');
      const batchVideoProcessForm = document.getElementById('batch-video-process-form');

      // 重置所有文件输入
      if (imageInput) imageInput.value = '';
      if (batchImageInput) batchImageInput.value = '';
      if (videoInput) videoInput.value = '';
      if (batchVideoInput) batchVideoInput.value = '';

      // 重置所有表单
      if (imageProcessForm) imageProcessForm.reset();
      if (batchImageProcessForm) batchImageProcessForm.reset();
      if (videoProcessForm) videoProcessForm.reset();
      if (batchVideoProcessForm) batchVideoProcessForm.reset();

      // 隐藏所有预览区域
      const imagePreview = document.getElementById('image-preview');
      const batchImagePreview = document.getElementById('batch-image-preview');
      const videoPreview = document.getElementById('video-preview');
      const batchVideoPreview = document.getElementById('batch-video-preview');

      if (imagePreview) imagePreview.style.display = 'none';
      if (batchImagePreview) batchImagePreview.style.display = 'none';
      if (videoPreview) videoPreview.style.display = 'none';
      if (batchVideoPreview) batchVideoPreview.style.display = 'none';

      // 重置单个/批量处理按钮状态
      const singleUploadModeBtn = document.getElementById('single-upload-mode');
      const batchUploadModeBtn = document.getElementById('batch-upload-mode');
      const singleVideoModeBtn = document.getElementById('single-video-mode');
      const batchVideoModeBtn = document.getElementById('batch-video-mode');

      if (singleUploadModeBtn) singleUploadModeBtn.classList.add('active');
      if (batchUploadModeBtn) batchUploadModeBtn.classList.remove('active');
      if (singleVideoModeBtn) singleVideoModeBtn.classList.add('active');
      if (batchVideoModeBtn) batchVideoModeBtn.classList.remove('active');

      // 隐藏所有处理结果和进度区域
      const processingProgress = document.getElementById('processing-progress');
      const processResult = document.getElementById('process-result');
      const videoProcessingProgress = document.getElementById('video-processing-progress');
      const videoProcessResult = document.getElementById('video-process-result');

      if (processingProgress) processingProgress.style.display = 'none';
      if (processResult) processResult.style.display = 'none';
      if (videoProcessingProgress) videoProcessingProgress.style.display = 'none';
      if (videoProcessResult) videoProcessResult.style.display = 'none';

      // 清空并隐藏结果显示区域
      const singleResultDisplay = document.getElementById('single-result-display');
      const batchResultsDisplay = document.getElementById('batch-results-display');
      const singleVideoResultDisplay = document.getElementById('single-video-result-display');
      const batchVideoResultsDisplay = document.getElementById('batch-video-results-display');

      if (singleResultDisplay) singleResultDisplay.style.display = 'none';
      if (batchResultsDisplay) batchResultsDisplay.style.display = 'none';
      if (singleVideoResultDisplay) singleVideoResultDisplay.style.display = 'none';
      if (batchVideoResultsDisplay) batchVideoResultsDisplay.style.display = 'none';

      // 清空批量结果容器
      const batchResultsContainer = document.getElementById('batch-results-container');
      const batchVideoResultsContainer = document.getElementById('batch-video-results-container');

      if (batchResultsContainer) batchResultsContainer.innerHTML = '';
      if (batchVideoResultsContainer) batchVideoResultsContainer.innerHTML = '';

      // 重置处理进度状态
      const stepProcessing = document.getElementById('step-processing');
      const stepComplete = document.getElementById('step-complete');
      const processProgressBar = document.getElementById('process-progress-bar');
      const processStatusText = document.getElementById('process-status-text');

      if (stepProcessing) stepProcessing.classList.remove('active', 'completed');
      if (stepComplete) stepComplete.classList.remove('active', 'completed');
      if (processProgressBar) processProgressBar.style.width = '33%';
      if (processStatusText) processStatusText.textContent = '正在处理图像数据...';

      // 同样处理视频进度状态
      const videoStepProcessing = document.getElementById('video-step-processing');
      const videoStepComplete = document.getElementById('video-step-complete');
      const videoProgressBar = document.getElementById('video-progress-bar');
      const videoStatusText = document.getElementById('video-status-text');

      if (videoStepProcessing) videoStepProcessing.classList.remove('active', 'completed');
      if (videoStepComplete) videoStepComplete.classList.remove('active', 'completed');
      if (videoProgressBar) videoProgressBar.style.width = '33%';
      if (videoStatusText) videoStatusText.textContent = '正在处理视频数据...';

      // 重新绑定表单事件，解决事件监听器丢失问题
      rebindUploadFormsEvents();
    }

    // 重新绑定上传表单事件
    function rebindUploadFormsEvents() {
      console.log("重新绑定上传表单事件");

      // 重新绑定单张图像处理表单事件
      const imageProcessForm = document.getElementById('image-process-form');
      if (imageProcessForm) {
        console.log("重新绑定单张图像处理表单事件");
        // 克隆表单并替换，移除旧的事件监听器
        const newForm = imageProcessForm.cloneNode(true);
        imageProcessForm.parentNode.replaceChild(newForm, imageProcessForm);

        // 绑定新的事件监听器
        newForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log("单张图像处理表单提交");

          const modelSelect = document.getElementById('model-select');
          const imageInput = document.getElementById('image-input');

          if (!modelSelect.value) {
            showToast('请选择识别模型', 'warning');
            return;
          }

          if (!imageInput.files || imageInput.files.length === 0) {
            showToast('请先上传图像', 'warning');
            return;
          }

          // 显示处理进度
          document.getElementById('processing-progress').style.display = 'block';
          document.getElementById('step-processing').classList.add('active');
          document.getElementById('process-progress-bar').style.width = '66%';
          document.getElementById('process-status-text').textContent = '正在上传图像...';

          // 禁用提交按钮防止重复提交
          document.getElementById('process-image-btn').disabled = true;

          // 首先上传图像
          const formData = new FormData();
          formData.append('file', imageInput.files[0]);

          const token = localStorage.getItem('auth_token');
          if (!token) {
            window.location.href = '/login.html';
            return;
          }

          // 上传并处理图像
          fetch('/api/images/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('图像上传失败');
            }
            return response.json();
          })
          .then(uploadData => {
            if (uploadData.success) {
              document.getElementById('process-status-text').textContent = '正在分析图像特征...';
              // 第二步：处理图像
              return fetch('/api/images/process', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  imageId: uploadData.image.id,
                  modelId: modelSelect.value
                })
              });
            } else {
              throw new Error(uploadData.message || '图像上传失败');
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('图像处理失败');
            }
            return response.json();
          })
          .then(processData => {
            if (processData.success) {
              // 处理成功，更新UI
              document.getElementById('step-processing').classList.add('completed');
              document.getElementById('step-complete').classList.add('active');
              document.getElementById('step-complete').classList.add('completed');
              document.getElementById('process-progress-bar').style.width = '100%';
              document.getElementById('process-status-text').textContent = '处理完成';

              // 显示结果
              document.getElementById('process-result').style.display = 'block';

              // 单张图像处理结果显示
              document.getElementById('single-result-display').style.display = 'block';
              document.getElementById('batch-results-display').style.display = 'none';

              // 展示结果信息
              document.getElementById('result-accuracy').textContent =
                processData.result.accuracy ? `${processData.result.accuracy.toFixed(2)}%` : 'N/A';
              document.getElementById('result-time').textContent =
                processData.result.processingTime ? `${processData.result.processingTime.toFixed(2)}秒` : 'N/A';
              document.getElementById('result-categories').textContent =
                (processData.result.categories && processData.result.categories.length > 0) ?
                processData.result.categories.join(', ') : '未检测到分类';
              document.getElementById('result-objects').textContent =
                processData.result.objectCount !== undefined ? processData.result.objectCount : '0';

              // 保存结果ID用于下载
              document.getElementById('download-result').setAttribute('data-id', processData.result.id);

              // 显示结果图片
              if (processData.result.resultUrl) {
                const resultImg = document.getElementById('result-image');
                resultImg.src = processData.result.resultUrl;
                resultImg.style.display = 'block';
              } else {
                document.getElementById('result-image').style.display = 'none';
              }

              showToast('图像处理成功', 'success');

              // 自动刷新相关数据
              fetchRecentHistory();
              fetchDashboardStats();

              // 如果用户在历史记录页面，也刷新该页面的数据
              if (document.getElementById('history-tab').classList.contains('active')) {
                fetchHistoryRecords(1);
              }
            } else {
              throw new Error(processData.message || '图像处理失败');
            }
          })
          .catch(error => {
            console.error('处理图像出错:', error);
            document.getElementById('process-status-text').textContent = '处理失败: ' + error.message;
            document.getElementById('process-progress-bar').style.width = '33%';
            document.getElementById('step-processing').classList.remove('active', 'completed');
            document.getElementById('step-complete').classList.remove('active', 'completed');
            showToast('处理失败: ' + error.message, 'error');
          })
          .finally(() => {
            // 无论成功或失败，都重新启用提交按钮
            document.getElementById('process-image-btn').disabled = false;
          });
        });
      }

      // 同样处理如有必要，可以在这里添加其他表单的重新绑定
      // 批量图像处理表单、视频处理表单等...
    }

    function initModelFeatures() {
      modelUploadFormBinded = false;

      // 模型管理标签切换
      const modelTabLinks = document.querySelectorAll('.tab-link[data-tab^="all-models"], .tab-link[data-tab^="system-models"], .tab-link[data-tab^="custom-models"], .tab-link[data-tab^="favorite-models"]');
      const modelTabContents = document.querySelectorAll('#models-tab .tab-content');

      modelTabLinks.forEach(link => {
        link.addEventListener('click', function() {
          // 首先清除所有模型标签的激活状态
          modelTabLinks.forEach(l => l.classList.remove('active'));
          // 然后只给当前点击的标签添加激活状态
          this.classList.add('active');

          const tabId = this.getAttribute('data-tab');
          modelTabContents.forEach(tc => tc.classList.remove('active'));
          document.getElementById(`${tabId}-content`).classList.add('active');

          // 加载对应的模型数据
          if (tabId === 'all-models') {
            fetchAllModels('all');
          } else if (tabId === 'system-models') {
            fetchAllModels('system');
          } else if (tabId === 'custom-models') {
            fetchAllModels('custom');
          } else if (tabId === 'favorite-models') {
            fetchAllModels('favorite');
          }
        });
      });

      // 强制清除所有标签激活状态，避免多条激活线问题
      console.log("模型管理初始化：强制清除所有模型子标签状态");
      modelTabLinks.forEach(t => t.classList.remove('active'));

      // 添加激活状态到所有模型标签
      const defaultModelTab = document.querySelector('.tab-link[data-tab="all-models"]');
      if (defaultModelTab) {
        defaultModelTab.classList.add('active');

        // 显示对应内容
        modelTabContents.forEach(tc => tc.classList.remove('active'));
        const defaultContent = document.getElementById('all-models-content');
        if (defaultContent) {
          defaultContent.classList.add('active');
        }
      }

      // 添加模型按钮
      const addModelBtn = document.getElementById('add-model-btn');
      const addModelModal = document.getElementById('add-model-modal');
      const closeModelModal = document.getElementById('close-model-modal');
      const cancelModelUploadBtn = document.getElementById('cancel-model-upload');

      if (addModelBtn) {
        addModelBtn.addEventListener('click', function() {
          addModelModal.style.display = 'flex';
        });
      }

      if (closeModelModal) {
        closeModelModal.addEventListener('click', function() {
          addModelModal.style.display = 'none';
        });
      }

      if (cancelModelUploadBtn) {
        cancelModelUploadBtn.addEventListener('click', function() {
          addModelModal.style.display = 'none';
        });
      }

      // 添加文件选择按钮事件监听器
      const selectModelFileBtn = document.getElementById('select-model-file-btn');
      const modelFileInput = document.getElementById('model-file-input');

      if (selectModelFileBtn && modelFileInput) {
        selectModelFileBtn.addEventListener('click', function() {
          modelFileInput.click();
        });

        // 处理模型文件选择变更
        modelFileInput.addEventListener('change', function() {
          if (this.files && this.files.length > 0) {
            const file = this.files[0];
            const fileInfo = document.getElementById('model-file-info');
            const fileName = document.getElementById('model-file-name');
            const fileSize = document.getElementById('model-file-size');

            if (fileInfo && fileName && fileSize) {
              fileName.textContent = file.name;
              fileSize.textContent = formatFileSize(file.size);
              fileInfo.style.display = 'block';
            }
          }
        });
      }

      // 删除模型文件
      const removeModelFileBtn = document.getElementById('remove-model-file');
      if (removeModelFileBtn && modelFileInput) {
        removeModelFileBtn.addEventListener('click', function() {
          modelFileInput.value = '';
          document.getElementById('model-file-info').style.display = 'none';
        });
      }

      // 添加示例图像选择按钮事件监听器
      const selectModelImageBtn = document.getElementById('select-model-image-btn');
      const modelImageInput = document.getElementById('model-image-input');

      if (selectModelImageBtn && modelImageInput) {
        selectModelImageBtn.addEventListener('click', function() {
          modelImageInput.click();
        });

        // 处理图像文件选择变更
        modelImageInput.addEventListener('change', function() {
          if (this.files && this.files.length > 0) {
            const file = this.files[0];
            const imagePreview = document.getElementById('model-image-preview');
            const previewImg = document.getElementById('model-image-preview-img');

            if (imagePreview && previewImg) {
              // 显示图像预览
              const reader = new FileReader();
              reader.onload = function(e) {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);

              imagePreview.style.display = 'block';
            }
          }
        });
      }

      // 删除示例图像
      const removeModelImageBtn = document.getElementById('remove-model-image');
      if (removeModelImageBtn && modelImageInput) {
        removeModelImageBtn.addEventListener('click', function() {
          modelImageInput.value = '';
          document.getElementById('model-image-preview').style.display = 'none';
        });
      }

      // 添加结果示例图片选择按钮事件监听器
      const selectModelResultImageBtn = document.getElementById('select-model-result-image-btn');
      const modelResultImageInput = document.getElementById('model-result-image-input');
      if (selectModelResultImageBtn && modelResultImageInput) {
        selectModelResultImageBtn.addEventListener('click', function() {
          modelResultImageInput.click();
        });
        modelResultImageInput.addEventListener('change', function() {
          if (this.files && this.files.length > 0) {
            const file = this.files[0];
            const imagePreview = document.getElementById('model-result-image-preview');
            const previewImg = document.getElementById('model-result-image-preview-img');
            if (imagePreview && previewImg) {
              const reader = new FileReader();
              reader.onload = function(e) {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);
              imagePreview.style.display = 'block';
            }
          }
        });
      }
      // 删除结果示例图片
      const removeModelResultImageBtn = document.getElementById('remove-model-result-image');
      if (removeModelResultImageBtn && modelResultImageInput) {
        removeModelResultImageBtn.addEventListener('click', function() {
          modelResultImageInput.value = '';
          document.getElementById('model-result-image-preview').style.display = 'none';
        });
      }

      // 模型筛选功能
      const modelTypeFilter = document.getElementById('model-type-filter');
      const modelSort = document.getElementById('model-sort');
      const modelSearch = document.getElementById('model-search');
      const modelSearchBtn = document.getElementById('model-search-btn');

      if (modelTypeFilter) {
        modelTypeFilter.addEventListener('change', function() {
          // 获取当前激活的标签
          const activeTab = document.querySelector('.tab-link.active[data-tab^="all-models"], .tab-link.active[data-tab^="system-models"], .tab-link.active[data-tab^="custom-models"], .tab-link.active[data-tab^="favorite-models"]');
          const tabId = activeTab.getAttribute('data-tab');

          if (tabId === 'all-models') {
            fetchAllModels('all');
          } else if (tabId === 'system-models') {
            fetchAllModels('system');
          } else if (tabId === 'custom-models') {
            fetchAllModels('custom');
          } else if (tabId === 'favorite-models') {
            fetchAllModels('favorite');
          }
        });
      }

      if (modelSort) {
        modelSort.addEventListener('change', function() {
          // 获取当前激活的标签
          const activeTab = document.querySelector('.tab-link.active[data-tab^="all-models"], .tab-link.active[data-tab^="system-models"], .tab-link.active[data-tab^="custom-models"], .tab-link.active[data-tab^="favorite-models"]');
          const tabId = activeTab.getAttribute('data-tab');

          if (tabId === 'all-models') {
            fetchAllModels('all');
          } else if (tabId === 'system-models') {
            fetchAllModels('system');
          } else if (tabId === 'custom-models') {
            fetchAllModels('custom');
          } else if (tabId === 'favorite-models') {
            fetchAllModels('favorite');
          }
        });
      }

      if (modelSearchBtn) {
        modelSearchBtn.addEventListener('click', function() {
          // 获取当前激活的标签
          const activeTab = document.querySelector('.tab-link.active[data-tab^="all-models"], .tab-link.active[data-tab^="system-models"], .tab-link.active[data-tab^="custom-models"], .tab-link.active[data-tab^="favorite-models"]');
          const tabId = activeTab.getAttribute('data-tab');

          if (tabId === 'all-models') {
            fetchAllModels('all');
          } else if (tabId === 'system-models') {
            fetchAllModels('system');
          } else if (tabId === 'custom-models') {
            fetchAllModels('custom');
          } else if (tabId === 'favorite-models') {
            fetchAllModels('favorite');
          }
        });
      }

      // 处理表单提交
      const modelUploadForm = document.getElementById('model-upload-form');
      console.log('modelUploadForm:', modelUploadForm);
      console.log('modelUploadFormBinded:', modelUploadFormBinded);
      const submitModelUploadBtn = document.getElementById('submit-model-upload');
      console.log('submitModelUploadBtn:', submitModelUploadBtn);

      if (modelUploadForm && !modelUploadFormBinded) {
        console.log('绑定模型上传表单事件');

        // 添加申请公开模型复选框变更事件
        const modelSharedCheckbox = document.getElementById('model-shared');
        const publishReasonGroup = document.getElementById('publish-reason-group');

        if (modelSharedCheckbox && publishReasonGroup) {
          modelSharedCheckbox.addEventListener('change', function() {
            if (this.checked) {
              publishReasonGroup.style.display = 'block';
            } else {
              publishReasonGroup.style.display = 'none';
            }
          });
        }

        modelUploadForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const modelName = document.getElementById('model-name').value;
          const modelCategory = document.getElementById('model-category').value;
          const modelDescription = document.getElementById('model-description').value;
          const modelFileInput = document.getElementById('model-file-input');
          const modelFile = modelFileInput.files[0];
          const modelImageInput = document.getElementById('model-image-input');
          const exampleImage = modelImageInput.files[0];
          const modelResultImageInput = document.getElementById('model-result-image-input');
          const resultExampleImage = modelResultImageInput.files[0];
          const isShared = document.getElementById('model-shared').checked;
          const publishReason = document.getElementById('model-publish-reason').value;
          const modelParameters = document.getElementById('model-parameters').value;
          const modelInstructions = document.getElementById('model-instructions').value;

          if (!modelName || !modelCategory || !modelDescription || !modelFile || !exampleImage || !resultExampleImage) {
            showToast('请填写完整的模型信息', 'warning');
            return;
          }

          // 验证申请理由
          if (isShared && !publishReason.trim()) {
            showToast('申请公开模型需要填写申请理由', 'warning');
            return;
          }

          // 创建表单数据对象
          const formData = new FormData();
          formData.append('name', modelName);
          formData.append('type', modelCategory);
          formData.append('description', modelDescription);
          formData.append('modelFile', modelFile);
          formData.append('exampleImage', exampleImage);
          formData.append('resultExampleImage', resultExampleImage);
          formData.append('isShared', isShared);
          formData.append('publishReason', publishReason);
          formData.append('parameters', modelParameters);
          formData.append('instructions', modelInstructions);

          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }

          // 显示上传中的状态
          submitModelUploadBtn.disabled = true;
          submitModelUploadBtn.innerHTML = '<i class="ri-loader-line loading"></i> 上传中...';

          // 上传模型
          fetch('/api/models/add', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          })
          .then(response => {
            // 记录原始响应的HTTP状态码
            const statusCode = response.status;

            // 不论状态码如何，尝试解析JSON响应
            return response.text().then(text => {
              try {
                // 尝试将响应解析为JSON
                const data = text ? JSON.parse(text) : {};
                return { statusCode, data };
              } catch (e) {
                // 如果解析JSON失败，返回原始文本
                return { statusCode, data: { success: statusCode >= 200 && statusCode < 300, message: text } };
              }
            });
          })
          .then(({ statusCode, data }) => {
            submitModelUploadBtn.disabled = false;
            submitModelUploadBtn.innerHTML = '上传模型';

            console.log("模型上传响应:", { statusCode, data });

            // 状态码介于200-299之间表示成功，或者data.success为true
            if ((statusCode >= 200 && statusCode < 300) || data.success === true) {
              // 无论响应内容如何，只要HTTP状态码正常就认为上传成功
              showToast(data.message || '模型上传成功', 'success');

              // 如果用户选择申请公开，则提示已提交申请并刷新通知徽章
              if (isShared) {
                showToast('模型公开申请已提交，等待管理员审核', 'success');
                // 刷新通知小铃铛徽章
                updateNotificationBadge();
              }

              // 关闭模态框
              addModelModal.style.display = 'none';

              // 重置表单
              modelUploadForm.reset();
              document.getElementById('model-file-info').style.display = 'none';
              document.getElementById('model-image-preview').style.display = 'none';
              document.getElementById('model-result-image-preview').style.display = 'none';

              // 刷新模型列表
              fetchAllModels('all');
              fetchAllModels('custom');

              // 刷新上传页面的模型选择列表
              loadModelList();
            } else {
              // 失败情况
              showToast(data.message || '上传失败，请稍后重试', 'error');
            }
          })
          .catch(error => {
            console.error('上传模型出错:', error);
            submitModelUploadBtn.disabled = false;
            submitModelUploadBtn.innerHTML = '上传模型';
            showToast('上传失败，请稍后重试', 'error');
          });
        });

        // 添加按钮点击事件，手动触发表单提交
        if (submitModelUploadBtn) {
          submitModelUploadBtn.addEventListener('click', function() {
            console.log('提交按钮被点击，手动触发表单提交');
            modelUploadForm.dispatchEvent(new Event('submit'));
          });
        }

        modelUploadFormBinded = true;
      }
    }

    function initPermissionFeatures() {
      // 获取用户信息，判断是否为管理员
      const userInfoStr = localStorage.getItem('user_info');
      let isAdmin = false;

      if (userInfoStr) {
        try {
          const userInfo = JSON.parse(userInfoStr);
          isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;
        } catch (e) {
          console.error("【调试】解析用户信息失败:", e);
        }
      }

      // 强制检查是否为admin用户名(额外检查以确保管理员功能正常显示)
      const username = document.getElementById('username').textContent;
      if (username === 'admin') {
        isAdmin = true;
      }

      console.log("权限功能初始化 - 用户是管理员:", isAdmin);

      // 获取对话框和按钮元素（提前定义，确保在各处都可以使用）
      const newPermissionModal = document.getElementById('new-permission-modal');
      const closePermissionModal = document.getElementById('close-permission-modal');
      const cancelPermissionBtn = document.getElementById('cancel-permission');
      const permissionType = document.getElementById('permission-type');
      const storageSizeGroup = document.getElementById('storage-size-group');

      // 更新左侧菜单文本
      const permissionMenuText = document.getElementById('permissions-menu-text');
      if (permissionMenuText) {
        permissionMenuText.textContent = isAdmin ? '权限审批' : '权限申请';
      }

      // 设置标题和按钮
      const permissionsHeader = document.getElementById('permissions-header');
      if (isAdmin) {
        permissionsHeader.innerHTML = `
          <h2 class="section-title">权限审批</h2>
          <div>
            <button class="btn btn-outline btn-sm" id="refresh-permissions-btn">
              <i class="ri-refresh-line"></i> 刷新列表
            </button>
          </div>
        `;

        // 显示管理员内容，隐藏用户内容
        document.getElementById('admin-permissions-content').style.display = 'block';
        document.getElementById('user-permissions-content').style.display = 'none';

        // 获取待审批权限列表
        fetchAdminPermissions();

        // 绑定刷新按钮事件
        const refreshBtn = document.getElementById('refresh-permissions-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', fetchAdminPermissions);
        }

        // 管理员专属：初始化权限审批功能
        initPermissionApprovalFeatures();
      } else {
        permissionsHeader.innerHTML = `
          <h2 class="section-title">权限申请</h2>
          <button class="btn btn-primary btn-sm" id="new-permission-btn">
            <i class="ri-add-line"></i> 新建申请
          </button>
        `;

        // 显示用户内容，隐藏管理员内容
        document.getElementById('admin-permissions-content').style.display = 'none';
        document.getElementById('user-permissions-content').style.display = 'block';

        // 获取权限申请列表
        fetchPermissions();

        // 新建权限申请按钮
        const newPermissionBtn = document.getElementById('new-permission-btn');

        if (newPermissionBtn && newPermissionModal) {
          newPermissionBtn.addEventListener('click', function() {
            newPermissionModal.style.display = 'flex';
          });
        }

        if (closePermissionModal && newPermissionModal) {
          closePermissionModal.addEventListener('click', function() {
            newPermissionModal.style.display = 'none';
          });
        }

        // 取消申请按钮点击事件
        if (cancelPermissionBtn && newPermissionModal) {
          cancelPermissionBtn.addEventListener('click', function() {
            newPermissionModal.style.display = 'none';
            // 可选：重置申请表单
            const permissionForm = document.getElementById('permission-form');
            if (permissionForm) {
              permissionForm.reset();
            }
            // 隐藏存储大小选项
            const storageSizeGroup = document.getElementById('storage-size-group');
            if (storageSizeGroup) {
              storageSizeGroup.style.display = 'none';
            }
          });
        }
      }

      // 权限类型选择变更 - 这部分对所有用户通用
      if (permissionType && storageSizeGroup) {
        permissionType.addEventListener('change', function() {
          storageSizeGroup.style.display = this.value === 'storage' ? 'block' : 'none';
        });
      }

      // 提交申请按钮 - 这部分对所有用户通用
      let submitPermissionBtn = document.getElementById('submit-permission');
      if (submitPermissionBtn) {
        // 先移除之前的事件监听器，防止重复绑定
        submitPermissionBtn.replaceWith(submitPermissionBtn.cloneNode(true));
        submitPermissionBtn = document.getElementById('submit-permission');
        submitPermissionBtn.addEventListener('click', function() {
          const permissionTypeValue = document.getElementById('permission-type').value;
          const permissionReason = document.getElementById('permission-reason').value;
          const storageSizeValue = document.getElementById('storage-size').value;

          if (!permissionTypeValue) {
            showToast('请选择申请类型', 'warning');
            return;
          }

          if (!permissionReason.trim()) {
            showToast('请填写申请原因', 'warning');
            return;
          }

          // 准备请求数据
          const requestData = {
            requestType: permissionTypeValue,
            requestReason: permissionReason
          };

          // 如果是存储空间申请，添加存储大小
          if (permissionTypeValue === 'storage') {
            requestData.storageSize = parseInt(storageSizeValue);
          }

          // 获取token
          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }

          // 发送权限申请请求
          fetch('/api/permissions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
          })
          .then(response => {
            // 首先检查HTTP响应状态
            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem('auth_token');
                window.location.href = '/login.html';
                throw new Error('未授权，请重新登录');
              }
              return response.json().then(errorData => {
                throw new Error(errorData.message || '申请提交失败');
              });
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showToast('权限申请已提交', 'success');
              newPermissionModal.style.display = 'none';
              // 刷新权限申请列表
              fetchPermissions();

              // 重置表单
              const permissionForm = document.getElementById('permission-form');
              if (permissionForm) {
                permissionForm.reset();
              }

              // 隐藏存储大小选项
              if (storageSizeGroup) {
                storageSizeGroup.style.display = 'none';
              }

              // 立即更新通知徽章，显示新的未读消息
              updateNotificationBadge();
            } else {
              showToast(data.message || '申请提交失败', 'error');
            }
          })
          .catch(error => {
            console.error('提交权限申请出错:', error);
            showToast(error.message || '申请提交失败，请稍后重试', 'error');
          });
        });
      }

      // 管理员审批功能初始化
      if (isAdmin) {
        initPermissionApprovalFeatures();
      }
    }

    // 初始化模型公开申请相关功能
    function initModelPublishFeatures() {
      console.log("初始化模型公开申请功能");

      // 优先使用window.userRole，否则尝试从localStorage获取
      let isAdmin = window.userRole === 'admin';

      // 如果window.userRole未设置，尝试从localStorage获取
      if (window.userRole === undefined) {
        try {
          const userInfoStr = localStorage.getItem('user_info');
          if (userInfoStr) {
            const userInfo = JSON.parse(userInfoStr);
            isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;
            // 设置window.userRole以便将来使用
            window.userRole = isAdmin ? 'admin' : 'user';
          }
        } catch (e) {
          console.error("解析用户信息失败:", e);
        }
      }

      console.log("模型公开功能权限检查:", window.userRole, isAdmin);

      // 获取元素
      const modelPublishMenuText = document.getElementById('model-publish-menu-text');
      if (modelPublishMenuText) {
        modelPublishMenuText.textContent = isAdmin ? '模型审核' : '模型公开';
      }

      // 调整标题和按钮
      const modelPublishHeader = document.getElementById('model-publish-header');
      if (!modelPublishHeader) return;

      if (isAdmin) {
        // 管理员界面
        modelPublishHeader.innerHTML = `
          <h2 class="section-title">模型公开审批</h2>
          <button class="btn btn-outline btn-sm" id="refresh-model-publish-btn">
            <i class="ri-refresh-line"></i> 刷新
          </button>
        `;

        // 显示管理员内容，隐藏用户内容
        document.getElementById('admin-model-publish-content').style.display = 'block';
        document.getElementById('user-model-publish-content').style.display = 'none';

        // 加载管理员待审批列表
        fetchAdminModelPublishRequests('all');

        // 绑定刷新按钮事件
        const refreshBtn = document.getElementById('refresh-model-publish-btn');
        if (refreshBtn) {
          console.log("找到管理员刷新按钮，添加点击事件");
          // 移除所有现有事件监听器
          refreshBtn.removeEventListener('click', function(){});
          // 使用onclick属性直接绑定
          refreshBtn.onclick = function() {
            console.log("管理员刷新按钮被点击");
            // 调用fetchAdminModelPublishRequests并传递'all'参数
            fetchAdminModelPublishRequests('all');
          };
        }
      } else {
        // 普通用户界面
        modelPublishHeader.innerHTML = `
          <h2 class="section-title">模型公开申请</h2>
          <button class="btn btn-outline btn-sm" id="refresh-model-publish-btn">
            <i class="ri-refresh-line"></i> 刷新列表
          </button>
        `;

        // 显示用户内容，隐藏管理员内容
        document.getElementById('admin-model-publish-content').style.display = 'none';
        document.getElementById('user-model-publish-content').style.display = 'block';

        // 加载用户申请列表
        fetchUserModelPublishRequests();

        // 绑定刷新按钮事件
        const refreshBtn = document.getElementById('refresh-model-publish-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', fetchUserModelPublishRequests);
        }
      }

      // 初始化用户查看详情模态框
      initUserModelPublishDetailModal();
    }

    // 获取用户的模型公开申请列表
    function fetchUserModelPublishRequests() {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const tableBody = document.getElementById('model-publish-table-body');
      if (!tableBody) return;

      // 显示加载中
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center">
            <div class="loading-spinner"></div>
          </td>
        </tr>
      `;

      // 获取数据
      fetch('/api/model-publish-requests', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const requests = data.requests;

          if (requests.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" class="text-center">暂无申请记录</td>
              </tr>
            `;
            return;
          }

          let html = '';
          requests.forEach(req => {
            let statusTag = '';
            let actionBtn = '';

            // 根据状态设置不同的标签样式
            if (req.status === 'pending') {
              statusTag = `<span class="tag tag-warning">审核中</span>`;
              actionBtn = `<button class="btn btn-sm btn-outline view-model-publish" data-id="${req.id}">查看</button>`;
            } else if (req.status === 'approved') {
              statusTag = `<span class="tag tag-success">已批准</span>`;
              actionBtn = `<button class="btn btn-sm btn-outline view-model-publish" data-id="${req.id}">详情</button>`;
            } else if (req.status === 'rejected') {
              statusTag = `<span class="tag tag-danger">已拒绝</span>`;
              actionBtn = `<button class="btn btn-sm btn-outline view-model-publish" data-id="${req.id}">详情</button>`;
            }

            html += `
              <tr>
                <td>${escapeHtml(req.model_name)}</td>
                <td>${getModelTypeName(req.model_type)}</td>
                <td>${formatDate(req.created_at)}</td>
                <td>${statusTag}</td>
                <td>${actionBtn}</td>
              </tr>
            `;
          });

          tableBody.innerHTML = html;

          // 绑定查看详情按钮事件
          const viewBtns = document.querySelectorAll('.view-model-publish');
          viewBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const requestId = this.getAttribute('data-id');
              openUserModelPublishDetail(requestId);
            });
          });
        } else {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-danger">
                加载失败: ${data.message || '未知错误'}
              </td>
            </tr>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型公开申请列表失败:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-danger">
              加载失败: ${error.message || '网络错误'}
            </td>
          </tr>
        `;
      });
    }

    // 获取管理员的模型公开申请列表
    function fetchAdminModelPublishRequests(status = 'all') {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const tableBody = document.getElementById('admin-model-publish-table-body');
      if (!tableBody) return;

      // 显示加载中
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center">
            <div class="loading-spinner"></div>
          </td>
        </tr>
      `;

      // 获取数据 - 添加status参数
      fetch(`/api/admin/model-publish-requests?status=${status}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        console.log("收到响应状态:", response.status);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const requests = data.requests;

          if (requests.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="text-center">暂无${status === 'pending' ? '待审批' : ''}申请</td>
              </tr>
            `;
            return;
          }

          let html = '';
          requests.forEach(req => {
            let statusTag = '';
            let actionBtn = '';

            // 根据状态设置不同的标签样式
            if (req.status === 'pending') {
              statusTag = `<span class="tag tag-warning">待审批</span>`;
              actionBtn = `<button class="btn btn-sm btn-primary approve-model-publish" data-id="${req.id}">审批</button>`;
            } else if (req.status === 'approved') {
              statusTag = `<span class="tag tag-success">已批准</span>`;
              actionBtn = `<button class="btn btn-sm btn-outline view-admin-model-publish" data-id="${req.id}">详情</button>`;
            } else if (req.status === 'rejected') {
              statusTag = `<span class="tag tag-danger">已拒绝</span>`;
              actionBtn = `<button class="btn btn-sm btn-outline view-admin-model-publish" data-id="${req.id}">详情</button>`;
            }

            html += `
              <tr>
                <td>${escapeHtml(req.username)}</td>
                <td>${escapeHtml(req.model_name)}</td>
                <td>${getModelTypeName(req.model_type)}</td>
                <td>${formatDate(req.created_at)}</td>
                <td>${statusTag}</td>
                <td>${actionBtn}</td>
              </tr>
            `;
          });

          tableBody.innerHTML = html;

          // 绑定审批按钮事件
          const approveBtns = document.querySelectorAll('.approve-model-publish');
          approveBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const requestId = this.getAttribute('data-id');
              openModelPublishApproval(requestId);
            });
          });

          // 绑定详情按钮事件
          const viewBtns = document.querySelectorAll('.view-admin-model-publish');
          viewBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const requestId = this.getAttribute('data-id');
              openModelPublishApproval(requestId, true);
            });
          });
        } else {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger">
                加载失败: ${data.message || '未知错误'}
              </td>
            </tr>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型公开申请列表失败:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              加载失败: ${error.message || '网络错误'}
            </td>
          </tr>
        `;
      });
    }

    // 初始化用户查看模型公开申请详情模态框
    function initUserModelPublishDetailModal() {
      console.log("初始化用户查看模型公开申请详情模态框");

      // 关闭按钮事件
      const closeBtn = document.getElementById('close-user-model-publish-modal');
      const closeDetailBtn = document.getElementById('close-user-model-publish-btn');
      const modal = document.getElementById('user-model-publish-detail-modal');

      if (!modal) {
        console.error("找不到用户模型公开申请详情模态框");
        return;
      }

      if (closeBtn) {
        console.log("为关闭按钮(X)添加事件监听器");
        closeBtn.onclick = function() {
          console.log("关闭按钮(X)被点击");
          modal.style.display = 'none';
        };
      } else {
        console.error("找不到关闭按钮(X)");
      }

      if (closeDetailBtn) {
        console.log("为关闭按钮(底部)添加事件监听器");
        closeDetailBtn.onclick = function() {
          console.log("关闭按钮(底部)被点击");
          modal.style.display = 'none';
        };
      } else {
        console.error("找不到关闭按钮(底部)");
      }

      // 点击模态框背景关闭
      modal.onclick = function(e) {
        if (e.target === this) {
          console.log("模态框背景被点击");
          this.style.display = 'none';
        }
      };
    }

    // 打开用户模型公开申请详情
    function openUserModelPublishDetail(requestId) {
      console.log("打开用户模型公开申请详情, ID:", requestId);

      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modal = document.getElementById('user-model-publish-detail-modal');
      const contentDiv = document.getElementById('user-model-publish-detail-content');
      const pendingActions = document.getElementById('model-publish-pending-actions');
      const editBtn = document.getElementById('edit-model-publish-btn');
      const cancelBtn = document.getElementById('cancel-model-publish-btn');

      if (!modal) {
        console.error("找不到用户模型公开申请详情模态框");
        return;
      }

      if (!contentDiv) {
        console.error("找不到用户模型公开申请详情内容区域");
        return;
      }

      // 显示模态框并加载内容
      modal.style.display = 'flex';
      contentDiv.innerHTML = '<div class="loading-spinner"></div>';

      // 隐藏修改和撤销按钮，直到确认状态是pending
      if (pendingActions) {
        pendingActions.style.display = 'none';
      }

      // 获取申请详情
      fetch(`/api/model-publish-requests/${requestId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const req = data.request;
          let statusTag = '';

          // 保存请求ID到全局变量，以便修改和撤销功能使用
          window.currentModelPublishRequestId = requestId;
          window.currentModelPublishRequest = req;

          // 根据状态设置不同的标签样式
          if (req.status === 'pending') {
            statusTag = `<span class="tag tag-warning">审核中</span>`;
            // 显示修改和撤销按钮
            if (pendingActions) {
              pendingActions.style.display = 'block';
            }
          } else if (req.status === 'approved') {
            statusTag = `<span class="tag tag-success">已批准</span>`;
          } else if (req.status === 'rejected') {
            statusTag = `<span class="tag tag-danger">已拒绝</span>`;
          }

          // 构建审批反馈部分
          let feedbackHtml = '';
          if (req.status === 'approved' || req.status === 'rejected') {
            feedbackHtml = `
              <div class="form-group">
                <label class="form-label">管理员反馈</label>
                <div class="alert ${req.status === 'approved' ? 'alert-success' : 'alert-danger'}">
                  <i class="${req.status === 'approved' ? 'ri-checkbox-circle-line' : 'ri-error-warning-line'}"></i>
                  <span>${req.admin_comment ? escapeHtml(req.admin_comment) : (req.status === 'approved' ? '您的申请已通过' : '您的申请未通过')}</span>
                </div>
              </div>
            `;
          }

          // 构建详情HTML
          contentDiv.innerHTML = `
            <div class="form-group">
              <label class="form-label">模型名称</label>
              <div class="d-flex align-center">
                <span>${escapeHtml(req.model_name)}</span>
                ${statusTag}
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">模型类型</label>
              <span>${getModelTypeName(req.model_type)}</span>
            </div>

            <div class="form-group">
              <label class="form-label">模型描述</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_description)}</div>
            </div>

            <div class="form-group">
              <label class="form-label">申请时间</label>
              <span>${formatDate(req.created_at)}</span>
            </div>

            <div class="form-group" id="reason-display-group">
              <label class="form-label">申请理由</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.reason)}</div>
            </div>

            <div class="form-group" id="reason-edit-group" style="display: none;">
              <label class="form-label">申请理由</label>
              <textarea class="form-control" id="edit-model-publish-reason" rows="5">${escapeHtml(req.reason)}</textarea>
              <div class="form-text">请详细说明为何需要公开此模型</div>
              <div class="mt-10">
                <button class="btn btn-sm btn-primary" id="save-reason-btn">保存修改</button>
                <button class="btn btn-sm btn-outline" id="cancel-edit-btn">取消</button>
              </div>
            </div>

            ${req.model_parameters ? `
            <div class="form-group">
              <label class="form-label">技术参数</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_parameters)}</div>
            </div>
            ` : ''}

            ${req.model_instructions ? `
            <div class="form-group">
              <label class="form-label">使用说明</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_instructions)}</div>
            </div>
            ` : ''}

            <div class="form-group">
              <label class="form-label">模型输入示例</label>
              <div>
                <img src="${req.model_example_image}" alt="模型输入示例" style="max-width: 100%; max-height: 300px; border-radius: var(--border-radius);">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">模型输出示例</label>
              <div>
                <img src="${req.model_result_example_image}" alt="模型输出示例" style="max-width: 100%; max-height: 300px; border-radius: var(--border-radius);">
              </div>
            </div>

            ${feedbackHtml}
          `;

          // 绑定修改按钮事件
          if (editBtn && req.status === 'pending') {
            editBtn.onclick = function() {
              document.getElementById('reason-display-group').style.display = 'none';
              document.getElementById('reason-edit-group').style.display = 'block';

              // 绑定保存和取消按钮
              document.getElementById('save-reason-btn').onclick = function() {
                const newReason = document.getElementById('edit-model-publish-reason').value.trim();
                if (!newReason) {
                  alert('申请理由不能为空');
                  return;
                }
                updateModelPublishRequest(requestId, newReason);
              };

              document.getElementById('cancel-edit-btn').onclick = function() {
                document.getElementById('reason-display-group').style.display = 'block';
                document.getElementById('reason-edit-group').style.display = 'none';
              };
            };
          }

          // 绑定撤销按钮事件
          if (cancelBtn && req.status === 'pending') {
            cancelBtn.onclick = function() {
              if (confirm('确定要撤销此模型公开申请吗？此操作不可撤销。')) {
                cancelModelPublishRequest(requestId);
              }
            };
          }
        } else {
          contentDiv.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <p>加载失败: ${data.message || '无法获取申请详情'}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型公开申请详情失败:', error);
        contentDiv.innerHTML = `
          <div class="empty-state">
            <i class="ri-error-warning-line"></i>
            <p>加载失败: ${error.message || '网络错误'}</p>
          </div>
        `;
      });
    }

    // 添加更新模型公开申请的函数
    function updateModelPublishRequest(requestId, newReason) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示保存中状态
      const saveBtn = document.getElementById('save-reason-btn');
      const cancelBtn = document.getElementById('cancel-edit-btn');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="ri-loader-line loading"></i> 保存中...';
        saveBtn.disabled = true;
      }
      if (cancelBtn) {
        cancelBtn.disabled = true;
      }

      // 发送更新请求
      fetch(`/api/model-publish-requests/${requestId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reason: newReason })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('申请修改成功', 'success');
          // 重新打开详情，显示更新后的内容
          openUserModelPublishDetail(requestId);
          // 刷新用户申请列表
          fetchUserModelPublishRequests();
        } else {
          showToast(data.message || '修改失败', 'error');
          // 恢复按钮状态
          if (saveBtn) {
            saveBtn.innerHTML = '保存修改';
            saveBtn.disabled = false;
          }
          if (cancelBtn) {
            cancelBtn.disabled = false;
          }
        }
      })
      .catch(error => {
        console.error('修改模型公开申请失败:', error);
        showToast('修改失败，请稍后重试', 'error');
        // 恢复按钮状态
        if (saveBtn) {
          saveBtn.innerHTML = '保存修改';
          saveBtn.disabled = false;
        }
        if (cancelBtn) {
          cancelBtn.disabled = false;
        }
      });
    }

    // 添加撤销模型公开申请的函数
    function cancelModelPublishRequest(requestId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示撤销中状态
      const modal = document.getElementById('user-model-publish-detail-modal');
      const cancelBtn = document.getElementById('cancel-model-publish-btn');
      if (cancelBtn) {
        cancelBtn.innerHTML = '<i class="ri-loader-line loading"></i> 撤销中...';
        cancelBtn.disabled = true;
      }

      // 发送撤销请求
      fetch(`/api/model-publish-requests/${requestId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('申请已成功撤销', 'success');
          // 关闭模态框
          if (modal) {
            modal.style.display = 'none';
          }
          // 刷新用户申请列表
          fetchUserModelPublishRequests();
        } else {
          showToast(data.message || '撤销失败', 'error');
          // 恢复按钮状态
          if (cancelBtn) {
            cancelBtn.innerHTML = '<i class="ri-close-circle-line"></i> 撤销申请';
            cancelBtn.disabled = false;
          }
        }
      })
      .catch(error => {
        console.error('撤销模型公开申请失败:', error);
        showToast('撤销失败，请稍后重试', 'error');
        // 恢复按钮状态
        if (cancelBtn) {
          cancelBtn.innerHTML = '<i class="ri-close-circle-line"></i> 撤销申请';
          cancelBtn.disabled = false;
        }
      });
    }

    // 打开模型公开申请审批模态框
    function openModelPublishApproval(requestId, readOnly = false) {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modal = document.getElementById('model-publish-approval-modal');
      const contentDiv = document.getElementById('model-publish-detail-content');
      const approveBtn = document.getElementById('approve-model-publish-btn');
      const rejectBtn = document.getElementById('reject-model-publish-btn');
      const closeBtn = document.getElementById('close-approval-btn');
      const closeModalBtn = document.getElementById('close-model-publish-approval-modal');

      if (!modal || !contentDiv) {
        console.error("找不到模态框或内容区域");
        return;
      }

      console.log("打开模型审批模态框，请求ID:", requestId, "只读模式:", readOnly);

      // 设置按钮的请求ID，确保是字符串类型
      if (approveBtn) approveBtn.setAttribute('data-id', requestId.toString());
      if (rejectBtn) rejectBtn.setAttribute('data-id', requestId.toString());

      // 重新绑定按钮事件，以防之前的事件绑定失效
      if (closeBtn) {
        // 清除之前的事件
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

        // 重新绑定事件
        newCloseBtn.addEventListener('click', function() {
          console.log("关闭按钮点击");
          modal.style.display = 'none';
        });
      }

      if (closeModalBtn) {
        // 清除之前的事件
        const newCloseModalBtn = closeModalBtn.cloneNode(true);
        closeModalBtn.parentNode.replaceChild(newCloseModalBtn, closeModalBtn);

        // 重新绑定事件
        newCloseModalBtn.addEventListener('click', function() {
          console.log("右上角关闭按钮点击");
          modal.style.display = 'none';
        });
      }

      if (approveBtn && !readOnly) {
        // 清除之前的事件
        const newApproveBtn = approveBtn.cloneNode(true);
        approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);

        // 重新绑定事件
        newApproveBtn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          console.log("批准按钮点击，ID:", id);
          if (!id) {
            console.error("无法获取申请ID");
            return;
          }

          // 请求确认
          if (!confirm('确定批准这个模型公开申请吗？')) return;

          // 获取可能的评论
          const commentInput = document.getElementById('model-publish-admin-comment');
          const adminComment = commentInput ? commentInput.value.trim() : '';

          approveModelPublishRequest(id, adminComment);
        });
      }

      if (rejectBtn && !readOnly) {
        // 清除之前的事件
        const newRejectBtn = rejectBtn.cloneNode(true);
        rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);

        // 重新绑定事件
        newRejectBtn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          console.log("拒绝按钮点击，ID:", id);
          if (!id) {
            console.error("无法获取申请ID");
            return;
          }

          // 获取拒绝理由
          const commentInput = document.getElementById('model-publish-admin-comment');
          const adminComment = commentInput ? commentInput.value.trim() : '';

          if (!adminComment) {
            alert('请填写拒绝理由');
            if (commentInput) commentInput.focus();
            return;
          }

          // 请求确认
          if (!confirm('确定拒绝这个模型公开申请吗？')) return;

          rejectModelPublishRequest(id, adminComment);
        });
      }

      // 如果是只读模式，隐藏审批按钮，只显示关闭按钮
      if (readOnly) {
        if (approveBtn) approveBtn.style.display = 'none';
        if (rejectBtn) rejectBtn.style.display = 'none';
        if (closeBtn) closeBtn.style.display = 'inline-flex';
      } else {
        if (approveBtn) approveBtn.style.display = 'inline-flex';
        if (rejectBtn) rejectBtn.style.display = 'inline-flex';
        if (closeBtn) closeBtn.style.display = 'inline-flex';
      }

      // 显示模态框并加载内容
      modal.style.display = 'flex';
      contentDiv.innerHTML = '<div class="loading-spinner"></div>';

      // 获取申请详情
      fetch(`/api/admin/model-publish-requests/${requestId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const req = data.request;
          let statusTag = '';

          // 根据状态设置不同的标签样式
          if (req.status === 'pending') {
            statusTag = `<span class="tag tag-warning">待审批</span>`;
          } else if (req.status === 'approved') {
            statusTag = `<span class="tag tag-success">已批准</span>`;
          } else if (req.status === 'rejected') {
            statusTag = `<span class="tag tag-danger">已拒绝</span>`;
          }

          // 构建评论输入区或显示区
          let commentHtml = '';
          if (readOnly) {
            if (req.admin_comment) {
              commentHtml = `
                <div class="form-group">
                  <label class="form-label">管理员评论</label>
                  <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.admin_comment)}</div>
                </div>
              `;
            }
          } else {
            commentHtml = `
              <div class="form-group">
                <label class="form-label">管理员评论 ${req.status === 'pending' ? '（拒绝时必填）' : ''}</label>
                <textarea class="form-control" id="model-publish-admin-comment" rows="3" placeholder="输入评论或拒绝理由">${req.admin_comment ? escapeHtml(req.admin_comment) : ''}</textarea>
              </div>
            `;
          }

          // 构建详情HTML
          contentDiv.innerHTML = `
            <div class="form-group">
              <label class="form-label">申请用户</label>
              <span>${escapeHtml(req.username)} (${escapeHtml(req.user_email)})</span>
            </div>

            <div class="form-group">
              <label class="form-label">模型名称</label>
              <div class="d-flex align-center">
                <span>${escapeHtml(req.model_name)}</span>
                ${statusTag}
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">模型类型</label>
              <span>${getModelTypeName(req.model_type)}</span>
            </div>

            <div class="form-group">
              <label class="form-label">模型描述</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_description)}</div>
            </div>

            <div class="form-group">
              <label class="form-label">申请时间</label>
              <span>${formatDate(req.created_at)}</span>
            </div>

            <div class="form-group">
              <label class="form-label">申请理由</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.reason)}</div>
            </div>

            ${req.model_parameters ? `
            <div class="form-group">
              <label class="form-label">技术参数</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_parameters)}</div>
            </div>
            ` : ''}

            ${req.model_instructions ? `
            <div class="form-group">
              <label class="form-label">使用说明</label>
              <div style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius); white-space: pre-wrap;">${escapeHtml(req.model_instructions)}</div>
            </div>
            ` : ''}

            <div class="form-group">
              <label class="form-label">模型输入示例</label>
              <div>
                <img src="${req.model_example_image}" alt="模型输入示例" style="max-width: 100%; max-height: 300px; border-radius: var(--border-radius);">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">模型输出示例</label>
              <div>
                <img src="${req.model_result_example_image}" alt="模型输出示例" style="max-width: 100%; max-height: 300px; border-radius: var(--border-radius);">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">模型文件</label>
              <div class="d-flex align-center" style="background: var(--color-bg); padding: 10px; border-radius: var(--border-radius);">
                <i class="ri-file-code-line" style="margin-right: 10px; font-size: 20px;"></i>
                <span>${req.model_path ? req.model_path.split(/[\\/]/).pop() : '无文件'}</span>
                ${req.model_path ? `
                <button class="btn btn-sm btn-outline ml-auto" onclick="downloadModelFile('${req.model_path}')">
                  <i class="ri-download-line"></i> 下载模型文件
                </button>
                ` : ''}
              </div>
            </div>

            ${commentHtml}
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <p>加载失败: ${data.message || '无法获取申请详情'}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型公开申请详情失败:', error);
        contentDiv.innerHTML = `
          <div class="empty-state">
            <i class="ri-error-warning-line"></i>
            <p>加载失败: ${error.message || '网络错误'}</p>
          </div>
        `;
      });
    }

    // 批准模型公开申请
    function approveModelPublishRequest(requestId, adminComment) {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modal = document.getElementById('model-publish-approval-modal');
      const approveBtn = document.getElementById('approve-model-publish-btn');
      const rejectBtn = document.getElementById('reject-model-publish-btn');

      if (!modal || !approveBtn || !rejectBtn) return;

      // 禁用按钮，防止重复提交
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      approveBtn.innerHTML = '<i class="ri-loader-line loading"></i> 处理中...';

      // 发送批准请求
      fetch(`/api/admin/model-publish-requests/${requestId}/approve`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ adminComment })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('申请已批准', 'success');
          modal.style.display = 'none';

          // 刷新申请列表 - 传递'all'参数
          fetchAdminModelPublishRequests('all');
        } else {
          showToast(`批准失败: ${data.message || '未知错误'}`, 'error');

          // 恢复按钮状态
          approveBtn.disabled = false;
          rejectBtn.disabled = false;
          approveBtn.innerHTML = '批准';
        }
      })
      .catch(error => {
        console.error('批准模型公开申请失败:', error);
        showToast(`批准失败: ${error.message || '网络错误'}`, 'error');

        // 恢复按钮状态
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
        approveBtn.innerHTML = '批准';
      });
    }

    // 拒绝模型公开申请
    function rejectModelPublishRequest(requestId, adminComment) {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modal = document.getElementById('model-publish-approval-modal');
      const approveBtn = document.getElementById('approve-model-publish-btn');
      const rejectBtn = document.getElementById('reject-model-publish-btn');

      if (!modal || !approveBtn || !rejectBtn) return;

      // 禁用按钮，防止重复提交
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      rejectBtn.innerHTML = '<i class="ri-loader-line loading"></i> 处理中...';

      // 发送拒绝请求
      fetch(`/api/admin/model-publish-requests/${requestId}/reject`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ adminComment })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('申请已拒绝', 'success');
          modal.style.display = 'none';

          // 刷新申请列表 - 传递'all'参数
          fetchAdminModelPublishRequests('all');
        } else {
          showToast(`拒绝失败: ${data.message || '未知错误'}`, 'error');

          // 恢复按钮状态
          approveBtn.disabled = false;
          rejectBtn.disabled = false;
          rejectBtn.innerHTML = '拒绝';
        }
      })
      .catch(error => {
        console.error('拒绝模型公开申请失败:', error);
        showToast(`拒绝失败: ${error.message || '网络错误'}`, 'error');

        // 恢复按钮状态
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
        rejectBtn.innerHTML = '拒绝';
      });
    }

    // 模型类型名称映射
    function getModelTypeName(type) {
      const typeMap = {
        'landcover': '土地覆盖',
        'building': '建筑物提取',
        'water': '水体监测',
        'vegetation': '植被分析',
        'urban': '城市分析',
        'other': '其他'
      };
      return typeMap[type] || type;
    }

    function initNotificationFeatures() {
      // 获取通知列表数据
      fetchNotifications();

      // tab切换
      // tab切换
      document.querySelectorAll('.tab-link[data-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
          // 首先清除同级标签的激活状态
          // 如果是通知相关的标签
          if (this.getAttribute('data-tab').includes('notifications')) {
            document.querySelectorAll('.tab-link[data-tab^="all-notifications"], .tab-link[data-tab^="unread-notifications"], .tab-link[data-tab^="read-notifications"]').forEach(t => t.classList.remove('active'));
          }
          // 如果是模型相关的标签
          else if (this.getAttribute('data-tab').includes('models')) {
            document.querySelectorAll('.tab-link[data-tab^="all-models"], .tab-link[data-tab^="system-models"], .tab-link[data-tab^="custom-models"], .tab-link[data-tab^="favorite-models"]').forEach(t => t.classList.remove('active'));
          }
          // 其他情况，清除所有tab-link
          else {
            document.querySelectorAll('.tab-link[data-tab]').forEach(t => t.classList.remove('active'));
          }

          this.classList.add('active');
          document.querySelectorAll('.card-body .tab-content').forEach(c => c.classList.remove('active'));
          const tabId = this.getAttribute('data-tab') + '-content';
          const content = document.getElementById(tabId);
          if (content) content.classList.add('active');
        });
      });

      // 强制清除所有标签激活状态，避免多条激活线问题
      console.log("通知标签初始化：强制清除所有通知子标签状态");
      document.querySelectorAll('.tab-link[data-tab^="all-notifications"], .tab-link[data-tab^="unread-notifications"], .tab-link[data-tab^="read-notifications"]').forEach(t => t.classList.remove('active'));

      // 添加激活状态到全部通知标签
      const defaultNotificationsTab = document.querySelector('.tab-link[data-tab="all-notifications"]');
      if (defaultNotificationsTab) {
        defaultNotificationsTab.classList.add('active');

        // 显示对应内容
        document.querySelectorAll('.card-body .tab-content').forEach(c => c.classList.remove('active'));
        const defaultContent = document.getElementById('all-notifications-content');
        if (defaultContent) {
          defaultContent.classList.add('active');
        }
      }

      // 全部已读
      const markAllReadBtn = document.getElementById('mark-all-read');
      if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }
          fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showToast('全部标记为已读', 'success');
              fetchNotifications();
            } else {
              showToast(data.message || '操作失败', 'error');
            }
          })
          .catch(() => showToast('操作失败，请稍后重试', 'error'));
        });
      }

      // 清除已读
      const clearReadBtn = document.getElementById('clear-read');
      if (clearReadBtn) {
        clearReadBtn.addEventListener('click', function() {
          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }
          fetch('/api/notifications/delete-read', {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showToast('已清除所有已读通知', 'success');
              fetchNotifications();
            } else {
              showToast(data.message || '操作失败', 'error');
            }
          })
          .catch(() => showToast('操作失败，请稍后重试', 'error'));
        });
      }
    }

    // 只更新通知图标徽章，不加载完整通知列表
    function updateNotificationBadge() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 只获取通知计数，不获取完整通知列表，减轻服务器负担
      fetch('/api/notifications?count_only=true', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            // token过期，不处理
            return null;
          }
          throw new Error('获取通知计数失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        // 更新未读消息数量角标
        const unreadCount = data.unreadCount || 0;
        const notificationBadge = document.getElementById('notification-badge');
        if (notificationBadge) {
          if (unreadCount > 0) {
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = 'flex';
          } else {
            notificationBadge.style.display = 'none';
          }
        }
      })
      .catch(error => {
        console.error('获取通知计数出错:', error);
        // 静默失败，不显示错误给用户
      });
    }

    // 只更新权限申请徽章，不加载完整申请列表
    function updatePermissionBadge() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 先检查是否为管理员
      const userInfoStr = localStorage.getItem('user_info');
      let isAdmin = false;

      if (userInfoStr) {
        try {
          const userInfo = JSON.parse(userInfoStr);
          isAdmin = userInfo.is_admin === true || userInfo.is_admin === 1;

          // 强制检查是否为admin用户名
          const username = document.getElementById('username').textContent;
          if (username === 'admin') {
            isAdmin = true;
          }
        } catch (e) {
          console.error("解析用户信息失败:", e);
          return;
        }
      }

      // 如果不是管理员，不需要获取权限申请计数，并隐藏权限图标
      if (!isAdmin) {
        // 隐藏顶部权限图标
        const permissionToggle = document.getElementById('permission-toggle');
        if (permissionToggle) {
          permissionToggle.style.display = 'none';
        }
        return;
      }

      // 显示顶部权限图标（仅管理员可见）
      const permissionToggle = document.getElementById('permission-toggle');
      if (permissionToggle) {
        permissionToggle.style.display = 'flex';
      }

      // 获取待处理权限申请数量
      fetch('/api/admin/permissions/count', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            return null;
          }
          throw new Error('获取权限申请计数失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        // 更新待处理申请数量角标
        const pendingCount = data.pendingCount || 0;

        // 更新顶部导航徽章
        const headerBadge = document.getElementById('header-permission-badge');
        if (headerBadge) {
          if (pendingCount > 0) {
            headerBadge.textContent = pendingCount > 99 ? '99+' : pendingCount;
            headerBadge.style.display = 'flex';
          } else {
            headerBadge.style.display = 'none';
          }
        }
      })
      .catch(error => {
        console.error('获取权限申请计数失败:', error);
      });
    }

    // 获取通知列表
    function fetchNotifications() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 显示加载中状态
      document.getElementById('all-notifications-list').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
      document.getElementById('unread-notifications-list').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
      document.getElementById('read-notifications-list').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';

      // 获取全部通知
      fetch('/api/notifications?status=all', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取通知失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        // 更新未读消息数量角标
        const unreadCount = data.unreadCount || 0;
        const notificationBadge = document.getElementById('notification-badge');
        if (unreadCount > 0) {
          notificationBadge.textContent = unreadCount;
          notificationBadge.style.display = 'flex';
        } else {
          notificationBadge.style.display = 'none';
        }

        // 处理全部通知
        renderNotifications('all-notifications-list', data.notifications);

        // 分类处理未读和已读通知
        const unreadNotifications = data.notifications.filter(n => !n.is_read);
        const readNotifications = data.notifications.filter(n => n.is_read);

        // 渲染未读通知
        renderNotifications('unread-notifications-list', unreadNotifications);

        // 渲染已读通知
        renderNotifications('read-notifications-list', readNotifications);
      })
      .catch(error => {
        console.error('获取通知列表出错:', error);
        document.getElementById('all-notifications-list').innerHTML = '<div class="empty-state"><i class="ri-error-warning-line" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>获取数据失败，请刷新重试</p></div>';
        document.getElementById('unread-notifications-list').innerHTML = '<div class="empty-state"><i class="ri-error-warning-line" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>获取数据失败，请刷新重试</p></div>';
        document.getElementById('read-notifications-list').innerHTML = '<div class="empty-state"><i class="ri-error-warning-line" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>获取数据失败，请刷新重试</p></div>';
      });
    }

    // 渲染通知列表
    function renderNotifications(containerId, notifications) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`找不到容器: ${containerId}`);
        return;
      }

      if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="ri-notification-line" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>暂无消息通知</p></div>';
        return;
      }

      let html = '';

      notifications.forEach(notification => {
        // 根据通知类型设置图标和样式
        let iconClass = 'ri-information-line';
        let typeClass = 'notification-info';

        switch (notification.type) {
          case 'success':
            iconClass = 'ri-check-line';
            typeClass = 'notification-success';
            break;
          case 'warning':
            iconClass = 'ri-alert-line';
            typeClass = 'notification-warning';
            break;
          case 'error':
            iconClass = 'ri-error-warning-line';
            typeClass = 'notification-error';
            break;
          case 'info':
          default:
            iconClass = 'ri-information-line';
            typeClass = 'notification-info';
        }

        html += `
          <div class="notification-item ${!notification.is_read ? 'unread' : ''} ${typeClass}">
            <div class="notification-icon">
              <i class="${iconClass}"></i>
            </div>
            <div class="notification-content">
              <div class="notification-header">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-time">${formatDate(notification.created_at)}</div>
              </div>
              <div class="notification-text">${notification.content}</div>
            </div>
            <div class="notification-actions">
              ${!notification.is_read ?
                `<button class="action-btn mark-read-btn" title="标记为已读" data-id="${notification.id}">
                  <i class="ri-check-double-line"></i>
                </button>` :
                ''}
              <button class="action-btn delete-notification-btn" title="删除通知" data-id="${notification.id}">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // 添加标记已读按钮点击事件
      container.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const notificationId = this.getAttribute('data-id');
          markNotificationRead(notificationId);
        });
      });

      // 添加删除通知按钮点击事件
      container.querySelectorAll('.delete-notification-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const notificationId = this.getAttribute('data-id');
          deleteNotification(notificationId);
        });
      });
    }

    // 标记单个通知为已读
    function markNotificationRead(notificationId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      fetch(`/api/notifications/read/${notificationId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('通知已标记为已读', 'success');
          // 刷新通知列表
          fetchNotifications();
        } else {
          showToast(data.message || '操作失败', 'error');
        }
      })
      .catch(error => {
        console.error('标记通知已读出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    // 删除单个通知
    function deleteNotification(notificationId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      fetch(`/api/notifications/${notificationId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('通知已删除', 'success');
          // 刷新通知列表
          fetchNotifications();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      })
      .catch(error => {
        console.error('删除通知出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    function initProfileFeatures() {
      // 保存资料按钮
      const profileForm = document.getElementById('profile-form');
      if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
          e.preventDefault();

          // 获取表单数据
          const userData = {
            email: document.getElementById('profile-email').value,
            name: document.getElementById('profile-name').value,
            phone: document.getElementById('profile-phone').value,
            organization: document.getElementById('profile-organization').value,
            department: document.getElementById('profile-department').value,
            bio: document.getElementById('profile-bio').value
          };

          // 获取token
          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }

          // 显示加载状态
          const saveBtn = document.getElementById('save-profile');
          const originalBtnText = '<i class="ri-save-line"></i> 保存资料';
          saveBtn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> 保存中...';
          saveBtn.disabled = true;

          // 调用保存用户资料的API
          fetch('/api/user/update', {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
          })
          .then(response => {
            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem('auth_token');
                window.location.href = '/login.html';
                return null;
              }
              return response.json().then(err => {
                throw new Error(err.message || '保存资料失败');
              });
            }
            return response.json();
          })
          .then(data => {
            if (!data) return; // 已处理跳转

            if (data.success) {
              // 使用辅助函数更新用户数据
              updateUserData(data);
            } else {
              showToast(data.message || '保存失败', 'error');
            }
          })
          .catch(error => {
            console.error('保存用户资料出错:', error);
            showToast(error.message || '保存失败，请稍后重试', 'error');
          })
          .finally(() => {
            saveBtn.innerHTML = originalBtnText;
            saveBtn.disabled = false;
          });
        });
      }

            // 修改密码按钮
            const passwordForm = document.getElementById('password-form');
      if (passwordForm) {
        // 清除错误消息的辅助函数
        function clearPasswordErrors() {
          document.getElementById('current-password-error').textContent = '';
          document.getElementById('new-password-error').textContent = '';
          document.getElementById('confirm-password-error').textContent = '';
        }

        // 监听新密码输入框和确认密码框的实时输入，进行验证
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');

        if (newPasswordInput && confirmPasswordInput) {
          // 当确认密码框失去焦点时，检查两次密码是否一致
          confirmPasswordInput.addEventListener('blur', function() {
            if (newPasswordInput.value && confirmPasswordInput.value) {
              if (newPasswordInput.value !== confirmPasswordInput.value) {
                document.getElementById('confirm-password-error').textContent = '两次输入的密码不一致';
              } else {
                document.getElementById('confirm-password-error').textContent = '';
              }
            }
          });

          // 当新密码框值变化时，检查长度和强度
          newPasswordInput.addEventListener('input', function() {
            const password = newPasswordInput.value;
            document.getElementById('new-password-error').textContent = '';
          });
        }

        passwordForm.addEventListener('submit', function(e) {
          e.preventDefault();

          // 清除以前的错误消息
          clearPasswordErrors();

          // 获取密码数据
          const currentPassword = document.getElementById('current-password').value;
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;

          // 基本验证
          let hasError = false;

          if (!currentPassword) {
            document.getElementById('current-password-error').textContent = '请输入当前密码';
            hasError = true;
          }

          if (!newPassword) {
            document.getElementById('new-password-error').textContent = '请输入新密码';
            hasError = true;
          }

          if (!confirmPassword) {
            document.getElementById('confirm-password-error').textContent = '请确认新密码';
            hasError = true;
          } else if (newPassword !== confirmPassword) {
            document.getElementById('confirm-password-error').textContent = '两次输入的密码不一致';
            hasError = true;
          }

          // 如果有错误，则不继续提交
          if (hasError) {
            return;
          }

          // 获取token
          const token = localStorage.getItem('auth_token');
          if (!token) {
            showToast('请先登录', 'warning');
            return;
          }

          // 显示加载状态
          const changeBtn = document.getElementById('change-password');
          const originalBtnText = changeBtn.innerHTML;
          changeBtn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> 修改中...';
          changeBtn.disabled = true;

          // 调用修改密码的API
          fetch('/api/user/change-password', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              currentPassword,
              newPassword,
              confirmPassword
            })
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => {
                throw new Error(err.message || '修改密码失败');
              });
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showToast(data.message || '密码修改成功', 'success');
              // 重置表单
              passwordForm.reset();
              clearPasswordErrors();
            } else {
              // 显示错误信息
              showToast(data.message || '修改密码失败', 'error');
            }
          })
          .catch(error => {
            console.error('修改密码出错:', error);

            // 检查错误消息，根据不同错误在对应位置显示
            const errorMsg = error.message || '修改密码失败，请稍后重试';

            if (errorMsg.includes('当前密码不正确')) {
              document.getElementById('current-password-error').textContent = '当前密码不正确';
            } else {
              showToast(errorMsg, 'error');
            }
          })
          .finally(() => {
            // 恢复按钮状态
            changeBtn.innerHTML = originalBtnText;
            changeBtn.disabled = false;
          });
        });
      }
    }

    // 用于显示提示信息的工具函数
    function showToast(message, type = 'info') {
      // 创建toast元素
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;

      // 添加到页面
      document.body.appendChild(toast);

      // 显示
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);

      // 自动移除
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // 获取最近处理记录
    function fetchRecentHistory() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 显示加载中
      const tableBody = document.getElementById('recent-history-body');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center">
              <div class="loading-spinner"></div>
            </td>
          </tr>
        `;
      }

      fetch('/api/history?page=1&perPage=5', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取历史记录失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        const tableBody = document.getElementById('recent-history-body');

        if (!tableBody) {
          console.error("找不到recent-history-body元素");
          return;
        }

        if (data.success && data.records && data.records.length > 0) {
          try {
            // 对记录数据进行修复和清理，和历史记录保持一致
            const sanitizedRecords = sanitizeRecords(data.records);
            console.log("最近处理记录修复后:", sanitizedRecords);

            let html = '';

            sanitizedRecords.forEach((record, index) => {
              try {
                // 准备各字段的默认值
                const fileName = record.original_filename || '未命名文件';
                const modelName = record.model_name || '未知模型';
                const processingTime = record.processing_time || 0;
                // 处理准确率
                let accuracyDisplay = '0.00%';
                if (record.accuracy !== undefined && record.accuracy !== null) {
                  const accuracy = record.accuracy > 1 ? record.accuracy : record.accuracy * 100;
                  accuracyDisplay = accuracy.toFixed(2) + '%';
                }
                const fileType = record.file_type || 'image';

                // 为不同类型的记录设置不同的样式和图标
                let typeIcon = '';
                let typeClass = '';
                let typeLabel = '';
                let bgColor = '';
                let iconColor = '';

                if (fileType === 'video') {
                  typeIcon = 'ri-film-line';
                  typeClass = 'tag-info';
                  typeLabel = '视频';
                  bgColor = 'rgba(42, 92, 170, 0.1)';
                  iconColor = 'var(--color-primary)';
                } else if (fileType === 'realtime') {
                  typeIcon = 'ri-live-line';
                  typeClass = 'tag-warning';
                  typeLabel = '实时监测';
                  bgColor = 'rgba(255, 209, 102, 0.1)';
                  iconColor = 'var(--color-warning)';
                } else {
                  typeIcon = 'ri-image-line';
                  typeClass = 'tag-success';
                  typeLabel = '图像';
                  bgColor = 'rgba(0, 196, 154, 0.1)';
                  iconColor = 'var(--color-success)';
                }

                // 统一使用图标标识
                let thumbnailHtml = `
                  <div class="d-flex align-center">
                    <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background-color: ${bgColor}; border-radius: 6px; margin-right: 10px;">
                      <i class="${typeIcon}" style="font-size: 28px; color: ${iconColor};"></i>
                    </div>
                    <div>
                      <div class="fw-bold">${fileName}</div>
                      <div class="text-gray" style="font-size: var(--font-size-sm);">ID: ${record.id}</div>
                    </div>
                  </div>
                `;

                html += `
                  <tr>
                    <td>
                      ${thumbnailHtml}
                    </td>
                    <td>
                      <span class="tag ${typeClass}">
                        <i class="${typeIcon}" style="margin-right: 3px;"></i> ${typeLabel}
                      </span>
                    </td>
                    <td>${modelName}</td>
                    <td>${typeof processingTime === 'number' ? processingTime.toFixed(2) : processingTime}s</td>
                    <td>${accuracyDisplay}</td>
                    <td>
                      ${record.id ? `
                      <button class="action-btn view-detail-btn" title="查看详情" data-id="${record.id}" data-file-type="${fileType}">
                        <i class="ri-eye-line"></i>
                      </button>
                      <button class="action-btn download-result-btn" title="下载结果" data-id="${record.id}" data-file-type="${fileType}">
                        <i class="ri-download-line"></i>
                      </button>
                      ` : '<span class="text-gray">无可用操作</span>'}
                    </td>
                  </tr>
                `;
              } catch (error) {
                console.error(`渲染最近记录${index}时出错:`, error);
              }
            });

            if (html === '') {
              showEmptyState('recent-history-body', '记录渲染失败', 'ri-error-warning-line');
              return;
            }

            tableBody.innerHTML = html;

            // 添加查看详情和下载结果按钮的点击事件
            attachRecentHistoryEvents();
          } catch (error) {
            console.error("渲染最近处理记录出错:", error);
            showEmptyState('recent-history-body', '记录渲染失败', 'ri-error-warning-line');
          }
        } else {
          showEmptyState('recent-history-body', '暂无处理记录', 'ri-history-line');
        }
      })
      .catch(error => {
        console.error('获取最近处理记录出错:', error);
        showEmptyState('recent-history-body', '加载失败，请重试', 'ri-error-warning-line');
      });

      // 查看全部历史记录按钮点击事件
      const viewAllBtn = document.getElementById('view-all-history');
      if (viewAllBtn) {
        viewAllBtn.addEventListener('click', function(e) {
          e.preventDefault();
          showTab('history');
        });
      }
    }

    // 为最近历史记录添加事件处理
    function attachRecentHistoryEvents() {
      const tableBody = document.getElementById('recent-history-body');
      if (!tableBody) return;

      // 查看详情按钮
      tableBody.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const fileType = this.getAttribute('data-file-type') || 'image';
          showHistoryDetail(recordId, fileType);
        });
      });

      // 下载结果按钮
      tableBody.querySelectorAll('.download-result-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const fileType = this.getAttribute('data-file-type') || 'image';
          const token = localStorage.getItem('auth_token');
          const downloadLink = document.createElement('a');

          if (fileType === 'video') {
            downloadLink.href = `/api/videos/download/${recordId}?token=${token}`;
          } else if (fileType === 'realtime') {
            downloadLink.href = `/api/realtime/download/${recordId}?token=${token}`;
          } else {
            downloadLink.href = `/api/images/download/${recordId}?token=${token}`;
          }

          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });
    }

    // 获取常用模型
    function fetchPopularModels() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      fetch('/api/models', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取模型数据失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        const modelsContainer = document.getElementById('popular-models-container');

        if (data.success && data.models && data.models.length > 0) {
          // 按使用次数排序，取前5个模型
          const popularModels = data.models
            .sort((a, b) => b.usage_count - a.usage_count)
            .slice(0, 5);

          if (popularModels.length === 0) {
            showEmptyState('popular-models-container', '暂无常用模型', 'ri-database-2-line');
            return;
          }

          let html = '';

          popularModels.forEach(model => {
            html += `
              <div class="model-card">
                <div class="model-image" style="display: flex; gap: 4px;">
                  <img src="${model.example_image || '/static/images/default-model.jpg'}" alt="${model.name}输入示例" style="width: 50%; border-radius: 8px;">
                  <img src="${model.result_example_image || '/static/images/default-model.jpg'}" alt="${model.name}结果示例" style="width: 50%; border-radius: 8px;">
                </div>
                <div class="model-content">
                  <h3 class="model-title">${model.name}</h3>
                  <p class="model-description">${model.description || '暂无描述'}</p>
                  <div class="model-metadata">
                    <span class="tag tag-${getModelTypeClass(model.type)}">${getModelTypeName(model.type)}</span>
                    <span>使用次数: ${model.usage_count || 0}</span>
                    <span>准确率: ${model.accuracy || 0}%</span>
                  </div>
                  <div class="model-creator">
                    <span>创建者: ${model.creator_name || '系统'}</span>
                    <span>创建时间: ${formatDate(model.created_at)}</span>
                  </div>
                  <div class="model-actions">
                    <button class="btn btn-outline btn-sm model-details-btn" data-id="${model.id}">
                      <i class="ri-information-line"></i> 详情
                    </button>
                    <button class="btn btn-primary btn-sm model-use-btn" data-id="${model.id}">
                      <i class="ri-play-circle-line"></i> 使用
                    </button>
                    <button class="btn btn-outline btn-sm model-download-btn" data-id="${model.id}" data-path="${model.path}">
                      <i class="ri-download-line"></i> 下载
                    </button>
                    <button class="action-btn favorite ${model.is_favorite ? 'active' : ''}" data-id="${model.id}">
                      <i class="${model.is_favorite ? 'ri-heart-fill' : 'ri-heart-line'}"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });

          modelsContainer.innerHTML = html;

          // 添加收藏按钮点击事件
          modelsContainer.querySelectorAll('.action-btn.favorite').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              toggleFavoriteModel(modelId, this);
            });
          });

          // 添加详情和使用按钮点击事件
          modelsContainer.querySelectorAll('.model-details-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              showModelDetail(modelId);
            });
          });

          modelsContainer.querySelectorAll('.model-use-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              showTab('upload');
              document.getElementById('model-select').value = modelId;
            });
          });

          modelsContainer.querySelectorAll('.model-download-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelPath = this.getAttribute('data-path');
              const token = localStorage.getItem('auth_token');
              if (!modelPath) {
                showToast('模型文件路径不存在', 'error');
                return;
              }
              if (!token) {
                showToast('请先登录', 'warning');
                return;
              }
              fetch(`/api/models/download?path=${encodeURIComponent(modelPath)}`, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              })
              .then(response => {
                if (!response.ok) throw new Error('下载失败');
                return response.blob();
              })
              .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = modelPath.split(/[\\/]/).pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
              })
              .catch(() => {
                showToast('模型下载失败', 'error');
              });
            });
          });
        } else {
          showEmptyState('popular-models-container', '暂无常用模型', 'ri-database-2-line');
        }
      })
      .catch(error => {
        console.error('获取热门模型失败:', error);
        showEmptyState('popular-models-container', '加载失败', 'ri-error-warning-line');
      });
    }

        // 显示历史记录详情弹窗
        function showHistoryDetail(recordId, fileType) {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const modal = document.getElementById('history-detail-modal');
      const imageContainer = document.getElementById('history-detail-image-container');
      const detailContent = document.getElementById('history-detail-content');
      const downloadBtn = document.getElementById('download-detail-btn');

      // 显示加载中
      detailContent.innerHTML = '<div class="loading-spinner"></div>';
      imageContainer.innerHTML = '<div class="loading-spinner"></div>';
      document.getElementById('detail-accuracy').textContent = '-';
      document.getElementById('detail-categories').textContent = '-';
      document.getElementById('detail-time').textContent = '-';
      document.getElementById('detail-objects').textContent = '-';

      // 显示弹窗
      modal.style.display = 'flex';

      // 存储当前记录ID和类型，用于下载按钮
      downloadBtn.setAttribute('data-id', recordId);
      downloadBtn.setAttribute('data-file-type', fileType);

      console.log("查看详情 - 记录ID:", recordId, "文件类型:", fileType);

      // 根据文件类型获取详情数据
      let apiUrl = '';
      if (fileType === 'video') {
        // 视频类型使用videos/status API
        apiUrl = `/api/videos/status/${recordId}`;

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            console.error("视频状态API响应不成功:", response.status, response.statusText);
            throw new Error('获取视频详情失败: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log("视频详情数据:", data);

          // 清除加载图标
          detailContent.innerHTML = '';

          if (data.success && data.processing) {
            const record = data.processing;

            // 填充详情信息
            let accuracy = parseFloat(record.accuracy || 0);
            accuracy = accuracy > 1 ? accuracy : accuracy * 100;
            document.getElementById('detail-accuracy').textContent = accuracy.toFixed(2) + '%';

            // 处理时间
            let processingTime = parseFloat(record.processingTime || 0);
            document.getElementById('detail-time').textContent = processingTime.toFixed(2) + 's';

            // 分类和目标数
            let categories = Array.isArray(record.categories) ? record.categories.join(', ') : (record.categories || '');
            document.getElementById('detail-categories').textContent = categories || '未识别到分类';
            document.getElementById('detail-objects').textContent = record.objectCount || '0';

            // 显示视频
            let videoUrl = record.staticUrl || record.resultUrl;
            if (videoUrl) {
              console.log("视频URL:", videoUrl);
              imageContainer.innerHTML = `
                <video controls style="max-width: 100%; max-height: 500px; margin: 0 auto;">
                  <source src="${videoUrl}" type="video/mp4">
                  您的浏览器不支持视频播放
                </video>
              `;
            } else {
              imageContainer.innerHTML = '<div class="empty-state">视频加载失败</div>';
            }
          } else {
            throw new Error(data.message || '加载视频详情失败');
          }
        })
        .catch(error => {
          console.error('获取视频详情出错:', error);
          // 清除加载图标
          detailContent.innerHTML = '';
          imageContainer.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <h3>加载失败</h3>
              <p>${error.message || '无法获取视频详情，请重试'}</p>
            </div>
          `;
        });
      } else {
        // 对于图像和实时监测，使用新的单条记录API
        apiUrl = `/api/history/${recordId}`;

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            console.error("历史记录API响应不成功:", response.status, response.statusText);
            throw new Error('获取记录失败: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log("历史记录详情数据:", data);

          // 清除加载图标
          detailContent.innerHTML = '';

          if (data.success && data.record) {
            const record = data.record;

            // 填充详情信息
            if (record.accuracy !== undefined) {
              let accuracy = parseFloat(record.accuracy || 0);
              accuracy = accuracy > 1 ? accuracy : accuracy * 100;
              document.getElementById('detail-accuracy').textContent = accuracy.toFixed(2) + '%';
            }

            if (record.processing_time !== undefined) {
              let processingTime = parseFloat(record.processing_time || 0);
              document.getElementById('detail-time').textContent = processingTime.toFixed(2) + 's';
            }

            if (record.categories) {
              let categories = '';
              try {
                // 尝试解析JSON
                const categoriesData = JSON.parse(record.categories);
                categories = Array.isArray(categoriesData) ? categoriesData.join(', ') : categoriesData.toString();
        } catch (e) {
                // 如果不是JSON，直接使用原始字符串
                categories = record.categories;
              }
              document.getElementById('detail-categories').textContent = categories || '未识别到分类';
            }

            if (record.object_count !== undefined) {
              document.getElementById('detail-objects').textContent = record.object_count.toString();
            }

            // 显示图像
            let imageUrl = '';
            if (fileType === 'realtime') {
              imageUrl = `/api/realtime/view/${recordId}?token=${token}`;
            } else {
              imageUrl = `/api/images/view/${recordId}?token=${token}`;
            }

            console.log("图像URL:", imageUrl);
            try {
              const resultPath = record.result_path;
              console.log("结果路径:", resultPath);

              if (!resultPath) {
                throw new Error("处理结果路径不存在");
              }

              if (fileType === 'realtime') {
                // 动态获取扩展名，设置type属性
                let ext = resultPath.split('.').pop().toLowerCase();
                let type = 'video/mp4';
                if (ext === 'avi') type = 'video/avi';
                else if (ext === 'mov') type = 'video/quicktime';
                // 其他类型可扩展
                imageContainer.innerHTML = `
                  <video id="detail-video" controls style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <source src="${imageUrl}" type="${type}">
                    您的浏览器不支持视频播放
                  </video>
                  <div id="video-load-error" style="display: none; color: var(--color-danger);">
                    <p>视频加载失败，请确认视频文件是否存在</p>
                    <p class="mt-10"><button class="btn btn-sm btn-outline" onclick="refreshDetailMedia('${imageUrl}','realtime')">重新加载</button></p>
                  </div>
                `;
                // 视频加载失败时显示错误提示
                const detailVideo = document.getElementById('detail-video');
                if (detailVideo) {
                  detailVideo.onerror = function() {
                    detailVideo.style.display = 'none';
                    document.getElementById('video-load-error').style.display = 'block';
                  };
                }
              } else {
                imageContainer.innerHTML = `
                  <img id="detail-img" src="${imageUrl}" alt="处理结果" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"
                       onerror="this.style.display='none'; document.getElementById('image-load-error').style.display='block';">
                  <div id="image-load-error" style="display: none; color: var(--color-danger);">
                    <p>图像加载失败，请确认图像文件是否存在</p>
                    <p class="mt-10"><button class="btn btn-sm btn-outline" onclick="refreshDetailMedia('${imageUrl}','image')">重新加载</button></p>
                  </div>
                `;
              }
            } catch (error) {
              console.error("显示图像错误:", error);
              imageContainer.innerHTML = `
                <div class="empty-state">
                  <i class="ri-error-warning-line"></i>
                  <h3>图像数据错误</h3>
                  <p>${error.message || '结果图像路径无效'}</p>
                </div>
              `;
            }
          } else {
            throw new Error(data.message || '加载记录详情失败');
          }
        })
        .catch(error => {
          console.error('获取历史记录详情出错:', error);
          // 清除加载图标
          detailContent.innerHTML = '';
          imageContainer.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <h3>加载失败</h3>
              <p>${error.message || '无法获取详情，请重试'}</p>
            </div>
          `;
        });
      }
    }

    // 刷新详情图片
    function refreshDetailMedia(mediaUrl, fileType) {
      const imageContainer = document.getElementById('history-detail-image-container');
      const now = new Date().getTime();
      const refreshedUrl = mediaUrl.includes('?') ? `${mediaUrl}&t=${now}` : `${mediaUrl}?t=${now}`;
      if (fileType === 'realtime') {
        // 刷新视频
        imageContainer.innerHTML = `
          <video id="detail-video" controls style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <source src="${refreshedUrl}" type="video/mp4">
            您的浏览器不支持视频播放
          </video>
          <div id="video-load-error" style="display: none; color: var(--color-danger);">
            <p>视频加载失败，请确认视频文件是否存在</p>
            <p class="mt-10"><button class="btn btn-sm btn-outline" onclick="refreshDetailMedia('${mediaUrl}','realtime')">重新加载</button></p>
          </div>
        `;
        const detailVideo = document.getElementById('detail-video');
        if (detailVideo) {
          detailVideo.onerror = function() {
            detailVideo.style.display = 'none';
            document.getElementById('video-load-error').style.display = 'block';
          };
        }
      } else {
        // 刷新图片
        imageContainer.innerHTML = `
          <img id="detail-img" src="${refreshedUrl}" alt="处理结果" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"
               onerror="this.style.display='none'; document.getElementById('image-load-error').style.display='block';">
          <div id="image-load-error" style="display: none; color: var(--color-danger);">
            <p>图像加载失败，请确认图像文件是否存在</p>
            <p class="mt-10"><button class="btn btn-sm btn-outline" onclick="refreshDetailMedia('${mediaUrl}','image')">重新加载</button></p>
          </div>
        `;
      }
    }

    // 初始化历史记录详情弹窗
    function initHistoryDetailModal() {
      console.log("初始化历史记录详情弹窗");

      // 绑定关闭按钮事件
      const closeBtn = document.getElementById('close-history-detail-modal');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          document.getElementById('history-detail-modal').style.display = 'none';
        });
      }

      // 点击模态框背景也关闭
      const modal = document.getElementById('history-detail-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      }

      // 绑定底部的关闭按钮事件
      const closeDetailBtn = document.getElementById('close-history-detail-btn');
      if (closeDetailBtn) {
        closeDetailBtn.addEventListener('click', function() {
          document.getElementById('history-detail-modal').style.display = 'none';
        });
      }

      // 绑定下载按钮事件
      const downloadBtn = document.getElementById('download-detail-btn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const fileType = this.getAttribute('data-file-type');
          const token = localStorage.getItem('auth_token');

          if (!recordId || !token) return;

          let downloadUrl = '';
          if (fileType === 'video') {
            downloadUrl = `/api/videos/download/${recordId}?token=${token}`;
          } else if (fileType === 'realtime') {
            downloadUrl = `/api/realtime/download/${recordId}?token=${token}`;
          } else {
            downloadUrl = `/api/images/download/${recordId}?token=${token}`;
          }

          console.log("下载URL:", downloadUrl);

          // 创建一个临时链接并点击它来下载文件
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.target = '_blank';
          link.download = '处理结果_' + recordId;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }
    }

    // 辅助函数：修复或补充记录数据中的缺失或不正确的字段
    function sanitizeRecords(records) {
      if (!records || !Array.isArray(records)) {
        console.error("无效的记录数据:", records);
        return [];
      }

      console.log("开始修复记录数据，记录数量:", records.length);

      return records.map((record, index) => {
        try {
          if (!record) {
            console.warn(`记录 ${index} 为空或无效`);
            return null;
          }

          // 创建基础记录对象，避免修改原始数据
          const sanitizedRecord = {
            id: record.id || `unknown-${index}`,
            original_filename: record.original_filename || '未命名文件',
            model_name: record.model_name || '未知模型',
            processing_time: parseFloat(record.processing_time || 0),
            file_type: record.file_type || 'image',
            created_at: record.created_at || new Date().toISOString()
          };

          // 修复准确率
          if (record.accuracy !== undefined && record.accuracy !== null) {
            try {
              let accuracyValue = parseFloat(record.accuracy);
              if (isNaN(accuracyValue)) {
                accuracyValue = 0;
              }
              sanitizedRecord.accuracy = accuracyValue;
            } catch (e) {
              console.warn(`记录 ${index} 的准确率解析失败:`, e);
              sanitizedRecord.accuracy = 0;
            }
        } else {
            sanitizedRecord.accuracy = 0;
          }

          // 复制其他可能存在的字段
          if (record.categories) sanitizedRecord.categories = record.categories;
          if (record.object_count) sanitizedRecord.object_count = record.object_count;
          if (record.status) sanitizedRecord.status = record.status;
          if (record.thumbnail) sanitizedRecord.thumbnail = record.thumbnail;

          return sanitizedRecord;
        } catch (error) {
          console.error(`修复记录 ${index} 时出错:`, error);
          return null;
        }
      }).filter(record => record !== null); // 移除无效记录
    }

    // 获取历史记录数据
    function fetchHistoryRecords(page = 1) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
          return;
        }

      // 显示加载动画
      const tableBody = document.getElementById('history-table-body');
      if (!tableBody) {
        console.error("找不到history-table-body元素");
        return;
      }

      tableBody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center">
            <div class="loading-spinner"></div>
          </td>
        </tr>
      `;

      // 获取筛选条件
      let timeFilter = 'all';
      let modelFilter = 'all';
      let searchQuery = '';

      try {
        const timeFilterElem = document.getElementById('history-time-filter');
        if (timeFilterElem) timeFilter = timeFilterElem.value || 'all';

        const modelFilterElem = document.getElementById('history-model-filter');
        if (modelFilterElem) modelFilter = modelFilterElem.value || 'all';

        const searchQueryElem = document.getElementById('history-search');
        if (searchQueryElem) searchQuery = searchQueryElem.value || '';
      } catch (error) {
        console.error("获取筛选条件出错:", error);
      }

      // 构建请求URL
      let url = `/api/history?page=${page}&perPage=20`;

      // 仅当非默认值时添加筛选参数
      if (timeFilter !== 'all') {
        url += `&timeFilter=${timeFilter}`;
      }

      if (modelFilter !== 'all') {
        url += `&modelFilter=${modelFilter}`;
      }

      if (searchQuery) {
        url += `&search=${encodeURIComponent(searchQuery)}`;
      }

      // 处理自定义日期范围
      if (timeFilter === 'custom') {
        try {
          const startDate = document.getElementById('history-start-date')?.value;
          const endDate = document.getElementById('history-end-date')?.value;
          if (startDate && endDate) {
            url += `&startDate=${startDate}&endDate=${endDate}`;
          }
        } catch (error) {
          console.error("获取日期范围出错:", error);
        }
      }

      console.log("发送历史记录请求:", url);

      // 请求后端API
      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        console.log("历史记录API状态码:", response.status);
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error(`获取历史记录失败: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        console.log("历史记录API返回数据:", data);

        // 详细检查返回数据结构
        if (data.success) {
          if (data.records) {
            console.log("API返回记录数量:", data.records.length);
            if (data.records.length > 0) {
              try {
                // 对记录数据进行修复和清理
                const sanitizedRecords = sanitizeRecords(data.records);
                // 使用简化渲染方式，避免数据完整性问题
                renderSimpleHistoryTable(sanitizedRecords);
                renderPagination(data.pagination);
              } catch (error) {
                console.error("渲染历史记录或分页出错:", error);
                showEmptyState('history-table-body', '渲染记录时出错', 'ri-error-warning-line');
              }
            } else {
              console.log("API返回空记录列表");
              showEmptyState('history-table-body', '暂无处理记录', 'ri-history-line');
            }
          } else {
            console.error("API返回数据中缺少records字段");
            showEmptyState('history-table-body', '返回数据格式不正确', 'ri-error-warning-line');
          }
        } else {
          console.error("API返回失败状态:", data.message);
          showEmptyState('history-table-body', data.message || '获取数据失败', 'ri-error-warning-line');
        }
      })
      .catch(error => {
        console.error('获取历史记录出错:', error);
        showEmptyState('history-table-body', '加载失败，请重试', 'ri-error-warning-line');
      });
    }

    // 全局变量
    let isRealtimeMonitoring = false; // 跟踪实时监测状态
    let monitoringSessionId = null; // 存储当前监测会话ID
    let videoStream = null; // 存储摄像头流
    let videoElement = null; // 用于预览摄像头画面的视频元素
    let monitoringCanvas = null; // 用于处理帧的画布
    let canvasContext = null; // 画布上下文
    let frameInterval = null; // 帧处理间隔ID

    // 简化版的历史记录表格渲染，以适应可能不完整的数据
    function renderSimpleHistoryTable(records) {
      const tableBody = document.getElementById('history-table-body');

      if (!records || records.length === 0) {
        showEmptyState('history-table-body', '暂无处理记录', 'ri-history-line');
        return;
      }

      // 添加调试日志
      console.log("开始渲染历史记录，记录数量:", records.length);
      console.log("记录示例:", records[0]);

      let html = '';
      const token = localStorage.getItem('auth_token');

      for (let index = 0; index < records.length; index++) {
        try {
          const record = records[index];
          console.log(`正在处理记录 ${index}:`, record);

          // 确保每条记录至少有一个id，必须有此字段
          const recordId = record.id || `unknown-${index}`;
          if (!record.id) {
            console.warn(`记录${index}缺少ID字段，使用临时ID`);
          }

          // 准备各字段的默认值
          const fileName = record.original_filename || '未命名文件';
          const modelName = record.model_name || '未知模型';
          const processingTime = record.processing_time || 0;

          // 处理准确率数据 - 确保数据正确显示并添加强健的类型检查
          let accuracyDisplay = '0.00%';
          try {
            let accuracy = 0;
            if (record.accuracy !== undefined && record.accuracy !== null) {
              // 确保转换为数字
              const accuracyNum = parseFloat(record.accuracy);
              if (!isNaN(accuracyNum)) {
                // 检查准确率是否已经是百分比形式(0-100)还是小数形式(0-1)
                accuracy = accuracyNum > 1 ? accuracyNum : accuracyNum * 100;
                accuracyDisplay = accuracy.toFixed(2) + '%';
              }
            }
          } catch (error) {
            console.error(`处理记录${index}的准确率时出错:`, error);
            accuracyDisplay = '0.00%';
          }

          // 日期格式化
          let formattedDate = '未知日期';
          try {
            if (record.created_at) {
              const date = new Date(record.created_at);
              formattedDate = date.toLocaleString('zh-CN');
            }
          } catch (e) {
            console.warn(`格式化记录${index}的日期时出错:`, e);
          }

          // 确定文件类型和显示标签
          const fileType = record.file_type || 'image';

          // 为不同类型的记录设置不同的样式和图标
          let typeIcon = '';
          let typeClass = '';
          let typeLabel = '';
          let bgColor = '';
          let iconColor = '';

          if (fileType === 'video') {
            typeIcon = 'ri-film-line';
            typeClass = 'tag-info';
            typeLabel = '视频';
            bgColor = 'rgba(42, 92, 170, 0.1)';
            iconColor = 'var(--color-primary)';
          } else if (fileType === 'realtime') {
            typeIcon = 'ri-live-line';
            typeClass = 'tag-warning';
            typeLabel = '实时监测';
            bgColor = 'rgba(255, 209, 102, 0.1)';
            iconColor = 'var(--color-warning)';
          } else {
            typeIcon = 'ri-image-line';
            typeClass = 'tag-success';
            typeLabel = '图像';
            bgColor = 'rgba(0, 196, 154, 0.1)';
            iconColor = 'var(--color-success)';
          }

          // 统一使用图标标识
          let thumbnailHtml = `
            <div class="d-flex align-center">
              <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background-color: ${bgColor}; border-radius: 6px; margin-right: 10px;">
                <i class="${typeIcon}" style="font-size: 28px; color: ${iconColor};"></i>
              </div>
              <div>
                <div class="fw-bold">${fileName}</div>
                <div class="text-gray" style="font-size: var(--font-size-sm);">ID: ${recordId}</div>
              </div>
            </div>
          `;

          // 根据不同类型的记录设置不同的操作按钮
          let actionsHtml = '';
          if (fileType === 'realtime') {
            actionsHtml = `
              <button class="action-btn view-realtime-btn" title="查看详情" data-id="${record.id}">
                <i class="ri-eye-line"></i>
              </button>
              <button class="action-btn download-realtime-btn" title="下载结果" data-id="${record.id}">
                <i class="ri-download-line"></i>
              </button>
              <button class="action-btn delete-history-btn" title="删除记录" data-id="${record.id}">
                <i class="ri-delete-bin-line"></i>
              </button>
            `;
          } else if (fileType === 'video') {
            actionsHtml = `
              <button class="action-btn view-video-btn" title="查看视频" data-id="${record.id}">
                <i class="ri-eye-line"></i>
              </button>
              <button class="action-btn download-video-btn" title="下载结果" data-id="${record.id}">
                <i class="ri-download-line"></i>
              </button>
              <button class="action-btn delete-history-btn" title="删除记录" data-id="${record.id}">
                <i class="ri-delete-bin-line"></i>
              </button>
            `;
          } else {
            actionsHtml = `
              <button class="action-btn view-result-btn" title="查看结果" data-id="${record.id}">
                <i class="ri-eye-line"></i>
              </button>
              <button class="action-btn download-result-btn" title="下载结果" data-id="${record.id}">
                <i class="ri-download-line"></i>
              </button>
              <button class="action-btn delete-history-btn" title="删除记录" data-id="${record.id}">
                <i class="ri-delete-bin-line"></i>
              </button>
            `;
          }

          const rowHtml = `
            <tr>
              <td>
                <input type="checkbox" class="history-checkbox" data-id="${recordId}">
              </td>
              <td>
                ${thumbnailHtml}
              </td>
              <td>
                <span class="tag ${typeClass}">
                  <i class="${typeIcon}" style="margin-right: 3px;"></i> ${typeLabel}
                </span>
              </td>
              <td>${modelName}</td>
              <td>${processingTime}s</td>
              <td>${accuracyDisplay}</td>
              <td>${formattedDate}</td>
              <td>
                ${record.id ? actionsHtml : '<span class="text-gray">无可用操作</span>'}
              </td>
            </tr>
          `;

          html += rowHtml;
          console.log(`成功渲染记录 ${index}`);
        } catch (error) {
          console.error(`渲染记录${index}时出错:`, error);
        }
      }

      console.log("HTML生成完成，长度:", html.length);

      if (html === '') {
        console.error("生成的HTML为空，显示记录渲染失败");
        showEmptyState('history-table-body', '记录渲染失败', 'ri-error-warning-line');
        return;
      }

      tableBody.innerHTML = html;
      attachHistoryEvents();
      console.log("历史记录渲染完成");
    }

    // 添加历史记录事件处理
    function attachHistoryEvents() {
      // 复选框变更事件
      const checkboxes = document.querySelectorAll('#history-table-body .history-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateBatchButtonsState();
        });
      });

      // 下载图像结果按钮
      const downloadImageBtns = document.querySelectorAll('#history-table-body .download-result-btn');
      downloadImageBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const token = localStorage.getItem('auth_token');
          const downloadLink = document.createElement('a');
          downloadLink.href = `/api/images/download/${recordId}?token=${token}`;
          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });

      // 下载视频结果按钮
      const downloadVideoBtns = document.querySelectorAll('#history-table-body .download-video-btn');
      downloadVideoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const token = localStorage.getItem('auth_token');
          const downloadLink = document.createElement('a');
          downloadLink.href = `/api/videos/download/${recordId}?token=${token}`;
          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });

      // 下载实时监测结果按钮
      const downloadRealtimeBtns = document.querySelectorAll('#history-table-body .download-realtime-btn');
      downloadRealtimeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          const token = localStorage.getItem('auth_token');
          const downloadLink = document.createElement('a');
          downloadLink.href = `/api/realtime/download/${recordId}?token=${token}`;
          downloadLink.setAttribute('download', ''); // 确保浏览器将其作为下载处理
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      });

      // 删除按钮
      const deleteBtns = document.querySelectorAll('#history-table-body .delete-history-btn');
      deleteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          if (confirm('确定要删除此记录吗？')) {
            deleteHistoryRecords([recordId]);
          }
        });
      });

      // 查看图像结果按钮
      const viewResultBtns = document.querySelectorAll('#history-table-body .view-result-btn');
      viewResultBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showHistoryDetail(recordId, 'image');
        });
      });

      // 查看视频结果按钮
      const viewVideoBtns = document.querySelectorAll('#history-table-body .view-video-btn');
      viewVideoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showHistoryDetail(recordId, 'video');
        });
      });

      // 查看实时监测结果按钮
      const viewRealtimeBtns = document.querySelectorAll('#history-table-body .view-realtime-btn');
      viewRealtimeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const recordId = this.getAttribute('data-id');
          showHistoryDetail(recordId, 'realtime');
        });
      });
    }

    // 更新批量操作按钮状态
    function updateBatchButtonsState() {
      const selectedIds = getSelectedHistoryIds();
      const batchDownloadBtn = document.getElementById('batch-download');
      const batchDeleteBtn = document.getElementById('batch-delete');

      if (selectedIds.length > 0) {
        batchDownloadBtn.disabled = false;
        batchDeleteBtn.disabled = false;
      } else {
        batchDownloadBtn.disabled = true;
        batchDeleteBtn.disabled = true;
      }
    }

    // 获取选中的历史记录ID
    function getSelectedHistoryIds() {
      const checkboxes = document.querySelectorAll('#history-table-body .history-checkbox:checked');
      return Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-id'));
    }

    // 删除历史记录
    function deleteHistoryRecords(ids) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      fetch('/api/history/batch/delete', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids: ids })
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('删除历史记录失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success) {
          showToast(`成功删除${data.deletedCount}条记录`, 'success');
          fetchHistoryRecords(); // 刷新历史记录
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      })
      .catch(error => {
        console.error('删除历史记录出错:', error);
        showToast('删除失败，请重试', 'error');
      });
    }

    // 渲染分页控件
    function renderPagination(pagination) {

      const paginationContainer = document.getElementById('history-pagination');
      if (!paginationContainer) {
        console.error("找不到history-pagination元素");
        return;
      }

      if (!pagination || !pagination.total) {
        paginationContainer.innerHTML = '';
        return;
      }

      // 确保分页属性存在且有效
      const page = pagination.page || 1;
      const perPage = pagination.perPage || 10;
      const total = pagination.total || 0;
      const totalPages = pagination.totalPages || Math.ceil(total / perPage) || 1;

      // 如果总页数小于等于1，不显示分页
      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      let html = '';

      // 上一页按钮
      html += `
        <button class="btn btn-outline btn-sm" ${page <= 1 ? 'disabled' : ''} data-page="${page - 1}">
          <i class="ri-arrow-left-s-line"></i>
        </button>
      `;

      // 页码按钮
      const maxVisiblePages = 5;
      let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      // 调整startPage以确保显示maxVisiblePages个页码
      if (endPage - startPage + 1 < maxVisiblePages && startPage > 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}" data-page="${i}">
            ${i}
          </button>
        `;
      }

      // 下一页按钮
      html += `
        <button class="btn btn-outline btn-sm" ${page >= totalPages ? 'disabled' : ''} data-page="${page + 1}">
          <i class="ri-arrow-right-s-line"></i>
        </button>
      `;

      paginationContainer.innerHTML = html;

      // 添加页码按钮点击事件
      try {
        const pageButtons = paginationContainer.querySelectorAll('button:not([disabled])');
        pageButtons.forEach(button => {
          button.addEventListener('click', function() {
            const pageNum = parseInt(this.getAttribute('data-page'));
            fetchHistoryRecords(pageNum);
          });
        });
      } catch (error) {
        console.error("添加分页按钮事件时出错:", error);
      }
    }

    // 获取并显示模型列表
    function fetchAllModels(modelCategory = 'all') {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 显示加载中的状态
      let targetGrid;
      if (modelCategory === 'all') {
        targetGrid = document.getElementById('all-models-grid');
      } else if (modelCategory === 'system') {
        targetGrid = document.getElementById('system-models-grid');
      } else if (modelCategory === 'custom') {
        targetGrid = document.getElementById('custom-models-grid');
      } else if (modelCategory === 'favorite') {
        targetGrid = document.getElementById('favorite-models-grid');
      }

      if (!targetGrid) return;

      targetGrid.innerHTML = `
        <div class="empty-state model-center">
          <div class="loading-spinner"></div>
        </div>
      `;

      // 获取筛选参数
      const modelType = document.getElementById('model-type-filter').value;
      const sortBy = document.getElementById('model-sort').value;
      const searchQuery = document.getElementById('model-search').value.trim();

      // 构建请求URL
      let url = '/api/models?';
      if (modelType !== 'all') {
        url += `type=${modelType}&`;
      }

      if (searchQuery) {
        url += `search=${encodeURIComponent(searchQuery)}&`;
      }

      // 使用新的category参数
      url += `category=${modelCategory}`;

      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取模型数据失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success && data.models && data.models.length > 0) {
          let models = data.models;
          const currentUserId = getUserId();

          // 首先按创建时间排序，确保最新的模型在前面
          models = models.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          // 如果选择了其他排序方式，再进行二次排序
          if (sortBy === 'popular') {
            models = models.sort((a, b) => b.usage_count - a.usage_count);
          } else if (sortBy === 'accuracy') {
            models = models.sort((a, b) => b.accuracy - a.accuracy);
          }
          // newest 排序就是默认的创建时间排序，不需要再次排序

          let html = '';

          models.forEach(model => {
            html += `
              <div class="model-card">
                <div class="model-image" style="display: flex; gap: 4px;">
                  <img src="${model.example_image || '/static/images/default-model.jpg'}" alt="${model.name}输入示例" style="width: 50%; border-radius: 8px;">
                  <img src="${model.result_example_image || '/static/images/default-model.jpg'}" alt="${model.name}结果示例" style="width: 50%; border-radius: 8px;">
                </div>
                <div class="model-content">
                  <h3 class="model-title">${model.name}</h3>
                  <p class="model-description">${model.description || '暂无描述'}</p>
                  <div class="model-metadata">
                    <span class="tag tag-${getModelTypeClass(model.type)}">${getModelTypeName(model.type)}</span>
                    <span>使用次数: ${model.usage_count || 0}</span>
                    <span>准确率: ${model.accuracy || 0}%</span>
                  </div>
                  <div class="model-creator">
                    <span>创建者: ${model.creator_name || '系统'}</span>
                    <span>创建时间: ${formatDate(model.created_at)}</span>
                  </div>
                  <div class="model-actions">
                    <button class="btn btn-outline btn-sm model-details-btn" data-id="${model.id}">
                      <i class="ri-information-line"></i> 详情
                    </button>
                    <button class="btn btn-primary btn-sm model-use-btn" data-id="${model.id}">
                      <i class="ri-play-circle-line"></i> 使用此模型
                    </button>
                    <button class="btn btn-outline btn-sm model-download-btn" data-id="${model.id}" data-path="${model.path}">
                      <i class="ri-download-line"></i> 下载
                    </button>
                    <button class="action-btn favorite ${model.is_favorite ? 'active' : ''}" data-id="${model.id}">
                      <i class="${model.is_favorite ? 'ri-heart-fill' : 'ri-heart-line'}"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });

          targetGrid.innerHTML = html;

          // 添加模型详情、使用和收藏按钮的点击事件
          targetGrid.querySelectorAll('.model-details-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              // 打开模型详情模态框而不是导航到新页面
              showModelDetail(modelId);
            });
          });

          targetGrid.querySelectorAll('.model-use-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              // 切换到上传识别选项卡并选中该模型
              showTab('upload');
              document.getElementById('model-select').value = modelId;
            });
          });

          // 添加收藏按钮点击事件
          targetGrid.querySelectorAll('.action-btn.favorite').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelId = this.getAttribute('data-id');
              toggleFavoriteModel(modelId, this);
            });
          });

          targetGrid.querySelectorAll('.model-download-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const modelPath = this.getAttribute('data-path');
              const token = localStorage.getItem('auth_token');
              if (!modelPath) {
                showToast('模型文件路径不存在', 'error');
                return;
              }
              if (!token) {
                showToast('请先登录', 'warning');
                return;
              }
              fetch(`/api/models/download?path=${encodeURIComponent(modelPath)}`, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              })
              .then(response => {
                if (!response.ok) throw new Error('下载失败');
                return response.blob();
              })
              .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = modelPath.split(/[\\/]/).pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
              })
              .catch(() => {
                showToast('模型下载失败', 'error');
              });
            });
          });

          } else {
          // 显示空状态
          targetGrid.innerHTML = `
            <div class="empty-state model-center">
              <i class="ri-database-2-line empty-icon"></i>
              <h3>暂无模型</h3>
              <p>根据您的筛选条件，暂时没有找到模型</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型数据出错:', error);
        // 显示错误状态
        targetGrid.innerHTML = `
          <div class="empty-state model-center">
            <i class="ri-error-warning-line empty-icon"></i>
            <h3>加载失败</h3>
            <p>获取模型数据时发生错误，请重试</p>
          </div>
        `;
      });
    }

    // 切换模型收藏状态
    function toggleFavoriteModel(modelId, buttonElement) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      const isFavorite = buttonElement.classList.contains('active');
      const method = isFavorite ? 'DELETE' : 'POST';

      // 显示加载状态
      buttonElement.classList.add('loading');
      buttonElement.disabled = true;

      // 发送请求前先禁用按钮，防止重复点击
      fetch(`/api/models/favorite/${modelId}`, {
        method: method,
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        return response.json().then(data => {
          if (!response.ok) {
            return Promise.reject(data.message || '服务器响应错误');
          }
          return data;
        });
      })
      .then(data => {

        // 根据请求类型更新UI
        if (method === 'POST') {
          buttonElement.classList.add('active');
          buttonElement.innerHTML = '<i class="ri-heart-fill"></i>';
          showToast(data.message || '已添加到收藏', 'success');

          // 刷新热门模型列表
          fetchPopularModels();
        } else { // DELETE
          buttonElement.classList.remove('active');
          buttonElement.innerHTML = '<i class="ri-heart-line"></i>';
          showToast(data.message || '已移除收藏', 'info');

          // 如果当前在收藏标签页，需要刷新列表
          const activeTab = document.querySelector('.tab-link.active[data-tab="favorite-models"]');
          if (activeTab) {
            fetchAllModels('favorite');
          }

          // 刷新热门模型列表
          fetchPopularModels();
        }

        // 刷新所有模型列表（如果当前在所有模型页面）
        const allModelsTab = document.querySelector('.tab-link.active[data-tab="all-models"]');
        if (allModelsTab) {
          fetchAllModels('all');
        }
      })
      .catch(error => {
        console.error('收藏操作失败:', error);
        showToast('操作失败：' + error, 'error');

        // 如果操作失败，恢复按钮原始状态
        if (isFavorite) {
          buttonElement.classList.add('active');
          buttonElement.innerHTML = '<i class="ri-heart-fill"></i>';
          } else {
          buttonElement.classList.remove('active');
          buttonElement.innerHTML = '<i class="ri-heart-line"></i>';
        }
      })
      .finally(() => {
        // 无论成功或失败，都需要移除加载状态
        buttonElement.classList.remove('loading');
        buttonElement.disabled = false;
      });
    }

    // 获取模型类型对应的样式类
    function getModelTypeClass(type) {
      const typeClasses = {
        'landcover': 'primary',
        'building': 'success',
        'water': 'info',
        'vegetation': 'warning',
        'urban': 'danger',
        'other': 'secondary'
      };
      return typeClasses[type] || 'secondary';
    }

    // 获取模型类型对应的中文名称
    function getModelTypeName(type) {
      const typeNames = {
        'landcover': '土地覆盖',
        'building': '建筑物',
        'water': '水体',
        'vegetation': '植被',
        'urban': '城市',
        'other': '其他'
      };
      return typeNames[type] || '未知类型';
    }

    // 格式化日期
    function formatDate(dateString) {
      if (!dateString) return '未知';

      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // 初始化控制面板功能
    function initDashboardFeatures() {
      // 刷新数据按钮
      const refreshDashboardBtn = document.getElementById('refresh-dashboard');
      if (refreshDashboardBtn) {
        refreshDashboardBtn.addEventListener('click', function() {
          // 显示加载中状态
          document.getElementById('model-usage-stats').innerHTML = '<div class="loading-spinner"></div>';
          document.getElementById('accuracy-stats').innerHTML = '<div class="loading-spinner"></div>';
          document.getElementById('processing-time-stats').innerHTML = '<div class="loading-spinner"></div>';
          document.getElementById('data-volume-stats').innerHTML = '<div class="loading-spinner"></div>';
          document.getElementById('recent-history-body').innerHTML = '<tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr>';
          document.getElementById('popular-models-container').innerHTML = '<div class="text-center" style="grid-column: 1/-1;"><div class="loading-spinner"></div></div>';

          // 重新获取所有数据
          fetchDashboardStats();
          fetchRecentHistory();
          fetchPopularModels();

          // 显示成功消息
          showToast('数据已刷新', 'success');
        });
      }

      // 查看全部历史按钮
      const viewAllHistoryBtn = document.getElementById('view-all-history');
      if (viewAllHistoryBtn) {
        viewAllHistoryBtn.addEventListener('click', function(e) {
          e.preventDefault();
          showTab('history');
        });
      }

      // 查看全部模型按钮
      const viewAllModelsBtn = document.getElementById('view-all-models');
      if (viewAllModelsBtn) {
        viewAllModelsBtn.addEventListener('click', function(e) {
          e.preventDefault();
          showTab('models');
        });
      }
    }

        // 显示模型详情
        function showModelDetail(modelId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示模态框和加载状态
      const modalElement = document.getElementById('model-detail-modal');
      const contentElement = document.getElementById('model-detail-content');
      const modalFooter = modalElement.querySelector('.modal-footer');

      modalElement.style.display = 'flex';
      contentElement.innerHTML = '<div class="loading-spinner"></div>';

      // 重置底部按钮，只保留关闭按钮
      modalFooter.innerHTML = '<button class="btn btn-outline" id="close-detail-btn">关闭</button>';

      // 绑定关闭按钮事件
      const closeModelBtn = document.getElementById('close-model-detail-modal');
      const closeDetailBtn = document.getElementById('close-detail-btn');

      if (closeModelBtn) {
        closeModelBtn.onclick = function() {
          modalElement.style.display = 'none';
        };
      }

      if (closeDetailBtn) {
        closeDetailBtn.onclick = function() {
          modalElement.style.display = 'none';
        };
      }

      // 获取当前用户ID
      const currentUserId = getUserId();

      // 获取模型详情数据
      fetch(`/api/models/${modelId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('获取模型详情失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success) {
          const model = data.model;

          // 检查删除按钮显示条件
          const showDeleteButton = !model.is_system && (Number(model.creator_id) === Number(currentUserId));

          // 渲染模型详情
          contentElement.innerHTML = `
            <div class="model-detail">
              <div class="d-flex" style="gap: 20px; margin-bottom: 20px;">
                <div class="model-image" style="flex: 0 0 200px;">
                  <img src="${model.example_image || '/static/images/default-model.jpg'}" alt="${model.name}" style="width: 100%; border-radius: 8px;">
                </div>
                <div class="model-info" style="flex: 1;">
                  <h3>${model.name}</h3>
                  <div class="model-metadata" style="margin: 10px 0;">
                    <span class="tag tag-${getModelTypeClass(model.type)}">${getModelTypeName(model.type)}</span>
                    <span>创建时间: ${formatDate(model.created_at)}</span>
                  </div>
                  <div class="model-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                    <div class="stat-item">
                      <span class="stat-label">使用次数</span>
                      <span class="stat-value">${model.usage_count || 0}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">准确率</span>
                      <span class="stat-value">${model.accuracy || 0}%</span>
                    </div>
                  </div>
                  <div class="model-creator">
                    <span>创建者: ${model.creator_name || '系统'}</span>
                  </div>
                </div>
              </div>
              <div class="model-description">
                <h4>模型描述</h4>
                <p>${model.description || '暂无描述'}</p>
              </div>
              <div class="d-flex justify-between align-center" style="margin-top: 15px;">
                ${model.is_favorite ?
                  `<div class="favorite-status"><i class="ri-heart-fill"></i> 已收藏</div>` :
                  `<div class="favorite-status"><i class="ri-heart-line"></i> 未收藏</div>`
                }
              </div>
            </div>
          `;

          // 始终添加一个删除按钮用于测试，但根据条件设置不同的文本和样式
          const deleteButton = document.createElement('button');

          if (!model.is_system && (Number(model.creator_id) === Number(currentUserId))) {
            // 用户自己的非系统模型，显示正常的删除按钮
            deleteButton.className = 'btn btn-danger';
            deleteButton.innerHTML = '<i class="ri-delete-bin-line"></i> 删除该模型';
            deleteButton.disabled = false;
          } else {
            // 不符合条件，显示灰色的按钮并说明原因
            deleteButton.className = 'btn btn-secondary';
            if (model.is_system) {
              deleteButton.innerHTML = '<i class="ri-information-line"></i> 系统模型不可删除';
            } else {
              deleteButton.innerHTML = '<i class="ri-information-line"></i> 只能删除自己的模型';
            }
            deleteButton.disabled = true;
          }

          deleteButton.id = 'delete-model-btn';
          deleteButton.setAttribute('data-id', model.id);
          deleteButton.style.marginLeft = '10px';

          modalFooter.appendChild(deleteButton);

          // 添加删除按钮事件（仅当按钮未禁用时）
          if (!deleteButton.disabled) {
            // 使用内联函数直接调用deleteModel，确保传入正确的ID
            deleteButton.onclick = function() {
              deleteModel(model.id);
            };
          }

          // 再次绑定关闭按钮事件，确保关闭按钮可用
          const updatedCloseDetailBtn = document.getElementById('close-detail-btn');
          if (updatedCloseDetailBtn) {
            updatedCloseDetailBtn.onclick = function() {
              modalElement.style.display = 'none';
            };
          }
        } else {
          contentElement.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line empty-icon"></i>
              <h3>获取失败</h3>
              <p>无法加载模型详情数据</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('获取模型详情出错:', error);
        contentElement.innerHTML = `
          <div class="empty-state">
            <i class="ri-error-warning-line empty-icon"></i>
            <h3>加载失败</h3>
            <p>获取模型详情时发生错误: ${error.message}</p>
          </div>
        `;
      });
    }

    // 添加获取权限申请列表的函数
    function fetchPermissions() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 显示加载中
      const tableBody = document.getElementById('permissions-table-body');
      if (!tableBody) {
        console.error("找不到permissions-table-body元素");
        return;
      }

      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center">
            <div class="loading-spinner"></div>
          </td>
        </tr>
      `;

      // 发送请求获取权限申请列表
      fetch('/api/permissions', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取权限申请列表失败');
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success && data.permissions && data.permissions.length > 0) {
          let html = '';

          data.permissions.forEach(permission => {
            // 获取申请类型的中文名称
            const typeMap = {
              'model': '高级模型使用权限',
              'storage': '增加存储空间',
              'api': 'API接口调用权限',
              'other': '其他权限'
            };
            const typeName = typeMap[permission.request_type] || '未知类型';

            // 获取状态对应的样式和文本
            let statusClass = '';
            let statusText = '';
            switch(permission.status) {
              case 'pending':
                statusClass = 'tag-warning';
                statusText = '待审核';
                break;
              case 'approved':
                statusClass = 'tag-success';
                statusText = '已批准';
                break;
              case 'rejected':
                statusClass = 'tag-danger';
                statusText = '已拒绝';
                break;
              default:
                statusClass = 'tag-info';
                statusText = '未知状态';
            }

            // 构建行HTML
            html += `
              <tr>
                <td>${typeName}</td>
                <td>${formatDate(permission.created_at)}</td>
                <td><span class="tag ${statusClass}">${statusText}</span></td>
                <td>
                  ${permission.status === 'pending' ? `
                    <button class="action-btn edit-permission-btn" title="修改申请" data-id="${permission.id}">
                      <i class="ri-edit-line"></i>
                    </button>
                    <button class="action-btn cancel-permission-btn" title="取消申请" data-id="${permission.id}">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  ` : `
                    <button class="action-btn view-permission-btn" title="查看详情" data-id="${permission.id}">
                      <i class="ri-eye-line"></i>
                    </button>
                  `}
                </td>
              </tr>
            `;
          });

          tableBody.innerHTML = html;

          // 添加修改、取消和查看申请按钮的点击事件处理
          document.querySelectorAll('.edit-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const permissionId = this.getAttribute('data-id');
              // 实现编辑权限申请的功能
              showUserPermissionDetail(permissionId, true);
            });
          });

          document.querySelectorAll('.cancel-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const permissionId = this.getAttribute('data-id');
              if (confirm('确定要取消此申请吗？')) {
                cancelPermission(permissionId);
              }
            });
          });

          document.querySelectorAll('.view-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const permissionId = this.getAttribute('data-id');
              // 实现查看权限申请详情的功能
              showUserPermissionDetail(permissionId, false);
            });
          });
        } else {
          // 显示暂无数据状态
          showEmptyState('permissions-table-body', '暂无权限申请记录', 'ri-shield-keyhole-line');
        }
      })
      .catch(error => {
        console.error('获取权限申请列表出错:', error);
        showEmptyState('permissions-table-body', '获取数据失败，请刷新重试', 'ri-error-warning-line');
      });
    }

    // 显示用户权限申请详情
    function showUserPermissionDetail(permissionId, canEdit) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示模态框
      const modal = document.getElementById('user-permission-detail-modal');
      if (!modal) {
        console.error('找不到权限详情模态框');
        return;
      }
      modal.style.display = 'flex';

      // 显示加载中
      const contentDiv = document.getElementById('user-permission-detail-content');
      if (contentDiv) {
        contentDiv.innerHTML = '<div class="loading-spinner"></div>';
      }

      // 根据是否可编辑显示/隐藏编辑按钮
      const editBtn = document.getElementById('edit-permission-btn');
      if (editBtn) {
        editBtn.style.display = canEdit ? 'inline-block' : 'none';
      }

      // 根据是否可编辑显示/隐藏保存按钮
      const saveBtn = document.getElementById('save-permission-btn');
      if (saveBtn) {
        saveBtn.style.display = canEdit ? 'inline-block' : 'none';

        // 先移除之前可能存在的事件监听器，避免重复添加
        saveBtn.replaceWith(saveBtn.cloneNode(true));

        // 重新获取按钮并添加事件监听器
        const newSaveBtn = document.getElementById('save-permission-btn');
        if (newSaveBtn && canEdit) {
          newSaveBtn.addEventListener('click', function() {
            const form = document.getElementById('edit-permission-form');
            if (form) {
              const permissionId = form.getAttribute('data-id');
              const newReason = document.getElementById('edit-permission-reason').value.trim();

              if (!newReason) {
                showToast('请填写申请原因', 'warning');
                return;
              }

              updatePermission(permissionId, newReason);
            } else {
              showToast('表单不存在，无法保存', 'error');
            }
          });
        }
      }

      // 获取权限申请详情
      fetch(`/api/permissions/${permissionId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
      .then(response => response.json())
        .then(data => {
        if (data.success && data.permission) {
          const permission = data.permission;

          // 获取申请类型中文名称
          const typeMap = {
            'model': '高级模型使用权限',
            'storage': '增加存储空间',
            'api': 'API接口调用权限',
            'other': '其他权限'
          };
          const typeName = typeMap[permission.request_type] || '未知类型';

          // 获取状态中文名称和样式
          let statusText = '';
          let statusClass = '';
          switch(permission.status) {
            case 'pending':
              statusText = '待审核';
              statusClass = 'tag-warning';
              break;
            case 'approved':
              statusText = '已批准';
              statusClass = 'tag-success';
              break;
            case 'rejected':
              statusText = '已拒绝';
              statusClass = 'tag-danger';
              break;
            default:
              statusText = '未知状态';
              statusClass = 'tag-info';
          }

          // 显示详情
          let detailHTML = `
            <div class="permission-detail">
              <div class="form-group">
                <label class="form-label">申请类型</label>
                <div class="detail-text">${typeName}</div>
              </div>

              <div class="form-group">
                <label class="form-label">申请状态</label>
                <div><span class="tag ${statusClass}">${statusText}</span></div>
              </div>

              <div class="form-group">
                <label class="form-label">申请日期</label>
                <div class="detail-text">${formatDate(permission.created_at)}</div>
              </div>

              <div class="form-group">
                <label class="form-label">申请原因</label>
                <div class="detail-text">${permission.request_reason || '无'}</div>
              </div>
          `;

          // 如果已审核，显示审核结果
          if (permission.status !== 'pending') {
            detailHTML += `
              <div class="form-group">
                <label class="form-label">审核时间</label>
                <div class="detail-text">${permission.updated_at ? formatDate(permission.updated_at) : '未知'}</div>
              </div>

              <div class="form-group">
                <label class="form-label">审核意见</label>
                <div class="detail-text">${permission.admin_comment || '无'}</div>
              </div>
            `;
          }

          // 如果是可编辑模式，添加表单
          if (canEdit) {
            detailHTML += `
              <form id="edit-permission-form" data-id="${permission.id}">
                <div class="form-group">
                  <label class="form-label">修改申请原因</label>
                  <textarea class="form-control" id="edit-permission-reason" rows="4" required>${permission.request_reason || ''}</textarea>
                </div>
              </form>
            `;
          }

          detailHTML += `</div>`;

          // 更新内容
          if (contentDiv) {
            contentDiv.innerHTML = detailHTML;

            // 如果是编辑模式，绑定表单提交事件
            if (canEdit) {
              const form = document.getElementById('edit-permission-form');
              if (form) {
                form.addEventListener('submit', function(e) {
                  e.preventDefault();
                  const permissionId = this.getAttribute('data-id');
                  const newReason = document.getElementById('edit-permission-reason').value.trim();

                  if (!newReason) {
                    showToast('请填写申请原因', 'warning');
                    return;
                  }

                  updatePermission(permissionId, newReason);
                });
              }
            }
            }
          } else {
          if (contentDiv) {
            contentDiv.innerHTML = `
              <div class="empty-state">
                <i class="ri-error-warning-line"></i>
                <h3>获取详情失败</h3>
                <p>${data.message || '无法获取申请详情，请稍后重试'}</p>
              </div>
            `;
          }
          }
        })
        .catch(error => {
        console.error('获取权限申请详情出错:', error);
        if (contentDiv) {
          contentDiv.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <h3>获取详情失败</h3>
              <p>网络错误，请稍后重试</p>
            </div>
          `;
        }
      });

      // 绑定关闭按钮事件
      const closeBtn = document.getElementById('close-user-permission-modal');
      const closeDetailBtn = document.getElementById('close-user-permission-btn');

      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }

      if (closeDetailBtn) {
        closeDetailBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }
    }

    // 更新权限申请
    function updatePermission(permissionId, newReason) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示处理中
      showToast('正在处理...', 'info');

      // 发送更新请求
      fetch(`/api/permissions/${permissionId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          requestReason: newReason
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('申请已更新', 'success');

          // 关闭模态框
          const modal = document.getElementById('user-permission-detail-modal');
          if (modal) {
            modal.style.display = 'none';
          }

          // 刷新权限列表
          fetchPermissions();

          // 立即更新通知徽章，显示新的未读消息
          updateNotificationBadge();
        } else {
          showToast(data.message || '更新失败', 'error');
        }
      })
      .catch(error => {
        console.error('更新权限申请出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    // 取消权限申请
    function cancelPermission(permissionId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      fetch(`/api/permissions/${permissionId}`, {
        method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('已取消申请', 'success');
          fetchPermissions(); // 刷新列表

          // 立即更新通知徽章，显示新的未读消息
          updateNotificationBadge();
        } else {
          showToast(data.message || '取消申请失败', 'error');
        }
      })
      .catch(error => {
        console.error('取消申请出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    // 添加显示空状态的辅助函数(如果函数已存在则不需重复添加)
    function showEmptyState(targetId, message, iconClass = 'ri-information-line') {
      const targetElement = document.getElementById(targetId);
      if (!targetElement) {
        console.error(`找不到目标元素: ${targetId}`);
        return;
      }

      if (targetElement.tagName === 'TBODY') {
        targetElement.innerHTML = `
          <tr>
            <td colspan="7" class="text-center">
              <div class="empty-state" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; width: 100%;">
                <i class="${iconClass}" style="font-size: 48px; margin-bottom: 15px;"></i>
                <h3>${message || '暂无数据'}</h3>
                <p>当前没有可显示的内容</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        targetElement.innerHTML = `
          <div class="empty-state" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; width: 100%;">
            <i class="${iconClass}" style="font-size: 48px; margin-bottom: 15px;"></i>
            <h3>${message || '暂无数据'}</h3>
            <p>当前没有可显示的内容</p>
          </div>
        `;
      }
    }

    // 保存用户资料成功后的处理
    function updateUserData(data) {
      if (data.success && data.user) {
        // 更新界面上显示的用户名
        document.getElementById('username').textContent = data.user.username;
        document.getElementById('user-avatar').textContent = data.user.username.charAt(0).toUpperCase();

        // 更新个人资料表单中的数据
        document.getElementById('profile-username').value = data.user.username;
        document.getElementById('profile-email').value = data.user.email || '';
        document.getElementById('profile-name').value = data.user.name || '';
        document.getElementById('profile-phone').value = data.user.phone || '';
        document.getElementById('profile-organization').value = data.user.organization || '';
        document.getElementById('profile-department').value = data.user.department || '';
        document.getElementById('profile-bio').value = data.user.bio || '';

        // 显示成功提示
        showToast(data.message || '资料更新成功', 'success');
      } else {
        showToast(data.message || '操作失败', 'error');
      }
    }

    // 标记通知为已读
    function markNotificationAsRead(notificationId) {
      fetch('/api/notifications/mark-read', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify({ notification_id: notificationId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 标记成功后自动刷新通知列表
          fetchNotifications();
        } else {
          showToast('操作失败：' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error marking notification as read:', error);
        showToast('标记通知失败，请稍后重试', 'error');
      });
    }

    // 删除通知
    function deleteNotification(notificationId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      fetch('/api/notifications/' + notificationId, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 删除成功后自动刷新通知列表
          fetchNotifications();
        } else {
          showToast('操作失败：' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error deleting notification:', error);
        showToast('删除通知失败，请稍后重试', 'error');
      });
    }

    // 获取当前用户ID的函数
    function getUserId() {
      try {
        const userInfoStr = localStorage.getItem('user_info');

        if (!userInfoStr) {
          refreshUserInfo().catch(err => {
            console.error("【调试】刷新用户信息失败:", err);
          });
          return 0;
        }

        const userInfo = JSON.parse(userInfoStr);

        const userId = userInfo.id || 0;
        return Number(userId); // 确保返回数字类型
                } catch (e) {
        console.error('【调试】获取用户ID失败', e);
        return 0;
      }
    }

    // 删除模型的函数
    function deleteModel(modelId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      if (!confirm('确定要删除此模型吗？此操作无法撤销。')) {
        return;
      }

      // 显示加载状态
      showToast('正在删除模型...', 'info');

      // 获取模态框元素
      const modelDetailModal = document.getElementById('model-detail-modal');
      const contentElement = document.getElementById('model-detail-content');
      const modalFooter = modelDetailModal.querySelector('.modal-footer');

      // 禁用所有按钮
      const buttons = modalFooter.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = true;
      });

      // 显示删除中状态
      contentElement.innerHTML = `
        <div class="text-center" style="padding: 30px 0;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 15px; font-size: 16px;">正在删除模型，请稍候...</p>
        </div>
      `;

      // 执行删除操作
      fetch(`/api/models/${modelId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        return response.json().then(data => {
          if (!response.ok) {
            // 将错误信息包含在Promise.reject中
            return Promise.reject({
              status: response.status,
              message: data.message || '删除失败'
            });
          }
          return data;
        });
      })
      .then(data => {

        if (data.success) {
          showToast(data.message || '模型已成功删除', 'success');

          // 关闭模态框
          modelDetailModal.style.display = 'none';

          // 刷新模型列表数据，但不重新加载标签页
          fetchAllModels('all');
          fetchAllModels('system');
          fetchAllModels('custom');
          fetchAllModels('favorite');

          // 刷新控制面板上的常用模型列表
          fetchPopularModels();

          // 同时刷新上传表单中的模型下拉选择框
          loadModelList();
          loadVideoModelList();

          // 移除强制重新显示当前标签页的代码，避免界面刷新
        } else {
          // 删除失败，恢复按钮状态
          buttons.forEach(btn => {
            btn.disabled = false;
          });

          // 显示错误信息
          contentElement.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line empty-icon"></i>
              <h3>删除失败</h3>
              <p>${data.message || '无法删除此模型'}</p>
            </div>
          `;

          showToast(data.message || '删除失败', 'error');
          }
        })
        .catch(error => {
        console.error('【调试】删除模型出错:', error);

        // 恢复按钮状态
        buttons.forEach(btn => {
          btn.disabled = false;
        });

        // 显示错误信息
        contentElement.innerHTML = `
            <div class="empty-state">
            <i class="ri-error-warning-line empty-icon"></i>
            <h3>删除失败</h3>
            <p>发生错误: ${error.message || JSON.stringify(error)}</p>
            </div>
          `;

        showToast(`删除失败: ${error.message || '未知错误'}`, 'error');
      });
    }


    // 为删除按钮添加事件绑定
    setTimeout(() => {
      const deleteBtn = document.getElementById('delete-model-btn');
      if (deleteBtn) {
        deleteBtn.onclick = function() {
          const modelId = this.getAttribute('data-id');
          deleteModel(modelId);
        };
      }
    }, 100);

    // 强制重新获取用户信息的函数
    function refreshUserInfo() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        console.error("【调试】无法获取token，无法刷新用户信息");
        return Promise.reject("未登录状态");
      }

      return fetch('/api/user/info', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('获取用户信息失败');
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.user) {
          localStorage.setItem('user_info', JSON.stringify(data.user));
          return data.user;
        } else {
          throw new Error(data.message || '获取用户数据失败');
        }
      });
    }

    function initApp() {
      // 初始化侧边栏菜单
      initSidebarMenu();

      // 初始化用户下拉菜单
      initUserDropdown();

      // 初始化通知图标点击事件
      const notificationToggle = document.getElementById('notification-toggle');
      if (notificationToggle) {
        notificationToggle.addEventListener('click', function() {
          showTab('notifications');
        });
      }

      // 初始化权限图标点击事件（仅管理员可见）
      const permissionToggle = document.getElementById('permission-toggle');
      if (permissionToggle) {
        permissionToggle.addEventListener('click', function() {
          showTab('permissions');
        });
      }

      // 获取用户信息
      fetchUserInfo();

      // 立即更新通知徽章（在页面一加载时就显示未读消息计数）
      updateNotificationBadge();

      // 立即更新权限徽章（仅对管理员显示）
      updatePermissionBadge();

      // 设置定时器定期更新通知徽章和权限徽章（每30秒更新一次）
      setInterval(updateNotificationBadge, 30000);
      setInterval(updatePermissionBadge, 30000);

      // 强制清除所有可能重复激活的状态，确保标签只有一条激活线
      console.log("强制清除所有可能重复激活的目标检测子标签状态");
      const allUploadTabs = document.querySelectorAll('.tab-link[data-tab^="upload-"]');
      allUploadTabs.forEach(t => t.classList.remove('active'));

      // 初始各个功能模块
      initDashboardFeatures();
      fetchDashboardStats();
      fetchRecentHistory();
      fetchPopularModels();
      initUploadFeatures();
      initHistoryFeatures();
      initModelFeatures();
      initPermissionFeatures();
      initModelPublishFeatures();
      initNotificationFeatures();
      initProfileFeatures();

      // 初始化实时监测功能
      initRealTimeMonitoring();

      // 初始化历史记录详情弹窗
      initHistoryDetailModal();

      // 默认显示控制面板
      showTab('dashboard');
    }

    // 管理员获取所有权限申请列表
    function fetchAdminPermissions() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        return;
      }

      // 显示加载中
      const tableBody = document.getElementById('admin-permissions-table-body');
      if (!tableBody) {
        console.error("找不到admin-permissions-table-body元素");
        return;
      }

      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center">
            <div class="loading-spinner"></div>
          </td>
        </tr>
      `;

      // 发送请求获取管理员权限审批列表
      fetch('/api/admin/permissions', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取权限申请列表失败');
          }
          return response.json();
        })
        .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success && data.permissions && data.permissions.length > 0) {
          let html = '';

          data.permissions.forEach(permission => {
            // 获取申请类型的中文名称
            const typeMap = {
              'model': '高级模型使用权限',
              'storage': '增加存储空间',
              'api': 'API接口调用权限',
              'other': '其他权限'
            };
            const typeName = typeMap[permission.request_type] || '未知类型';

            // 获取状态对应的样式和文本
            let statusClass = '';
            let statusText = '';
            switch(permission.status) {
              case 'pending':
                statusClass = 'tag-warning';
                statusText = '待审核';
                break;
              case 'approved':
                statusClass = 'tag-success';
                statusText = '已批准';
                break;
              case 'rejected':
                statusClass = 'tag-danger';
                statusText = '已拒绝';
                break;
              default:
                statusClass = 'tag-info';
                statusText = '未知状态';
            }

            // 构建行HTML
            html += `
              <tr>
                <td>${permission.username || '未知用户'}</td>
                <td>${typeName}</td>
                <td>${formatDate(permission.created_at)}</td>
                <td><span class="tag ${statusClass}">${statusText}</span></td>
                <td>
                  ${permission.status === 'pending' ? `
                    <button class="action-btn view-admin-permission-btn" title="查看并处理" data-id="${permission.id}">
                      <i class="ri-eye-line"></i>
                    </button>
                  ` : `
                    <button class="action-btn view-admin-permission-btn" title="查看详情" data-id="${permission.id}">
                      <i class="ri-eye-line"></i>
                    </button>
                  `}
                </td>
              </tr>
            `;
          });

          tableBody.innerHTML = html;

          // 添加查看申请按钮的点击事件处理
          document.querySelectorAll('.view-admin-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const permissionId = this.getAttribute('data-id');
              viewPermissionDetail(permissionId);
            });
          });
        } else {
          // 显示暂无数据状态
          showEmptyState('admin-permissions-table-body', '暂无待处理的权限申请', 'ri-shield-keyhole-line');
        }
      })
      .catch(error => {
        console.error('获取管理员权限申请列表出错:', error);
        showEmptyState('admin-permissions-table-body', '获取数据失败，请刷新重试', 'ri-error-warning-line');
      });
    }

    // 查看权限申请详情
    function viewPermissionDetail(permissionId) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示模态框
      const modal = document.getElementById('permission-approval-modal');
      const detailContent = document.getElementById('permission-detail-content');

      if (modal && detailContent) {
        modal.style.display = 'flex';
        detailContent.innerHTML = '<div class="loading-spinner"></div>';

        // 获取权限申请详情
        fetch(`/api/admin/permissions/${permissionId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.permission) {
            const permission = data.permission;

            // 获取申请类型的中文名称
            const typeMap = {
              'model': '高级模型使用权限',
              'storage': '增加存储空间',
              'api': 'API接口调用权限',
              'other': '其他权限'
            };
            const typeName = typeMap[permission.request_type] || '未知类型';

            // 获取状态对应的文本
            let statusText = '';
            switch(permission.status) {
              case 'pending':
                statusText = '待审核';
                break;
              case 'approved':
                statusText = '已批准';
                break;
              case 'rejected':
                statusText = '已拒绝';
                break;
              default:
                statusText = '未知状态';
            }

            // 构建详情HTML
            let detailHtml = `
              <div class="permission-detail">
                <div class="detail-item">
                  <div class="detail-label">申请用户:</div>
                  <div class="detail-value">${permission.username || '未知用户'}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">申请类型:</div>
                  <div class="detail-value">${typeName}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">申请时间:</div>
                  <div class="detail-value">${formatDate(permission.created_at)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">当前状态:</div>
                  <div class="detail-value">${statusText}</div>
                </div>
            `;

            // 如果是存储空间申请，显示申请的大小
            if (permission.request_type === 'storage' && permission.storage_size) {
              detailHtml += `
                <div class="detail-item">
                  <div class="detail-label">申请存储空间:</div>
                  <div class="detail-value">${permission.storage_size} GB</div>
                </div>
              `;
            }

            // 添加申请原因
            detailHtml += `
                <div class="detail-item">
                  <div class="detail-label">申请原因:</div>
                  <div class="detail-value permit-reason">${permission.request_reason || '无'}</div>
                </div>
            `;

            // 如果已经审批，显示审批信息
            if (permission.status !== 'pending') {
              detailHtml += `
                <div class="detail-item">
                  <div class="detail-label">审批时间:</div>
                  <div class="detail-value">${formatDate(permission.updated_at)}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">审批意见:</div>
                  <div class="detail-value">${permission.admin_comment || '无'}</div>
                </div>
              `;
            }

            detailHtml += `</div>`;

            // 更新模态框内容
            detailContent.innerHTML = detailHtml;

            // 针对不同状态显示不同的按钮
            const approveBtn = document.getElementById('approve-permission-btn');
            const rejectBtn = document.getElementById('reject-permission-btn');

            // 如果已审批，隐藏审批按钮
            if (permission.status !== 'pending') {
              approveBtn.style.display = 'none';
              rejectBtn.style.display = 'none';
            } else {
              approveBtn.style.display = 'inline-block';
              rejectBtn.style.display = 'inline-block';

              // 设置当前处理的权限ID
              approveBtn.setAttribute('data-id', permissionId);
              rejectBtn.setAttribute('data-id', permissionId);
            }
          } else {
            detailContent.innerHTML = `
              <div class="empty-state">
                <i class="ri-error-warning-line"></i>
                <p>获取申请详情失败</p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('获取权限申请详情出错:', error);
          detailContent.innerHTML = `
            <div class="empty-state">
              <i class="ri-error-warning-line"></i>
              <p>获取申请详情失败，请稍后重试</p>
            </div>
          `;
        });
      }
    }

    // 初始化权限审批功能
    function initPermissionApprovalFeatures() {
      console.log("初始化权限审批功能...");

      // 关闭审批模态框
      const closeApprovalModal = document.getElementById('close-approval-modal');
      const approvalModal = document.getElementById('permission-approval-modal');

      if (closeApprovalModal && approvalModal) {
        // 先移除旧的事件监听器，防止重复绑定
        const newCloseBtn = closeApprovalModal.cloneNode(true);
        closeApprovalModal.parentNode.replaceChild(newCloseBtn, closeApprovalModal);

        newCloseBtn.onclick = function() {
          approvalModal.style.display = 'none';
        };
      }

      // 批准权限申请
      const approveBtn = document.getElementById('approve-permission-btn');
      if (approveBtn) {
        // 克隆节点并替换，以移除所有旧的事件监听器
        const newApproveBtn = approveBtn.cloneNode(true);
        approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);

        newApproveBtn.onclick = function() {
          const permissionId = this.getAttribute('data-id');
          if (!permissionId) {
            showToast('无法获取权限ID', 'error');
            return;
          }

          // 显示批准意见输入框
          const approveCommentModal = document.getElementById('approve-comment-modal');
          if (approveCommentModal) {
            approveCommentModal.style.display = 'flex';
            // 清空文本框内容
            const approveTextarea = document.getElementById('approve-comment-textarea');
            if (approveTextarea) {
              approveTextarea.value = '';
            }
          }

          // 设置确认批准按钮的事件处理
          const submitApproveBtn = document.getElementById('submit-approve-btn');
          if (submitApproveBtn) {
            submitApproveBtn.onclick = function() {
              const adminComment = document.getElementById('approve-comment-textarea').value;
              approvePermission(permissionId, adminComment);
              // 关闭模态框
              approveCommentModal.style.display = 'none';
            };
          }
        };
      }

      // 拒绝权限申请
      const rejectBtn = document.getElementById('reject-permission-btn');
      if (rejectBtn) {
        // 克隆节点并替换，以移除所有旧的事件监听器
        const newRejectBtn = rejectBtn.cloneNode(true);
        rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);

        newRejectBtn.onclick = function() {
          const permissionId = this.getAttribute('data-id');
          if (!permissionId) {
            showToast('无法获取权限ID', 'error');
            return;
          }

          // 显示拒绝原因输入框
          const rejectCommentModal = document.getElementById('reject-comment-modal');
          if (rejectCommentModal) {
            rejectCommentModal.style.display = 'flex';
            // 清空文本框内容
            const rejectTextarea = document.getElementById('reject-comment-textarea');
            if (rejectTextarea) {
              rejectTextarea.value = '';

              // 添加实时验证
              rejectTextarea.addEventListener('input', function() {
                const value = this.value.trim();
                const validationMessage = document.getElementById('reject-validation-message');

                if (value.length < 10) {
                  validationMessage.textContent = `请填写详细的拒绝理由，还需要${10 - value.length}个字符`;
                  validationMessage.style.color = '#F25F5C';
                  document.getElementById('submit-reject-btn').disabled = true;
                } else {
                  validationMessage.textContent = '拒绝理由已满足最低要求';
                  validationMessage.style.color = '#00C49A';
                  document.getElementById('submit-reject-btn').disabled = false;
                }
              });

              // 初始状态下禁用提交按钮
              document.getElementById('submit-reject-btn').disabled = true;
            }
          }

          // 设置确认拒绝按钮的事件处理
          const submitRejectBtn = document.getElementById('submit-reject-btn');
          if (submitRejectBtn) {
            submitRejectBtn.onclick = function() {
              const adminComment = document.getElementById('reject-comment-textarea').value;
              if (!adminComment.trim()) {
                showToast('拒绝原因不能为空', 'warning');
                return;
              }
              rejectPermission(permissionId, adminComment);
            };
          }
        };
      }

      // 取消批准权限申请
      const cancelApproveBtn = document.getElementById('cancel-approve-btn');
      if (cancelApproveBtn) {
        cancelApproveBtn.onclick = function() {
          const approveCommentModal = document.getElementById('approve-comment-modal');
          if (approveCommentModal) {
            approveCommentModal.style.display = 'none';
          }
        };
      }

      // 取消拒绝权限申请
      const cancelRejectBtn = document.getElementById('cancel-reject-btn');
      if (cancelRejectBtn) {
        cancelRejectBtn.onclick = function() {
          const rejectCommentModal = document.getElementById('reject-comment-modal');
          if (rejectCommentModal) {
            rejectCommentModal.style.display = 'none';
          }
        };
      }

      // 关闭批准模态框按钮事件
      const closeApproveCommentModal = document.getElementById('close-approve-comment-modal');
      if (closeApproveCommentModal) {
        closeApproveCommentModal.onclick = function() {
          const approveCommentModal = document.getElementById('approve-comment-modal');
          if (approveCommentModal) {
            approveCommentModal.style.display = 'none';
          }
        };
      }

      // 关闭拒绝模态框按钮事件
      const closeRejectCommentModal = document.getElementById('close-reject-comment-modal');
      if (closeRejectCommentModal) {
        closeRejectCommentModal.onclick = function() {
          const rejectCommentModal = document.getElementById('reject-comment-modal');
          if (rejectCommentModal) {
            rejectCommentModal.style.display = 'none';
          }
        };
      }
    }

    // 批准权限申请
    function approvePermission(permissionId, adminComment) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示处理中
      showToast('正在处理...', 'info');

      // 发送批准请求
      fetch(`/api/admin/permissions/${permissionId}/approve`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          adminComment: adminComment,
          reason: adminComment // 兼容后端API可能使用的参数名
        })
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('已批准权限申请', 'success');

          // 关闭模态框
          const modal = document.getElementById('permission-approval-modal');
          if (modal) {
            modal.style.display = 'none';
          }

          // 关闭批准理由模态框
          const approveModal = document.getElementById('approve-comment-modal');
          if (approveModal) {
            approveModal.style.display = 'none';
          }

          // 刷新权限列表
          fetchAdminPermissions();

          // 立即更新权限徽章
          updatePermissionBadge();
        } else {
          showToast(data.message || '操作失败', 'error');
        }
      })
      .catch(error => {
        console.error('批准权限申请出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    // 拒绝权限申请
    function rejectPermission(permissionId, adminComment) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示处理中
      showToast('正在处理...', 'info');

      // 发送拒绝请求
      fetch(`/api/admin/permissions/${permissionId}/reject`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          adminComment: adminComment,
          reason: adminComment // 后端API中使用的参数名
        })
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('已拒绝权限申请', 'success');

          // 关闭模态框
          const modal = document.getElementById('permission-approval-modal');
          if (modal) {
            modal.style.display = 'none';
          }

          // 关闭拒绝理由模态框
          const rejectModal = document.getElementById('reject-comment-modal');
          if (rejectModal) {
            rejectModal.style.display = 'none';
          }

          // 刷新权限列表
          fetchAdminPermissions();

          // 立即更新权限徽章
          updatePermissionBadge();
        } else {
          showToast(data.message || '操作失败', 'error');
        }
      })
      .catch(error => {
        console.error('拒绝权限申请出错:', error);
        showToast('操作失败，请稍后重试', 'error');
      });
    }

    // 获取用户信息并加载个人资料页面
    function loadUserProfile() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 1500);
        return;
      }

      // 从本地存储获取基本信息
      const userInfoStr = localStorage.getItem('user_info');
      if (userInfoStr) {
        try {
          const userInfo = JSON.parse(userInfoStr);
          // 填充基本信息
          document.getElementById('profile-username').value = userInfo.username || '';
          document.getElementById('profile-email').value = userInfo.email || '';
          document.getElementById('profile-organization').value = userInfo.organization || '';
        } catch (e) {
          console.error('解析用户信息失败:', e);
        }
      }

      // 从服务器获取完整的用户信息
      fetch('/api/user/info', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
            return null;
          }
          throw new Error('获取用户信息失败');
          }
          return response.json();
        })
        .then(data => {
        if (!data) return; // 已处理跳转

        if (data.success && data.user) {
          const user = data.user;

          // 更新表单值
          document.getElementById('profile-username').value = user.username || '';
          document.getElementById('profile-email').value = user.email || '';
          document.getElementById('profile-organization').value = user.organization || '';

          // 更新用户头像、用户名等界面元素
          const usernameElement = document.getElementById('username');
          if (usernameElement) {
            usernameElement.textContent = user.username;
          }

          // 如果有头像信息，更新头像
          const avatarElement = document.getElementById('user-avatar');
          if (avatarElement && user.username) {
            avatarElement.textContent = user.username.charAt(0).toUpperCase();
          }

          // 存储更新后的用户信息
          localStorage.setItem('user_info', JSON.stringify(user));
        }
      })
      .catch(error => {
        console.error('加载用户资料失败:', error);
        showToast('加载用户资料失败', 'error');
      });
    }

    // 实时监测功能
    function initRealTimeMonitoring() {
      console.log("初始化实时监测功能...");

      // 加载模型列表
      loadRealtimeModelList();

    // 实时监测表单提交处理
    const realtimeConfigForm = document.getElementById('realtime-config-form');
    if (realtimeConfigForm) {
      realtimeConfigForm.addEventListener('submit', function(e) {
        e.preventDefault();
        startRealtimeMonitoring();
      });
    }

    // 停止监测按钮
    const stopMonitoringBtn = document.getElementById('stop-monitoring-btn');
    if (stopMonitoringBtn) {
      stopMonitoringBtn.addEventListener('click', function() {
        stopRealtimeMonitoring();
      });
    }

    // 清空检测日志按钮
    const clearDetectionLogBtn = document.getElementById('clear-detection-log');
    if (clearDetectionLogBtn) {
      clearDetectionLogBtn.addEventListener('click', function() {
        const detectionLog = document.getElementById('detection-log');
        if (detectionLog) {
          detectionLog.innerHTML = '<div class="text-center text-gray">监测日志已清空</div>';
        }
      });
      }
    }

    // 加载实时监测模型列表
    function loadRealtimeModelList() {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const realtimeModelSelect = document.getElementById('realtime-model-select');
      if (!realtimeModelSelect) return;

      // 显示加载中
      realtimeModelSelect.innerHTML = '<option value="">加载中...</option>';

      fetch('/api/models?supports_video=true', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
          throw new Error('获取模型列表失败');
      }
      return response.json();
    })
    .then(data => {
        if (data.success && data.models && data.models.length > 0) {
          // 清空现有选项
          realtimeModelSelect.innerHTML = '';

          // 添加默认选项
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = '--请选择模型--';
          realtimeModelSelect.appendChild(defaultOption);

          // 添加所有模型选项，不仅仅是支持视频的
          data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            realtimeModelSelect.appendChild(option);
          });
              } else {
          realtimeModelSelect.innerHTML = '<option value="">暂无可用模型</option>';
      }
    })
    .catch(error => {
        console.error('加载实时监测模型列表出错:', error);
        realtimeModelSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      });

      // 初始化视频源选择切换
      initRealtimeSourceSelection();
    }

    // 初始化实时监测视频源选择
    function initRealtimeSourceSelection() {
      const cameraGroup = document.getElementById('camera-source-group');

      // 初始化摄像头列表
      const cameraSelect = document.getElementById('camera-select');
      if (cameraSelect) {
        // 获取可用摄像头
        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
          navigator.mediaDevices.enumerateDevices()
            .then(devices => {
              // 清空现有选项，保留默认
              while (cameraSelect.options.length > 1) {
                cameraSelect.remove(1);
              }

              // 添加找到的摄像头
              let hasCamera = false;
              devices.forEach(device => {
                if (device.kind === 'videoinput') {
                  hasCamera = true;
                  const option = document.createElement('option');
                  option.value = device.deviceId;
                  option.textContent = device.label || `摄像头 ${cameraSelect.options.length}`;
                  cameraSelect.appendChild(option);
                }
              });

              if (!hasCamera) {
                cameraSelect.innerHTML = '<option value="">未检测到摄像头</option>';
              }
            })
            .catch(err => {
              console.error('获取摄像头列表失败:', err);
              cameraSelect.innerHTML = '<option value="">无法访问摄像头</option>';
            });
        } else {
          cameraSelect.innerHTML = '<option value="">浏览器不支持摄像头访问</option>';
        }
      }
    }

    // 开始实时监测
    function startRealtimeMonitoring() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 获取配置
    const cameraSelect = document.getElementById('camera-select');
      const modelSelect = document.getElementById('realtime-model-select');
    const detectionThreshold = document.getElementById('detection-threshold');
    const detectionFrequency = document.getElementById('detection-frequency');
    const saveFrequency = document.getElementById('save-frequency');

      const cameraSource = cameraSelect ? cameraSelect.value : '';
      const modelId = modelSelect ? modelSelect.value : '';
      const threshold = detectionThreshold ? detectionThreshold.value : 0.5;
      const frequency = detectionFrequency ? detectionFrequency.value : 5;
      const saveFreq = saveFrequency ? saveFrequency.value : 10;

      // 验证配置
      if (!modelId) {
        showToast('请选择识别模型', 'warning');
        return;
      }

      if (!cameraSource) {
        showToast('请选择摄像头', 'warning');
        return;
      }

      // 显示处理中
      showToast('正在初始化实时监测...', 'info');

      // 设置isRealtimeMonitoring全局变量为true
      isRealtimeMonitoring = true;

      // 使用JSON格式数据而不是FormData，与后端API匹配
      const requestData = {
        modelId: modelId,
        recordVideo: true,
        remark: "实时监测",
        // 添加前端特定参数，后端可能不使用
        source: "camera",
        camera_id: cameraSource,
        detection_threshold: threshold,
        detection_frequency: frequency,
        save_frequency: saveFreq
      };

      let fetchOptions = {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      };

      // 发送初始化请求到正确的API端点
      fetch('/api/realtime/start', fetchOptions)
      .then(response => {
        if (!response.ok) {
          throw new Error('初始化实时监测失败');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // 显示监测区域
          const realtimeMonitoringArea = document.getElementById('realtime-monitoring-area');
          if (realtimeMonitoringArea) {
            realtimeMonitoringArea.style.display = 'block';
          }

          // 隐藏配置表单
          const realtimeConfigForm = document.getElementById('realtime-config-form').parentElement.parentElement;
          if (realtimeConfigForm) {
            realtimeConfigForm.style.display = 'none';
          }

          showToast('实时监测已启动', 'success');

          // 保存会话ID
          monitoringSessionId = data.sessionId;

          // 启动摄像头
          startCameraAccess(cameraSource);
        } else {
          showToast(data.message || '初始化实时监测失败', 'error');
          isRealtimeMonitoring = false; // 重置监测状态
        }
      })
      .catch(error => {
        console.error('初始化实时监测出错:', error);
        showToast('初始化实时监测失败', 'error');
        isRealtimeMonitoring = false; // 重置监测状态
      });
    }

    // 启动摄像头访问
    function startCameraAccess(cameraDeviceId) {
      // 创建/获取视频元素
      const streamContainer = document.getElementById('realtime-stream-container');
      videoElement = document.createElement('video');
      videoElement.style.width = '100%';
      videoElement.style.height = '100%';
      videoElement.style.objectFit = 'contain';
      videoElement.autoplay = true;
      videoElement.muted = true; // 必须静音以避免反馈

      // 替换loading文本
      const loadingElement = document.getElementById('loading-stream');
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }

      // 清空容器并添加视频元素
      streamContainer.innerHTML = '';
      streamContainer.appendChild(videoElement);

      // 设置canvas用于帧处理
      monitoringCanvas = document.createElement('canvas');
      monitoringCanvas.style.display = 'none';
      document.body.appendChild(monitoringCanvas);

      // 访问摄像头
      const constraints = {
        video: cameraDeviceId ? { deviceId: cameraDeviceId } : true,
        audio: false
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          videoStream = stream;
          videoElement.srcObject = stream;

          // 等待视频元素数据加载后开始捕获帧
          videoElement.onloadedmetadata = () => {
            // 设置canvas尺寸
            monitoringCanvas.width = videoElement.videoWidth;
            monitoringCanvas.height = videoElement.videoHeight;
            canvasContext = monitoringCanvas.getContext('2d');

            // 开始捕获和发送帧
            frameInterval = setInterval(captureAndSendFrame, 200); // 5fps
          };
        })
        .catch(err => {
          console.error('访问摄像头失败:', err);
          showToast('无法访问摄像头: ' + err.message, 'error');
          stopRealtimeMonitoring();
        });
    }

    // 捕获并发送视频帧
    function captureAndSendFrame() {
      if (!videoElement || !canvasContext || !monitoringCanvas || !monitoringSessionId) {
        console.error('视频元素或画布未初始化');
        return;
      }

      try {
        // 在画布上绘制当前视频帧
        canvasContext.drawImage(videoElement, 0, 0, monitoringCanvas.width, monitoringCanvas.height);

        // 将画布内容转换为Blob
        monitoringCanvas.toBlob(blob => {
          if (!blob) {
            console.error('无法创建图像Blob');
            return;
          }

          // 创建FormData对象来发送帧数据
          const formData = new FormData();
          formData.append('sessionId', monitoringSessionId);
          formData.append('frame', blob, 'frame.jpg');

          // 发送帧到服务器
          sendFrameToServer(formData);
        }, 'image/jpeg', 0.8);
      } catch (err) {
        console.error('捕获帧失败:', err);
      }
    }

    // 发送帧到服务器
    function sendFrameToServer(formData) {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showToast('请先登录', 'warning');
        stopRealtimeMonitoring();
        return;
      }

      fetch('/api/realtime/frame', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      })
      .then(response => {
        // 检查HTTP状态码
        if (response.status === 404) {
          console.log('会话不存在或已过期，停止监测');
          isRealtimeMonitoring = false; // 立即标记为非监测状态
          stopRealtimeMonitoring();
          showToast('监测会话已结束，请重新开始', 'info');
          return Promise.reject(new Error('会话不存在'));
        }

        if (!response.ok) {
          throw new Error('帧处理失败');
        }

        // 检查响应类型
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json().then(data => {
            if (!data.success) {
              throw new Error(data.message || '帧处理失败');
            }

            // 更新界面
            updateRealTimeDisplay(data);
          });
        } else if (contentType && contentType.includes('image/jpeg')) {
          // 直接处理图像响应
          return response.arrayBuffer().then(buffer => {
            // 将缓冲区转换为base64
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));

            // 显示处理后的图像
            const realtimeFrame = document.getElementById('realtime-frame');
            if (realtimeFrame) {
              realtimeFrame.src = 'data:image/jpeg;base64,' + base64;
              realtimeFrame.style.display = 'block';
            }

            // 从头部提取统计信息
            const stats = {
              detection_count: response.headers.get('X-Detections-Count'),
              total_frames: response.headers.get('X-Total-Frames'),
              total_detections: response.headers.get('X-Total-Detections'),
              avg_confidence: response.headers.get('X-Avg-Confidence'),
              categories: response.headers.get('X-Categories'),
              elapsed_time: response.headers.get('X-Elapsed-Time')
            };

            // 更新统计信息
            updateMonitoringStatsFromHeaders(stats);
          });
        }
      })
      .catch(error => {
        console.error('帧处理出错:', error);

        // 检查是否是会话不存在错误
        if (error.message && error.message.includes('会话不存在')) {
          // 已在前面处理过，不需要额外操作
          return;
        }

        // 检查是否应该停止监测
        if (!isRealtimeMonitoring) {
          console.log('监测已停止，不再处理错误');
          return;
        }

        // 其他错误，可能是暂时性的，显示错误但继续尝试
        const loadingStream = document.getElementById('loading-stream');
        if (loadingStream) {
          loadingStream.textContent = '连接错误，正在重试...';
          loadingStream.style.display = 'block';
        }
      });
    }

    // 从响应头更新监测统计信息
    function updateMonitoringStatsFromHeaders(stats) {
      // 处理检测结果
      if (stats.detection_count && parseInt(stats.detection_count) > 0) {
        // 更新日志 - 这里可能需要另一种方式来获取检测细节
        const detectionLog = document.getElementById('detection-log');
        if (detectionLog) {
          // 清除"监测开始后将显示检测日志"提示
          if (detectionLog.querySelector('.text-center.text-gray')) {
            detectionLog.innerHTML = '';
          }

          // 添加检测记录
          const logItem = document.createElement('div');
          logItem.className = 'd-flex justify-between mb-10 align-center';

          const timestamp = new Date().toLocaleTimeString();
          const categories = stats.categories ? stats.categories.split(',') : ['未知对象'];

          logItem.innerHTML = `
            <span><i class="ri-checkbox-circle-line text-success mr-10"></i>${categories[0]}</span>
            <span>检测数量: ${stats.detection_count}</span>
            <span class="text-gray">${timestamp}</span>
          `;

          detectionLog.insertBefore(logItem, detectionLog.firstChild);

          // 保持日志不超过20条
          if (detectionLog.children.length > 20) {
            detectionLog.removeChild(detectionLog.lastChild);
          }
        }
      }

      // 更新统计数据
      if (stats.elapsed_time) {
        const seconds = Math.floor(parseFloat(stats.elapsed_time));
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const formattedTime = `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        document.getElementById('monitoring-duration').textContent = formattedTime;
      }

      if (stats.total_detections) {
        document.getElementById('detected-objects-count').textContent = stats.total_detections;
      }

      if (stats.total_frames) {
        const fps = Math.round((stats.total_frames / parseFloat(stats.elapsed_time)) * 10) / 10;
        document.getElementById('current-fps').textContent = fps.toFixed(1) + ' FPS';
      }

      if (stats.avg_confidence) {
        const accuracy = parseFloat(stats.avg_confidence) * 100;
        document.getElementById('avg-accuracy').textContent = accuracy.toFixed(1) + '%';
      }
    }

    // 处理实时监测JSON响应数据
    function updateRealTimeDisplay(data) {
      // 显示图像（如果有）
      if (data.frame_data) {
        const realtimeFrame = document.getElementById('realtime-frame');
        if (realtimeFrame) {
          realtimeFrame.src = 'data:image/jpeg;base64,' + data.frame_data;
          realtimeFrame.style.display = 'block';

          // 隐藏加载提示
          const loadingElement = document.getElementById('loading-stream');
          if (loadingElement) {
            loadingElement.style.display = 'none';
          }
        }
      }

      // 处理检测结果
      if (data.detection_results && data.detection_results.length > 0) {
        const detectionLog = document.getElementById('detection-log');
        if (detectionLog) {
          // 清除"监测开始后将显示检测日志"提示
          if (detectionLog.querySelector('.text-center.text-gray')) {
            detectionLog.innerHTML = '';
          }

          // 为每个检测结果添加一条日志记录
          data.detection_results.forEach(result => {
            const logItem = document.createElement('div');
            logItem.className = 'd-flex justify-between mb-10 align-center';

            const timestamp = new Date().toLocaleTimeString();
            const className = result.class || '未知对象';
            const confidence = result.confidence ? (result.confidence * 100).toFixed(1) + '%' : '未知';

            logItem.innerHTML = `
              <span><i class="ri-checkbox-circle-line text-success mr-10"></i>${className}</span>
              <span>准确度: ${confidence}</span>
              <span class="text-gray">${timestamp}</span>
            `;

            detectionLog.insertBefore(logItem, detectionLog.firstChild);

            // 保持日志不超过20条
            if (detectionLog.children.length > 20) {
              detectionLog.removeChild(detectionLog.lastChild);
            }
          });
        }

        // 更新统计数据
        if (data.stats) {
          // 更新各个统计指标
          if (data.stats.duration) {
            document.getElementById('monitoring-duration').textContent = data.stats.duration;
          }

          if (data.stats.object_count !== undefined) {
            document.getElementById('detected-objects-count').textContent = data.stats.object_count;
          }

          if (data.stats.fps !== undefined) {
            document.getElementById('current-fps').textContent = data.stats.fps.toFixed(1) + ' FPS';
          }

          if (data.stats.accuracy !== undefined) {
            document.getElementById('avg-accuracy').textContent = (data.stats.accuracy * 100).toFixed(1) + '%';
          }

          if (data.stats.saved_frames !== undefined) {
            document.getElementById('saved-frames').textContent = data.stats.saved_frames;
          }
        }
      }
    }

    // 停止实时监测
    function stopRealtimeMonitoring() {
      // 立即清除定时帧捕获并更新监测状态，避免继续发送请求
      if (frameInterval) {
        clearInterval(frameInterval);
        frameInterval = null;
      }

      // 立即重置监测状态
      isRealtimeMonitoring = false;

      const token = localStorage.getItem('auth_token');

      // 清理视频和画布资源
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }

      if (videoElement) {
        if (videoElement.parentNode) {
          videoElement.parentNode.removeChild(videoElement);
        }
        videoElement = null;
      }

      if (monitoringCanvas && monitoringCanvas.parentNode) {
        monitoringCanvas.parentNode.removeChild(monitoringCanvas);
        monitoringCanvas = null;
        canvasContext = null;
      }

      // 恢复界面
      const realtimeMonitoringArea = document.getElementById('realtime-monitoring-area');
      if (realtimeMonitoringArea) {
        realtimeMonitoringArea.style.display = 'none';
      }

      // 显示配置表单
      const realtimeConfigForm = document.getElementById('realtime-config-form').parentElement.parentElement;
      if (realtimeConfigForm) {
        realtimeConfigForm.style.display = 'block';
      }

      // 重置加载状态
      const loadingStream = document.getElementById('loading-stream');
      if (loadingStream) {
        loadingStream.textContent = '准备连接视频流...';
        loadingStream.style.display = 'block';
      }

      // 隐藏实时帧
      const realtimeFrame = document.getElementById('realtime-frame');
      if (realtimeFrame) {
        realtimeFrame.style.display = 'none';
      }

      // 如果没有token或会话ID，只进行前端清理
      if (!token || !monitoringSessionId) {
        monitoringSessionId = null;
        return;
      }

      // 显示处理中
      showToast('正在停止实时监测...', 'info');

      // 发送停止请求
      fetch('/api/realtime/stop', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sessionId: monitoringSessionId
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('停止实时监测失败');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('实时监测已停止', 'success');
        } else {
          showToast(data.message || '停止实时监测失败', 'error');
        }
      })
      .catch(error => {
        console.error('停止实时监测出错:', error);
        showToast('停止实时监测失败', 'error');
      })
      .finally(() => {
        // 确保会话ID重置
        monitoringSessionId = null;
      });
    }

    // 添加模型文件下载函数
    function downloadModelFile(modelPath) {
      const token = localStorage.getItem('auth_token');
      if (!modelPath) {
        showToast('模型文件路径不存在', 'error');
        return;
      }
      if (!token) {
        showToast('请先登录', 'warning');
        return;
      }

      // 显示下载中的提示
      showToast('正在准备下载模型文件...', 'info');

      fetch(`/api/models/download?path=${encodeURIComponent(modelPath)}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('下载失败');
        return response.blob();
      })
      .then(blob => {
        // 创建下载链接并点击
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = modelPath.split(/[\\/]/).pop();
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        showToast('模型文件下载成功', 'success');
      })
      .catch(error => {
        console.error('模型下载失败:', error);
        showToast('模型下载失败：' + (error.message || '未知错误'), 'error');
      });
    }
  </script>
</body>
</html>