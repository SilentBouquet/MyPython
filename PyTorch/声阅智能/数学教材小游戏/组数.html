<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组数小游戏</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f9c74f;
            --error-color: #f94144;
            --light-primary: #7b94ff;
            --light-secondary: #8977d8;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            height: 100vh;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-color);
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .title {
            font-size: 1.8rem;
            margin: 0;
            text-align: center;
            color: var(--secondary-color);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            min-height: 0;
            overflow: hidden;
        }

        .game-config {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding-right: 1.5rem;
            border-right: 1px solid #eee;
            background-color: rgba(123, 148, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        .game-area {
            display: grid;
            grid-template-rows: auto 1fr auto;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            min-height: 0;
            padding: 1rem;
        }

        .instruction {
            background-color: rgba(123, 148, 255, 0.1);
            border-left: 4px solid var(--light-primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            font-size: 0.9rem;
        }

        .instruction p {
            margin: 0.5rem 0;
        }

        .section-title {
            font-size: 1.1rem;
            margin: 0 0 0.5rem 0;
            color: var(--light-secondary);
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            background-color: var(--light-primary);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(123, 148, 255, 0.2);
        }

        .controls .btn {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(67, 97, 238, 0.25);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
        }

        .btn-secondary {
            background-color: var(--success-color);
            box-shadow: 0 4px 6px rgba(76, 201, 240, 0.25);
        }

        .btn-secondary:hover {
            background-color: #3db8dc;
            box-shadow: 0 6px 10px rgba(76, 201, 240, 0.3);
        }

        .btn-danger {
            background-color: var(--error-color);
            box-shadow: 0 4px 6px rgba(249, 65, 68, 0.25);
        }

        .btn-danger:hover {
            background-color: #e03c3e;
            box-shadow: 0 6px 10px rgba(249, 65, 68, 0.3);
        }

        .btn-active {
            background-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.4);
            position: relative;
        }

        .btn-active::after {
            content: '✓';
            position: absolute;
            right: 10px;
            font-size: 1.2rem;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            grid-column: 1 / -1;
        }

        .stat-item {
            background-color: rgba(67, 97, 238, 0.1);
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .game-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: center;
            grid-column: 1 / -1;
        }

        .tree-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calculator-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            justify-content: center;
        }

        .controls {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            grid-column: 1 / -1;
            margin-top: 1.5rem;
            padding: 0.5rem;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem;
            width: 100%;
            max-width: 240px;
            margin: 0 auto;
            padding: 0.8rem;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: var(--border-radius);
        }

        .inputs-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .feedback-message {
            grid-column: 1 / -1;
            text-align: center;
            min-height: 2rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 0.5rem 1rem;
        }

        .correct {
            color: #4CAF50;
        }

        .incorrect {
            color: #f44336;
        }

        .tree-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            margin: 0;
            padding: 1rem;
        }

        .tree {
            position: relative;
            width: 300px;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .node {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            background-color: white;
            border: 3px solid white;
            color: var(--dark-color);
            z-index: 2;
            position: absolute;
            transition: var(--transition);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .node input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
            outline: none;
            border-radius: 50%;
        }

        .node input:focus, .node input.active {
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.5);
            background-color: rgba(76, 201, 240, 0.2);
        }

        .result-node {
            background-color: white;
            color: var(--dark-color);
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-color: white;
        }

        .hidden-node {
            background-color: white;
            border-color: var(--success-color);
            color: var(--dark-color);
        }

        .hidden-node input {
            background-color: transparent;
            color: var(--dark-color);
        }

        .hidden-node input.active {
            background-color: rgba(76, 201, 240, 0.2);
            box-shadow: 0 0 8px 2px rgba(76, 201, 240, 0.6);
        }

        .children {
            position: absolute;
            top: 120px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .children .node:first-child {
            left: 20%;
            transform: translateX(-50%);
        }

        .children .node:last-child {
            right: 20%;
            transform: translateX(50%);
        }

        .connection {
            position: absolute;
            background-color: var(--primary-color);
            z-index: 1;
            width: 3px;
            height: 80px;
            transform-origin: bottom;
        }

        .diagonal-left {
            bottom: 50px;
            left: 35%;
            transform: rotate(30deg);
        }

        .diagonal-right {
            bottom: 50px;
            right: 35%;
            transform: rotate(-30deg);
        }

        .input-wrapper {
            position: relative;
        }

        .input-field {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background-color: white;
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .input-field:focus, .input-field.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
        }

        .key {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 0.8rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .key:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .key:active {
            transform: translateY(0);
        }

        .key.function-key {
            background-color: var(--primary-color);
            color: white;
            font-size: 1.2rem;
            aspect-ratio: 1;
            padding: 0.8rem;
        }

        .key.delete-key {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        @media screen and (max-width: 768px) {
            .card {
                grid-template-columns: 1fr;
            }

            .game-config {
                border-right: none;
                border-bottom: 1px solid #eee;
                padding-right: 0;
                padding-bottom: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Animation */
        @keyframes appear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .node-sign {
            font-size: 2rem !important;
            color: var(--secondary-color);
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .question-node {
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 1.2rem;
            color: var(--secondary-color);
            z-index: 3;
        }

        .show-answer-btn {
            background-color: var(--warning-color);
            color: var(--dark-color);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(249, 199, 79, 0.25);
        }

        .controls .show-answer-btn {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
        }

        .show-answer-btn:hover {
            background-color: #f0bc2c;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(249, 199, 79, 0.3);
        }

        .show-answer-btn.visible {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="title">组数小游戏</h1>

        <div class="card">
            <div class="game-config" id="configSection">
                <div class="instruction">
                    <p>这是一个帮助学生掌握数的组成的练习游戏。游戏有三个难度等级：</p>
                    <p>等级1：给出结果数和一个组成数，填写另一个组成数</p>
                    <p>等级2：给出结果数，填写两个组成数</p>
                    <p>等级3：给出两个组成数，填写它们的和</p>
                </div>

                <div>
                    <h3 class="section-title">选择难度等级：</h3>
                    <div class="btn-group" id="levelButtons">
                        <button class="btn" data-level="1">等级1</button>
                        <button class="btn" data-level="2">等级2</button>
                        <button class="btn" data-level="3">等级3</button>
                    </div>
                </div>

                <div>
                    <h3 class="section-title">选择数字范围：</h3>
                    <div class="btn-group" id="rangeButtons">
                        <button class="btn" data-range="10">10以内</button>
                        <button class="btn" data-range="20">20以内</button>
                    </div>
                </div>
            </div>

            <div class="game-area hidden" id="gameArea">
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-label">当前等级</div>
                        <div class="stat-value" id="currentLevel">1</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">数字范围</div>
                        <div class="stat-value"><span id="currentRange">10</span>以内</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">当前得分</div>
                        <div class="stat-value" id="scoreDisplay">0</div>
                    </div>
                </div>

                <div class="game-content">
                    <div class="tree-section">
                        <div class="tree-container" id="treeContainer">
                            <div class="tree">
                                <div class="node result-node" id="resultNode">?</div>
                                <div class="children">
                                    <div class="node" id="leftNode">5</div>
                                    <div class="node" id="rightNode">3</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-section">
                        <div class="keyboard" id="keyboard"></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" id="checkBtn">检查答案</button>
                    <button class="btn btn-secondary" id="nextBtn">下一题</button>
                    <button class="btn btn-danger" id="resetBtn">重新开始</button>
                    <button class="show-answer-btn" id="showAnswerBtn">查看答案</button>
                </div>

                <div class="feedback-message" id="message"></div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            level: null,
            range: null,
            targetNumber: null,
            compositionNumbers: {
                left: null,
                right: null
            },
            answers: [],
            userInputs: [],
            activeInputIndex: 0,
            score: 0,
            gameStarted: false,
            hiddenNodePosition: 'result',
            wrongAttempts: 0
        };

        // DOM元素
        const configSection = document.getElementById('configSection');
        const gameArea = document.getElementById('gameArea');
        const currentLevelDisplay = document.getElementById('currentLevel');
        const currentRangeDisplay = document.getElementById('currentRange');
        const treeContainer = document.getElementById('treeContainer');
        const resultNode = document.getElementById('resultNode');
        const leftNode = document.getElementById('leftNode');
        const rightNode = document.getElementById('rightNode');
        const inputsContainer = document.getElementById('inputsContainer');
        const keyboardElement = document.getElementById('keyboard');
        const message = document.getElementById('message');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');
        const resetBtn = document.getElementById('resetBtn');
        const scoreDisplay = document.getElementById('scoreDisplay');

        // 显示消息
        function showMessage(text, type, duration = 3000) {
            // 清除之前的定时器
            clearTimeout(message.timer);

            message.textContent = text;
            message.className = 'feedback-message';
            if (type) {
                message.classList.add(type);
            }

            // 设置定时器自动清除消息
            if (duration > 0) {
                message.timer = setTimeout(() => {
                    clearMessage();
                }, duration);
            }
        }

        // 清除消息
        function clearMessage() {
            // 清除之前的定时器
            clearTimeout(message.timer);
            message.textContent = '';
            message.className = 'feedback-message';
        }

        // 创建输入框
        function createInputs(count) {
            gameState.userInputs = Array(count).fill('');
            gameState.activeInputIndex = 0;
        }

        // 设置虚拟键盘
        function setupKeyboard() {
            keyboardElement.innerHTML = '';

            // 数字键
            for (let i = 1; i <= 9; i++) {
                const key = document.createElement('div');
                key.className = 'key fade-in';
                key.textContent = i;
                key.addEventListener('click', () => handleKeyPress(i.toString()));
                keyboardElement.appendChild(key);
            }

            // 添加删除键
            const deleteKey = document.createElement('div');
            deleteKey.className = 'key delete-key fade-in';
            deleteKey.textContent = '←';
            deleteKey.addEventListener('click', () => handleKeyPress('Backspace'));
            keyboardElement.appendChild(deleteKey);

            // 添加0键
            const zeroKey = document.createElement('div');
            zeroKey.className = 'key fade-in';
            zeroKey.textContent = '0';
            zeroKey.addEventListener('click', () => handleKeyPress('0'));
            keyboardElement.appendChild(zeroKey);

            // 添加确认键
            const enterKey = document.createElement('div');
            enterKey.className = 'key function-key fade-in';
            enterKey.textContent = '✓';
            enterKey.addEventListener('click', checkAnswer);
            keyboardElement.appendChild(enterKey);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 先获取原始按钮引用
            const origCheckBtn = document.getElementById('checkBtn');
            const origNextBtn = document.getElementById('nextBtn');
            const origResetBtn = document.getElementById('resetBtn');

            // 克隆按钮并替换
            const newCheckBtn = origCheckBtn.cloneNode(true);
            const newNextBtn = origNextBtn.cloneNode(true);
            const newResetBtn = origResetBtn.cloneNode(true);

            origCheckBtn.parentNode.replaceChild(newCheckBtn, origCheckBtn);
            origNextBtn.parentNode.replaceChild(newNextBtn, origNextBtn);
            origResetBtn.parentNode.replaceChild(newResetBtn, origResetBtn);

            // 更新全局变量引用
            window.checkBtn = newCheckBtn;
            window.nextBtn = newNextBtn;
            window.resetBtn = newResetBtn;

            // 绑定事件
            newCheckBtn.addEventListener('click', checkAnswer);
            newNextBtn.addEventListener('click', handleNextQuestion);
            newResetBtn.addEventListener('click', resetGame);

            console.log("全部按钮重新绑定完成");

            // 初始化其他事件
            initEventListeners();

            // 默认选择等级1和10以内
            const defaultLevelBtn = document.querySelector('#levelButtons .btn[data-level="1"]');
            const defaultRangeBtn = document.querySelector('#rangeButtons .btn[data-range="10"]');

            if (defaultLevelBtn && defaultRangeBtn) {
                defaultLevelBtn.click();
                defaultRangeBtn.click();
            }
        });

        // 初始化事件监听器
        function initEventListeners() {
            // 难度按钮
            document.querySelectorAll('#levelButtons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    selectLevel(level);
                    highlightButton('#levelButtons .btn', this);
                });
            });

            // 范围按钮
            document.querySelectorAll('#rangeButtons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const range = parseInt(this.dataset.range);
                    selectRange(range);
                    highlightButton('#rangeButtons .btn', this);
                });
            });

            // 添加查看答案按钮事件监听器
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            const newShowAnswerBtn = showAnswerBtn.cloneNode(true);
            showAnswerBtn.parentNode.replaceChild(newShowAnswerBtn, showAnswerBtn);

            newShowAnswerBtn.addEventListener('click', function() {
                showCorrectAnswer();
                this.disabled = true;
                this.style.opacity = '0.5';
                this.style.cursor = 'not-allowed';
            });

            // 添加键盘事件监听
            document.addEventListener('keydown', function(event) {
                if (!gameState.gameStarted) return; // 游戏未开始时不响应键盘

                if (event.key >= '0' && event.key <= '9') {
                    handleKeyPress(event.key);
                } else if (event.key === 'Backspace') {
                    handleKeyPress('Backspace');
                } else if (event.key === 'Enter') {
                    if (event.shiftKey) {
                        // Shift + Enter 切换到下一题
                        handleNextQuestion();
                    } else {
                        // Enter 检查答案
                        checkAnswer();
                    }
                } else if (event.key === 'Tab') {
                    // 阻止默认Tab行为
                    event.preventDefault();
                    // 在等级2的情况下，切换输入框
                    if (gameState.level === 2) {
                        gameState.activeInputIndex = gameState.activeInputIndex === 0 ? 1 : 0;
                        const inputs = document.querySelectorAll('.hidden-node input');
                        inputs.forEach((input, index) => {
                            if (index === gameState.activeInputIndex) {
                                input.classList.add('active');
                            } else {
                                input.classList.remove('active');
                            }
                        });
                    }
                }
            });
        }

        // 高亮选中的按钮
        function highlightButton(selector, activeBtn) {
            document.querySelectorAll(selector).forEach(btn => {
                btn.classList.remove('btn-active');
            });
            activeBtn.classList.add('btn-active');
        }

        // 选择等级
        function selectLevel(level) {
            gameState.level = level;
            currentLevelDisplay.textContent = level;
            checkStartConditions();
        }

        // 选择范围
        function selectRange(range) {
            gameState.range = range;
            currentRangeDisplay.textContent = range;
            checkStartConditions();
        }

        // 检查是否可以开始游戏
        function checkStartConditions() {
            const levelSelected = gameState.level !== null;
            const rangeSelected = gameState.range !== null;

            // 更新选择提示
            const levelButtons = document.querySelectorAll('#levelButtons .btn');
            const rangeButtons = document.querySelectorAll('#rangeButtons .btn');

            if (!levelSelected) {
                showMessage('请选择难度等级', 'incorrect');
                levelButtons.forEach(btn => btn.classList.add('pulse'));
            } else {
                levelButtons.forEach(btn => btn.classList.remove('pulse'));
            }

            if (!rangeSelected) {
                if (levelSelected) {
                    showMessage('请选择数字范围', 'incorrect');
                }
                rangeButtons.forEach(btn => btn.classList.add('pulse'));
            } else {
                rangeButtons.forEach(btn => btn.classList.remove('pulse'));
            }

            if (levelSelected && rangeSelected) {
                clearMessage();
                startGame();
            }
        }

        // 完全重写下一题按钮的处理函数
        function handleNextQuestion() {
            console.log("点击下一题按钮");

            // 检查是否已显示答案
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            if (showAnswerBtn.disabled) {
                // 已经查看过答案，直接创建新题目
                createNewQuestion();
                return;
            }

            // 检查是否所有输入框都已填写
            const allInputsFilled = gameState.userInputs.every(input => input !== '');

            // 情况1: 未完成输入
            if (!allInputsFilled) {
                showConfirmDialog("当前题目未完成，是否确定要切换到下一题？", () => {
                    createNewQuestion();
                });
                return;
            }

            // 情况2: 已完成输入但未检查答案
            if (!checkBtn.disabled) {
                console.log("自动检查答案");
                const isCorrect = checkAnswer();
                if (isCorrect) {
                    // 答案正确，延迟一点创建新题目，让用户看到反馈
                    setTimeout(() => {
                        createNewQuestion();
                    }, 1000);
                }
                return;
            }

            // 情况3: 答案已检查，直接创建新题目
            createNewQuestion();
        }

        // 显示确认对话框
        function showConfirmDialog(message, onConfirm) {
            // 创建确认对话框
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog fade-in';
            confirmDialog.innerHTML = `
                <div class="confirm-content">
                    <p>${message}</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-secondary" id="confirmYes">确定</button>
                        <button class="btn" id="confirmNo">取消</button>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmDialog);

            // 添加确认对话框的样式
            if (!document.getElementById('confirm-dialog-style')) {
                const style = document.createElement('style');
                style.id = 'confirm-dialog-style';
                style.textContent = `
                    .confirm-dialog {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .confirm-content {
                        background: white;
                        padding: 2rem;
                        border-radius: var(--border-radius);
                        box-shadow: var(--box-shadow);
                        text-align: center;
                    }
                    .confirm-buttons {
                        display: flex;
                        justify-content: center;
                        gap: 1rem;
                        margin-top: 1.5rem;
                    }
                `;
                document.head.appendChild(style);
            }

            // 添加按钮事件
            document.getElementById('confirmYes').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });

            document.getElementById('confirmNo').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
            });
        }

        // 开始游戏
        function startGame() {
            gameState.gameStarted = true;
            gameState.score = 0;
            updateScoreDisplay();
            configSection.classList.add('hidden');
            gameArea.classList.remove('hidden');
            gameArea.classList.add('appear');
            createNewQuestion();
            setupKeyboard();
        }

        // 创建新问题
        function createNewQuestion() {
            clearMessage();

            // 重置按钮状态和错误计数
            checkBtn.disabled = false;
            nextBtn.disabled = true;
            gameState.wrongAttempts = 0;

            // 重置查看答案按钮状态
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            showAnswerBtn.classList.remove('visible');
            showAnswerBtn.disabled = false;
            showAnswerBtn.style.opacity = '1';
            showAnswerBtn.style.cursor = 'pointer';

            // 根据等级和范围创建题目
            const maxNumber = gameState.range;

            // 根据等级决定隐藏哪个节点
            if (gameState.level === 1) {
                generateLevel1Question(maxNumber);
            } else if (gameState.level === 2) {
                generateLevel2Question(maxNumber);
            } else if (gameState.level === 3) {
                generateLevel3Question(maxNumber);
            }

            // 更新树形图显示
            updateTreeDisplay();
        }

        // 生成等级1的问题
        function generateLevel1Question(maxNumber) {
            // 等级1：随机遮挡一个组成元素
            const positions = ['left', 'right'];
            gameState.hiddenNodePosition = positions[Math.floor(Math.random() * positions.length)];

            // 生成两个随机数
            const left = Math.floor(Math.random() * maxNumber) + 1;
            const right = Math.floor(Math.random() * maxNumber) + 1;
            const result = left + right;

            if (result > maxNumber) {
                // 如果结果超过范围，重新生成
                generateLevel1Question(maxNumber);
                return;
            }

            gameState.compositionNumbers.left = left;
            gameState.compositionNumbers.right = right;
            gameState.targetNumber = result;

            // 根据隐藏位置设置答案
            if (gameState.hiddenNodePosition === 'left') {
                gameState.answers = [left];
            } else {
                gameState.answers = [right];
            }

            // 创建一个输入框
            createInputs(1);
        }

        // 生成等级2的问题
        function generateLevel2Question(maxNumber) {
            // 等级2：只显示目标数字，用户输入两个组成数字
            gameState.hiddenNodePosition = 'both';

            // 生成目标数字
            const target = Math.floor(Math.random() * maxNumber) + 1;
            gameState.targetNumber = target;

            // 生成一个有效的组合作为答案
            let validCombinations = [];
            for (let i = 1; i <= target; i++) {
                const j = target - i;
                if (j > 0 && j <= maxNumber && i <= maxNumber) {
                    validCombinations.push([i, j]);
                }
            }

            if (validCombinations.length === 0) {
                // 如果没有有效组合，重新生成
                generateLevel2Question(maxNumber);
                return;
            }

            // 随机选择一个组合作为参考答案
            const [left, right] = validCombinations[Math.floor(Math.random() * validCombinations.length)];
            gameState.compositionNumbers.left = left;
            gameState.compositionNumbers.right = right;
            gameState.answers = [left, right];

            // 创建两个输入框
            createInputs(2);
        }

        // 生成等级3的问题
        function generateLevel3Question(maxNumber) {
            // 等级3：显示两个组成数字，用户填写结果数字
            gameState.hiddenNodePosition = 'result';

            // 生成两个随机数
            const left = Math.floor(Math.random() * maxNumber) + 1;
            const right = Math.floor(Math.random() * maxNumber) + 1;
            const result = left + right;

            if (result > maxNumber) {
                // 如果结果超过范围，重新生成
                generateLevel3Question(maxNumber);
                return;
            }

            gameState.compositionNumbers.left = left;
            gameState.compositionNumbers.right = right;
            gameState.targetNumber = result;
            gameState.answers = [result];

            // 创建一个输入框
            createInputs(1);
        }

        // 更新树形图显示
        function updateTreeDisplay() {
            // 清除旧的连接线和符号
            const oldElements = treeContainer.querySelectorAll('.dynamic-line, .node-sign, .question-node');
            oldElements.forEach(element => element.remove());

            const tree = treeContainer.querySelector('.tree');

            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 2;
            input.readOnly = true;

            if (gameState.level === 1) {
                // 等级1：显示目标数字和一个组成数字
                resultNode.textContent = gameState.targetNumber;
                resultNode.classList.remove('hidden-node');

                if (gameState.hiddenNodePosition === 'left') {
                    leftNode.innerHTML = '';
                    leftNode.appendChild(input);
                    leftNode.classList.add('hidden-node');
                    rightNode.textContent = gameState.compositionNumbers.right;
                    rightNode.classList.remove('hidden-node');
                } else {
                    leftNode.textContent = gameState.compositionNumbers.left;
                    leftNode.classList.remove('hidden-node');
                    rightNode.innerHTML = '';
                    rightNode.appendChild(input);
                    rightNode.classList.add('hidden-node');
                }
            } else if (gameState.level === 2) {
                // 等级2：修改输入框处理
                resultNode.textContent = gameState.targetNumber;
                resultNode.classList.remove('hidden-node');

                const inputLeft = input.cloneNode(true);
                const inputRight = input.cloneNode(true);

                // 为输入框添加点击事件
                inputLeft.addEventListener('click', () => {
                    gameState.activeInputIndex = 0;
                    inputLeft.classList.add('active');
                    inputRight.classList.remove('active');
                });

                inputRight.addEventListener('click', () => {
                    gameState.activeInputIndex = 1;
                    inputRight.classList.add('active');
                    inputLeft.classList.remove('active');
                });

                // 设置初始活动状态
                inputLeft.classList.add('active');

                leftNode.innerHTML = '';
                leftNode.appendChild(inputLeft);
                leftNode.classList.add('hidden-node');

                rightNode.innerHTML = '';
                rightNode.appendChild(inputRight);
                rightNode.classList.add('hidden-node');
            } else if (gameState.level === 3) {
                // 等级3：显示两个组成数字，隐藏结果数字
                resultNode.innerHTML = '';
                resultNode.appendChild(input);
                resultNode.classList.add('hidden-node');

                leftNode.textContent = gameState.compositionNumbers.left;
                rightNode.textContent = gameState.compositionNumbers.right;
                leftNode.classList.remove('hidden-node');
                rightNode.classList.remove('hidden-node');
            }

            // 添加连接线和运算符号
            addTreeConnections(tree);
        }

        // 添加树的连接线和符号
        function addTreeConnections(tree) {
            // 添加加号
            const plusSign = document.createElement('div');
            plusSign.className = 'node-sign fade-in';
            plusSign.style.position = 'absolute';
            plusSign.style.top = '140px';
            plusSign.style.left = '50%';
            plusSign.style.transform = 'translateX(-50%)';
            plusSign.innerHTML = '+';
            tree.appendChild(plusSign);

            // 添加连接线
            const diagonalLeft = document.createElement('div');
            diagonalLeft.className = 'connection diagonal-left dynamic-line fade-in';
            tree.appendChild(diagonalLeft);

            const diagonalRight = document.createElement('div');
            diagonalRight.className = 'connection diagonal-right dynamic-line fade-in';
            tree.appendChild(diagonalRight);
        }

        // 处理按键
        function handleKeyPress(key) {
            let activeInput;
            if (gameState.level === 2) {
                // 对于等级2，使用activeInputIndex来确定当前输入框
                const inputs = document.querySelectorAll('.hidden-node input');
                activeInput = inputs[gameState.activeInputIndex];
            } else {
                // 对于其他等级，直接获取隐藏节点的输入框
                activeInput = document.querySelector('.hidden-node input');
            }

            if (!activeInput) return;

            if (key === 'Backspace') {
                if (gameState.userInputs[gameState.activeInputIndex].length > 0) {
                    gameState.userInputs[gameState.activeInputIndex] = gameState.userInputs[gameState.activeInputIndex].slice(0, -1);
                }
            } else if (!isNaN(parseInt(key))) {
                if (gameState.userInputs[gameState.activeInputIndex].length < 2) {
                    gameState.userInputs[gameState.activeInputIndex] += key;
                }
            }

            // 更新输入框显示
            activeInput.value = gameState.userInputs[gameState.activeInputIndex];
        }

        // 清除输入
        function clearInputs() {
            gameState.userInputs = [''];
            gameState.activeInputIndex = 0;
            const inputs = document.querySelectorAll('.hidden-node input');
            inputs.forEach(input => input.value = '');
        }

        // 检查答案
        function checkAnswer() {
            const allInputsFilled = gameState.userInputs.every(input => input !== '');
            if (!allInputsFilled) {
                showMessage('请填写所有答案！', 'incorrect');
                return false;
            }

            if (gameState.level === 1) {
                // 等级1：检查单个数字
                const userAnswer = parseInt(gameState.userInputs[0]);
                const correctAnswer = gameState.answers[0];
                return checkSingleAnswer(userAnswer, correctAnswer);
            } else if (gameState.level === 2) {
                // 等级2：检查两个数字
                const userLeft = parseInt(gameState.userInputs[0]);
                const userRight = parseInt(gameState.userInputs[1]);
                return checkCompositionAnswer(userLeft, userRight);
            } else if (gameState.level === 3) {
                // 等级3：检查结果数字
                const userAnswer = parseInt(gameState.userInputs[0]);
                const correctAnswer = gameState.targetNumber;
                return checkSingleAnswer(userAnswer, correctAnswer);
            }
            return false;
        }

        // 检查单个答案
        function checkSingleAnswer(userAnswer, correctAnswer) {
            if (userAnswer === correctAnswer) {
                handleCorrectAnswer();
                return true;
            } else {
                handleWrongAnswer();
                return false;
            }
        }

        // 检查组合答案
        function checkCompositionAnswer(userLeft, userRight) {
            const target = gameState.targetNumber;
            if (userLeft + userRight === target &&
                userLeft >= 0 && userRight >= 0 &&
                userLeft <= gameState.range &&
                userRight <= gameState.range) {
                handleCorrectAnswer();
                return true;
            } else {
                handleWrongAnswer();
                return false;
            }
        }

        // 处理正确答案
        function handleCorrectAnswer() {
            showMessage('恭喜你，答对了！', 'correct');
            gameState.score += 10;
            updateScoreDisplay();

            if (gameState.level === 1) {
                // 显示正确答案
                const nodeToUpdate = {
                    'left': leftNode,
                    'right': rightNode
                }[gameState.hiddenNodePosition];

                if (nodeToUpdate) {
                    nodeToUpdate.textContent = gameState.answers[0];
                    nodeToUpdate.classList.remove('hidden-node');
                }
            } else if (gameState.level === 2) {
                // 显示用户输入的正确组合
                leftNode.textContent = gameState.userInputs[0];
                rightNode.textContent = gameState.userInputs[1];
                leftNode.classList.remove('hidden-node');
                rightNode.classList.remove('hidden-node');
            } else if (gameState.level === 3) {
                // 显示正确的结果数字
                resultNode.textContent = gameState.targetNumber;
                resultNode.classList.remove('hidden-node');
            }

            checkBtn.disabled = true;
            nextBtn.disabled = false;
            nextBtn.focus();
        }

        // 处理错误答案
        function handleWrongAnswer() {
            gameState.wrongAttempts++;

            let msgText = '不正确，请重试！';
            if (gameState.wrongAttempts >= 3) {
                msgText = '不正确。已尝试3次，现在可以查看答案了！';
                showAnswerButton();
            }

            showMessage(msgText, 'incorrect', 4000);

            if (gameState.score > 0) {
                gameState.score -= 2;
                updateScoreDisplay();
            }
        }

        // 显示查看答案按钮
        function showAnswerButton() {
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            showAnswerBtn.classList.add('visible');
        }

        // 显示正确答案
        function showCorrectAnswer() {
            if (gameState.level === 1) {
                const input = document.querySelector('.hidden-node input');
                if (input) {
                    input.value = gameState.answers[0];
                }
                showMessage(`正确答案是：${gameState.answers[0]}`, 'correct');
            } else if (gameState.level === 2) {
                // 随机选择一组有效答案
                const target = gameState.targetNumber;
                let validAnswers = [];
                for (let i = 1; i <= target; i++) {
                    const j = target - i;
                    if (j > 0 && j <= gameState.range && i <= gameState.range) {
                        validAnswers.push([i, j]);
                    }
                }
                if (validAnswers.length > 0) {
                    const randomAnswer = validAnswers[Math.floor(Math.random() * validAnswers.length)];
                    const inputs = document.querySelectorAll('.hidden-node input');
                    if (inputs.length === 2) {
                        inputs[0].value = randomAnswer[0];
                        inputs[1].value = randomAnswer[1];
                    }
                    showMessage(`一种正确答案是：${randomAnswer[0]} 和 ${randomAnswer[1]}`, 'correct');
                }
            } else if (gameState.level === 3) {
                const input = document.querySelector('.hidden-node input');
                if (input) {
                    input.value = gameState.targetNumber;
                }
                showMessage(`正确答案是：${gameState.targetNumber}`, 'correct');
            }
        }

        // 重置游戏
        function resetGame() {
            clearInputs();
            clearMessage();
            gameState.gameStarted = false;
            gameState.score = 0;
            updateScoreDisplay();

            // 显示配置区域，隐藏游戏区域
            configSection.classList.remove('hidden');
            gameArea.classList.add('hidden');

            // 重置按钮高亮
            document.querySelectorAll('#levelButtons .btn, #rangeButtons .btn').forEach(btn => {
                btn.classList.remove('btn-active');
            });

            // 清除树形图
            resultNode.textContent = '?';
            resultNode.classList.remove('hidden-node', 'pulse');
            leftNode.textContent = '5';
            leftNode.classList.remove('hidden-node', 'pulse');
            rightNode.textContent = '3';
            rightNode.classList.remove('hidden-node', 'pulse');

            // 清除动态元素
            const dynamicElements = document.querySelectorAll('.dynamic-line, .node-sign, .question-node');
            dynamicElements.forEach(element => element.remove());
        }

        // 更新分数显示
        function updateScoreDisplay() {
            scoreDisplay.textContent = gameState.score;
        }
    </script>
</body>
</html>